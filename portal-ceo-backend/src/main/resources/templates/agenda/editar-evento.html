<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Evento - Agenda - ERP Corporativo</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Tempus Dominus CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.7/dist/css/tempus-dominus.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/agenda.css}" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div th:replace="~{fragments/topbar :: topbar}"></div>
        
        <!-- Page Content -->
        <div class="container-fluid p-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-0 text-gray-800">
                                <i class="fas fa-edit me-2"></i>Editar Evento
                            </h1>
                            <p class="text-muted mb-0">Modifique as informações do evento</p>
                        </div>
                        <div>
                            <a th:href="@{/agenda/visualizar-eventos}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Voltar à Lista
                            </a>
                            <a th:href="@{/agenda}" class="btn btn-outline-secondary ms-2">
                                <i class="fas fa-home me-1"></i>Agenda
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alert Messages -->
            <div th:if="${mensagem}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${mensagem}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:text="${erro}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <!-- Informações do Evento Atual -->
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-info-circle me-2"></i>Informações Atuais do Evento
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Título:</strong> <span th:text="${evento.titulo}">Título do Evento</span></p>
                            <p><strong>Data de Criação:</strong> <span th:text="${#temporals.format(evento.dataCriacao, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span></p>
                            <p><strong>Última Modificação:</strong> <span th:text="${#temporals.format(evento.dataModificacao, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong> 
                                <span class="badge" th:classappend="${evento.status == 'ATIVO' ? 'bg-success' : 
                                                                      evento.status == 'CANCELADO' ? 'bg-danger' : 
                                                                      evento.status == 'ADIADO' ? 'bg-warning' : 'bg-secondary'}" 
                                      th:text="${evento.status}">Status</span>
                            </p>
                            <p><strong>Criado por:</strong> <span th:text="${evento.criadoPor}">Usuário</span></p>
                            <p><strong>ID do Evento:</strong> <span th:text="${evento.id}" class="text-muted">#123</span></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form Card -->
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-calendar-edit me-2"></i>Editar Informações do Evento
                            </h6>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/agenda/editar/{id}(id=${evento.id})}" method="post" th:object="${evento}" id="formEditarEvento">
                                <input type="hidden" th:field="*{id}">
                                <input type="hidden" th:field="*{dataCriacao}">
                                <input type="hidden" th:field="*{criadoPor}">
                                
                                <div class="row">
                                    <!-- Título -->
                                    <div class="col-md-8 mb-3">
                                        <label for="titulo" class="form-label">
                                            <i class="fas fa-heading me-1"></i>Título do Evento *
                                        </label>
                                        <input type="text" class="form-control" id="titulo" th:field="*{titulo}" 
                                               placeholder="Digite o título do evento" required maxlength="100">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                                    </div>
                                    
                                    <!-- Status -->
                                    <div class="col-md-4 mb-3">
                                        <label for="status" class="form-label">
                                            <i class="fas fa-toggle-on me-1"></i>Status
                                        </label>
                                        <select class="form-select" id="status" th:field="*{status}">
                                            <option value="ATIVO">Ativo</option>
                                            <option value="CANCELADO">Cancelado</option>
                                            <option value="ADIADO">Adiado</option>
                                            <option value="CONCLUIDO">Concluído</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <!-- Prioridade -->
                                    <div class="col-md-6 mb-3">
                                        <label for="prioridade" class="form-label">
                                            <i class="fas fa-flag me-1"></i>Prioridade
                                        </label>
                                        <select class="form-select" id="prioridade" th:field="*{prioridade}">
                                            <option value="BAIXA">Baixa</option>
                                            <option value="MEDIA">Média</option>
                                            <option value="ALTA">Alta</option>
                                            <option value="URGENTE">Urgente</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Categoria -->
                                    <div class="col-md-6 mb-3">
                                        <label for="categoria" class="form-label">
                                            <i class="fas fa-tags me-1"></i>Categoria
                                        </label>
                                        <select class="form-select" id="categoria" th:field="*{categoria}">
                                            <option value="">Selecione uma categoria</option>
                                            <option value="REUNIAO">Reunião</option>
                                            <option value="COMPROMISSO">Compromisso</option>
                                            <option value="EVENTO">Evento</option>
                                            <option value="TAREFA">Tarefa</option>
                                            <option value="LEMBRETE">Lembrete</option>
                                            <option value="OUTRO">Outro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <!-- Data de Início -->
                                    <div class="col-md-6 mb-3">
                                        <label for="dataInicio" class="form-label">
                                            <i class="fas fa-calendar me-1"></i>Data e Hora de Início *
                                        </label>
                                        <div class="input-group" id="datetimepicker1" data-td-target-input="nearest" data-td-target-toggle="nearest">
                                            <input type="datetime-local" class="form-control" id="dataInicio" th:field="*{dataInicio}" 
                                                   data-td-target="#datetimepicker1" required>
                                            <span class="input-group-text" data-td-target="#datetimepicker1" data-td-toggle="datetimepicker">
                                                <i class="fas fa-calendar"></i>
                                            </span>
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('dataInicio')}" th:errors="*{dataInicio}"></div>
                                    </div>
                                    
                                    <!-- Data de Fim -->
                                    <div class="col-md-6 mb-3">
                                        <label for="dataFim" class="form-label">
                                            <i class="fas fa-calendar-check me-1"></i>Data e Hora de Fim
                                        </label>
                                        <div class="input-group" id="datetimepicker2" data-td-target-input="nearest" data-td-target-toggle="nearest">
                                            <input type="datetime-local" class="form-control" id="dataFim" th:field="*{dataFim}" 
                                                   data-td-target="#datetimepicker2">
                                            <span class="input-group-text" data-td-target="#datetimepicker2" data-td-toggle="datetimepicker">
                                                <i class="fas fa-calendar"></i>
                                            </span>
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('dataFim')}" th:errors="*{dataFim}"></div>
                                    </div>
                                </div>
                                
                                <!-- Descrição -->
                                <div class="mb-3">
                                    <label for="descricao" class="form-label">
                                        <i class="fas fa-align-left me-1"></i>Descrição
                                    </label>
                                    <textarea class="form-control" id="descricao" th:field="*{descricao}" rows="4" 
                                              placeholder="Descreva os detalhes do evento" maxlength="500"></textarea>
                                    <div class="form-text">Máximo 500 caracteres</div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}"></div>
                                </div>
                                
                                <div class="row">
                                    <!-- Local -->
                                    <div class="col-md-6 mb-3">
                                        <label for="local" class="form-label">
                                            <i class="fas fa-map-marker-alt me-1"></i>Local
                                        </label>
                                        <input type="text" class="form-control" id="local" th:field="*{local}" 
                                               placeholder="Local do evento" maxlength="100">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('local')}" th:errors="*{local}"></div>
                                    </div>
                                    
                                    <!-- Cor do Evento -->
                                    <div class="col-md-6 mb-3">
                                        <label for="cor" class="form-label">
                                            <i class="fas fa-palette me-1"></i>Cor do Evento
                                        </label>
                                        <div class="input-group">
                                            <input type="color" class="form-control form-control-color" id="cor" th:field="*{cor}" 
                                                   title="Escolha uma cor para o evento">
                                            <span class="input-group-text">Cor no calendário</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Configurações Adicionais -->
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cogs me-2"></i>Configurações Adicionais
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- Evento Dia Inteiro -->
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="diaInteiro" th:field="*{diaInteiro}">
                                                    <label class="form-check-label" for="diaInteiro">
                                                        <i class="fas fa-sun me-1"></i>Evento de dia inteiro
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Evento Recorrente -->
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="recorrente" th:field="*{recorrente}">
                                                    <label class="form-check-label" for="recorrente">
                                                        <i class="fas fa-redo me-1"></i>Evento recorrente
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Privado -->
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="privado" th:field="*{privado}">
                                                    <label class="form-check-label" for="privado">
                                                        <i class="fas fa-lock me-1"></i>Evento privado
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Recorrência (mostrar apenas se recorrente estiver marcado) -->
                                        <div id="recorrenciaConfig" class="row" th:style="${evento.recorrente} ? 'display: block;' : 'display: none;'">
                                            <div class="col-md-6 mb-3">
                                                <label for="tipoRecorrencia" class="form-label">
                                                    <i class="fas fa-repeat me-1"></i>Tipo de Recorrência
                                                </label>
                                                <select class="form-select" id="tipoRecorrencia" th:field="*{tipoRecorrencia}">
                                                    <option value="DIARIA">Diária</option>
                                                    <option value="SEMANAL">Semanal</option>
                                                    <option value="MENSAL">Mensal</option>
                                                    <option value="ANUAL">Anual</option>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="dataFimRecorrencia" class="form-label">
                                                    <i class="fas fa-calendar-times me-1"></i>Fim da Recorrência
                                                </label>
                                                <input type="date" class="form-control" id="dataFimRecorrencia" th:field="*{dataFimRecorrencia}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lembretes -->
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-bell me-2"></i>Lembretes
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete15min" name="lembretes" value="15">
                                                    <label class="form-check-label" for="lembrete15min">
                                                        15 minutos antes
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete30min" name="lembretes" value="30">
                                                    <label class="form-check-label" for="lembrete30min">
                                                        30 minutos antes
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete1h" name="lembretes" value="60">
                                                    <label class="form-check-label" for="lembrete1h">
                                                        1 hora antes
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete1dia" name="lembretes" value="1440">
                                                    <label class="form-check-label" for="lembrete1dia">
                                                        1 dia antes
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembreteEmail" th:field="*{lembreteEmail}">
                                                    <label class="form-check-label" for="lembreteEmail">
                                                        <i class="fas fa-envelope me-1"></i>Enviar por e-mail
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Histórico de Alterações -->
                                <div class="card mt-4" th:if="${evento.historicoAlteracoes}">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-history me-2"></i>Histórico de Alterações
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="timeline">
                                            <div class="timeline-item" th:each="alteracao : ${evento.historicoAlteracoes}">
                                                <div class="timeline-marker"></div>
                                                <div class="timeline-content">
                                                    <h6 class="timeline-title" th:text="${alteracao.descricao}">Alteração realizada</h6>
                                                    <p class="timeline-text text-muted">
                                                        <i class="fas fa-user me-1"></i><span th:text="${alteracao.usuario}">Usuário</span>
                                                        <i class="fas fa-clock ms-3 me-1"></i><span th:text="${#temporals.format(alteracao.dataHora, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botões de Ação -->
                                <div class="d-flex justify-content-between mt-4">
                                    <div>
                                        <a th:href="@{/agenda/visualizar-eventos}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times me-1"></i>Cancelar
                                        </a>
                                        <button type="button" class="btn btn-outline-danger ms-2" onclick="confirmarExclusao()">
                                            <i class="fas fa-trash me-1"></i>Excluir Evento
                                        </button>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary me-2" onclick="salvarRascunho()">
                                            <i class="fas fa-save me-1"></i>Salvar Rascunho
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-check me-1"></i>Atualizar Evento
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Confirmar Exclusão
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este evento?</p>
                    <p class="text-muted">Esta ação não pode ser desfeita e removerá permanentemente:</p>
                    <ul class="text-muted">
                        <li>Todas as informações do evento</li>
                        <li>Lembretes configurados</li>
                        <li>Histórico de alterações</li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">
                        <i class="fas fa-trash me-1"></i>Excluir Definitivamente
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.7/dist/js/tempus-dominus.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Configurar data fim automaticamente (1 hora depois)
            $('#dataInicio').on('change', function() {
                const dataInicio = new Date($(this).val());
                if (dataInicio && !$('#dataFim').val()) {
                    const dataFim = new Date(dataInicio.getTime() + 60 * 60 * 1000); // +1 hora
                    $('#dataFim').val(dataFim.toISOString().slice(0, 16));
                }
            });
            
            // Mostrar/ocultar configurações de recorrência
            $('#recorrente').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#recorrenciaConfig').show();
                } else {
                    $('#recorrenciaConfig').hide();
                }
            });
            
            // Configurar evento de dia inteiro
            $('#diaInteiro').on('change', function() {
                if ($(this).is(':checked')) {
                    // Definir horários para dia inteiro
                    const dataInicio = new Date($('#dataInicio').val());
                    dataInicio.setHours(0, 0, 0, 0);
                    $('#dataInicio').val(dataInicio.toISOString().slice(0, 16));
                    
                    const dataFim = new Date(dataInicio);
                    dataFim.setHours(23, 59, 59, 999);
                    $('#dataFim').val(dataFim.toISOString().slice(0, 16));
                    
                    // Desabilitar edição de horário
                    $('#dataInicio, #dataFim').prop('readonly', true);
                } else {
                    $('#dataInicio, #dataFim').prop('readonly', false);
                }
            });
            
            // Validação do formulário
            $('#formEditarEvento').on('submit', function(e) {
                const dataInicio = new Date($('#dataInicio').val());
                const dataFim = new Date($('#dataFim').val());
                
                if (dataFim && dataFim <= dataInicio) {
                    e.preventDefault();
                    alert('A data de fim deve ser posterior à data de início.');
                    return false;
                }
                
                // Adicionar lembretes selecionados ao formulário
                const lembretesSelecionados = [];
                $('input[name="lembretes"]:checked').each(function() {
                    lembretesSelecionados.push($(this).val());
                });
                
                if (lembretesSelecionados.length > 0) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'lembretesMinutos',
                        value: lembretesSelecionados.join(',')
                    }).appendTo('#formEditarEvento');
                }
                
                // Adicionar campo de data de modificação
                $('<input>').attr({
                    type: 'hidden',
                    name: 'dataModificacao',
                    value: new Date().toISOString()
                }).appendTo('#formEditarEvento');
            });
            
            // Contador de caracteres para descrição
            $('#descricao').on('input', function() {
                const maxLength = 500;
                const currentLength = $(this).val().length;
                const remaining = maxLength - currentLength;
                
                $(this).siblings('.form-text').text(`${remaining} caracteres restantes`);
                
                if (remaining < 50) {
                    $(this).siblings('.form-text').addClass('text-warning');
                } else {
                    $(this).siblings('.form-text').removeClass('text-warning');
                }
            });
            
            // Carregar lembretes existentes
            carregarLembretesExistentes();
            
            // Detectar mudanças no formulário
            detectarMudancas();
        });
        
        function carregarLembretesExistentes() {
            // Carregar lembretes existentes do evento
            const lembretesExistentes = /*[[${evento.lembretes}]]*/ [];
            
            if (lembretesExistentes && lembretesExistentes.length > 0) {
                lembretesExistentes.forEach(function(lembrete) {
                    $('input[name="lembretes"][value="' + lembrete + '"]').prop('checked', true);
                });
            }
        }
        
        function detectarMudancas() {
            let formularioOriginal = $('#formEditarEvento').serialize();
            let mudancasDetectadas = false;
            
            $('#formEditarEvento input, #formEditarEvento select, #formEditarEvento textarea').on('change input', function() {
                const formularioAtual = $('#formEditarEvento').serialize();
                mudancasDetectadas = formularioOriginal !== formularioAtual;
                
                if (mudancasDetectadas) {
                    $('button[type="submit"]').removeClass('btn-primary').addClass('btn-warning');
                    $('button[type="submit"] i').removeClass('fa-check').addClass('fa-exclamation-triangle');
                } else {
                    $('button[type="submit"]').removeClass('btn-warning').addClass('btn-primary');
                    $('button[type="submit"] i').removeClass('fa-exclamation-triangle').addClass('fa-check');
                }
            });
            
            // Aviso ao sair da página com mudanças não salvas
            $(window).on('beforeunload', function() {
                if (mudancasDetectadas) {
                    return 'Você tem alterações não salvas. Deseja realmente sair?';
                }
            });
        }
        
        function salvarRascunho() {
            const formData = new FormData($('#formEditarEvento')[0]);
            formData.append('rascunho', 'true');
            
            $.ajax({
                url: '/agenda/salvar-rascunho/' + /*[[${evento.id}]]*/ 0,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    alert('Rascunho salvo com sucesso!');
                },
                error: function() {
                    alert('Erro ao salvar rascunho.');
                }
            });
        }
        
        function confirmarExclusao() {
            $('#modalConfirmarExclusao').modal('show');
        }
        
        $('#btnConfirmarExclusao').on('click', function() {
            const eventoId = /*[[${evento.id}]]*/ 0;
            
            $.ajax({
                url: '/agenda/excluir/' + eventoId,
                type: 'DELETE',
                success: function() {
                    $('#modalConfirmarExclusao').modal('hide');
                    window.location.href = '/agenda/visualizar-eventos';
                },
                error: function() {
                    alert('Erro ao excluir evento.');
                }
            });
        });
    </script>
</body>
</html>