<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Devolução de Venda - Painel do CEO</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
  <link href="/css/notifications.css" rel="stylesheet">
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <div class="container-fluid">
          <!-- Header da Página -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="display-6 fw-bold text-dark mb-0">
                    <i class="fas fa-undo me-2 text-danger"></i>Devolução de Venda
                  </h1>
                  <p class="text-muted mb-0" th:text="'Venda #' + ${venda.numeroVenda}">Venda #000001</p>
                </div>
                <div>
                  <a th:href="@{'/vendas/' + ${venda.id}}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Informações da Venda Original -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card border-info">
                <div class="card-header bg-info text-white">
                  <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações da Venda Original</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <p><strong>Número:</strong> <span th:text="${venda.numeroVenda}">000001</span></p>
                      <p><strong>Data:</strong> <span th:text="${#temporals.format(venda.dataVenda, 'dd/MM/yyyy')}">01/01/2024</span></p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Cliente:</strong> <span th:text="${venda.cliente.nome}">Cliente</span></p>
                      <p><strong>CPF/CNPJ:</strong> <span th:text="${venda.cliente.cpfCnpj}">000.000.000-00</span></p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Forma Pagamento:</strong> <span th:text="${venda.formaPagamento}">Dinheiro</span></p>
                      <p><strong>Status:</strong> <span class="badge bg-success" th:text="${venda.status}">Finalizada</span></p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Total da Venda:</strong> <span class="fw-bold text-success" th:text="'R$ ' + ${#numbers.formatDecimal(venda.total, 1, 2)}">R$ 0,00</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Formulário de Devolução -->
          <form th:action="@{'/vendas/' + ${venda.id} + '/processar-devolucao'}" method="post">
            <div class="row">
              <!-- Itens para Devolução -->
              <div class="col-lg-8">
                <div class="card mb-4">
                  <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Selecionar Itens para Devolução</h5>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-striped">
                        <thead class="table-dark">
                          <tr>
                            <th class="text-center">
                              <input type="checkbox" id="selecionarTodos" onchange="selecionarTodosItens()">
                            </th>
                            <th>Produto</th>
                            <th class="text-center">Qtd. Original</th>
                            <th class="text-center">Qtd. Devolver</th>
                            <th class="text-end">Preço Unit.</th>
                            <th class="text-end">Subtotal Devolução</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr th:each="item, iterStat : ${venda.itens}">
                            <td class="text-center">
                              <input type="checkbox" class="item-checkbox" 
                                     th:id="'item-' + ${iterStat.index}" 
                                     th:name="'itensDevolver[' + ${iterStat.index} + '].selecionado'"
                                     onchange="toggleQuantidadeItem(this)">
                            </td>
                            <td>
                              <input type="hidden" th:name="'itensDevolver[' + ${iterStat.index} + '].vendaItemId'" th:value="${item.id}">
                              <strong th:text="${item.produto.nome}">Nome do Produto</strong>
                              <br>
                              <small class="text-muted" th:text="'Código: ' + ${item.produto.codigoInterno}">Código: COD001</small>
                            </td>
                            <td class="text-center">
                              <span class="badge bg-primary" th:text="${item.quantidade}">1</span>
                            </td>
                            <td class="text-center">
                              <input type="number" class="form-control form-control-sm text-center quantidade-devolver" 
                                     th:name="'itensDevolver[' + ${iterStat.index} + '].quantidade'" 
                                     th:max="${item.quantidade}" min="0" value="0" disabled
                                     onchange="calcularSubtotalDevolucao(this)">
                            </td>
                            <td class="text-end" th:text="'R$ ' + ${#numbers.formatDecimal(item.precoUnitario, 1, 2)}">R$ 0,00</td>
                            <td class="text-end">
                              <span class="subtotal-devolucao fw-bold">R$ 0,00</span>
                              <input type="hidden" class="preco-unitario" th:value="${item.precoUnitario}">
                            </td>
                          </tr>
                        </tbody>
                        <tfoot class="table-light">
                          <tr>
                            <th colspan="5" class="text-end">Total da Devolução:</th>
                            <th class="text-end text-danger" id="totalDevolucao">R$ 0,00</th>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Informações da Devolução -->
              <div class="col-lg-4">
                <div class="card mb-4">
                  <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Dados da Devolução</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="motivo" class="form-label">Motivo da Devolução *</label>
                      <select class="form-select" id="motivo" name="motivo" required>
                        <option value="">Selecione o motivo</option>
                        <option value="Produto com defeito">Produto com defeito</option>
                        <option value="Produto errado">Produto errado</option>
                        <option value="Não gostou do produto">Não gostou do produto</option>
                        <option value="Arrependimento da compra">Arrependimento da compra</option>
                        <option value="Produto danificado no transporte">Produto danificado no transporte</option>
                        <option value="Erro na venda">Erro na venda</option>
                        <option value="Outros">Outros</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="observacoes" class="form-label">Observações</label>
                      <textarea class="form-control" id="observacoes" name="observacoes" rows="4" 
                                placeholder="Descreva detalhes sobre a devolução..."></textarea>
                    </div>
                    <div class="mb-3">
                      <label for="tipoReembolso" class="form-label">Tipo de Reembolso *</label>
                      <select class="form-select" id="tipoReembolso" name="tipoReembolso" required>
                        <option value="">Selecione o tipo</option>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Estorno no cartão">Estorno no cartão</option>
                        <option value="Crédito na loja">Crédito na loja</option>
                        <option value="Troca por outro produto">Troca por outro produto</option>
                      </select>
                    </div>
                  </div>
                </div>

                <!-- Resumo Financeiro -->
                <div class="card mb-4">
                  <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumo Financeiro</h5>
                  </div>
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <span>Valor Original:</span>
                      <span th:text="'R$ ' + ${#numbers.formatDecimal(venda.total, 1, 2)}">R$ 0,00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Valor da Devolução:</span>
                      <span id="valorDevolucaoResumo" class="text-danger">R$ 0,00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold">
                      <span>Valor Restante:</span>
                      <span id="valorRestante" class="text-success">R$ 0,00</span>
                    </div>
                  </div>
                </div>

                <!-- Botões de Ação -->
                <div class="card">
                  <div class="card-body">
                    <button type="submit" class="btn btn-danger w-100 mb-2" id="btnProcessarDevolucao" disabled>
                      <i class="fas fa-undo"></i> Processar Devolução
                    </button>
                    <a th:href="@{'/vendas/' + ${venda.id}}" class="btn btn-outline-secondary w-100">
                      <i class="fas fa-times"></i> Cancelar
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </form>

          <!-- Histórico de Devoluções -->
          <div class="row" th:if="${devolucoes != null and !devolucoes.isEmpty()}">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-dark text-white">
                  <h5 class="mb-0"><i class="fas fa-history me-2"></i>Histórico de Devoluções</h5>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-sm">
                      <thead>
                        <tr>
                          <th>Data</th>
                          <th>Motivo</th>
                          <th>Itens</th>
                          <th class="text-end">Valor</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr th:each="devolucao : ${devolucoes}">
                          <td th:text="${#temporals.format(devolucao.dataDevolucao, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</td>
                          <td th:text="${devolucao.motivo}">Motivo</td>
                          <td>
                            <small th:each="item : ${devolucao.itens}" class="d-block">
                              <span th:text="${item.produto.nome + ' (Qtd: ' + item.quantidade + ')'}">Produto (Qtd: 1)</span>
                            </small>
                          </td>
                          <td class="text-end" th:text="'R$ ' + ${#numbers.formatDecimal(devolucao.valorTotal, 1, 2)}">R$ 0,00</td>
                          <td>
                            <span class="badge" th:classappend="${devolucao.status == 'Processada'} ? 'bg-success' : 'bg-warning'" 
                                  th:text="${devolucao.status}">Processada</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/notifications.js}" defer></script>
  <script src="/js/sidebar.js" defer></script>

  <script>
    const valorOriginal = [[${venda.total}]];

    function selecionarTodosItens() {
      const selecionarTodos = document.getElementById('selecionarTodos');
      const checkboxes = document.querySelectorAll('.item-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selecionarTodos.checked;
        toggleQuantidadeItem(checkbox);
      });
    }

    function toggleQuantidadeItem(checkbox) {
      const linha = checkbox.closest('tr');
      const quantidadeInput = linha.querySelector('.quantidade-devolver');
      const quantidadeOriginal = parseInt(linha.querySelector('.badge').textContent);
      
      if (checkbox.checked) {
        quantidadeInput.disabled = false;
        quantidadeInput.value = quantidadeOriginal;
        quantidadeInput.focus();
      } else {
        quantidadeInput.disabled = true;
        quantidadeInput.value = 0;
      }
      
      calcularSubtotalDevolucao(quantidadeInput);
      verificarBotaoProcessar();
    }

    function calcularSubtotalDevolucao(input) {
      const linha = input.closest('tr');
      const quantidade = parseInt(input.value) || 0;
      const precoUnitario = parseFloat(linha.querySelector('.preco-unitario').value);
      const subtotal = quantidade * precoUnitario;
      
      linha.querySelector('.subtotal-devolucao').textContent = 'R$ ' + subtotal.toFixed(2).replace('.', ',');
      
      calcularTotalDevolucao();
    }

    function calcularTotalDevolucao() {
      let totalDevolucao = 0;
      
      document.querySelectorAll('.subtotal-devolucao').forEach(span => {
        const valor = parseFloat(span.textContent.replace('R$ ', '').replace(',', '.'));
        if (!isNaN(valor)) totalDevolucao += valor;
      });
      
      const valorRestante = valorOriginal - totalDevolucao;
      
      document.getElementById('totalDevolucao').textContent = 'R$ ' + totalDevolucao.toFixed(2).replace('.', ',');
      document.getElementById('valorDevolucaoResumo').textContent = 'R$ ' + totalDevolucao.toFixed(2).replace('.', ',');
      document.getElementById('valorRestante').textContent = 'R$ ' + valorRestante.toFixed(2).replace('.', ',');
    }

    function verificarBotaoProcessar() {
      const algumSelecionado = document.querySelectorAll('.item-checkbox:checked').length > 0;
      const motivo = document.getElementById('motivo').value;
      const tipoReembolso = document.getElementById('tipoReembolso').value;
      
      const btnProcessar = document.getElementById('btnProcessarDevolucao');
      btnProcessar.disabled = !(algumSelecionado && motivo && tipoReembolso);
    }

    // Event listeners
    document.getElementById('motivo').addEventListener('change', verificarBotaoProcessar);
    document.getElementById('tipoReembolso').addEventListener('change', verificarBotaoProcessar);

    // Validação antes do envio
    document.querySelector('form').addEventListener('submit', function(e) {
      const itensSelecionados = document.querySelectorAll('.item-checkbox:checked').length;
      
      if (itensSelecionados === 0) {
        e.preventDefault();
        alert('Selecione pelo menos um item para devolução.');
        return;
      }
      
      if (!confirm('Confirma o processamento desta devolução? Esta ação não poderá ser desfeita.')) {
        e.preventDefault();
      }
    });

    // Inicializar cálculos
    document.addEventListener('DOMContentLoaded', function() {
      calcularTotalDevolucao();
    });
  </script>
</body>

</html>