<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Histórico de Vendas do Cliente - Painel do CEO</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
  <link href="/css/notifications.css" rel="stylesheet">
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <div class="container-fluid">
          <!-- Header da Página -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="display-6 fw-bold text-dark mb-0">
                    <i class="fas fa-user-clock me-2"></i>Histórico de Vendas
                  </h1>
                  <p class="text-muted mb-0" th:text="'Cliente: ' + ${cliente.nome}">Cliente: Nome do Cliente</p>
                </div>
                <div>
                  <a th:href="@{/vendas}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Informações do Cliente -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informações do Cliente</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div class="col-md-3">
                      <p><strong>Nome:</strong> <span th:text="${cliente.nome}">Nome do Cliente</span></p>
                      <p><strong>CPF/CNPJ:</strong> <span th:text="${cliente.cpfCnpj}">000.000.000-00</span></p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Email:</strong> <span th:text="${cliente.email ?: 'Não informado'}">email@exemplo.com</span></p>
                      <p><strong>Telefone:</strong> <span th:text="${cliente.telefone ?: 'Não informado'}">(11) 99999-9999</span></p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Tipo:</strong> <span th:text="${cliente.tipoCliente}">Pessoa Física</span></p>
                      <p><strong>Status:</strong> 
                        <span class="badge" th:classappend="${cliente.ativo} ? 'bg-success' : 'bg-danger'" 
                              th:text="${cliente.ativo} ? 'Ativo' : 'Inativo'">Ativo</span>
                      </p>
                    </div>
                    <div class="col-md-3">
                      <p><strong>Cliente desde:</strong> <span th:text="${#temporals.format(cliente.dataCadastro, 'dd/MM/yyyy')}">01/01/2024</span></p>
                      <p><strong>Última compra:</strong> <span th:text="${ultimaCompra != null ? #temporals.format(ultimaCompra, 'dd/MM/yyyy') : 'Nenhuma compra'}">01/01/2024</span></p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Estatísticas do Cliente -->
          <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card bg-primary text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1 opacity-75">Total de Vendas</h6>
                      <h3 class="mb-0 fw-bold" th:text="${totalVendas}">0</h3>
                    </div>
                    <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card bg-success text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1 opacity-75">Valor Total Gasto</h6>
                      <h3 class="mb-0 fw-bold" th:text="'R$ ' + ${#numbers.formatDecimal(valorTotalGasto, 1, 2)}">R$ 0,00</h3>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1 opacity-75">Ticket Médio</h6>
                      <h3 class="mb-0 fw-bold" th:text="'R$ ' + ${#numbers.formatDecimal(ticketMedio, 1, 2)}">R$ 0,00</h3>
                    </div>
                    <i class="fas fa-chart-line fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
              <div class="card bg-warning text-dark">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h6 class="mb-1 opacity-75">Produtos Únicos</h6>
                      <h3 class="mb-0 fw-bold" th:text="${produtosUnicos}">0</h3>
                    </div>
                    <i class="fas fa-boxes fa-2x opacity-75"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filtros -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-light">
                  <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
                </div>
                <div class="card-body">
                  <form method="get" class="row g-3">
                    <input type="hidden" name="clienteId" th:value="${cliente.id}">
                    <div class="col-md-3">
                      <label for="dataInicio" class="form-label">Data Início</label>
                      <input type="date" class="form-control" id="dataInicio" name="dataInicio" th:value="${dataInicio}">
                    </div>
                    <div class="col-md-3">
                      <label for="dataFim" class="form-label">Data Fim</label>
                      <input type="date" class="form-control" id="dataFim" name="dataFim" th:value="${dataFim}">
                    </div>
                    <div class="col-md-3">
                      <label for="status" class="form-label">Status</label>
                      <select class="form-select" id="status" name="status">
                        <option value="">Todos</option>
                        <option value="Finalizada" th:selected="${status == 'Finalizada'}">Finalizada</option>
                        <option value="Pendente" th:selected="${status == 'Pendente'}">Pendente</option>
                        <option value="Cancelada" th:selected="${status == 'Cancelada'}">Cancelada</option>
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label for="ordenacao" class="form-label">Ordenar por</label>
                      <select class="form-select" id="ordenacao" name="ordenacao">
                        <option value="data_desc" th:selected="${ordenacao == 'data_desc'}">Data (Mais recente)</option>
                        <option value="data_asc" th:selected="${ordenacao == 'data_asc'}">Data (Mais antiga)</option>
                        <option value="valor_desc" th:selected="${ordenacao == 'valor_desc'}">Valor (Maior)</option>
                        <option value="valor_asc" th:selected="${ordenacao == 'valor_asc'}">Valor (Menor)</option>
                      </select>
                    </div>
                    <div class="col-12">
                      <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search"></i> Filtrar
                      </button>
                      <a th:href="@{'/vendas/historico-cliente/' + ${cliente.id}}" class="btn btn-outline-secondary">
                        <i class="fas fa-eraser"></i> Limpar
                      </a>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Lista de Vendas -->
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                  <h5 class="mb-0"><i class="fas fa-list me-2"></i>Histórico de Vendas</h5>
                  <span class="badge bg-light text-dark" th:text="${#lists.size(vendas)} + ' vendas encontradas'">0 vendas encontradas</span>
                </div>
                <div class="card-body">
                  <div th:if="${vendas.isEmpty()}" class="text-center py-5">
                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhuma venda encontrada</h5>
                    <p class="text-muted">Este cliente ainda não realizou nenhuma compra ou não há vendas no período selecionado.</p>
                  </div>
                  
                  <div th:if="${!vendas.isEmpty()}" class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead class="table-dark">
                        <tr>
                          <th>Número</th>
                          <th>Data</th>
                          <th>Itens</th>
                          <th>Forma Pagamento</th>
                          <th class="text-end">Total</th>
                          <th>Status</th>
                          <th class="text-center">Ações</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr th:each="venda : ${vendas}">
                          <td>
                            <strong th:text="${venda.numeroVenda}">000001</strong>
                          </td>
                          <td>
                            <span th:text="${#temporals.format(venda.dataVenda, 'dd/MM/yyyy')}">01/01/2024</span>
                            <br>
                            <small class="text-muted" th:text="${#temporals.format(venda.dataVenda, 'HH:mm')}">10:00</small>
                          </td>
                          <td>
                            <span class="badge bg-primary" th:text="${#lists.size(venda.itens)} + ' itens'">1 itens</span>
                            <br>
                            <small class="text-muted" th:if="${#lists.size(venda.itens) > 0}" 
                                   th:text="${venda.itens[0].produto.nome + (venda.itens.size() > 1 ? ' e mais...' : '')}">Produto</small>
                          </td>
                          <td>
                            <span th:text="${venda.formaPagamento}">Dinheiro</span>
                            <span th:if="${venda.parcelas != null and venda.parcelas > 1}" 
                                  class="badge bg-info ms-1" th:text="${venda.parcelas} + 'x'">2x</span>
                          </td>
                          <td class="text-end">
                            <strong class="text-success" th:text="'R$ ' + ${#numbers.formatDecimal(venda.total, 1, 2)}">R$ 0,00</strong>
                          </td>
                          <td>
                            <span class="badge" 
                                  th:classappend="${venda.status == 'Finalizada'} ? 'bg-success' : (${venda.status == 'Pendente'} ? 'bg-warning' : 'bg-danger')" 
                                  th:text="${venda.status}">Finalizada</span>
                          </td>
                          <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                              <a th:href="@{'/vendas/' + ${venda.id}}" class="btn btn-outline-primary" title="Ver Detalhes">
                                <i class="fas fa-eye"></i>
                              </a>
                              <a th:href="@{'/vendas/' + ${venda.id} + '/pdf'}" class="btn btn-outline-secondary" title="Gerar PDF" target="_blank">
                                <i class="fas fa-file-pdf"></i>
                              </a>
                              <a th:if="${venda.status == 'Finalizada'}" th:href="@{'/vendas/' + ${venda.id} + '/devolucao'}" 
                                 class="btn btn-outline-danger" title="Devolução">
                                <i class="fas fa-undo"></i>
                              </a>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Produtos Mais Comprados -->
          <div class="row mt-4" th:if="${!produtosMaisComprados.isEmpty()}">
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-info text-white">
                  <h5 class="mb-0"><i class="fas fa-star me-2"></i>Produtos Mais Comprados</h5>
                </div>
                <div class="card-body">
                  <div class="row">
                    <div th:each="produto : ${produtosMaisComprados}" class="col-md-4 mb-3">
                      <div class="card border-info">
                        <div class="card-body text-center">
                          <h6 class="card-title" th:text="${produto.nome}">Nome do Produto</h6>
                          <p class="card-text">
                            <span class="badge bg-primary" th:text="'Qtd: ' + ${produto.quantidadeTotal}">Qtd: 5</span>
                            <br>
                            <small class="text-muted" th:text="'R$ ' + ${#numbers.formatDecimal(produto.valorTotal, 1, 2)}">R$ 100,00</small>
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/notifications.js}" defer></script>
  <script src="/js/sidebar.js" defer></script>

  <script>
    // Função para exportar dados do cliente
    function exportarDadosCliente() {
      const clienteId = [[${cliente.id}]];
      const dataInicio = document.getElementById('dataInicio').value;
      const dataFim = document.getElementById('dataFim').value;
      
      let url = `/vendas/historico-cliente/${clienteId}/exportar?`;
      if (dataInicio) url += `dataInicio=${dataInicio}&`;
      if (dataFim) url += `dataFim=${dataFim}&`;
      
      window.open(url, '_blank');
    }

    // Adicionar botão de exportar se houver vendas
    document.addEventListener('DOMContentLoaded', function() {
      const totalVendas = [[${#lists.size(vendas)}]];
      if (totalVendas > 0) {
        const cardHeader = document.querySelector('.card-header.bg-dark');
        const exportBtn = document.createElement('button');
        exportBtn.className = 'btn btn-outline-light btn-sm';
        exportBtn.innerHTML = '<i class="fas fa-download"></i> Exportar';
        exportBtn.onclick = exportarDadosCliente;
        cardHeader.appendChild(exportBtn);
      }
    });
  </script>
</body>

</html>