<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <title>PDV - Ponto de Venda - Painel do CEO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <style>
    .pdv-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .pdv-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .pdv-header {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .scanner-section {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      padding: 25px;
      color: white;
    }
    
    .scanner-input {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 15px;
      color: white;
      padding: 15px 20px;
      font-size: 18px;
      font-weight: 500;
    }
    
    .scanner-input::placeholder {
      color: rgba(255,255,255,0.8);
    }
    
    .scanner-input:focus {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.6);
      box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
      color: white;
    }
    
    .product-display {
      min-height: 400px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .product-item {
      border-bottom: 1px solid #e5e7eb;
      padding: 15px;
      transition: background-color 0.2s;
    }
    
    .product-item:hover {
      background-color: #f8fafc;
    }
    
    .product-item:last-child {
      border-bottom: none;
    }
    
    .product-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 5px;
    }
    
    .product-price {
      font-size: 18px;
      font-weight: 700;
      color: #059669;
    }
    
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .quantity-btn {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      transition: all 0.2s;
    }
    
    .quantity-btn:hover {
      transform: scale(1.1);
    }
    
    .quantity-input {
      width: 60px;
      text-align: center;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 5px;
      font-weight: 600;
    }
    
    .total-section {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    
    .total-amount {
      font-size: 48px;
      font-weight: 900;
      margin: 20px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .payment-section {
      padding: 25px;
    }
    
    .payment-method {
      border: 2px solid #e5e7eb;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .payment-method:hover {
      border-color: #3b82f6;
      background-color: #f8fafc;
    }
    
    .payment-method.selected {
      border-color: #3b82f6;
      background-color: #eff6ff;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .payment-icon {
      font-size: 24px;
      width: 40px;
      text-align: center;
    }
    
    .payment-details {
      flex-grow: 1;
    }
    
    .payment-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 5px;
    }
    
    .payment-description {
      color: #6b7280;
      font-size: 14px;
    }
    
    .installments-section {
      background: #f8fafc;
      border-radius: 15px;
      padding: 20px;
      margin-top: 15px;
      display: none;
    }
    
    .installment-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .installment-option:hover {
      border-color: #3b82f6;
      background-color: white;
    }
    
    .installment-option.selected {
      border-color: #3b82f6;
      background-color: #eff6ff;
    }
    
    .installment-text {
      font-weight: 600;
      color: #1f2937;
    }
    
    .installment-value {
      font-weight: 700;
      color: #059669;
    }
    
    .action-buttons {
      padding: 25px;
      display: flex;
      gap: 15px;
    }
    
    .btn-pdv {
      border-radius: 15px;
      padding: 15px 30px;
      font-weight: 600;
      font-size: 16px;
      border: none;
      transition: all 0.3s;
      flex: 1;
    }
    
    .btn-pdv:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .btn-cancel {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    .btn-clear {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
    }
    
    .btn-finish {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .empty-cart {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .empty-cart i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .customer-section {
      background: #f8fafc;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .customer-select {
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px 15px;
      font-size: 16px;
    }
    
    .customer-select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .receipt-modal .modal-content {
      border-radius: 20px;
      border: none;
    }
    
    .receipt-header {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
      color: white;
      padding: 25px;
      text-align: center;
      border-radius: 20px 20px 0 0;
    }
    
    .receipt-body {
      padding: 30px;
    }
    
    .receipt-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    
    .receipt-total {
      background: #f8fafc;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    
    @media (max-width: 768px) {
      .pdv-container {
        padding: 10px;
      }
      
      .total-amount {
        font-size: 36px;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <div class="container-fluid">
      <div class="row">
        <!-- Coluna Esquerda - Scanner e Produtos -->
        <div class="col-lg-8">
          <!-- Header PDV -->
          <div class="pdv-card">
            <div class="pdv-header">
              <h1><i class="fas fa-cash-register me-3"></i>PDV - Ponto de Venda</h1>
              <p class="mb-0">Sistema de Vendas Rápido e Eficiente</p>
            </div>
          </div>

          <!-- Scanner de Produtos -->
          <div class="pdv-card">
            <div class="scanner-section">
              <h4 class="mb-3">
                <i class="fas fa-barcode me-2"></i>Scanner de Produtos
              </h4>
              <div class="input-group">
                <span class="input-group-text bg-transparent border-0 text-white">
                  <i class="fas fa-search"></i>
                </span>
                <input type="text" id="eanScanner" class="form-control scanner-input" 
                        placeholder="Digite ou escaneie o código EAN..." autocomplete="off" />
                <button type="button" id="btnAddProduct" class="btn btn-light btn-pdv ms-3">
                  <i class="fas fa-plus me-2"></i>Adicionar
                </button>
              </div>
            </div>
          </div>

          <!-- Lista de Produtos -->
          <div class="pdv-card">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="fas fa-shopping-cart me-2"></i>Produtos no Carrinho
                <span class="badge bg-primary ms-2" id="itemCount">0</span>
              </h5>
            </div>
            <div class="product-display" id="productList">
              <div class="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <h5>Carrinho Vazio</h5>
                <p>Escaneie ou digite o código EAN para adicionar produtos</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Coluna Direita - Total e Pagamento -->
        <div class="col-lg-4">
          <!-- Seleção de Cliente -->
          <div class="pdv-card">
            <div class="customer-section">
              <h6 class="mb-3">
                <i class="fas fa-user me-2"></i>Cliente
              </h6>
              <select id="customerSelect" class="form-select customer-select">
                <option value="">Cliente Avulso</option>
                <option th:each="cliente : ${clientes}" th:value="${cliente.id}" th:text="${cliente.nome}"></option>
              </select>
            </div>
          </div>

          <!-- Total da Venda -->
          <div class="pdv-card">
            <div class="total-section">
              <h4><i class="fas fa-calculator me-2"></i>Total da Venda</h4>
              <div class="total-amount" id="totalAmount">R$ 0,00</div>
              <div class="d-flex justify-content-between">
                <span>Itens: <strong id="totalItems">0</strong></span>
                <span>Qtd: <strong id="totalQuantity">0</strong></span>
              </div>
            </div>
          </div>

          <!-- Status do Caixa -->
          <div class="pdv-card" th:if="${caixaAberto == null}">
            <div class="alert alert-warning text-center">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Caixa Fechado</strong><br>
              <small>É necessário abrir o caixa para realizar vendas</small>
              <br><br>
              <button class="btn btn-warning btn-sm" onclick="abrirCaixa()">
                <i class="fas fa-cash-register me-2"></i>Abrir Caixa
              </button>
            </div>
          </div>
          
          <div class="pdv-card" th:if="${caixaAberto != null}">
            <div class="alert alert-success text-center">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Caixa Aberto</strong><br>
              <small th:text="'Valor inicial: R$ ' + ${#numbers.formatDecimal(caixaAberto.valorInicial, 1, 2)}"></small>
            </div>
          </div>

          <!-- Formas de Pagamento -->
          <div class="pdv-card">
            <div class="payment-section">
              <h5 class="mb-4">
                <i class="fas fa-credit-card me-2"></i>Forma de Pagamento
              </h5>
              
              <div id="paymentMethods">
                <!-- Formas de pagamento serão carregadas dinamicamente -->
              </div>

              <!-- Seção de Parcelas (aparece apenas para cartão de crédito) -->
              <div class="installments-section" id="installmentsSection">
                <h6 class="mb-3">
                  <i class="fas fa-calendar-alt me-2"></i>Parcelas
                </h6>
                <div id="installmentOptions">
                  <!-- Opções de parcelas serão geradas dinamicamente -->
                </div>
              </div>
            </div>
          </div>

          <!-- Botões de Ação -->
          <div class="pdv-card">
            <div class="action-buttons">
              <button type="button" class="btn btn-pdv btn-cancel" onclick="cancelSale()">
                <i class="fas fa-times me-2"></i>Cancelar
              </button>
              <button type="button" class="btn btn-pdv btn-clear" onclick="clearCart()">
                <i class="fas fa-trash me-2"></i>Limpar
              </button>
              <button type="button" class="btn btn-pdv btn-finish" onclick="finishSale()" disabled>
                <i class="fas fa-check me-2"></i>Finalizar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
        </div>
      </section>
      
      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <!-- Modal de Comprovante -->
  <div class="modal fade" id="receiptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content receipt-modal">
        <div class="receipt-header">
          <h4><i class="fas fa-receipt me-2"></i>Comprovante de Venda</h4>
          <p class="mb-0">Venda realizada com sucesso!</p>
        </div>
        <div class="receipt-body" id="receiptContent">
          <!-- Conteúdo do comprovante será gerado dinamicamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="window.location.href='/vendas'">
            <i class="fas fa-times me-2"></i>Fechar
          </button>
          <button type="button" class="btn btn-primary" onclick="printReceipt()">
            <i class="fas fa-print me-2"></i>Imprimir
          </button>
          <button type="button" class="btn btn-success" onclick="newSale()">
            <i class="fas fa-plus me-2"></i>Nova Venda
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variáveis globais
    let cart = [];
    let selectedPayment = null;
    let selectedPaymentId = null;
    let selectedInstallments = 1;
    let totalAmount = 0;
    let paymentMethods = [];
    let caixaAberto = false;

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      loadPaymentMethods();
      checkCaixaStatus();
      updateDisplay();
    });

    function setupEventListeners() {
      // Scanner de produtos
      document.getElementById('eanScanner').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          addProductByEAN();
        }
      });

      document.getElementById('btnAddProduct').addEventListener('click', addProductByEAN);
    }
    
    async function loadPaymentMethods() {
      try {
        console.log('Carregando formas de pagamento...');
        const response = await fetch('/vendas/api/formas-pagamento');
        console.log('Response status:', response.status);
        if (response.ok) {
          paymentMethods = await response.json();
          console.log('Formas de pagamento carregadas:', paymentMethods);
          renderPaymentMethods();
        } else {
          console.error('Erro na resposta:', response.status, response.statusText);
        }
      } catch (error) {
        console.error('Erro ao carregar formas de pagamento:', error);
      }
    }
    
    function renderPaymentMethods() {
      const container = document.getElementById('paymentMethods');
      console.log('Renderizando formas de pagamento. Container:', container);
      console.log('Métodos de pagamento:', paymentMethods);
      
      if (!paymentMethods || paymentMethods.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Nenhuma forma de pagamento encontrada</div>';
        return;
      }
      
      container.innerHTML = paymentMethods.map(method => {
        const icon = getPaymentIcon(method.nome);
        return `
          <div class="payment-method" data-payment="${method.id}" data-payment-name="${method.nome}" data-accepts-installments="${method.aceitaParcelas}" data-max-installments="${method.maxParcelas}">
            <div class="payment-icon ${getPaymentIconColor(method.nome)}">
              <i class="${icon}"></i>
            </div>
            <div class="payment-details">
              <div class="payment-name">${method.nome}</div>
              <div class="payment-description">${method.descricao || 'Forma de pagamento'}</div>
            </div>
          </div>
        `;
      }).join('');
      
      console.log('HTML gerado:', container.innerHTML);
      
      // Adicionar event listeners
      document.querySelectorAll('.payment-method').forEach(method => {
        method.addEventListener('click', function() {
          selectPaymentMethod(this.dataset.payment, this.dataset.paymentName, this.dataset.acceptsInstallments === 'true', parseInt(this.dataset.maxInstallments));
        });
      });
    }
    
    function getPaymentIcon(paymentName) {
      const name = paymentName.toLowerCase();
      if (name.includes('dinheiro')) return 'fas fa-money-bill-wave';
      if (name.includes('pix')) return 'fas fa-qrcode';
      if (name.includes('débito') || name.includes('debito')) return 'fas fa-credit-card';
      if (name.includes('crédito') || name.includes('credito')) return 'fas fa-credit-card';
      if (name.includes('cartão') || name.includes('cartao')) return 'fas fa-credit-card';
      return 'fas fa-money-bill';
    }
    
    function getPaymentIconColor(paymentName) {
      const name = paymentName.toLowerCase();
      if (name.includes('dinheiro')) return 'text-success';
      if (name.includes('pix')) return 'text-primary';
      if (name.includes('débito') || name.includes('debito')) return 'text-info';
      if (name.includes('crédito') || name.includes('credito')) return 'text-warning';
      return 'text-secondary';
    }
    
    async function checkCaixaStatus() {
      try {
        const response = await fetch('/vendas/api/resumo-dia');
        if (response.ok) {
          caixaAberto = true;
        } else {
          caixaAberto = false;
        }
      } catch (error) {
        console.error('Erro ao verificar status do caixa:', error);
        caixaAberto = false;
      }
    }
    
    async function abrirCaixa() {
      const valorInicial = prompt('Digite o valor inicial do caixa (R$):');
      if (!valorInicial || isNaN(valorInicial)) {
        alert('Valor inválido!');
        return;
      }
      
      try {
        const response = await fetch('/vendas/api/caixa/abrir', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: `valorInicial=${valorInicial}`
        });
        
        const result = await response.json();
        
        if (result.sucesso) {
          alert('Caixa aberto com sucesso!');
          location.reload();
        } else {
          alert('Erro ao abrir caixa: ' + result.mensagem);
        }
      } catch (error) {
        console.error('Erro ao abrir caixa:', error);
        alert('Erro ao abrir caixa. Tente novamente.');
      }
    }

    async function addProductByEAN() {
      const ean = document.getElementById('eanScanner').value.trim();
      
      if (!ean) {
        alert('Digite o código EAN do produto');
        return;
      }

      try {
        const response = await fetch(`/vendas/api/produto/${ean}`);
        if (!response.ok) {
          alert('Produto não encontrado!');
          document.getElementById('eanScanner').value = '';
          return;
        }

        const product = await response.json();
        
        // Verificar se produto já está no carrinho
        const existingItem = cart.find(item => item.ean === ean);
        if (existingItem) {
          existingItem.quantity += 1;
          existingItem.subtotal = existingItem.quantity * existingItem.price;
        } else {
          cart.push({
            ean: ean,
            name: product.nome,
            price: product.preco,
            quantity: 1,
            subtotal: product.preco
          });
        }

        document.getElementById('eanScanner').value = '';
        updateDisplay();
      } catch (error) {
        console.error('Erro ao buscar produto:', error);
        alert('Erro ao buscar produto. Tente novamente.');
        document.getElementById('eanScanner').value = '';
      }
    }

    function updateQuantity(ean, change) {
      const item = cart.find(item => item.ean === ean);
      if (item) {
        item.quantity += change;
        if (item.quantity <= 0) {
          removeItem(ean);
        } else {
          item.subtotal = item.quantity * item.price;
          updateDisplay();
        }
      }
    }

    function removeItem(ean) {
      cart = cart.filter(item => item.ean !== ean);
      updateDisplay();
    }

    function updateDisplay() {
      updateProductList();
      updateTotals();
      updateFinishButton();
    }

    function updateProductList() {
      const productList = document.getElementById('productList');
      
      if (cart.length === 0) {
        productList.innerHTML = `
          <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <h5>Carrinho Vazio</h5>
            <p>Escaneie ou digite o código EAN para adicionar produtos</p>
          </div>
        `;
        return;
      }

      productList.innerHTML = cart.map(item => `
        <div class="product-item">
          <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
              <div class="product-name">${item.name}</div>
              <div class="text-muted small">EAN: ${item.ean}</div>
              <div class="product-price">R$ ${item.price.toFixed(2)}</div>
            </div>
            <div class="quantity-controls">
              <button class="btn btn-outline-danger quantity-btn" onclick="updateQuantity('${item.ean}', -1)">
                <i class="fas fa-minus"></i>
              </button>
              <input type="number" class="form-control quantity-input" value="${item.quantity}" 
                     onchange="setQuantity('${item.ean}', this.value)" min="1">
              <button class="btn btn-outline-success quantity-btn" onclick="updateQuantity('${item.ean}', 1)">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="text-end ms-3">
              <div class="fw-bold">R$ ${item.subtotal.toFixed(2)}</div>
              <button class="btn btn-sm btn-outline-danger" onclick="removeItem('${item.ean}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function setQuantity(ean, quantity) {
      const item = cart.find(item => item.ean === ean);
      if (item) {
        const newQuantity = parseInt(quantity);
        if (newQuantity > 0) {
          item.quantity = newQuantity;
          item.subtotal = item.quantity * item.price;
          updateDisplay();
        } else {
          removeItem(ean);
        }
      }
    }

    function updateTotals() {
      totalAmount = cart.reduce((sum, item) => sum + item.subtotal, 0);
      const totalItems = cart.length;
      const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);

      document.getElementById('totalAmount').textContent = `R$ ${totalAmount.toFixed(2)}`;
      document.getElementById('totalItems').textContent = totalItems;
      document.getElementById('totalQuantity').textContent = totalQuantity;
      document.getElementById('itemCount').textContent = totalItems;
    }

    function selectPaymentMethod(paymentId, paymentName, acceptsInstallments, maxInstallments) {
      // Remover seleção anterior
      document.querySelectorAll('.payment-method').forEach(method => {
        method.classList.remove('selected');
      });

      // Selecionar novo método
      document.querySelector(`[data-payment="${paymentId}"]`).classList.add('selected');
      selectedPaymentId = paymentId;
      selectedPayment = paymentName;

      // Mostrar/ocultar seção de parcelas
      const installmentsSection = document.getElementById('installmentsSection');
      if (acceptsInstallments && maxInstallments > 1) {
        installmentsSection.style.display = 'block';
        generateInstallmentOptions(maxInstallments);
      } else {
        installmentsSection.style.display = 'none';
        selectedInstallments = 1;
      }

      updateFinishButton();
    }

    function generateInstallmentOptions(maxInstallments) {
      const installmentOptions = document.getElementById('installmentOptions');
      const maxAllowed = Math.min(maxInstallments, Math.floor(totalAmount / 10)); // Mínimo R$ 10 por parcela
      
      let optionsHTML = '';
      for (let i = 1; i <= maxAllowed; i++) {
        const installmentValue = totalAmount / i;
        const isSelected = i === selectedInstallments ? 'selected' : '';
        
        optionsHTML += `
          <div class="installment-option ${isSelected}" onclick="selectInstallments(${i})">
            <span class="installment-text">${i}x sem juros</span>
            <span class="installment-value">R$ ${installmentValue.toFixed(2)}</span>
          </div>
        `;
      }
      
      installmentOptions.innerHTML = optionsHTML;
    }

    function selectInstallments(installments) {
      document.querySelectorAll('.installment-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      event.target.closest('.installment-option').classList.add('selected');
      selectedInstallments = installments;
    }

    function updateFinishButton() {
      const finishButton = document.querySelector('.btn-finish');
      const canFinish = cart.length > 0 && selectedPayment;
      finishButton.disabled = !canFinish;
    }

    function clearCart() {
      if (cart.length > 0 && confirm('Deseja limpar todos os produtos do carrinho?')) {
        cart = [];
        updateDisplay();
      }
    }

    function cancelSale() {
      if (confirm('Deseja cancelar a venda atual?')) {
        // Redirecionar para a lista de vendas
        window.location.href = '/vendas';
      }
    }

    async function finishSale() {
      if (cart.length === 0) {
        alert('Adicione produtos ao carrinho antes de finalizar a venda');
        return;
      }

      if (!selectedPayment) {
        alert('Selecione uma forma de pagamento');
        return;
      }
      
      if (!caixaAberto) {
        alert('É necessário abrir o caixa antes de realizar vendas');
        return;
      }

      // Preparar dados para envio
      const saleData = {
        clienteId: document.getElementById('customerSelect').value || null,
        formaPagamentoId: selectedPaymentId,
        formaPagamento: selectedPayment,
        parcelas: selectedInstallments,
        valorTotal: totalAmount,
        itens: cart.map(item => ({
          ean: item.ean,
          quantidade: item.quantity,
          precoUnitario: item.price
        }))
      };

      try {
        // Desabilitar botão durante processamento
        const finishButton = document.querySelector('.btn-finish');
        finishButton.disabled = true;
        finishButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';

        // Fazer chamada para o backend
        const response = await fetch('/vendas/api/processar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(saleData)
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText);
        }

        const result = await response.json();
        
        // Mostrar comprovante com dados reais
        const receiptData = {
          id: result.id,
          items: cart,
          total: totalAmount,
          payment: selectedPayment,
          installments: selectedInstallments,
          customer: document.getElementById('customerSelect').value,
          date: new Date().toLocaleString('pt-BR')
        };
        
        showReceipt(receiptData);
        
        // Limpar carrinho após venda
        cart = [];
        updateDisplay();
        
        // Resetar seleções de pagamento
        selectedPayment = null;
        selectedInstallments = 1;
        document.querySelectorAll('.payment-method').forEach(method => {
          method.classList.remove('selected');
        });
        document.getElementById('installmentsSection').style.display = 'none';
        document.getElementById('customerSelect').value = '';
        
      } catch (error) {
        console.error('Erro ao processar venda:', error);
        alert('Erro ao processar venda: ' + error.message);
      } finally {
        // Reabilitar botão
        const finishButton = document.querySelector('.btn-finish');
        finishButton.disabled = false;
        finishButton.innerHTML = '<i class="fas fa-check me-2"></i>Finalizar';
      }
    }

    function getPaymentMethodName(payment) {
      switch(payment) {
        case 'dinheiro': return 'Dinheiro';
        case 'pix': return 'PIX';
        case 'debito': return 'Cartão de Débito';
        case 'credito': return 'Cartão de Crédito';
        default: return 'Não informado';
      }
    }

    function showReceipt(saleData) {
      const receiptContent = document.getElementById('receiptContent');
      
      let paymentText = '';
      switch(saleData.payment) {
        case 'dinheiro': paymentText = 'Dinheiro'; break;
        case 'pix': paymentText = 'PIX'; break;
        case 'debito': paymentText = 'Cartão de Débito'; break;
        case 'credito': 
          paymentText = `Cartão de Crédito - ${saleData.installments}x de R$ ${(saleData.total / saleData.installments).toFixed(2)}`;
          break;
      }

      receiptContent.innerHTML = `
        <div class="text-center mb-4">
          <h5>Painel do CEO</h5>
          <p class="text-muted">Sistema ERP Corporativo</p>
          <hr>
        </div>
        
        <div class="mb-3">
          <strong>Data:</strong> ${saleData.date}<br>
          <strong>Cliente:</strong> ${saleData.customer || 'Cliente Avulso'}<br>
          <strong>Forma de Pagamento:</strong> ${paymentText}
        </div>
        
        <hr>
        
        <div class="mb-3">
          ${saleData.items.map(item => `
            <div class="receipt-item">
              <div>
                <strong>${item.name}</strong><br>
                <small>${item.quantity}x R$ ${item.price.toFixed(2)}</small>
              </div>
              <div class="text-end">
                <strong>R$ ${item.subtotal.toFixed(2)}</strong>
              </div>
            </div>
          `).join('')}
        </div>
        
        <div class="receipt-total">
          <div class="d-flex justify-content-between">
            <strong>TOTAL:</strong>
            <strong class="fs-4">R$ ${saleData.total.toFixed(2)}</strong>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <p class="text-muted">Obrigado pela preferência!</p>
        </div>
      `;

      const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
      modal.show();
    }

    function printReceipt() {
      window.print();
    }

    function newSale() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('receiptModal'));
      modal.hide();
      
      // Limpar tudo para nova venda
      cart = [];
      selectedPayment = null;
      selectedInstallments = 1;
      document.querySelectorAll('.payment-method').forEach(method => {
        method.classList.remove('selected');
      });
      document.getElementById('installmentsSection').style.display = 'none';
      document.getElementById('customerSelect').value = '';
      updateDisplay();
      
      // Focar no scanner
      document.getElementById('eanScanner').focus();
    }

    // Focar no scanner ao carregar a página
    window.addEventListener('load', function() {
      setTimeout(() => {
        document.getElementById('eanScanner').focus();
      }, 100);
    });
    
    // Manter foco no scanner
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.modal') && !e.target.closest('button') && !e.target.closest('select')) {
        setTimeout(() => {
          document.getElementById('eanScanner').focus();
        }, 10);
      }
    });
  </script>
  <!-- Scripts para notificações -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</body>
</html>