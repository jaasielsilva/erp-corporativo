<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Evento - Agenda - ERP Corporativo</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Tempus Dominus CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.7/dist/css/tempus-dominus.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link th:href="@{/css/agenda.css}" rel="stylesheet">

    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="~{components/sidebar :: sidebar}"></div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div th:replace="~{components/topbar :: topbar}"></div>
        
        <!-- Page Content -->
        <div class="container-fluid p-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-0 text-gray-800">
                                <i class="fas fa-plus-circle me-2"></i>Novo Evento
                            </h1>
                            <p class="text-muted mb-0">Crie um novo evento na sua agenda</p>
                        </div>
                        <div>
                            <a th:href="@{/agenda}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Voltar à Agenda
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Alert Messages -->
            <div th:if="${mensagem}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${mensagem}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:text="${erro}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <!-- Form Card -->
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-calendar-plus me-2"></i>Informações do Evento
                            </h6>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/agenda/novo-evento}" method="post" th:object="${evento}" id="formNovoEvento">
                                <div class="row">
                                    <!-- Título -->
                                    <div class="col-md-8 mb-3">
                                        <label for="titulo" class="form-label">
                                            <i class="fas fa-heading me-1"></i>Título do Evento *
                                        </label>
                                        <input type="text" class="form-control" id="titulo" th:field="*{titulo}" 
                                               placeholder="Digite o título do evento" required maxlength="100">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('titulo')}" th:errors="*{titulo}"></div>
                                    </div>
                                    
                                    <!-- Prioridade -->
                                    <div class="col-md-4 mb-3">
                                        <label for="prioridade" class="form-label">
                                            <i class="fas fa-flag me-1"></i>Prioridade
                                        </label>
                                        <select class="form-select" id="prioridade" th:field="*{prioridade}">
                                            <option value="BAIXA">Baixa</option>
                                            <option value="MEDIA" selected>Média</option>
                                            <option value="ALTA">Alta</option>
                                            <option value="URGENTE">Urgente</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <!-- Data de Início -->
                                    <div class="col-md-6 mb-3">
                                        <label for="dataInicio" class="form-label">
                                            <i class="fas fa-calendar me-1"></i>Data e Hora de Início *
                                        </label>
                                        <div class="input-group" id="datetimepicker1" data-td-target-input="nearest" data-td-target-toggle="nearest">
                                            <input type="datetime-local" class="form-control" id="dataInicio" th:field="*{dataInicio}" 
                                                   data-td-target="#datetimepicker1" required>
                                            <span class="input-group-text" data-td-target="#datetimepicker1" data-td-toggle="datetimepicker">
                                                <i class="fas fa-calendar"></i>
                                            </span>
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('dataInicio')}" th:errors="*{dataInicio}"></div>
                                    </div>
                                    
                                    <!-- Data de Fim -->
                                    <div class="col-md-6 mb-3">
                                        <label for="dataFim" class="form-label">
                                            <i class="fas fa-calendar-check me-1"></i>Data e Hora de Fim
                                        </label>
                                        <div class="input-group" id="datetimepicker2" data-td-target-input="nearest" data-td-target-toggle="nearest">
                                            <input type="datetime-local" class="form-control" id="dataFim" th:field="*{dataFim}" 
                                                   data-td-target="#datetimepicker2">
                                            <span class="input-group-text" data-td-target="#datetimepicker2" data-td-toggle="datetimepicker">
                                                <i class="fas fa-calendar"></i>
                                            </span>
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('dataFim')}" th:errors="*{dataFim}"></div>
                                    </div>
                                </div>
                                
                                <!-- Descrição -->
                                <div class="mb-3">
                                    <label for="descricao" class="form-label">
                                        <i class="fas fa-align-left me-1"></i>Descrição
                                    </label>
                                    <textarea class="form-control" id="descricao" th:field="*{descricao}" rows="4" 
                                              placeholder="Descreva os detalhes do evento" maxlength="500"></textarea>
                                    <div class="form-text">Máximo 500 caracteres</div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('descricao')}" th:errors="*{descricao}"></div>
                                </div>
                                
                                <div class="row">
                                    <!-- Local -->
                                    <div class="col-md-6 mb-3">
                                        <label for="local" class="form-label">
                                            <i class="fas fa-map-marker-alt me-1"></i>Local
                                        </label>
                                        <input type="text" class="form-control" id="local" th:field="*{local}" 
                                               placeholder="Local do evento" maxlength="100">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('local')}" th:errors="*{local}"></div>
                                    </div>
                                    
                                    <!-- Categoria -->
                                    <div class="col-md-6 mb-3">
                                        <label for="categoria" class="form-label">
                                            <i class="fas fa-tags me-1"></i>Categoria
                                        </label>
                                        <select class="form-select" id="categoria" th:field="*{categoria}">
                                            <option value="">Selecione uma categoria</option>
                                            <option value="REUNIAO">Reunião</option>
                                            <option value="COMPROMISSO">Compromisso</option>
                                            <option value="EVENTO">Evento</option>
                                            <option value="TAREFA">Tarefa</option>
                                            <option value="LEMBRETE">Lembrete</option>
                                            <option value="OUTRO">Outro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Configurações Adicionais -->
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-cogs me-2"></i>Configurações Adicionais
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <!-- Evento Dia Inteiro -->
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="diaInteiro" th:field="*{diaInteiro}">
                                                    <label class="form-check-label" for="diaInteiro">
                                                        <i class="fas fa-sun me-1"></i>Evento de dia inteiro
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Evento Recorrente -->
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="recorrente" th:field="*{recorrente}">
                                                    <label class="form-check-label" for="recorrente">
                                                        <i class="fas fa-redo me-1"></i>Evento recorrente
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <!-- Privado -->
                                            <div class="col-md-4 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="privado" th:field="*{privado}">
                                                    <label class="form-check-label" for="privado">
                                                        <i class="fas fa-lock me-1"></i>Evento privado
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Recorrência (mostrar apenas se recorrente estiver marcado) -->
                                        <div id="recorrenciaConfig" class="row" style="display: none;">
                                            <div class="col-md-6 mb-3">
                                                <label for="tipoRecorrencia" class="form-label">
                                                    <i class="fas fa-repeat me-1"></i>Tipo de Recorrência
                                                </label>
                                                <select class="form-select" id="tipoRecorrencia" th:field="*{tipoRecorrencia}">
                                                    <option value="DIARIA">Diária</option>
                                                    <option value="SEMANAL">Semanal</option>
                                                    <option value="MENSAL">Mensal</option>
                                                    <option value="ANUAL">Anual</option>
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-6 mb-3">
                                                <label for="dataFimRecorrencia" class="form-label">
                                                    <i class="fas fa-calendar-times me-1"></i>Fim da Recorrência
                                                </label>
                                                <input type="date" class="form-control" id="dataFimRecorrencia" th:field="*{dataFimRecorrencia}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lembretes -->
                                <div class="card mt-4">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-bell me-2"></i>Lembretes
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete15min" name="lembretes" value="15">
                                                    <label class="form-check-label" for="lembrete15min">
                                                        15 minutos antes
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete30min" name="lembretes" value="30">
                                                    <label class="form-check-label" for="lembrete30min">
                                                        30 minutos antes
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete1h" name="lembretes" value="60">
                                                    <label class="form-check-label" for="lembrete1h">
                                                        1 hora antes
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembrete1dia" name="lembretes" value="1440">
                                                    <label class="form-check-label" for="lembrete1dia">
                                                        1 dia antes
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="lembreteEmail" th:field="*{lembreteEmail}">
                                                    <label class="form-check-label" for="lembreteEmail">
                                                        <i class="fas fa-envelope me-1"></i>Enviar por e-mail
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Botões de Ação -->
                                <div class="d-flex justify-content-between mt-4">
                                    <div>
                                        <a th:href="@{/agenda}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times me-1"></i>Cancelar
                                        </a>
                                    </div>
                                    <div>
                                        <button type="button" class="btn btn-outline-primary me-2" onclick="salvarRascunho()">
                                            <i class="fas fa-save me-1"></i>Salvar Rascunho
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-check me-1"></i>Criar Evento
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div th:replace="~{components/footer :: footer}"></div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.7.7/dist/js/tempus-dominus.min.js"></script>
    

    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script>
        $(document).ready(function() {
            // Configurar data/hora padrão
            const agora = new Date();
            const dataAtual = agora.toISOString().slice(0, 16);
            
            if (!$('#dataInicio').val()) {
                $('#dataInicio').val(dataAtual);
            }
            
            // Configurar data fim automaticamente (1 hora depois)
            $('#dataInicio').on('change', function() {
                const dataInicio = new Date($(this).val());
                if (dataInicio) {
                    const dataFim = new Date(dataInicio.getTime() + 60 * 60 * 1000); // +1 hora
                    $('#dataFim').val(dataFim.toISOString().slice(0, 16));
                }
            });
            
            // Mostrar/ocultar configurações de recorrência
            $('#recorrente').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#recorrenciaConfig').show();
                } else {
                    $('#recorrenciaConfig').hide();
                }
            });
            
            // Configurar evento de dia inteiro
            $('#diaInteiro').on('change', function() {
                if ($(this).is(':checked')) {
                    // Definir horários para dia inteiro
                    const dataInicio = new Date($('#dataInicio').val());
                    dataInicio.setHours(0, 0, 0, 0);
                    $('#dataInicio').val(dataInicio.toISOString().slice(0, 16));
                    
                    const dataFim = new Date(dataInicio);
                    dataFim.setHours(23, 59, 59, 999);
                    $('#dataFim').val(dataFim.toISOString().slice(0, 16));
                    
                    // Desabilitar edição de horário
                    $('#dataInicio, #dataFim').prop('readonly', true);
                } else {
                    $('#dataInicio, #dataFim').prop('readonly', false);
                }
            });
            
            // Validação do formulário
            $('#formNovoEvento').on('submit', function(e) {
                const dataInicio = new Date($('#dataInicio').val());
                const dataFim = new Date($('#dataFim').val());
                
                if (dataFim && dataFim <= dataInicio) {
                    e.preventDefault();
                    alert('A data de fim deve ser posterior à data de início.');
                    return false;
                }
                
                // Adicionar lembretes selecionados ao formulário
                const lembretesSelecionados = [];
                $('input[name="lembretes"]:checked').each(function() {
                    lembretesSelecionados.push($(this).val());
                });
                
                if (lembretesSelecionados.length > 0) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'lembretesMinutos',
                        value: lembretesSelecionados.join(',')
                    }).appendTo('#formNovoEvento');
                }
            });
            
            // Contador de caracteres para descrição
            $('#descricao').on('input', function() {
                const maxLength = 500;
                const currentLength = $(this).val().length;
                const remaining = maxLength - currentLength;
                
                $(this).siblings('.form-text').text(`${remaining} caracteres restantes`);
                
                if (remaining < 50) {
                    $(this).siblings('.form-text').addClass('text-warning');
                } else {
                    $(this).siblings('.form-text').removeClass('text-warning');
                }
            });
        });
        
        function salvarRascunho() {
            const formData = new FormData($('#formNovoEvento')[0]);
            formData.append('rascunho', 'true');
            
            $.ajax({
                url: '/agenda/salvar-rascunho',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    alert('Rascunho salvo com sucesso!');
                },
                error: function() {
                    alert('Erro ao salvar rascunho.');
                }
            });
        }
    </script>
</body>
</html>
