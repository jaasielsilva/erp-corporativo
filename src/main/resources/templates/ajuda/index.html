<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Central de Ajuda - ERP Corporativo</title>
  
  <!-- CSS Dependencies -->
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link rel="stylesheet" th:href="@{/css/notifications.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      --card-hover-transform: translateY(-5px);
    }

    /* Hero Section */
    .help-hero {
      background: var(--primary-gradient);
      color: white;
      padding: 3rem 1rem;
      margin-bottom: 2rem;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .search-container {
      max-width: 700px;
      margin: 0 auto;
      position: relative;
    }

    .search-input {
      height: 55px;
      border-radius: 30px;
      padding-left: 25px;
      padding-right: 120px;
      border: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-size: 1.1rem;
    }

    .search-btn {
      position: absolute;
      right: 5px;
      top: 5px;
      height: 45px;
      border-radius: 25px;
      padding: 0 25px;
      background: #2563eb;
      color: white;
      border: none;
      font-weight: 600;
      transition: background 0.2s;
    }

    .search-btn:hover {
      background: #1d4ed8;
    }

    /* Topic Cards */
    .topic-card {
      border: none;
      border-radius: 15px;
      background: white;
      padding: 1.5rem;
      height: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .topic-card:hover {
      transform: var(--card-hover-transform);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      color: #2563eb;
    }

    .topic-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 1rem;
    }

    /* FAQ Accordion */
    .accordion-button:not(.collapsed) {
      background-color: #eff6ff;
      color: #1e40af;
    }
    
    .accordion-button:focus {
      box-shadow: none;
      border-color: rgba(59, 130, 246, 0.5);
    }

    /* Chat Widget */
    .chat-widget {
      border: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      background: white;
    }
    
    .chat-header {
      background: #1f2937;
      color: white;
      padding: 1rem;
    }

    .chat-messages {
      height: 350px;
      overflow-y: auto;
      padding: 1rem;
      background: #f9fafb;
    }

    .chat-message {
      margin-bottom: 1rem;
      max-width: 85%;
    }

    .chat-message.user {
      margin-left: auto;
      background: #3b82f6;
      color: white;
      border-radius: 15px 15px 0 15px;
      padding: 0.8rem;
    }

    .chat-message.bot {
      margin-right: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 15px 15px 15px 0;
      padding: 0.8rem;
    }

    /* Documentation Section */
    .docs-nav .nav-link {
      color: #4b5563;
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.5rem;
    }
    
    .docs-nav .nav-link.active {
      background-color: #eff6ff;
      color: #2563eb;
      font-weight: 600;
    }

    .permission-tag {
      font-family: monospace;
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      color: #475569;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content bg-light">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <!-- Hero Section -->
      <section class="help-hero text-center">
        <div class="container">
          <h1 class="display-6 fw-bold mb-3">Como podemos ajudar você hoje?</h1>
          <p class="mb-4 text-white-50 fs-5">Encontre tutoriais, documentação e respostas para suas dúvidas.</p>
          
          <div class="search-container">
            <input type="text" id="mainSearchInput" class="form-control search-input" 
                   placeholder="Digite sua dúvida (ex: como cadastrar cliente, solicitar férias...)"
                   onkeypress="if(event.key === 'Enter') performSearch()">
            <button class="search-btn" onclick="performSearch()">
              <i class="fas fa-search me-2"></i> Buscar
            </button>
          </div>
          
          <div class="mt-3 text-white-50 small">
            <span class="me-2">Sugestões:</span>
            <a href="#" class="text-white text-decoration-underline me-2" onclick="quickSearch('esqueci minha senha')">Senha</a>
            <a href="#" class="text-white text-decoration-underline me-2" onclick="quickSearch('solicitar acesso')">Acessos</a>
            <a href="#" class="text-white text-decoration-underline" onclick="quickSearch('abrir chamado')">Suporte</a>
          </div>
        </div>
      </section>

      <div class="container-fluid px-4 pb-5">
        
        <!-- Navigation Modules -->
        <div class="row g-4 mb-5">
          <div class="col-md-3 col-sm-6">
            <a href="#doc-comercial" class="topic-card text-center" onclick="showTab('comercial')">
              <div class="topic-icon bg-blue-100 text-primary mx-auto" style="background-color: #dbeafe;">
                <i class="fas fa-chart-line"></i>
              </div>
              <h5 class="fw-bold mb-2">Comercial</h5>
              <p class="text-muted small mb-0">Vendas, Clientes, CRM</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="#doc-rh" class="topic-card text-center" onclick="showTab('rh')">
              <div class="topic-icon bg-green-100 text-success mx-auto" style="background-color: #dcfce7;">
                <i class="fas fa-users"></i>
              </div>
              <h5 class="fw-bold mb-2">Recursos Humanos</h5>
              <p class="text-muted small mb-0">Férias, Folha, Ponto</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="#doc-gestao" class="topic-card text-center" onclick="showTab('gestao')">
              <div class="topic-icon bg-purple-100 text-warning mx-auto" style="background-color: #f3e8ff; color: #9333ea !important;">
                <i class="fas fa-briefcase"></i>
              </div>
              <h5 class="fw-bold mb-2">Gestão</h5>
              <p class="text-muted small mb-0">Financeiro, Jurídico</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="#doc-ti" class="topic-card text-center" onclick="showTab('ti')">
              <div class="topic-icon bg-gray-100 text-dark mx-auto" style="background-color: #f3f4f6;">
                <i class="fas fa-laptop-code"></i>
              </div>
              <h5 class="fw-bold mb-2">Tecnologia</h5>
              <p class="text-muted small mb-0">Suporte, Acessos, Sistemas</p>
            </a>
          </div>
        </div>

        <div class="row">
          <!-- Main Content Column -->
          <div class="col-lg-8">
            
            <!-- Search Results Area -->
            <div id="searchResultsArea" class="d-none mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Resultados da Busca</h4>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSearch()"><i class="fas fa-times"></i> Limpar</button>
              </div>
              <div id="resultsList"></div>
            </div>

            <!-- Content Tabs -->
            <div class="card border-0 shadow-sm" id="mainDocs">
              <div class="card-header bg-white border-bottom py-3">
                <ul class="nav nav-tabs card-header-tabs" id="helpTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq-content" type="button" role="tab">Dúvidas Frequentes</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs-content" type="button" role="tab">Documentação Técnica</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tutorials-tab" data-bs-toggle="tab" data-bs-target="#tutorials-content" type="button" role="tab">Tutoriais</button>
                  </li>
                </ul>
              </div>
              
              <div class="card-body p-4">
                <div class="tab-content">
                  
                  <!-- FAQ Tab -->
                  <div class="tab-pane fade show active" id="faq-content" role="tabpanel">
                    <div class="accordion" id="accordionFAQ">
                      <div class="accordion-item border-0 mb-2 shadow-sm rounded overflow-hidden">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            <i class="fas fa-key me-2 text-primary"></i> Como altero minha senha?
                          </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                          <div class="accordion-body">
                            Acesse seu perfil clicando no seu avatar no canto superior direito e selecione "Alterar Senha". Você precisará da sua senha atual.
                          </div>
                        </div>
                      </div>
                      <div class="accordion-item border-0 mb-2 shadow-sm rounded overflow-hidden">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            <i class="fas fa-user-plus me-2 text-primary"></i> Como solicitar novo acesso?
                          </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                          <div class="accordion-body">
                            Vá para <strong>Serviços > Solicitações > Nova Solicitação</strong>. Selecione o tipo de acesso desejado e justifique a necessidade.
                          </div>
                        </div>
                      </div>
                      <div class="accordion-item border-0 mb-2 shadow-sm rounded overflow-hidden">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            <i class="fas fa-umbrella-beach me-2 text-primary"></i> Como agendar férias?
                          </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                          <div class="accordion-body">
                            Acesse o módulo <strong>RH > Férias > Solicitar</strong>. Verifique seu saldo disponível e selecione o período desejado no calendário.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Documentation Tab (Migrated Content) -->
                  <div class="tab-pane fade" id="docs-content" role="tabpanel">
                    <div class="row">
                      <div class="col-md-4 border-end">
                        <div class="nav flex-column nav-pills docs-nav" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                          <button class="nav-link active text-start" data-bs-toggle="pill" data-bs-target="#v-pills-acessos" type="button">Solicitação de Acessos</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-comercial" type="button">Módulo Comercial</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-operacional" type="button">Módulo Operacional</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-rh" type="button">Recursos Humanos</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-gestao" type="button">Gestão & Financeiro</button>
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="tab-content ps-3" id="v-pills-tabContent">
                          <!-- Acessos -->
                          <div class="tab-pane fade show active" id="v-pills-acessos">
                            <h4 class="mb-3">Como Solicitar Acessos</h4>
                            <p>Solicite acessos informando o módulo e os subníveis necessários. Use solicitações com escopo mínimo.</p>
                            <div class="alert alert-info">
                              <i class="fas fa-info-circle me-2"></i> Exemplo: Para acessar <strong>Clientes > Geral > Listar</strong>
                              <ul class="mb-0 mt-2">
                                <li>Módulo: Clientes</li>
                                <li>Authority: <span class="permission-tag">MENU_CLIENTES_LISTAR</span></li>
                              </ul>
                            </div>
                          </div>
                          
                          <!-- Comercial -->
                          <div class="tab-pane fade" id="v-pills-comercial">
                            <h4 class="mb-3">Módulo Comercial</h4>
                            <h5 class="h6 mt-3">Clientes</h5>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_CLIENTES_LISTAR</span> Listagem geral</li>
                              <li class="mb-2"><span class="permission-tag">MENU_CLIENTES_NOVO</span> Cadastro novo cliente</li>
                              <li class="mb-2"><span class="permission-tag">MENU_CLIENTES_CONTRATOS_LISTAR</span> Contratos</li>
                            </ul>
                            <h5 class="h6 mt-3">Vendas</h5>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_VENDAS_PDV</span> Ponto de Venda</li>
                              <li class="mb-2"><span class="permission-tag">MENU_VENDAS_DASHBOARD</span> Indicadores</li>
                            </ul>
                          </div>

                          <!-- Operacional -->
                          <div class="tab-pane fade" id="v-pills-operacional">
                            <h4 class="mb-3">Módulo Operacional</h4>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_ESTOQUE_PRODUTOS</span> Gestão de Produtos</li>
                              <li class="mb-2"><span class="permission-tag">MENU_ESTOQUE_CATEGORIAS_LISTAR</span> Categorias</li>
                            </ul>
                          </div>

                          <!-- RH -->
                          <div class="tab-pane fade" id="v-pills-rh">
                            <h4 class="mb-3">Recursos Humanos</h4>
                            <div class="table-responsive">
                              <table class="table table-sm table-hover">
                                <thead><tr><th>Funcionalidade</th><th>Permissão</th></tr></thead>
                                <tbody>
                                  <tr><td>Colaboradores</td><td><span class="permission-tag">MENU_RH_COLABORADORES_LISTAR</span></td></tr>
                                  <tr><td>Folha de Pagamento</td><td><span class="permission-tag">MENU_RH_FOLHA_LISTAR</span></td></tr>
                                  <tr><td>Férias</td><td><span class="permission-tag">MENU_RH_FERIAS_SOLICITAR</span></td></tr>
                                  <tr><td>Ponto</td><td><span class="permission-tag">MENU_RH_PONTO_REGISTROS</span></td></tr>
                                </tbody>
                              </table>
                            </div>
                          </div>

                          <!-- Gestão -->
                          <div class="tab-pane fade" id="v-pills-gestao">
                            <h4 class="mb-3">Gestão & Financeiro</h4>
                            <p>Funcionalidades para administração e controle financeiro.</p>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_FINANCEIRO_DASHBOARD</span> Visão Geral</li>
                              <li class="mb-2"><span class="permission-tag">MENU_FINANCEIRO_CONTAS_PAGAR</span> Contas a Pagar</li>
                              <li class="mb-2"><span class="permission-tag">MENU_JURIDICO_PROCESSOS_LISTAR</span> Processos Jurídicos</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Tutorials Tab -->
                  <div class="tab-pane fade" id="tutorials-content" role="tabpanel">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="card h-100">
                          <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-video text-danger me-2"></i> Primeiro Acesso</h5>
                            <p class="card-text">Aprenda a configurar seu perfil e alterar sua senha no primeiro login.</p>
                            <a href="#" class="btn btn-sm btn-outline-primary stretched-link">Ver Tutorial</a>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card h-100">
                          <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-file-invoice text-success me-2"></i> Emitir Nota Fiscal</h5>
                            <p class="card-text">Passo a passo para emissão de NF-e através do módulo financeiro.</p>
                            <a href="#" class="btn btn-sm btn-outline-primary stretched-link">Ver Tutorial</a>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card h-100">
                          <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-user-check text-info me-2"></i> Aprovar Solicitações</h5>
                            <p class="card-text">Guia para gestores sobre como aprovar ou rejeitar solicitações da equipe.</p>
                            <a href="#" class="btn btn-sm btn-outline-primary stretched-link">Ver Tutorial</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Feedback Section -->
            <div class="mt-4 p-4 bg-white rounded shadow-sm text-center">
              <h5 class="mb-3">Esse conteúdo foi útil?</h5>
              <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-outline-success px-4" onclick="sendGlobalFeedback(true)"><i class="far fa-thumbs-up me-2"></i> Sim</button>
                <button class="btn btn-outline-danger px-4" onclick="sendGlobalFeedback(false)"><i class="far fa-thumbs-down me-2"></i> Não</button>
              </div>
            </div>

          </div>

          <!-- Sidebar Column (AI & Support) -->
          <div class="col-lg-4">
            
            <!-- AI Chat Widget -->
            <div class="chat-widget mb-4 sticky-top" style="top: 80px; z-index: 100;">
              <div class="chat-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                  <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="fas fa-robot"></i>
                  </div>
                  <span class="fw-bold">Assistente IA</span>
                </div>
                <span class="badge bg-success">Online</span>
              </div>
              <div class="chat-messages" id="chatHistory">
                <div class="chat-message bot">
                  Olá! Sou a IA do ERP Corporativo. Como posso ajudar você hoje?
                </div>
              </div>
              <div class="p-3 bg-white border-top">
                <div class="input-group">
                  <input type="text" id="chatInput" class="form-control border-end-0" placeholder="Digite sua pergunta..." onkeypress="if(event.key === 'Enter') sendMessage()">
                  <button class="btn btn-outline-primary border-start-0" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="mt-2 d-flex flex-wrap gap-1">
                  <button class="btn btn-xs btn-outline-secondary rounded-pill py-0 px-2" style="font-size: 11px;" onclick="chatQuick('Como pedir férias?')">Pedir Férias</button>
                  <button class="btn btn-xs btn-outline-secondary rounded-pill py-0 px-2" style="font-size: 11px;" onclick="chatQuick('Erro no login')">Erro Login</button>
                </div>
              </div>
            </div>

            <!-- Contact Support -->
            <div class="card border-0 shadow-sm bg-light">
              <div class="card-body">
                <h5 class="card-title fw-bold mb-3">Ainda precisa de ajuda?</h5>
                <p class="text-muted small mb-3">Se não encontrou o que procurava, entre em contato com nosso time de suporte.</p>
                <div class="d-grid gap-2">
                  <button class="btn btn-primary" onclick="openTicket()">
                    <i class="fas fa-ticket-alt me-2"></i> Abrir Chamado
                  </button>
                  <button class="btn btn-outline-dark">
                    <i class="fab fa-whatsapp me-2"></i> Chat Suporte
                  </button>
                </div>
                <hr>
                <div class="d-flex align-items-center gap-3">
                  <i class="fas fa-envelope text-muted"></i>
                  <small class="text-muted">suporte@erpcorporativo.com</small>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <!-- Scripts -->
  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.bundle.min.js"></script>

  <script th:inline="javascript">
    // --- Base de Conhecimento do Sistema (Mapeamento do Sidebar) ---
    const systemKnowledge = [
        // Principal
        { title: "Dashboard Principal", path: "/dashboard", section: "Principal", keywords: ["inicio", "home", "visão geral", "gráficos"], auth: "DASHBOARD_EXECUTIVO_VISUALIZAR" },
        { title: "Chat Corporativo", path: "/chat", section: "Principal", keywords: ["conversa", "mensagem", "falar", "comunicação"], auth: "" },
        
        // Comercial > Clientes
        { title: "Listar Clientes", path: "/clientes", section: "Comercial > Clientes", keywords: ["ver clientes", "buscar cliente", "tabela clientes", "lista"], auth: "MENU_CLIENTES_LISTAR" },
        { title: "Novo Cliente", path: "/clientes/cadastro", section: "Comercial > Clientes", keywords: ["criar cliente", "cadastrar cliente", "novo registro"], auth: "MENU_CLIENTES_NOVO" },
        { title: "Contratos de Clientes", path: "/clientes/contratos/listar", section: "Comercial > Clientes", keywords: ["contrato", "documento", "acordo"], auth: "MENU_CLIENTES_CONTRATOS_LISTAR" },
        { title: "Histórico de Interações", path: "/clientes/historico/interacoes", section: "Comercial > Clientes", keywords: ["conversas", "atendimentos", "logs"], auth: "MENU_CLIENTES_HISTORICO_INTERACOES" },
        
        // Comercial > Vendas
        { title: "Dashboard de Vendas", path: "/vendas", section: "Comercial > Vendas", keywords: ["metas", "resultados", "performance"], auth: "MENU_VENDAS_DASHBOARD" },
        { title: "PDV (Ponto de Venda)", path: "/vendas/pdv", section: "Comercial > Vendas", keywords: ["caixa", "frente de loja", "vender"], auth: "MENU_VENDAS_PDV" },
        { title: "Pedidos de Venda", path: "/vendas/pedidos", section: "Comercial > Vendas", keywords: ["ordens", "solicitações", "acompanhar"], auth: "MENU_VENDAS_PEDIDOS" },
        
        // Operacional
        { title: "Fornecedores", path: "/fornecedores", section: "Operacional > Compras", keywords: ["compras", "parceiros", "suprimentos"], auth: "MENU_COMPRAS" },
        { title: "Produtos", path: "/produtos", section: "Operacional > Estoque", keywords: ["itens", "mercadorias", "catálogo"], auth: "MENU_ESTOQUE_PRODUTOS" },
        { title: "Estoque Geral", path: "/estoque", section: "Operacional > Estoque", keywords: ["quantidade", "armazenagem", "saldo"], auth: "MENU_ESTOQUE" },
        { title: "Categorias de Produtos", path: "/categorias", section: "Operacional > Estoque", keywords: ["grupos", "classificação", "tipos"], auth: "MENU_ESTOQUE_CATEGORIAS_LISTAR" },

        // RH > Colaboradores
        { title: "Listar Colaboradores", path: "/rh/colaboradores/listar", section: "RH > Colaboradores", keywords: ["funcionários", "empregados", "equipe"], auth: "MENU_RH_COLABORADORES_LISTAR" },
        { title: "Novo Colaborador", path: "/rh/colaboradores/novo", section: "RH > Colaboradores", keywords: ["contratar", "admitir", "ficha", "registro", "criar funcionario"], auth: "MENU_RH_COLABORADORES_NOVO" },
        { title: "Adesão de Colaboradores", path: "/rh/colaboradores/adesao", section: "RH > Colaboradores", keywords: ["onboarding", "integração"], auth: "MENU_RH_COLABORADORES_ADESAO" },

        // RH > Folha
        { title: "Folha de Pagamento", path: "/rh/folha-pagamento", section: "RH > Folha", keywords: ["salário", "pagamento", "holerite", "contracheque"], auth: "MENU_RH_FOLHA_INICIO" },
        { title: "Gerar Folha", path: "/rh/folha-pagamento/gerar", section: "RH > Folha", keywords: ["calcular", "fechamento", "mensal"], auth: "MENU_RH_FOLHA_GERAR" },
        
        // RH > Benefícios
        { title: "Plano de Saúde", path: "/rh/beneficios/plano-saude", section: "RH > Benefícios", keywords: ["convênio", "médico", "hospital"], auth: "MENU_RH_BENEFICIOS_PLANO_SAUDE" },
        { title: "Vale Transporte", path: "/rh/beneficios/vale-transporte/listar", section: "RH > Benefícios", keywords: ["vt", "transporte", "ônibus"], auth: "MENU_RH_BENEFICIOS_VALE_TRANSPORTE" },

        // RH > Ponto e Férias
        { title: "Registros de Ponto", path: "/rh/ponto-escalas/registros", section: "RH > Ponto", keywords: ["bater ponto", "horário", "entrada", "saída"], auth: "MENU_RH_PONTO_REGISTROS" },
        { title: "Solicitar Férias", path: "/rh/ferias/solicitar", section: "RH > Férias", keywords: ["descanso", "ausência", "requisição"], auth: "MENU_RH_FERIAS_SOLICITAR" },
        
        // Gestão > Financeiro
        { title: "Dashboard Financeiro", path: "/financeiro", section: "Gestão > Financeiro", keywords: ["caixa", "bancos", "saldo"], auth: "MENU_FINANCEIRO_DASHBOARD" },
        { title: "Contas a Pagar", path: "/financeiro/contas-pagar", section: "Gestão > Financeiro", keywords: ["despesas", "boletos", "pagamentos"], auth: "MENU_FINANCEIRO_CONTAS_PAGAR" },
        { title: "Contas a Receber", path: "/financeiro/contas-receber", section: "Gestão > Financeiro", keywords: ["receitas", "faturas", "cobrança"], auth: "MENU_FINANCEIRO_CONTAS_RECEBER" },
        
        // Gestão > TI
        { title: "Dashboard TI", path: "/ti", section: "Gestão > TI", keywords: ["infra", "tecnologia", "status"], auth: "MENU_TI_DASHBOARD" },
        { title: "Sistemas", path: "/ti/sistemas", section: "Gestão > TI", keywords: ["aplicações", "softwares", "servidores"], auth: "MENU_TI_SISTEMAS" },
        { title: "Suporte TI", path: "/ti/suporte", section: "Gestão > TI", keywords: ["helpdesk", "chamados", "técnico", "atendimento", "abrir chamado"], auth: "MENU_TI_SUPORTE" },
        
        // Gestão > Jurídico
        { title: "Dashboard Jurídico", path: "/juridico", section: "Gestão > Jurídico", keywords: ["processos", "audiências", "prazos"], auth: "MENU_JURIDICO_DASHBOARD" },
        { title: "Processos", path: "/juridico/processos", section: "Gestão > Jurídico", keywords: ["ações", "tribunal", "judicial"], auth: "MENU_JURIDICO_PROCESSOS_LISTAR" },
        
        // Serviços
        { title: "Nova Solicitação", path: "/solicitacoes/nova", section: "Serviços > Solicitações", keywords: ["pedir", "requerer", "abrir chamado"], auth: "" },
        { title: "Minhas Solicitações", path: "/solicitacoes", section: "Serviços > Solicitações", keywords: ["acompanhar", "status", "meus pedidos"], auth: "" },
        { title: "Gerenciar Pendências", path: "/solicitacoes/pendentes", section: "Serviços > Solicitações", keywords: ["aprovar", "fila", "atender"], auth: "MENU_SERVICOS_SOLICITACOES_GERENCIAR" },

        // Administração
        { title: "Gerenciar Usuários", path: "/usuarios/index", section: "Administração > Usuários", keywords: ["criar usuário", "novo usuário", "login", "senha", "acesso"], auth: "MENU_ADMIN_USUARIOS" },
        { title: "Perfis de Acesso", path: "/perfis", section: "Administração > Acesso", keywords: ["roles", "grupos", "cargos", "níveis", "perfil"], auth: "MENU_ADMIN_GESTAO_ACESSO_PERFIS" },
        { title: "Permissões do Sistema", path: "/permissoes", section: "Administração > Acesso", keywords: ["authorities", "regras", "liberações", "permissão"], auth: "MENU_ADMIN_GESTAO_ACESSO_PERMISSOES" },
        { title: "Configurações Gerais", path: "/configuracoes", section: "Administração > Config", keywords: ["parâmetros", "setup", "sistema"], auth: "MENU_ADMIN_CONFIGURACOES" }
    ];

    // --- Tabs Handling ---
    function showTab(category) {
      const tabEl = document.querySelector('#docs-tab');
      if(tabEl) {
          const tab = new bootstrap.Tab(tabEl);
          tab.show();
      }
      
      setTimeout(() => {
        const pillSelector = '#v-pills-' + category;
        const pillTrigger = document.querySelector(`button[data-bs-target="${pillSelector}"]`);
        if(pillTrigger) {
          const pill = new bootstrap.Tab(pillTrigger);
          pill.show();
          document.getElementById('mainDocs').scrollIntoView({behavior: 'smooth'});
        }
      }, 200);
    }

    // --- Search Functionality ---
    function quickSearch(query) {
      document.getElementById('mainSearchInput').value = query;
      performSearch();
    }
    
    function clearSearch() {
      document.getElementById('mainSearchInput').value = '';
      document.getElementById('searchResultsArea').classList.add('d-none');
      document.getElementById('mainDocs').classList.remove('d-none');
    }

    async function performSearch() {
      const query = document.getElementById('mainSearchInput').value.toLowerCase().trim();
      if (!query) return;

      const resultsArea = document.getElementById('searchResultsArea');
      const resultsList = document.getElementById('resultsList');
      const mainDocs = document.getElementById('mainDocs');

      // UI Loading State
      resultsList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Buscando informações...</p></div>';
      resultsArea.classList.remove('d-none');
      mainDocs.classList.add('d-none');

      // 1. Busca Local no SystemKnowledge
      const localResults = systemKnowledge.filter(item => 
          item.title.toLowerCase().includes(query) || 
          item.section.toLowerCase().includes(query) ||
          item.keywords.some(k => k.includes(query))
      );

      // Limpa lista para renderizar
      resultsList.innerHTML = '';

      if (localResults.length > 0) {
          localResults.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card mb-2 border-0 shadow-sm';
            div.innerHTML = `
                <div class="card-body py-3">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <h5 class="mb-1 text-primary card-title"><i class="fas fa-link me-2"></i>${item.title}</h5>
                        <small class="text-muted badge bg-light text-dark">${item.section}</small>
                    </div>
                    <p class="mb-1 text-secondary small">Acesso rápido: <code class="text-muted">${item.path}</code></p>
                    <a href="${item.path}" class="stretched-link"></a>
                </div>
            `;
            resultsList.appendChild(div);
          });
      }

      // Detecção de Intenção Complexa (Ex: "Como criar usuário...")
      if (query.includes("criar usuário") || (query.includes("usuário") && query.includes("permissão")) || query.includes("atender chamados")) {
         showTutorialCard('admin-user-creation');
         return; 
      }

      // Se poucos resultados locais, ou nenhum, sugere IA
      if (localResults.length === 0) {
          resultsList.innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-search me-2"></i> Nenhum resultado exato encontrado nos menus.
              <div class="mt-3">
                 <p>Tentando buscar na documentação inteligente...</p>
              </div>
            </div>
          `;
          // Chama IA automaticamente se não achou nada óbvio
          askIA(query);
      } else {
          // Adiciona rodapé sugerindo IA para mais detalhes
          const aiHint = document.createElement('div');
          aiHint.className = 'mt-3 text-center';
          aiHint.innerHTML = `<button class="btn btn-outline-info btn-sm" onclick="askIA('${query}')"><i class="fas fa-robot me-2"></i> Perguntar à IA sobre "${query}"</button>`;
          resultsList.appendChild(aiHint);
      }
    }
    
    function showTutorialCard(tutorialId) {
        const resultsList = document.getElementById('resultsList');
        // Adiciona um card de destaque para o tutorial
        const tutorialDiv = document.createElement('div');
        tutorialDiv.className = 'card border-primary mb-4 shadow';
        tutorialDiv.innerHTML = `
            <div class="card-header bg-primary text-white">
                <i class="fas fa-graduation-cap me-2"></i> Tutorial Recomendado
            </div>
            <div class="card-body">
                <h5 class="card-title">Como Criar Usuário com Permissões Específicas</h5>
                <p class="card-text">Identificamos que você quer saber como configurar um usuário para funções específicas (ex: Atender Chamados).</p>
                <button class="btn btn-primary" onclick="openTutorialContent('${tutorialId}')">Ver Passo a Passo Completo</button>
            </div>
        `;
        // Insere no topo
        resultsList.prepend(tutorialDiv);
    }

    function openTutorialContent(id) {
        // Simula abertura de conteúdo de tutorial
        showTab('tutorials');
        const content = document.getElementById('tutorials-content');
        if(id === 'admin-user-creation') {
            content.innerHTML = `
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="text-primary mb-3"><i class="fas fa-user-plus me-2"></i>Criando Usuário para Atendimento (Exemplo Prático)</h3>
                        <p>Siga este guia para cadastrar um usuário capaz de atender chamados ou solicitações.</p>
                        
                        <div class="alert alert-info"><i class="fas fa-info-circle"></i> Necessário perfil de Administrador.</div>

                        <ol class="list-group list-group-numbered list-group-flush">
                          <li class="list-group-item">Acesse o menu <strong>Administração > Usuários</strong> (<a href="/usuarios/index">link</a>).</li>
                          <li class="list-group-item">Clique em <strong>Novo Usuário</strong> e preencha os dados (Nome, Email/Login, Senha).</li>
                          <li class="list-group-item">
                            <strong>Configurando o Perfil:</strong>
                            <p class="mb-1 mt-1">Para atender chamados de TI:</p>
                            <ul class="small text-muted">
                                <li>Vá na aba <strong>Perfis</strong>.</li>
                                <li>Selecione o perfil <strong>"Suporte TI"</strong> (se existir).</li>
                                <li>Caso não exista, crie um perfil em <a href="/perfis">Gestão de Acesso > Perfis</a> e adicione a permissão <code>MENU_TI_SUPORTE</code>.</li>
                            </ul>
                            <p class="mb-1 mt-2">Para atender solicitações gerais:</p>
                            <ul class="small text-muted">
                                <li>Adicione a permissão <code>MENU_SERVICOS_SOLICITACOES_GERENCIAR</code> diretamente ou via perfil.</li>
                            </ul>
                          </li>
                          <li class="list-group-item">Salve o registro e peça para o usuário logar.</li>
                        </ol>
                    </div>
                </div>
                <button class="btn btn-secondary mt-3" onclick="location.reload()">Voltar</button>
            `;
        }
    }

    // --- AI Chat Functionality ---
    function chatQuick(msg) {
        document.getElementById('chatInput').value = msg;
        sendMessage();
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value;
      if (!text.trim()) return;

      addMessage(text, 'user');
      input.value = '';

      // Show typing indicator
      const typingId = addMessage('<i class="fas fa-ellipsis-h fa-fade"></i>', 'bot');

      try {
        const token = getXsrfToken();
        // Simulação de resposta inteligente baseada no mapa local para evitar chamadas de API desnecessárias se offline
        // Mas mantemos o fetch para a API real se disponível
        
        const res = await fetch('/api/ajuda/ia/generate?query=' + encodeURIComponent(text), {
            method: 'POST',
            headers: token ? { 'X-XSRF-TOKEN': token } : {}
        });

        if (res.status === 401) {
             updateMessage(typingId, 'Por favor, faça login para continuar.');
             return;
        }
        
        if (res.status === 404) {
             // Fallback local se a API não existir
             setTimeout(() => {
                 let fallbackResponse = "Desculpe, estou operando em modo offline. Tente usar a busca acima.";
                 if(text.toLowerCase().includes("senha")) fallbackResponse = "Para alterar sua senha, vá em Configurações > Alterar Senha.";
                 updateMessage(typingId, fallbackResponse);
             }, 1000);
             return;
        }

        const json = await res.json();
        let reply = json.sections?.resumo || json.resposta || "Desculpe, não consegui processar sua solicitação.";
        updateMessage(typingId, reply);

      } catch (e) {
        // Fallback robusto em caso de erro de rede
        console.warn("Erro na API de IA:", e);
        let fallbackMsg = "Não consegui conectar ao servidor de IA. ";
        
        // Tentativa de resposta local simples baseada em keywords
        const keywords = text.toLowerCase().split(' ');
        const match = systemKnowledge.find(k => k.keywords.some(kw => text.toLowerCase().includes(kw)));
        if(match) {
            fallbackMsg += `Mas encontrei algo sobre <strong>${match.title}</strong>. Tente acessar: <a href="${match.path}" class="text-white underline">Clique aqui</a>.`;
        } else {
            fallbackMsg += "Tente usar a busca principal para encontrar tópicos.";
        }
        
        updateMessage(typingId, fallbackMsg);
      }
    }
    
    function askIA(query) {
        const chatInput = document.getElementById('chatInput');
        chatInput.value = query;
        sendMessage();
        document.querySelector('.chat-widget').scrollIntoView({behavior: 'smooth'});
    }

    function addMessage(text, type) {
      const history = document.getElementById('chatHistory');
      const div = document.createElement('div');
      div.className = `chat-message ${type}`;
      div.id = 'msg-' + Date.now();
      div.innerHTML = text;
      history.appendChild(div);
      history.scrollTop = history.scrollHeight;
      return div.id;
    }

    function updateMessage(id, text) {
        const el = document.getElementById(id);
        if(el) el.innerHTML = text;
    }

    function getXsrfToken() {
      const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : null;
    }

    function sendGlobalFeedback(positive) {
      const btn = event.target.closest('button');
      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i>';
      btn.classList.add('text-success');
      setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.remove('text-success');
      }, 2000);
    }
  </script>
</body>
</html>
