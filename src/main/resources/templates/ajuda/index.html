<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ajuda - ERP Corporativo</title>
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link rel="stylesheet" th:href="@{/css/notifications.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h1 class="h3 m-0"><i class="fas fa-question-circle me-2"></i> Ajuda</h1>
            <small class="text-muted">Busque conte√∫dos, FAQs e v√≠deos. Se precisar, acione a IA.</small>
          </div>
        </div>

        <div class="row g-3">
          
        </div>
        <div class="row g-3 mt-3">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header d-flex align-items-center gap-2">
                <i class="fas fa-robot text-info"></i>
                <strong>Assistente Inteligente</strong>
                <span class="ms-2 text-muted small">Conversa contextual com RAG</span>
              </div>
              <div class="card-body">
                <div id="chatHistory" class="mb-3" style="min-height:160px;"></div>
                <div class="d-flex gap-2">
                  <input id="chatInput" class="form-control" placeholder="Pergunte em linguagem natural" />
                  <button class="btn btn-primary" id="chatSend"><i class="fas fa-paper-plane"></i> Enviar</button>
                </div>
                <div class="mt-2 d-flex flex-wrap gap-2">
                  <button class="btn btn-sm btn-outline-secondary" onclick="chatQuick('impressora travando')">Impressora travando</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="chatQuick('como abrir um chamado')">Abrir chamado</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="chatQuick('pagar sal√°rio')">Pagar sal√°rio</button>
                  <button class="btn btn-sm btn-outline-secondary" onclick="chatQuick('registrar venda no pdv')">Registrar venda</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script>
    async function loadCategories() {
      const res = await fetch('/api/ajuda/categorias');
      const cats = await res.json();
      const select = document.getElementById('categoria');
      select.innerHTML = '<option value="">Todas</option>' + cats.map(c => `<option value="${c.slug}">${c.nome}</option>`).join('');
      const list = document.getElementById('cats');
      if (list) {
        list.innerHTML = cats.map(c => `<li><a href="#" onclick="filterBy('${c.slug}')"><i class="fas fa-folder"></i> ${c.nome}</a></li>`).join('');
      }
    }

    function filterBy(slug) {
      document.getElementById('categoria').value = slug;
      doSearch();
    }

    async function doSearch(page=0) {
      const q = document.getElementById('q').value;
      const categoria = document.getElementById('categoria').value;
      const url = new URL(window.location.origin + '/api/ajuda/busca');
      if (q) url.searchParams.set('q', q);
      if (categoria) url.searchParams.set('categoria', categoria);
      url.searchParams.set('page', page);
      url.searchParams.set('size', 10);
      const res = await fetch(url);
      const json = await res.json();
      const items = json.items || [];
      const results = document.getElementById('results');
      const actions = document.getElementById('actions');
      if (items.length === 0) {
        actions.classList.remove('d-none');
        results.innerHTML = `
          <div class="alert alert-warning" role="alert">
            <i class="fas fa-info-circle"></i> Nenhum resultado encontrado.
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" onclick="askIA()"><i class="fas fa-robot"></i> Falar com IA</button>
            <button class="btn btn-outline-secondary" onclick="openTicket()"><i class="fas fa-ticket-alt"></i> Abrir Chamado</button>
          </div>
        `;
      } else {
        actions.classList.add('d-none');
        results.innerHTML = items.map(renderItem).join('');
      }
    }

    function renderItem(it) {
      const tipoIcon = it.tipo === 'VIDEO' ? 'fa-video' : it.tipo === 'FAQ' ? 'fa-question' : 'fa-file-alt';
      return `
        <article class="mb-3">
          <div class="d-flex align-items-center gap-2">
            <i class="fas ${tipoIcon} text-primary"></i>
            <strong>${it.titulo}</strong>
            <span class="ms-auto text-muted small">${it.categoria?.nome || ''}</span>
          </div>
          <div class="mt-2 text-secondary">${(it.corpo || '').substring(0, 240)}...</div>
          <div class="mt-2 d-flex gap-2">
            <a class="btn btn-sm btn-outline-primary" href="/ajuda/conteudo/${it.id}"><i class="fas fa-external-link-alt"></i> Abrir</a>
            <button class="btn btn-sm btn-success" onclick="feedback(${it.id}, true)"><i class="fas fa-thumbs-up"></i></button>
            <button class="btn btn-sm btn-danger" onclick="feedback(${it.id}, false)"><i class="fas fa-thumbs-down"></i></button>
          </div>
        </article>
      `;
    }

    function getXsrfToken() {
      const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : null;
    }

    async function feedback(conteudoId, upvote) {
      const token = getXsrfToken();
      const res = await fetch('/api/ajuda/feedback?conteudoId=' + conteudoId + '&upvote=' + upvote, {
        method: 'POST',
        headers: token ? { 'X-XSRF-TOKEN': token } : {}
      });
      if (res.status === 401) { if (typeof showToast === 'function') { showToast({ title: 'Autentica√ß√£o', message: 'Fa√ßa login para enviar feedback.', priority: 'MEDIUM' }); } return; }
      if (typeof showToast === 'function') {
        showToast({ title: 'Ajuda', message: 'Feedback registrado.', priority: 'LOW' });
      }
    }

    async function askIA() {
      const q = document.getElementById('q').value || 'Ajuda';
      const token = getXsrfToken();
      const res = await fetch('/api/ajuda/ia/generate?query=' + encodeURIComponent(q), {
        method: 'POST',
        headers: token ? { 'X-XSRF-TOKEN': token } : {}
      });
      if (res.status === 401) { alert('Fa√ßa login para usar a IA.'); return; }
      const json = await res.json();
      const results = document.getElementById('results');
      if (json.sections) {
        const s = json.sections;
        const resumo = s.resumo || json.resposta || '';
        const caminho = s.caminho || '';
        const passos = (s.passo_a_passo && s.passo_a_passo.items) ? s.passo_a_passo.items : [];
        const observacoes = (s.observacoes && s.observacoes.items) ? s.observacoes.items : [];
        const perguntaFinal = s.pergunta_final || '';

        const passosHtml = passos.length ? `<ol class="mb-0">${passos.map(p => `<li>${p}</li>`).join('')}</ol>` : '<span class="text-muted">Sem passos dispon√≠veis</span>';
        const obsHtml = observacoes.length ? `<ul class="mb-0">${observacoes.map(o => `<li>${o}</li>`).join('')}</ul>` : '<span class="text-muted">Sem observa√ß√µes</span>';

        const sugestoesCards = (json.sugestoes && json.sugestoes.length) ? json.sugestoes.map(sg => `
          <div class="card mb-2"><div class="card-body p-2">
            <div class="d-flex align-items-center gap-2">
              <i class="fas fa-lightbulb text-info"></i>
              <strong>${sg.titulo}</strong>
              <span class="ms-auto text-muted small">${sg.categoria}</span>
            </div>
          </div></div>`).join('') : '';

        results.innerHTML = `
          <div class="card mb-3"><div class="card-body">
            <div class="mb-2"><strong>üîπ Resumo r√°pido</strong><div>${resumo}</div></div>
            <div class="mb-2"><strong>üîπ Caminho de navega√ß√£o</strong><div>${caminho || '<span class="text-muted">N√£o especificado</span>'}</div></div>
            <div class="mb-2"><strong>üîπ Passo a passo</strong><div>${passosHtml}</div></div>
            <div class="mb-2"><strong>üîπ Observa√ß√µes √∫teis</strong><div>${obsHtml}</div></div>
            <div class="mb-2"><strong>üîπ Pergunta final</strong><div>${perguntaFinal}</div></div>
          </div></div>
        ` + sugestoesCards + (json.abrirChamadoSugerido ? `<button class="btn btn-outline-secondary" onclick="openTicket()"><i class="fas fa-ticket-alt"></i> Abrir Chamado</button>` : '');
      } else {
        if (json.sugestoes && json.sugestoes.length) {
          const cards = json.sugestoes.map(s => `
            <div class="card mb-2"><div class="card-body p-2">
              <div class="d-flex align-items-center gap-2">
                <i class="fas fa-lightbulb text-info"></i>
                <strong>${s.titulo}</strong>
                <span class="ms-auto text-muted small">${s.categoria}</span>
              </div>
            </div></div>`).join('');
          results.innerHTML = `<div class="alert alert-info"><i class="fas fa-robot"></i> ${json.resposta}</div>` + cards;
        } else {
          results.innerHTML = `<div class="alert alert-warning"><i class="fas fa-info-circle"></i> ${json.resposta}</div>
            <button class="btn btn-outline-secondary" onclick="openTicket()"><i class="fas fa-ticket-alt"></i> Abrir Chamado</button>`;
        }
      }
    }

    async function openTicket() {
      const q = document.getElementById('q').value || 'Ajuda';
      const categoria = document.getElementById('categoria').value || 'AJUDA';
      const token = getXsrfToken();
      const params = new URLSearchParams();
      params.set('assunto', 'Ajuda: ' + q);
      params.set('descricao', 'Origem: M√≥dulo de Ajuda\n\n' + q);
      params.set('categoria', categoria);
      params.set('prioridade', 'MEDIA');
      const res = await fetch('/api/chamados/ajuda', {
        method: 'POST',
        headers: token ? { 'Content-Type': 'application/x-www-form-urlencoded', 'X-XSRF-TOKEN': token } : { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      });
      const results = document.getElementById('results');
      if (res.status === 401) { results.innerHTML = '<div class="alert alert-danger">Fa√ßa login para abrir chamado.</div>'; return; }
      const json = await res.json();
      if (json.sucesso) {
        results.innerHTML = `<div class="alert alert-success"><i class="fas fa-check-circle"></i> Chamado aberto: ${json.numero}</div>`;
      } else {
        results.innerHTML = `<div class="alert alert-danger"><i class="fas fa-times-circle"></i> Erro ao abrir chamado: ${json.erro || json.mensagem}</div>`;
      }
    }
    function chatQuick(q){ const i=document.getElementById('chatInput'); if(i){ i.value=q; chatSend(); } }
    async function chatSend(){
      const q = document.getElementById('chatInput') ? document.getElementById('chatInput').value.trim() : ''; if (!q) return;
      chatAdd('Voc√™', `<div>${q}</div>`);
      const token = getXsrfToken();
      const typing = document.createElement('div'); typing.className='text-muted small'; typing.textContent='Assistente est√° pensando‚Ä¶';
      document.getElementById('chatHistory').appendChild(typing);
      try {
        const res = await fetch('/api/ajuda/ia/generate?query=' + encodeURIComponent(q), { method: 'POST', headers: token ? { 'X-XSRF-TOKEN': token } : {} });
        typing.remove(); if (res.status === 401) { chatAdd('Assistente','<div>Fa√ßa login para usar a IA.</div>'); return; }
        const json = await res.json(); const s = json.sections || {};
        const resumo = s.resumo || json.resposta || ''; const caminho = s.caminho || '';
        const passos = (s.passo_a_passo && s.passo_a_passo.items) ? s.passo_a_passo.items : [];
        const observacoes = (s.observacoes && s.observacoes.items) ? s.observacoes.items : [];
        const perguntaFinal = s.pergunta_final || '';
        const passosHtml = passos.length ? `<ol class="mb-0">${passos.map(p => `<li>${p}</li>`).join('')}</ol>` : '<span class="text-muted">Sem passos dispon√≠veis</span>';
        const obsHtml = observacoes.length ? `<ul class="mb-0">${observacoes.map(o => `<li>${o}</li>`).join('')}</ul>` : '<span class="text-muted">Sem observa√ß√µes</span>';
        const sugCards = (json.sugestoes && json.sugestoes.length) ? json.sugestoes.map(sg => `<div class="card mb-2"><div class="card-body p-2"><div class="d-flex align-items-center gap-2"><i class="fas fa-lightbulb text-info"></i><strong>${sg.titulo}</strong><span class="ms-auto text-muted small">${sg.categoria}</span></div></div></div>`).join('') : '';
        const actions = `<div class=\"mt-2 d-flex flex-wrap gap-2\">` +
          `<a class=\"btn btn-sm btn-outline-primary\" href=\"/ajuda\"><i class=\"fas fa-book\"></i> Ver FAQs</a>` +
          `<a class=\"btn btn-sm btn-outline-secondary\" href=\"/ti/suporte\"><i class=\"fas fa-headset\"></i> Suporte TI</a>` +
          `<button class=\"btn btn-sm btn-outline-success\" onclick=\"openTicket()\"><i class=\"fas fa-ticket-alt\"></i> Abrir Chamado</button>` +
        `</div>`;
        const html = `<div class=\"mb-2\"><strong>Resumo</strong><div>${resumo}</div></div>`+
          `<div class=\"mb-2\"><strong>Navega√ß√£o</strong><div>${caminho || '<span class=\"text-muted\">N√£o especificado</span>'}</div></div>`+
          `<div class=\"mb-2\"><strong>Passos</strong><div>${passosHtml}</div></div>`+
          `<div class=\"mb-2\"><strong>Observa√ß√µes</strong><div>${obsHtml}</div></div>`+
          (perguntaFinal ? `<div class=\"mb-2\"><strong>Pergunta</strong><div>${perguntaFinal}</div></div>` : '')+
          sugCards + actions;
        chatAdd('Assistente', html);
        try {
          const ir = await fetch('/api/navigation/route', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query: q }) });
          if (ir.ok) { const r = await ir.json(); if (r.suggestions && r.suggestions.length) {
            const top = r.suggestions.slice(0,3).map(s => `<a href=\"${s.routes[0]}\" class=\"btn btn-xs btn-outline-dark\">${s.intent}</a>`).join(' ');
            chatAdd('Assistente', `<div class=\"small text-muted\">Sugest√µes de navega√ß√£o:</div><div class=\"d-flex flex-wrap gap-1\">${top}</div>`);
          } }
        } catch (_) {}
      } catch (e) { typing.remove(); chatAdd('Assistente', '<div>Falha na comunica√ß√£o com a IA.</div>'); }
    }
    function chatAdd(who, html){ const box=document.getElementById('chatHistory'); if(!box) return; const bubble=document.createElement('div'); bubble.className='p-2 rounded mb-2 ' + (who==='Voc√™'?'bg-light':'bg-white border'); bubble.innerHTML = `<div class=\"small text-muted\">${who}</div>` + html; box.appendChild(bubble); box.scrollTop=box.scrollHeight; }
    document.addEventListener('DOMContentLoaded', function(){ const btn=document.getElementById('chatSend'); if(btn) btn.addEventListener('click', chatSend); const input=document.getElementById('chatInput'); if(input) input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') chatSend(); }); });
    loadCategories();
    doSearch();
  </script>
</body>
</html>
