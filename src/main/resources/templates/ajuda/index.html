<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Central de Ajuda - ERP Corporativo</title>
  
  <!-- CSS Dependencies -->
  <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link rel="stylesheet" th:href="@{/css/notifications.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      --card-hover-transform: translateY(-5px);
    }

    /* Hero Section */
    .help-hero {
      background: var(--primary-gradient);
      color: white;
      padding: 3rem 1rem;
      margin-bottom: 2rem;
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .search-container {
      max-width: 700px;
      margin: 0 auto;
      position: relative;
    }

    .search-input {
      height: 55px;
      border-radius: 30px;
      padding-left: 25px;
      padding-right: 120px;
      border: none;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      font-size: 1.1rem;
    }

    .search-btn {
      position: absolute;
      right: 5px;
      top: 5px;
      height: 45px;
      border-radius: 25px;
      padding: 0 25px;
      background: #2563eb;
      color: white;
      border: none;
      font-weight: 600;
      transition: background 0.2s;
    }

    .search-btn:hover {
      background: #1d4ed8;
    }

    /* Topic Cards */
    .topic-card {
      border: none;
      border-radius: 15px;
      background: white;
      padding: 1.5rem;
      height: 100%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .topic-card:hover {
      transform: var(--card-hover-transform);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      color: #2563eb;
    }

    .topic-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      margin-bottom: 1rem;
    }

    /* FAQ Accordion */
    .accordion-button:not(.collapsed) {
      background-color: #eff6ff;
      color: #1e40af;
    }
    
    .accordion-button:focus {
      box-shadow: none;
      border-color: rgba(59, 130, 246, 0.5);
    }

    /* Chat Widget */
    .chat-widget {
      border: none;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      background: white;
    }
    
    .chat-header {
      background: #1f2937;
      color: white;
      padding: 1rem;
    }

    .chat-messages {
      height: 350px;
      overflow-y: auto;
      padding: 1rem;
      background: #f9fafb;
    }

    .chat-message {
      margin-bottom: 1rem;
      max-width: 85%;
    }

    .chat-message.user {
      margin-left: auto;
      background: #3b82f6;
      color: white;
      border-radius: 15px 15px 0 15px;
      padding: 0.8rem;
    }

    .chat-message.bot {
      margin-right: auto;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 15px 15px 15px 0;
      padding: 0.8rem;
    }

    /* Documentation Section */
    .docs-nav .nav-link {
      color: #4b5563;
      border-radius: 8px;
      padding: 0.8rem 1rem;
      margin-bottom: 0.5rem;
    }
    
    .docs-nav .nav-link.active {
      background-color: #eff6ff;
      color: #2563eb;
      font-weight: 600;
    }

    .permission-tag {
      font-family: monospace;
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      color: #475569;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content bg-light">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <!-- Hero Section -->
      <section class="help-hero text-center">
        <div class="container">
          <h1 class="display-6 fw-bold mb-3">Como podemos ajudar você hoje?</h1>
          <p class="mb-4 text-white-50 fs-5">Encontre tutoriais, documentação e respostas para suas dúvidas.</p>
          
          <div class="search-container">
            <input type="text" id="mainSearchInput" class="form-control search-input" 
                   placeholder="Digite sua dúvida (ex: como cadastrar cliente, solicitar férias...)"
                   onkeypress="if(event.key === 'Enter') performSearch()">
            <button class="search-btn" onclick="performSearch()">
              <i class="fas fa-search me-2"></i> Buscar
            </button>
          </div>
          
          <div class="mt-3 text-white-50 small">
            <span class="me-2">Sugestões:</span>
            <a href="#" class="text-white text-decoration-underline me-2" onclick="quickSearch('esqueci minha senha')">Senha</a>
            <a href="#" class="text-white text-decoration-underline me-2" onclick="quickSearch('solicitar acesso')">Acessos</a>
            <a href="#" class="text-white text-decoration-underline" onclick="quickSearch('abrir chamado')">Suporte</a>
          </div>
        </div>
      </section>

      <div class="container-fluid px-4 pb-5">
        
        <!-- Navigation Modules -->
        <div class="row g-4 mb-5">
          <div class="col-md-3 col-sm-6">
            <a href="#doc-comercial" class="topic-card text-center" onclick="showTab('comercial')">
              <div class="topic-icon bg-blue-100 text-primary mx-auto" style="background-color: #dbeafe;">
                <i class="fas fa-chart-line"></i>
              </div>
              <h5 class="fw-bold mb-2">Comercial</h5>
              <p class="text-muted small mb-0">Vendas, Clientes, CRM</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="#doc-rh" class="topic-card text-center" onclick="showTab('rh')">
              <div class="topic-icon bg-green-100 text-success mx-auto" style="background-color: #dcfce7;">
                <i class="fas fa-users"></i>
              </div>
              <h5 class="fw-bold mb-2">Recursos Humanos</h5>
              <p class="text-muted small mb-0">Férias, Folha, Ponto</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="#doc-gestao" class="topic-card text-center" onclick="showTab('gestao')">
              <div class="topic-icon bg-purple-100 text-warning mx-auto" style="background-color: #f3e8ff; color: #9333ea !important;">
                <i class="fas fa-briefcase"></i>
              </div>
              <h5 class="fw-bold mb-2">Gestão</h5>
              <p class="text-muted small mb-0">Financeiro, Jurídico</p>
            </a>
          </div>
          <div class="col-md-3 col-sm-6">
            <a href="#doc-ti" class="topic-card text-center" onclick="showTab('ti')">
              <div class="topic-icon bg-gray-100 text-dark mx-auto" style="background-color: #f3f4f6;">
                <i class="fas fa-laptop-code"></i>
              </div>
              <h5 class="fw-bold mb-2">Tecnologia</h5>
              <p class="text-muted small mb-0">Suporte, Acessos, Sistemas</p>
            </a>
          </div>
        </div>

        <div class="row">
          <!-- Main Content Column -->
          <div class="col-lg-8">
            
            <!-- Search Results Area -->
            <div id="searchResultsArea" class="d-none mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Resultados da Busca</h4>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSearch()"><i class="fas fa-times"></i> Limpar</button>
              </div>
              <div id="resultsList"></div>
            </div>

            <!-- Content Tabs -->
            <div class="card border-0 shadow-sm" id="mainDocs">
              <div class="card-header bg-white border-bottom py-3">
                <ul class="nav nav-tabs card-header-tabs" id="helpTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq-content" type="button" role="tab">Dúvidas Frequentes</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs-content" type="button" role="tab">Documentação Técnica</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tutorials-tab" data-bs-toggle="tab" data-bs-target="#tutorials-content" type="button" role="tab">Tutoriais</button>
                  </li>
                </ul>
              </div>
              
              <div class="card-body p-4">
                <div class="tab-content">
                  
                  <!-- FAQ Tab -->
                  <div class="tab-pane fade show active" id="faq-content" role="tabpanel">
                    <div class="accordion" id="accordionFAQ">
                      <div class="accordion-item border-0 mb-2 shadow-sm rounded overflow-hidden">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            <i class="fas fa-key me-2 text-primary"></i> Como altero minha senha?
                          </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                          <div class="accordion-body">
                            Acesse seu perfil clicando no seu avatar no canto superior direito e selecione "Alterar Senha". Você precisará da sua senha atual.
                          </div>
                        </div>
                      </div>
                      <div class="accordion-item border-0 mb-2 shadow-sm rounded overflow-hidden">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            <i class="fas fa-user-plus me-2 text-primary"></i> Como solicitar novo acesso?
                          </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                          <div class="accordion-body">
                            Vá para <strong>Serviços > Solicitações > Nova Solicitação</strong>. Selecione o tipo de acesso desejado e justifique a necessidade.
                          </div>
                        </div>
                      </div>
                      <div class="accordion-item border-0 mb-2 shadow-sm rounded overflow-hidden">
                        <h2 class="accordion-header">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            <i class="fas fa-umbrella-beach me-2 text-primary"></i> Como agendar férias?
                          </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#accordionFAQ">
                          <div class="accordion-body">
                            Acesse o módulo <strong>RH > Férias > Solicitar</strong>. Verifique seu saldo disponível e selecione o período desejado no calendário.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Documentation Tab (Migrated Content) -->
                  <div class="tab-pane fade" id="docs-content" role="tabpanel">
                    <div class="row">
                      <div class="col-md-4 border-end">
                        <div class="nav flex-column nav-pills docs-nav" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                          <button class="nav-link active text-start" data-bs-toggle="pill" data-bs-target="#v-pills-ti" type="button">Tecnologia & Acessos</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-comercial" type="button">Módulo Comercial</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-operacional" type="button">Módulo Operacional</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-rh" type="button">Recursos Humanos</button>
                          <button class="nav-link text-start" data-bs-toggle="pill" data-bs-target="#v-pills-gestao" type="button">Gestão & Financeiro</button>
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="tab-content ps-3" id="v-pills-tabContent">
                          <!-- Tecnologia & Acessos -->
                          <div class="tab-pane fade show active" id="v-pills-ti">
                            <h4 class="mb-3">Tecnologia & Acessos</h4>
                            <p>Informações sobre suporte técnico, sistemas e gestão de acessos.</p>
                            
                            <h5 class="h6 mt-3 text-primary"><i class="fas fa-headset me-2"></i>Suporte Técnico & Sistemas</h5>
                            <p class="small text-muted">Para reportar problemas, acessar sistemas ou solicitar serviços de TI:</p>
                            <ul class="list-unstyled mb-4">
                                <li class="mb-2"><i class="fas fa-angle-right me-2 text-secondary"></i><a href="#" onclick="chatQuick('abrir chamado')">Abrir Chamado via Chat</a></li>
                                <li class="mb-2"><i class="fas fa-angle-right me-2 text-secondary"></i><a href="/ti/suporte">Painel de Suporte</a></li>
                                <li class="mb-2"><i class="fas fa-angle-right me-2 text-secondary"></i><a href="/ti/sistemas">Catálogo de Sistemas</a></li>
                            </ul>

                            <h5 class="h6 mt-3 text-primary"><i class="fas fa-key me-2"></i>Solicitação de Acessos</h5>
                            <p class="small text-muted">Solicite acessos informando o módulo e os subníveis necessários. Use solicitações com escopo mínimo.</p>
                            <div class="alert alert-info">
                              <i class="fas fa-info-circle me-2"></i> Exemplo: Para acessar <strong>Clientes > Geral > Listar</strong>
                              <ul class="mb-0 mt-2">
                                <li>Módulo: Clientes</li>
                                <li>Authority: <span class="permission-tag">MENU_CLIENTES_LISTAR</span></li>
                              </ul>
                            </div>
                          </div>
                          
                          <!-- Comercial -->
                          <div class="tab-pane fade" id="v-pills-comercial">
                            <h4 class="mb-3">Módulo Comercial</h4>
                            <h5 class="h6 mt-3">Clientes</h5>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_CLIENTES_LISTAR</span> Listagem geral</li>
                              <li class="mb-2"><span class="permission-tag">MENU_CLIENTES_NOVO</span> Cadastro novo cliente</li>
                              <li class="mb-2"><span class="permission-tag">MENU_CLIENTES_CONTRATOS_LISTAR</span> Contratos</li>
                            </ul>
                            <h5 class="h6 mt-3">Vendas</h5>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_VENDAS_PDV</span> Ponto de Venda</li>
                              <li class="mb-2"><span class="permission-tag">MENU_VENDAS_DASHBOARD</span> Indicadores</li>
                            </ul>
                          </div>

                          <!-- Operacional -->
                          <div class="tab-pane fade" id="v-pills-operacional">
                            <h4 class="mb-3">Módulo Operacional</h4>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_ESTOQUE_PRODUTOS</span> Gestão de Produtos</li>
                              <li class="mb-2"><span class="permission-tag">MENU_ESTOQUE_CATEGORIAS_LISTAR</span> Categorias</li>
                            </ul>
                          </div>

                          <!-- RH -->
                          <div class="tab-pane fade" id="v-pills-rh">
                            <h4 class="mb-3">Recursos Humanos</h4>
                            <div class="table-responsive">
                              <table class="table table-sm table-hover">
                                <thead><tr><th>Funcionalidade</th><th>Permissão</th></tr></thead>
                                <tbody>
                                  <tr><td>Colaboradores</td><td><span class="permission-tag">MENU_RH_COLABORADORES_LISTAR</span></td></tr>
                                  <tr><td>Folha de Pagamento</td><td><span class="permission-tag">MENU_RH_FOLHA_LISTAR</span></td></tr>
                                  <tr><td>Férias</td><td><span class="permission-tag">MENU_RH_FERIAS_SOLICITAR</span></td></tr>
                                  <tr><td>Ponto</td><td><span class="permission-tag">MENU_RH_PONTO_REGISTROS</span></td></tr>
                                </tbody>
                              </table>
                            </div>
                          </div>

                          <!-- Gestão -->
                          <div class="tab-pane fade" id="v-pills-gestao">
                            <h4 class="mb-3">Gestão & Financeiro</h4>
                            <p>Funcionalidades para administração e controle financeiro.</p>
                            <ul class="list-unstyled">
                              <li class="mb-2"><span class="permission-tag">MENU_FINANCEIRO_DASHBOARD</span> Visão Geral</li>
                              <li class="mb-2"><span class="permission-tag">MENU_FINANCEIRO_CONTAS_PAGAR</span> Contas a Pagar</li>
                              <li class="mb-2"><span class="permission-tag">MENU_JURIDICO_PROCESSOS_LISTAR</span> Processos Jurídicos</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Tutorials Tab -->
                  <div class="tab-pane fade" id="tutorials-content" role="tabpanel">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <div class="card h-100">
                          <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-video text-danger me-2"></i> Primeiro Acesso</h5>
                            <p class="card-text">Aprenda a configurar seu perfil e alterar sua senha no primeiro login.</p>
                            <a href="#" class="btn btn-sm btn-outline-primary stretched-link">Ver Tutorial</a>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card h-100">
                          <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-file-invoice text-success me-2"></i> Emitir Nota Fiscal</h5>
                            <p class="card-text">Passo a passo para emissão de NF-e através do módulo financeiro.</p>
                            <a href="#" class="btn btn-sm btn-outline-primary stretched-link">Ver Tutorial</a>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card h-100">
                          <div class="card-body">
                            <h5 class="card-title"><i class="fas fa-user-check text-info me-2"></i> Aprovar Solicitações</h5>
                            <p class="card-text">Guia para gestores sobre como aprovar ou rejeitar solicitações da equipe.</p>
                            <a href="#" class="btn btn-sm btn-outline-primary stretched-link">Ver Tutorial</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Feedback Section -->
            <div class="mt-4 p-4 bg-white rounded shadow-sm text-center">
              <h5 class="mb-3">Esse conteúdo foi útil?</h5>
              <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-outline-success px-4" onclick="sendGlobalFeedback(true)"><i class="far fa-thumbs-up me-2"></i> Sim</button>
                <button class="btn btn-outline-danger px-4" onclick="sendGlobalFeedback(false)"><i class="far fa-thumbs-down me-2"></i> Não</button>
              </div>
            </div>

          </div>

          <!-- Sidebar Column (AI & Support) -->
          <div class="col-lg-4">
            
            <!-- AI Chat Widget -->
            <div class="chat-widget mb-4 sticky-top" style="top: 80px; z-index: 100;">
              <div class="chat-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                  <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                    <i class="fas fa-robot"></i>
                  </div>
                  <span class="fw-bold">Assistente IA</span>
                </div>
                <span class="badge bg-success">Online</span>
              </div>
              <div class="chat-messages" id="chatHistory">
                <div class="chat-message bot">
                  Olá! Sou a IA do ERP Corporativo. Como posso ajudar você hoje?
                </div>
              </div>
              <div class="p-3 bg-white border-top">
                <div class="input-group">
                  <input type="text" id="chatInput" class="form-control border-end-0" placeholder="Digite sua pergunta..." onkeypress="if(event.key === 'Enter') sendMessage()">
                  <button class="btn btn-outline-primary border-start-0" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="mt-2 d-flex flex-wrap gap-1">
                  <button class="btn btn-xs btn-outline-secondary rounded-pill py-0 px-2" style="font-size: 11px;" onclick="chatQuick('Como pedir férias?')">Pedir Férias</button>
                  <button class="btn btn-xs btn-outline-secondary rounded-pill py-0 px-2" style="font-size: 11px;" onclick="chatQuick('Erro no login')">Erro Login</button>
                </div>
              </div>
            </div>



          </div>
        </div>
      </div>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <!-- Scripts -->
  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.bundle.min.js"></script>

  <script th:inline="javascript">
    // --- Base de Conhecimento do Sistema (Mapeamento Completo do Sidebar) ---
    const systemKnowledge = [
        // === PRINCIPAL ===
        { title: "Dashboard Principal", path: "/dashboard", section: "Principal", keywords: ["inicio", "home", "visão geral", "gráficos", "kpi"], auth: "DASHBOARD_EXECUTIVO_VISUALIZAR" },
        { title: "Chat Corporativo", path: "/chat", section: "Principal", keywords: ["conversa", "mensagem", "falar", "comunicação", "chat"], auth: "" },
        { title: "Central de Ajuda", path: "/ajuda", section: "Principal", keywords: ["suporte", "faq", "tutoriais", "dúvidas"], auth: "" },

        // === COMERCIAL ===
        // Clientes
        { title: "Listar Clientes", path: "/clientes", section: "Comercial > Clientes", keywords: ["ver clientes", "buscar cliente", "tabela clientes", "cadastro clientes"], auth: "MENU_CLIENTES_LISTAR" },
        { title: "Novo Cliente", path: "/clientes/cadastro", section: "Comercial > Clientes", keywords: ["criar cliente", "cadastrar cliente", "novo registro"], auth: "MENU_CLIENTES_NOVO" },
        { title: "Contratos de Clientes", path: "/clientes/contratos/listar", section: "Comercial > Clientes", keywords: ["contrato", "documento", "acordo", "vigência"], auth: "MENU_CLIENTES_CONTRATOS_LISTAR" },
        { title: "Histórico de Interações", path: "/clientes/historico/interacoes", section: "Comercial > Clientes", keywords: ["conversas", "atendimentos", "logs", "contatos"], auth: "MENU_CLIENTES_HISTORICO_INTERACOES" },
        { title: "Histórico de Pedidos", path: "/clientes/historico/pedidos", section: "Comercial > Clientes", keywords: ["compras anteriores", "histórico de vendas"], auth: "MENU_CLIENTES_HISTORICO_PEDIDOS" },
        { title: "Busca Avançada de Clientes", path: "/clientes/avancado/busca", section: "Comercial > Clientes", keywords: ["pesquisa detalhada", "filtros avançados"], auth: "MENU_CLIENTES_AVANCADO_BUSCA" },
        { title: "Relatórios de Clientes", path: "/clientes/avancado/relatorios", section: "Comercial > Clientes", keywords: ["estatísticas clientes", "dados demográficos"], auth: "MENU_CLIENTES_AVANCADO_RELATORIOS" },

        // Vendas
        { title: "Dashboard de Vendas", path: "/vendas", section: "Comercial > Vendas", keywords: ["metas", "resultados", "performance vendas", "indicadores vendas"], auth: "MENU_VENDAS_DASHBOARD" },
        { title: "PDV (Ponto de Venda)", path: "/vendas/pdv", section: "Comercial > Vendas", keywords: ["caixa", "frente de loja", "vender", "cupom"], auth: "MENU_VENDAS_PDV" },
        { title: "Pedidos de Venda", path: "/vendas/pedidos", section: "Comercial > Vendas", keywords: ["ordens", "solicitações", "acompanhar pedidos"], auth: "MENU_VENDAS_PEDIDOS" },
        { title: "Relatórios de Vendas", path: "/vendas/relatorios", section: "Comercial > Vendas", keywords: ["fechamento", "vendas por período", "curva abc"], auth: "MENU_VENDAS_RELATORIOS" },

        // === COMPRAS ===
        { title: "Gerenciar Fornecedores", path: "/fornecedores", section: "Compras", keywords: ["compras", "parceiros", "suprimentos", "fornecedor"], auth: "MENU_COMPRAS" },

        // === OPERACIONAL (ESTOQUE) ===
        { title: "Gestão de Produtos", path: "/produtos", section: "Operacional", keywords: ["itens", "mercadorias", "catálogo", "preços"], auth: "MENU_ESTOQUE_PRODUTOS" },
        { title: "Controle de Estoque", path: "/estoque", section: "Operacional", keywords: ["quantidade", "armazenagem", "saldo", "inventário", "movimentação"], auth: "MENU_ESTOQUE" },
        { title: "Listar Categorias", path: "/categorias", section: "Operacional > Categorias", keywords: ["grupos", "classificação", "família de produtos"], auth: "MENU_ESTOQUE_CATEGORIAS_LISTAR" },
        { title: "Nova Categoria", path: "/categorias/nova", section: "Operacional > Categorias", keywords: ["criar categoria", "adicionar grupo"], auth: "MENU_ESTOQUE_CATEGORIAS_NOVO" },

        // === RECURSOS HUMANOS (RH) ===
        // Colaboradores
        { title: "Listar Colaboradores", path: "/rh/colaboradores/listar", section: "RH > Colaboradores", keywords: ["funcionários", "empregados", "equipe", "staff"], auth: "MENU_RH_COLABORADORES_LISTAR" },
        { title: "Novo Colaborador", path: "/rh/colaboradores/novo", section: "RH > Colaboradores", keywords: ["contratar", "admitir", "ficha", "registro", "criar funcionario"], auth: "MENU_RH_COLABORADORES_NOVO" },
        { title: "Adesão de Colaboradores", path: "/rh/colaboradores/adesao", section: "RH > Colaboradores", keywords: ["onboarding", "integração", "admissão digital"], auth: "MENU_RH_COLABORADORES_ADESAO" },

        // Folha de Pagamento
        { title: "Folha de Pagamento (Início)", path: "/rh/folha-pagamento", section: "RH > Folha", keywords: ["salário", "pagamento", "resumo folha"], auth: "MENU_RH_FOLHA_INICIO" },
        { title: "Listar Folhas", path: "/rh/folha-pagamento/listar", section: "RH > Folha", keywords: ["histórico folha", "competências"], auth: "MENU_RH_FOLHA_LISTAR" },
        { title: "Gerar Folha", path: "/rh/folha-pagamento/gerar", section: "RH > Folha", keywords: ["calcular", "fechamento", "mensal", "processar folha"], auth: "MENU_RH_FOLHA_GERAR" },
        { title: "Holerites", path: "/rh/folha-pagamento/holerite", section: "RH > Folha", keywords: ["contracheque", "recibo de pagamento", "comprovante renda"], auth: "MENU_RH_FOLHA_HOLERITE" },
        { title: "Gestão de Descontos", path: "/rh/folha-pagamento/descontos", section: "RH > Folha", keywords: ["faltas", "adiantamentos", "empréstimos"], auth: "MENU_RH_FOLHA_DESCONTOS" },
        { title: "Relatórios da Folha", path: "/rh/folha-pagamento/relatorios", section: "RH > Folha", keywords: ["custo folha", "analítico", "sintético"], auth: "MENU_RH_FOLHA_RELATORIOS" },

        // Benefícios
        { title: "Plano de Saúde", path: "/rh/beneficios/plano-saude", section: "RH > Benefícios", keywords: ["convênio", "médico", "hospital", "unimed", "bradesco"], auth: "MENU_RH_BENEFICIOS_PLANO_SAUDE" },
        { title: "Vale Transporte", path: "/rh/beneficios/vale-transporte/listar", section: "RH > Benefícios", keywords: ["vt", "transporte", "ônibus", "metro"], auth: "MENU_RH_BENEFICIOS_VALE_TRANSPORTE" },
        { title: "Vale Refeição/Alimentação", path: "/rh/beneficios/vale-refeicao/listar", section: "RH > Benefícios", keywords: ["vr", "va", "ticket", "sodexo"], auth: "MENU_RH_BENEFICIOS_VALE_REFEICAO" },
        { title: "Adesão a Benefícios", path: "/rh/beneficios/adesao", section: "RH > Benefícios", keywords: ["incluir benefício", "optar benefício"], auth: "MENU_RH_BENEFICIOS_ADESAO" },

        // Workflow
        { title: "Aprovação de Processos", path: "/rh/workflow/aprovacao", section: "RH > Workflow", keywords: ["aprovar", "pendências", "workflow", "autorizar"], auth: "MENU_RH_WORKFLOW_APROVACAO" },
        { title: "Relatórios de Workflow", path: "/rh/workflow/relatorios", section: "RH > Workflow", keywords: ["status processos", "tempo aprovação"], auth: "MENU_RH_WORKFLOW_RELATORIOS" },

        // Ponto e Escalas
        { title: "Registros de Ponto", path: "/rh/ponto-escalas/registros", section: "RH > Ponto", keywords: ["bater ponto", "horário", "entrada", "saída", "espelho ponto"], auth: "MENU_RH_PONTO_REGISTROS" },
        { title: "Correção de Ponto", path: "/rh/ponto-escalas/correcoes", section: "RH > Ponto", keywords: ["ajuste ponto", "esqueci de bater", "abono"], auth: "MENU_RH_PONTO_CORRECOES" },
        { title: "Escalas de Trabalho", path: "/rh/ponto-escalas/escalas", section: "RH > Ponto", keywords: ["turno", "horário trabalho", "escala"], auth: "MENU_RH_PONTO_ESCALAS" },
        { title: "Relatórios de Ponto", path: "/rh/ponto-escalas/relatorios", section: "RH > Ponto", keywords: ["banco de horas", "horas extras", "atrasos"], auth: "MENU_RH_PONTO_RELATORIOS" },

        // Férias
        { title: "Solicitar Férias", path: "/rh/ferias/solicitar", section: "RH > Férias", keywords: ["descanso", "ausência", "requisição férias", "marcar férias"], auth: "MENU_RH_FERIAS_SOLICITAR" },
        { title: "Aprovar Férias", path: "/rh/ferias/aprovar", section: "RH > Férias", keywords: ["autorizar férias", "gestão férias"], auth: "MENU_RH_FERIAS_APROVAR" },
        { title: "Planejamento de Férias", path: "/rh/ferias/planejamento", section: "RH > Férias", keywords: ["mapa férias", "programação"], auth: "MENU_RH_FERIAS_PLANEJAMENTO" },
        { title: "Calendário de Férias", path: "/rh/ferias/calendario", section: "RH > Férias", keywords: ["agenda", "quem está de férias"], auth: "MENU_RH_FERIAS_CALENDARIO" },

        // Avaliação
        { title: "Periodicidade de Avaliação", path: "/rh/avaliacao/periodicidade", section: "RH > Avaliação", keywords: ["ciclo avaliação", "período"], auth: "MENU_RH_AVALIACAO_PERIODICIDADE" },
        { title: "Feedbacks", path: "/rh/avaliacao/feedbacks", section: "RH > Avaliação", keywords: ["retorno", "avaliação desempenho", "feedback 1:1"], auth: "MENU_RH_AVALIACAO_FEEDBACKS" },
        { title: "Relatórios de Avaliação", path: "/rh/avaliacao/relatorios", section: "RH > Avaliação", keywords: ["performance", "9box", "competências"], auth: "MENU_RH_AVALIACAO_RELATORIOS" },

        // Treinamentos
        { title: "Cadastro de Treinamentos", path: "/rh/treinamentos/cadastro", section: "RH > Treinamentos", keywords: ["novo curso", "criar treinamento"], auth: "MENU_RH_TREINAMENTOS_CADASTRO" },
        { title: "Inscrição em Treinamentos", path: "/rh/treinamentos/inscricao", section: "RH > Treinamentos", keywords: ["participar", "inscrever", "matrícula"], auth: "MENU_RH_TREINAMENTOS_INSCRICAO" },
        { title: "Meus Certificados", path: "/rh/treinamentos/certificado", section: "RH > Treinamentos", keywords: ["diploma", "comprovante", "conclusão"], auth: "MENU_RH_TREINAMENTOS_CERTIFICADO" },

        // Recrutamento (R&S)
        { title: "Banco de Candidatos", path: "/rh/recrutamento/candidatos", section: "RH > R&S", keywords: ["currículos", "talentos", "banco de talentos"], auth: "MENU_RH_RECRUTAMENTO_CANDIDATOS" },
        { title: "Gestão de Vagas", path: "/rh/recrutamento/vagas", section: "RH > R&S", keywords: ["abrir vaga", "novas oportunidades", "posições"], auth: "MENU_RH_RECRUTAMENTO_VAGAS" },
        { title: "Triagem de Currículos", path: "/rh/recrutamento/triagem", section: "RH > R&S", keywords: ["seleção", "filtrar candidatos"], auth: "MENU_RH_RECRUTAMENTO_TRIAGEM" },
        { title: "Entrevistas", path: "/rh/recrutamento/entrevistas", section: "RH > R&S", keywords: ["agendar entrevista", "processo seletivo"], auth: "MENU_RH_RECRUTAMENTO_ENTREVISTAS" },
        { title: "Histórico de Seleção", path: "/rh/recrutamento/historico", section: "RH > R&S", keywords: ["logs seleção", "antigos processos"], auth: "MENU_RH_RECRUTAMENTO_HISTORICO" },
        { title: "Pipeline de Contratação", path: "/rh/recrutamento/pipeline", section: "RH > R&S", keywords: ["funil contratação", "kanban"], auth: "MENU_RH_RECRUTAMENTO_PIPELINE" },
        { title: "Relatórios de R&S", path: "/rh/recrutamento/relatorios", section: "RH > R&S", keywords: ["tempo contratação", "eficácia fontes"], auth: "MENU_RH_RECRUTAMENTO_RELATORIOS" },

        // Relatórios Estratégicos RH
        { title: "Relatório de Turnover", path: "/rh/relatorios/turnover", section: "RH > Relatórios", keywords: ["rotatividade", "saídas"], auth: "MENU_RH_RELATORIOS_TURNOVER" },
        { title: "Relatório de Absenteísmo", path: "/rh/relatorios/absenteismo", section: "RH > Relatórios", keywords: ["faltas", "ausências"], auth: "MENU_RH_RELATORIOS_ABSENTEISMO" },
        { title: "Headcount", path: "/rh/relatorios/headcount", section: "RH > Relatórios", keywords: ["contagem", "total colaboradores"], auth: "MENU_RH_RELATORIOS_HEADCOUNT" },
        { title: "Indicadores RH", path: "/rh/relatorios/indicadores", section: "RH > Relatórios", keywords: ["kpi rh", "dashboard rh"], auth: "MENU_RH_RELATORIOS_INDICADORES" },
        { title: "Admissões e Demissões", path: "/rh/relatorios/admissoes-demissoes", section: "RH > Relatórios", keywords: ["entradas e saídas", "movimentação"], auth: "MENU_RH_RELATORIOS_ADMISSOES_DEMISSOES" },
        { title: "Relatório Férias e Benefícios", path: "/rh/relatorios/ferias-beneficios", section: "RH > Relatórios", keywords: ["custo benefícios", "provisão férias"], auth: "MENU_RH_RELATORIOS_FERIAS_BENEFICIOS" },

        // Configurações RH
        { title: "Configurações RH", path: "/rh/configuracoes", section: "RH > Config", keywords: ["ajustes rh", "setup rh"], auth: "MENU_RH_CONFIGURACOES_INICIO" },
        { title: "Políticas de Férias", path: "/rh/configuracoes/politicas-ferias", section: "RH > Config", keywords: ["regras férias", "dias direito"], auth: "MENU_RH_CONFIGURACOES_POLITICAS_FERIAS" },
        { title: "Parâmetros de Ponto", path: "/rh/configuracoes/ponto", section: "RH > Config", keywords: ["tolerância", "jornada", "regras ponto"], auth: "MENU_RH_CONFIGURACOES_PONTO" },
        { title: "Integrações RH", path: "/rh/configuracoes/integracoes", section: "RH > Config", keywords: ["api", "sistemas externos"], auth: "MENU_RH_CONFIGURACOES_INTEGRACOES" },

        // Auditoria RH
        { title: "Auditoria RH", path: "/rh/auditoria", section: "RH > Auditoria", keywords: ["compliance", "segurança"], auth: "MENU_RH_AUDITORIA_INICIO" },
        { title: "Log de Acessos RH", path: "/rh/auditoria/acessos", section: "RH > Auditoria", keywords: ["quem acessou", "rastreabilidade"], auth: "MENU_RH_AUDITORIA_ACESSOS" },

        // === ADMINISTRAÇÃO ===
        { title: "Gerenciar Usuários", path: "/usuarios/index", section: "Administração", keywords: ["criar usuário", "novo usuário", "login", "senha", "acesso"], auth: "MENU_ADMIN_USUARIOS" },
        { title: "Perfis de Acesso", path: "/perfis", section: "Administração", keywords: ["roles", "grupos", "cargos", "níveis", "perfil"], auth: "MENU_ADMIN_GESTAO_ACESSO_PERFIS" },
        { title: "Permissões do Sistema", path: "/permissoes", section: "Administração", keywords: ["authorities", "regras", "liberações", "permissão"], auth: "MENU_ADMIN_GESTAO_ACESSO_PERMISSOES" }
    ];

    // --- Tabs Handling ---
    function showTab(category) {
      const tabEl = document.querySelector('#docs-tab');
      if(tabEl) {
          const tab = new bootstrap.Tab(tabEl);
          tab.show();
      }
      
      setTimeout(() => {
        const pillSelector = '#v-pills-' + category;
        const pillTrigger = document.querySelector(`button[data-bs-target="${pillSelector}"]`);
        if(pillTrigger) {
          const pill = new bootstrap.Tab(pillTrigger);
          pill.show();
          document.getElementById('mainDocs').scrollIntoView({behavior: 'smooth'});
        }
      }, 200);
    }

    // --- Search Functionality ---
    function quickSearch(query) {
      document.getElementById('mainSearchInput').value = query;
      performSearch();
    }
    
    function clearSearch() {
      document.getElementById('mainSearchInput').value = '';
      document.getElementById('searchResultsArea').classList.add('d-none');
      document.getElementById('mainDocs').classList.remove('d-none');
    }

    async function performSearch() {
      const query = document.getElementById('mainSearchInput').value.toLowerCase().trim();
      if (!query) return;

      const resultsArea = document.getElementById('searchResultsArea');
      const resultsList = document.getElementById('resultsList');
      const mainDocs = document.getElementById('mainDocs');

      // UI Loading State
      resultsList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">Buscando informações...</p></div>';
      resultsArea.classList.remove('d-none');
      mainDocs.classList.add('d-none');

      // 1. Busca Local no SystemKnowledge
      const localResults = systemKnowledge.filter(item => 
          item.title.toLowerCase().includes(query) || 
          item.section.toLowerCase().includes(query) ||
          item.keywords.some(k => k.includes(query))
      );

      // Limpa lista para renderizar
      resultsList.innerHTML = '';

      if (localResults.length > 0) {
          localResults.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card mb-2 border-0 shadow-sm';
            div.innerHTML = `
                <div class="card-body py-3">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <h5 class="mb-1 text-primary card-title"><i class="fas fa-link me-2"></i>${item.title}</h5>
                        <small class="text-muted badge bg-light text-dark">${item.section}</small>
                    </div>
                    <p class="mb-1 text-secondary small">Acesso rápido: <code class="text-muted">${item.path}</code></p>
                    <a href="${item.path}" class="stretched-link"></a>
                </div>
            `;
            resultsList.appendChild(div);
          });
      }

      // Detecção de Intenção Complexa (Ex: "Como criar usuário...")
      if (query.includes("criar usuário") || (query.includes("usuário") && query.includes("permissão")) || query.includes("atender chamados")) {
         showTutorialCard('admin-user-creation');
         return; 
      }

      // Se poucos resultados locais, ou nenhum, sugere IA
      if (localResults.length === 0) {
          resultsList.innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-search me-2"></i> Nenhum resultado exato encontrado nos menus.
              <div class="mt-3">
                 <p>Tentando buscar na documentação inteligente...</p>
              </div>
            </div>
          `;
          // Chama IA automaticamente se não achou nada óbvio
          askIA(query);
      } else {
          // Adiciona rodapé sugerindo IA para mais detalhes
          const aiHint = document.createElement('div');
          aiHint.className = 'mt-3 text-center';
          aiHint.innerHTML = `<button class="btn btn-outline-info btn-sm" onclick="askIA('${query}')"><i class="fas fa-robot me-2"></i> Perguntar à IA sobre "${query}"</button>`;
          resultsList.appendChild(aiHint);
      }
    }
    
    function showTutorialCard(tutorialId) {
        const resultsList = document.getElementById('resultsList');
        // Adiciona um card de destaque para o tutorial
        const tutorialDiv = document.createElement('div');
        tutorialDiv.className = 'card border-primary mb-4 shadow';
        tutorialDiv.innerHTML = `
            <div class="card-header bg-primary text-white">
                <i class="fas fa-graduation-cap me-2"></i> Tutorial Recomendado
            </div>
            <div class="card-body">
                <h5 class="card-title">Como Criar Usuário com Permissões Específicas</h5>
                <p class="card-text">Identificamos que você quer saber como configurar um usuário para funções específicas (ex: Atender Chamados).</p>
                <button class="btn btn-primary" onclick="openTutorialContent('${tutorialId}')">Ver Passo a Passo Completo</button>
            </div>
        `;
        // Insere no topo
        resultsList.prepend(tutorialDiv);
    }

    function openTutorialContent(id) {
        // Simula abertura de conteúdo de tutorial
        showTab('tutorials');
        const content = document.getElementById('tutorials-content');
        if(id === 'admin-user-creation') {
            content.innerHTML = `
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="text-primary mb-3"><i class="fas fa-user-plus me-2"></i>Criando Usuário para Atendimento (Exemplo Prático)</h3>
                        <p>Siga este guia para cadastrar um usuário capaz de atender chamados ou solicitações.</p>
                        
                        <div class="alert alert-info"><i class="fas fa-info-circle"></i> Necessário perfil de Administrador.</div>

                        <ol class="list-group list-group-numbered list-group-flush">
                          <li class="list-group-item">Acesse o menu <strong>Administração > Usuários</strong> (<a href="/usuarios/index">link</a>).</li>
                          <li class="list-group-item">Clique em <strong>Novo Usuário</strong> e preencha os dados (Nome, Email/Login, Senha).</li>
                          <li class="list-group-item">
                            <strong>Configurando o Perfil:</strong>
                            <p class="mb-1 mt-1">Para atender chamados de TI:</p>
                            <ul class="small text-muted">
                                <li>Vá na aba <strong>Perfis</strong>.</li>
                                <li>Selecione o perfil <strong>"Suporte TI"</strong> (se existir).</li>
                                <li>Caso não exista, crie um perfil em <a href="/perfis">Gestão de Acesso > Perfis</a> e adicione a permissão <code>MENU_TI_SUPORTE</code>.</li>
                            </ul>
                            <p class="mb-1 mt-2">Para atender solicitações gerais:</p>
                            <ul class="small text-muted">
                                <li>Adicione a permissão <code>MENU_SERVICOS_SOLICITACOES_GERENCIAR</code> diretamente ou via perfil.</li>
                            </ul>
                          </li>
                          <li class="list-group-item">Salve o registro e peça para o usuário logar.</li>
                        </ol>
                    </div>
                </div>
                <button class="btn btn-secondary mt-3" onclick="location.reload()">Voltar</button>
            `;
        }
    }

    // --- AI Chat Functionality ---
    function chatQuick(msg) {
        document.getElementById('chatInput').value = msg;
        sendMessage();
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const text = input.value;
      if (!text.trim()) return;

      addMessage(text, 'user');
      input.value = '';

      // Show typing indicator
      const typingId = addMessage('<i class="fas fa-ellipsis-h fa-fade"></i>', 'bot');
      const statusBadge = document.querySelector('.chat-header .badge');

      try {
        const token = getXsrfToken();
        
        // Tenta conectar com a API Real
        const res = await fetch('/api/ajuda/ia/generate?query=' + encodeURIComponent(text), {
            method: 'POST',
            headers: token ? { 'X-XSRF-TOKEN': token } : {}
        });

        if (res.status === 401) {
             updateMessage(typingId, 'Por favor, faça login para continuar.');
             return;
        }
        
        if (res.status === 404 || res.status === 500) {
             throw new Error('API Indisponível');
        }

        const json = await res.json();
        let reply = json.sections?.resumo || json.resposta || "Desculpe, não consegui processar sua solicitação.";
        
        // Sucesso: IA Online
        if(statusBadge) {
            statusBadge.className = 'badge bg-success';
            statusBadge.innerHTML = '<i class="fas fa-brain me-1"></i> IA Online';
        }
        
        updateMessage(typingId, reply);

      } catch (e) {
        // Falha: IA Offline (Fallback Local)
        console.warn("IA Offline, usando fallback local:", e);
        
        if(statusBadge) {
            statusBadge.className = 'badge bg-warning text-dark';
            statusBadge.innerHTML = '<i class="fas fa-wifi-slash me-1"></i> Modo Offline';
            statusBadge.title = "A IA está indisponível. Respondendo com base de conhecimento local.";
        }

        let fallbackMsg = "";
        
        // Lógica de Fallback Inteligente Local
        const queryLower = text.toLowerCase();
        
        // 1. Busca no SystemKnowledge
        const match = systemKnowledge.find(k => 
            k.keywords.some(kw => queryLower.includes(kw)) || 
            k.title.toLowerCase().includes(queryLower)
        );

        if(match) {
            fallbackMsg = `<strong>Modo Offline:</strong> Encontrei uma funcionalidade relacionada: <br>
                           <i class="fas fa-arrow-right text-primary"></i> <strong>${match.title}</strong><br>
                           Caminho: <span class="badge bg-light text-dark">${match.section}</span><br>
                           <a href="${match.path}" class="btn btn-sm btn-outline-primary mt-2">Acessar agora</a>`;
        } else if (queryLower.includes("senha") || queryLower.includes("acesso")) {
             fallbackMsg = "Para questões de acesso ou senha, verifique seu perfil no canto superior direito ou contate o suporte.";
        } else {
             fallbackMsg = "Desculpe, estou sem conexão com a IA no momento e não encontrei tópicos exatos no menu para sua dúvida. Tente buscar pelo nome do módulo.";
        }
        
        updateMessage(typingId, fallbackMsg);
      }
    }
    
    function askIA(query) {
        const chatInput = document.getElementById('chatInput');
        chatInput.value = query;
        sendMessage();
        document.querySelector('.chat-widget').scrollIntoView({behavior: 'smooth'});
    }

    let msgCounter = 0;
    function addMessage(text, type) {
      const history = document.getElementById('chatHistory');
      const div = document.createElement('div');
      div.className = `chat-message ${type}`;
      div.id = 'msg-' + Date.now() + '-' + (msgCounter++);
      div.innerHTML = text;
      history.appendChild(div);
      history.scrollTop = history.scrollHeight;
      return div.id;
    }

    function updateMessage(id, text) {
        const el = document.getElementById(id);
        if(el) el.innerHTML = text;
    }

    function getXsrfToken() {
      const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : null;
    }

    function sendGlobalFeedback(positive) {
      const btn = event.target.closest('button');
      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check"></i>';
      btn.classList.add('text-success');
      setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.classList.remove('text-success');
      }, 2000);
    }
  </script>
</body>
</html>
