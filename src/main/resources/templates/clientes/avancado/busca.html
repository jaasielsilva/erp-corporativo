<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Busca Avançada de Clientes</title>

  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link rel="stylesheet" th:href="@{/css/notifications.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <div class="header-section">
          <div>
            <p class="breadcrumb"><a href="/clientes">Clientes</a> / Avançado / Busca</p>
            <h1>Busca Avançada</h1>
          </div>
        </div>

        <div class="card">
          <div class="toolbar">
            <div class="toolbar-group">
              <label for="avancadoBusca">Termo</label>
              <input type="text" id="avancadoBusca" placeholder="Nome, e-mail, telefone ou documento">
            </div>
            <div class="toolbar-group">
              <label for="avancadoStatus">Status</label>
              <select id="avancadoStatus">
                <option value="">Todos</option>
                <option value="ATIVO">Ativo</option>
                <option value="INATIVO">Inativo</option>
                <option value="PENDENTE">Pendente</option>
              </select>
            </div>
            <div class="toolbar-group">
              <label for="avancadoTipo">Tipo</label>
              <select id="avancadoTipo">
                <option value="">Todos</option>
                <option th:each="tipo : ${tiposCliente}" th:value="${tipo}" th:text="${tipo}"></option>
              </select>
            </div>
            <div class="toolbar-group">
              <label for="avancadoAtivo">Situação</label>
              <select id="avancadoAtivo">
                <option value="">Todos</option>
                <option value="true">Somente ativos</option>
                <option value="false">Inativos</option>
              </select>
            </div>
            <div class="toolbar-group checkbox">
              <label>
                <input type="checkbox" id="avancadoVip">
                Somente VIP
              </label>
            </div>
            <div class="toolbar-group">
              <label for="avancadoSize">Itens</label>
              <select id="avancadoSize">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
            <div class="toolbar-group">
              <button type="button" id="avancadoLimpar" class="btn btn-secondary">
                <i class="fas fa-eraser"></i> Limpar
              </button>
            </div>
          </div>
        </div>

        <article class="card">
          <div id="avancadoLoading" class="loading" style="display:none;">
            <i class="fas fa-spinner fa-spin"></i> Carregando clientes...
          </div>
          <div class="table-responsive">
            <table class="table-list">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Status</th>
                  <th>Tipo</th>
                  <th>VIP</th>
                  <th>Último acesso</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="avancadoBody">
                <tr>
                  <td colspan="7" class="text-center">Carregando clientes...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div id="avancadoPagination" class="pagination"></div>
        </article>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script th:inline="javascript">
    window.avancadoInitialFilters = {
      busca: /*[[${filtros.busca}]]*/ '',
      status: /*[[${filtros.status}]]*/ '',
      tipoCliente: /*[[${filtros.tipoCliente}]]*/ '',
      vip: /*[[${filtros.vip}]]*/ false,
      ativo: /*[[${filtros.ativo}]]*/ '',
      size: /*[[${filtros.pageSize}]]*/ 10
    };
  </script>
  <script>
    const avancadoState = {
      page: 0,
      size: Number(window.avancadoInitialFilters.size) || 10,
      busca: window.avancadoInitialFilters.busca || '',
      status: window.avancadoInitialFilters.status || '',
      tipoCliente: window.avancadoInitialFilters.tipoCliente || '',
      vip: window.avancadoInitialFilters.vip === true || window.avancadoInitialFilters.vip === 'true',
      ativo: window.avancadoInitialFilters.ativo === true || window.avancadoInitialFilters.ativo === 'true'
        ? 'true'
        : (window.avancadoInitialFilters.ativo === false || window.avancadoInitialFilters.ativo === 'false' ? 'false' : '')
    };

    const avancadoElements = {
      busca: document.getElementById('avancadoBusca'),
      status: document.getElementById('avancadoStatus'),
      tipo: document.getElementById('avancadoTipo'),
      ativo: document.getElementById('avancadoAtivo'),
      vip: document.getElementById('avancadoVip'),
      size: document.getElementById('avancadoSize'),
      body: document.getElementById('avancadoBody'),
      pagination: document.getElementById('avancadoPagination'),
      loading: document.getElementById('avancadoLoading'),
      limpar: document.getElementById('avancadoLimpar')
    };

    function renderClientesAvancado(clientes) {
      if (!clientes || clientes.length === 0) {
        avancadoElements.body.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum cliente encontrado.</td></tr>';
        return;
      }
      avancadoElements.body.innerHTML = clientes.map(cliente => `
        <tr>
          <td>${cliente.id ?? '-'}</td>
          <td>${cliente.nomeFantasia && cliente.nomeFantasia.trim() ? cliente.nomeFantasia : (cliente.nome ?? '-')}</td>
          <td>${cliente.status ?? '-'}</td>
          <td>${cliente.tipoCliente ?? '-'}</td>
          <td>
            <span class="status-chip ${cliente.vip ? 'success' : 'muted'}">
              ${cliente.vip ? 'SIM' : 'NÃO'}
            </span>
          </td>
          <td>${cliente.ultimoAcesso ? new Date(cliente.ultimoAcesso).toLocaleString('pt-BR') : '-'}</td>
          <td class="table-actions">
            <a href="/clientes/${cliente.id}/detalhes" class="btn btn-info btn-sm">
              <i class="fas fa-eye"></i> Detalhes
            </a>
          </td>
        </tr>
      `).join('');
    }

    function renderAvancadoPagination(data) {
      const totalPages = data.totalPages || 0;
      const totalElements = data.totalElements || 0;
      const page = data.currentPage || 0;
      const hasPrev = !!data.hasPrevious;
      const hasNext = !!data.hasNext;
      let html = `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} clientes)</span>`;
      html += hasPrev
        ? `<a class="btn btn-secondary" href="#" onclick="return avancadoGoToPage(${page - 1});"><i class="fas fa-chevron-left"></i> Anterior</a>`
        : `<span class="btn btn-secondary disabled"><i class="fas fa-chevron-left"></i> Anterior</span>`;
      html += hasNext
        ? `<a class="btn btn-secondary" href="#" onclick="return avancadoGoToPage(${page + 1});">Próxima <i class="fas fa-chevron-right"></i></a>`
        : `<span class="btn btn-secondary disabled">Próxima <i class="fas fa-chevron-right"></i></span>`;
      avancadoElements.pagination.innerHTML = html;
    }

    function avancadoGoToPage(page) {
      avancadoLoad(Math.max(0, page));
      return false;
    }

    function avancadoBuildParams(page) {
      const params = new URLSearchParams();
      params.set('page', page);
      params.set('size', avancadoState.size);
      if (avancadoState.busca) params.set('busca', avancadoState.busca);
      if (avancadoState.status) params.set('status', avancadoState.status);
      if (avancadoState.tipoCliente) params.set('tipoCliente', avancadoState.tipoCliente);
      if (avancadoState.vip) params.set('vip', true);
      if (avancadoState.ativo) params.set('ativo', avancadoState.ativo);
      return params.toString();
    }

    function avancadoLoad(page = 0) {
      avancadoState.page = page;
      avancadoElements.loading.style.display = 'block';
      fetch(`/clientes/avancado/api/busca?${avancadoBuildParams(page)}`)
        .then(resp => resp.json())
        .then(data => {
          renderClientesAvancado(data.content || []);
          renderAvancadoPagination(data);
        })
        .catch(() => {
          avancadoElements.body.innerHTML = '<tr><td colspan="7" class="text-center">Erro ao carregar clientes.</td></tr>';
          avancadoElements.pagination.innerHTML = '';
        })
        .finally(() => {
          avancadoElements.loading.style.display = 'none';
        });
    }

    function avancadoBindEvents() {
      avancadoElements.busca.value = avancadoState.busca;
      avancadoElements.status.value = avancadoState.status;
      avancadoElements.tipo.value = avancadoState.tipoCliente;
      avancadoElements.ativo.value = avancadoState.ativo;
      avancadoElements.vip.checked = !!avancadoState.vip;
      avancadoElements.size.value = avancadoState.size;

      avancadoElements.busca.addEventListener('input', (e) => {
        avancadoState.busca = e.target.value || '';
        avancadoLoad(0);
      });

      avancadoElements.status.addEventListener('change', (e) => {
        avancadoState.status = e.target.value || '';
        avancadoLoad(0);
      });

      avancadoElements.tipo.addEventListener('change', (e) => {
        avancadoState.tipoCliente = e.target.value || '';
        avancadoLoad(0);
      });

      avancadoElements.ativo.addEventListener('change', (e) => {
        avancadoState.ativo = e.target.value || '';
        avancadoLoad(0);
      });

      avancadoElements.vip.addEventListener('change', (e) => {
        avancadoState.vip = e.target.checked;
        avancadoLoad(0);
      });

      avancadoElements.size.addEventListener('change', (e) => {
        avancadoState.size = Number(e.target.value) || 10;
        avancadoLoad(0);
      });

      avancadoElements.limpar.addEventListener('click', () => {
        avancadoState.busca = '';
        avancadoState.status = '';
        avancadoState.tipoCliente = '';
        avancadoState.vip = false;
        avancadoState.ativo = '';
        avancadoElements.busca.value = '';
        avancadoElements.status.value = '';
        avancadoElements.tipo.value = '';
        avancadoElements.ativo.value = '';
        avancadoElements.vip.checked = false;
        avancadoLoad(0);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      avancadoBindEvents();
      avancadoLoad(0);
    });
  </script>
  <script th:src="@{/js/notifications.js}"></script>
  <script src="/js/sidebar.js" defer></script>
</body>

</html>

