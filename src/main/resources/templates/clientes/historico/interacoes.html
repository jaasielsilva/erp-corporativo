<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Histórico de Interações - Clientes</title>

  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link rel="stylesheet" th:href="@{/css/notifications.css}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <div class="header-section">
          <div>
            <p class="breadcrumb"><a href="/clientes">Clientes</a> / Histórico / Interações</p>
            <h1>Interações com Clientes</h1>
          </div>
        </div>

        <div class="metrics-grid">
          <article class="card metric-card">
            <span>Total de eventos</span>
            <strong id="interacoesTotal" th:text="${totalInteracoes}">0</strong>
          </article>
          <article class="card metric-card success">
            <span>Últimos 7 dias</span>
            <strong id="interacoes7dias" th:text="${interacoes7dias}">0</strong>
          </article>
          <article class="card metric-card warning">
            <span>Últimos 30 dias</span>
            <strong id="interacoes30dias" th:text="${interacoes30dias}">0</strong>
          </article>
          <article class="card metric-card">
            <span>Principais canais</span>
            <strong id="interacoesCanalDestaque"
              th:text="${#lists.isEmpty(canalDistribuicao) ? '-' : canalDistribuicao.keySet().iterator().next()}">-</strong>
          </article>
        </div>

        <div class="card">
          <div class="toolbar">
            <div class="toolbar-group">
              <label for="interacoesBusca">Busca rápida</label>
              <input type="text" id="interacoesBusca" placeholder="Cliente, responsável ou resumo">
            </div>
            <div class="toolbar-group">
              <label for="interacoesCanal">Canal</label>
              <select id="interacoesCanal">
                <option value="">Todos</option>
                <option value="CADASTRO">Cadastro</option>
                <option value="ATUALIZACAO">Atualização</option>
                <option value="PORTAL">Portal</option>
                <option value="ANOTACAO">Anotações</option>
              </select>
            </div>
            <div class="toolbar-group">
              <label for="interacoesSize">Itens</label>
              <select id="interacoesSize">
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
            <div class="toolbar-group">
              <button type="button" id="interacoesLimpar" class="btn btn-secondary">
                <i class="fas fa-eraser"></i> Limpar
              </button>
            </div>
          </div>
        </div>

        <article class="card">
          <div id="interacoesLoading" class="loading" style="display:none;">
            <i class="fas fa-spinner fa-spin"></i> Carregando interações...
          </div>
          <div class="table-responsive">
            <table class="table-list">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Cliente</th>
                  <th>Canal</th>
                  <th>Responsável</th>
                  <th>Resumo</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="interacoesBody">
                <tr>
                  <td colspan="6" class="text-center">Carregando interações...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div id="interacoesPagination" class="pagination"></div>
        </article>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script th:inline="javascript">
    window.interacoesInitialFilters = {
      busca: /*[[${filtros.busca}]]*/ '',
      canal: /*[[${filtros.canal}]]*/ '',
      size: 10
    };
  </script>
  <script>
    const interacoesState = {
      page: 0,
      size: window.interacoesInitialFilters.size || 10,
      busca: window.interacoesInitialFilters.busca || '',
      canal: window.interacoesInitialFilters.canal || ''
    };

    const interacoesElements = {
      busca: document.getElementById('interacoesBusca'),
      canal: document.getElementById('interacoesCanal'),
      size: document.getElementById('interacoesSize'),
      body: document.getElementById('interacoesBody'),
      pagination: document.getElementById('interacoesPagination'),
      loading: document.getElementById('interacoesLoading'),
      limpar: document.getElementById('interacoesLimpar'),
      total: document.getElementById('interacoesTotal')
    };

    function renderInteracoesRows(interacoes) {
      if (!interacoes || interacoes.length === 0) {
        interacoesElements.body.innerHTML = '<tr><td colspan="6" class="text-center">Nenhuma interação encontrada.</td></tr>';
        return;
      }

      interacoesElements.body.innerHTML = interacoes.map(i => `
        <tr>
          <td>${i.data ? new Date(i.data).toLocaleString('pt-BR') : '-'}</td>
          <td>${i.clienteNome ?? '-'}</td>
          <td>${i.canal ?? '-'}</td>
          <td>${i.responsavel ?? '-'}</td>
          <td>${i.resumo ?? '-'}</td>
          <td class="table-actions">
            ${i.clienteId ? `<a href="/clientes/${i.clienteId}/detalhes" class="btn btn-link btn-sm">Ver cliente</a>` : ''}
          </td>
        </tr>
      `).join('');
    }

    function renderInteracoesPagination(data) {
      const totalPages = data.totalPages || 0;
      const totalElements = data.totalElements || 0;
      const page = data.currentPage || 0;
      const hasPrev = !!data.hasPrevious;
      const hasNext = !!data.hasNext;
      let html = `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} registros)</span>`;
      html += hasPrev
        ? `<a class="btn btn-secondary" href="#" onclick="return interacoesGoToPage(${page - 1});"><i class="fas fa-chevron-left"></i> Anterior</a>`
        : `<span class="btn btn-secondary disabled"><i class="fas fa-chevron-left"></i> Anterior</span>`;
      html += hasNext
        ? `<a class="btn btn-secondary" href="#" onclick="return interacoesGoToPage(${page + 1});">Próxima <i class="fas fa-chevron-right"></i></a>`
        : `<span class="btn btn-secondary disabled">Próxima <i class="fas fa-chevron-right"></i></span>`;
      interacoesElements.pagination.innerHTML = html;
      if (interacoesElements.total) {
        interacoesElements.total.textContent = totalElements;
      }
    }

    function interacoesGoToPage(page) {
      interacoesLoad(Math.max(0, page));
      return false;
    }

    function interacoesBuildParams(page) {
      const params = new URLSearchParams();
      params.set('page', page);
      params.set('size', interacoesState.size);
      if (interacoesState.busca) params.set('busca', interacoesState.busca);
      if (interacoesState.canal) params.set('canal', interacoesState.canal);
      return params.toString();
    }

    function interacoesLoad(page = 0) {
      interacoesState.page = page;
      interacoesElements.loading.style.display = 'block';
      fetch(`/clientes/historico/api/interacoes?${interacoesBuildParams(page)}`)
        .then(resp => resp.json())
        .then(data => {
          renderInteracoesRows(data.content || []);
          renderInteracoesPagination(data);
        })
        .catch(() => {
          interacoesElements.body.innerHTML = '<tr><td colspan="6" class="text-center">Erro ao carregar interações.</td></tr>';
          interacoesElements.pagination.innerHTML = '';
        })
        .finally(() => {
          interacoesElements.loading.style.display = 'none';
        });
    }

    function interacoesBindEvents() {
      interacoesElements.busca.value = interacoesState.busca;
      interacoesElements.canal.value = interacoesState.canal;
      interacoesElements.size.value = interacoesState.size;

      interacoesElements.busca.addEventListener('input', (e) => {
        interacoesState.busca = e.target.value || '';
        interacoesLoad(0);
      });

      interacoesElements.canal.addEventListener('change', (e) => {
        interacoesState.canal = e.target.value || '';
        interacoesLoad(0);
      });

      interacoesElements.size.addEventListener('change', (e) => {
        interacoesState.size = Number(e.target.value) || 10;
        interacoesLoad(0);
      });

      interacoesElements.limpar.addEventListener('click', () => {
        interacoesState.busca = '';
        interacoesState.canal = '';
        interacoesElements.busca.value = '';
        interacoesElements.canal.value = '';
        interacoesLoad(0);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      interacoesBindEvents();
      interacoesLoad(0);
    });
  </script>
  <script th:src="@{/js/notifications.js}"></script>
  <script src="/js/sidebar.js" defer></script>
</body>

</html>

