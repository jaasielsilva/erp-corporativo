<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"> <!-- define UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- responsivo -->
    <title>Topbar - ERP Corporativo</title>
    <link rel="stylesheet" href="/css/fontawesome.min.css"/>
</head>
<body>
    <header class="topbar" th:fragment="topbar" th:inline="text">
        <div class="topbar-title">
            <h1>Sistema ERP Corporativo</h1>
        </div>
        <div class="topbar-actions">
            <!-- Notificações -->
            <a href="#" class="notification-trigger topbar-btn" title="Notificações">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" style="display: none;">0</span>
            </a>

            <!-- Usuário -->
            <a th:if="${usuarioLogado != null}"
               th:href="@{/usuarios/{id}/editar(id=${usuarioLogado.id})}"
               class="user-initial" title="Meu Perfil"
               th:text="${usuarioLogado.nome.substring(0,1).toUpperCase()}">U</a>
            <a th:if="${usuarioLogado == null}"
               href="/usuarios"
               class="user-initial" title="Usuário">
               U
            </a>
            <span class="user-name" th:text="${usuarioLogado != null ? usuarioLogado.nome : 'Usuário'}">Usuário</span>
        </div>

        <!-- Email do usuário para WebSocket global (injeta via Thymeleaf corretamente) -->
        <div data-user-email="[[${#httpServletRequest.remoteUser != null ? #httpServletRequest.remoteUser : ''}]]" style="display:none;"></div>

        <!-- Toast global (top-right) -->
        <div id="global-toast-container" style="position:fixed;top:12px;right:12px;z-index:9999;display:none;">
            <div id="global-toast" style="min-width:280px;max-width:420px;background:#1f2937;color:#fff;padding:10px 12px;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.2);display:flex;align-items:center;gap:8px">
                <i class="fas fa-info-circle" aria-hidden="true"></i>
                <div id="global-toast-body" style="font-size:14px;line-height:1.4">Mensagem</div>
                <button type="button" aria-label="Fechar" style="margin-left:auto;background:transparent;border:none;color:#fff;opacity:.8;cursor:pointer;font-size:16px" onclick="(function(){var c=document.getElementById('global-toast-container'); if(c) c.style.display='none';})()">&times;</button>
            </div>
        </div>

        <!-- jQuery fallback (para toasts) -->
        <script>
            if (typeof window.jQuery === 'undefined') {
                var jq = document.createElement('script');
                jq.src = 'https://code.jquery.com/jquery-3.7.0.min.js';
                document.head.appendChild(jq);
            }
        </script>

        <!-- Cliente WebSocket global para toasts -->
        <script src="/js/websocket-notifications.js"></script>
        <script>
            window.globalToast = function(message, icon){
                try {
                    var cont = document.getElementById('global-toast-container');
                    var body = document.getElementById('global-toast-body');
                    var iconEl = document.querySelector('#global-toast i');
                    if (!cont || !body || !iconEl) return;
                    body.textContent = String(message || '');
                    iconEl.className = icon ? icon : 'fas fa-info-circle';
                    cont.style.display = 'block';
                    clearTimeout(window.__globalToastTimer);
                    window.__globalToastTimer = setTimeout(function(){ cont.style.display='none'; }, 4000);
                } catch (e) {}
            };
        </script>
    </header>
</body>
</html>
