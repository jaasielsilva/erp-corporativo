<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"> <!-- define UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- responsivo -->
    <title>Topbar - ERP Corporativo</title>
    <link rel="stylesheet" href="/css/fontawesome.min.css"/>
</head>
<body>
    <header class="topbar" th:fragment="topbar" th:inline="text">
        <div class="topbar-title">
            <h1>Sistema ERP Corporativo</h1>
        </div>
        <div class="topbar-actions">
            <!-- Notificações -->
            <a href="#" class="notification-trigger topbar-btn" title="Notificações">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" style="display: none;">0</span>
            </a>

            <!-- Usuário -->
            <a th:if="${usuarioLogado != null}"
               th:href="@{/usuarios/{id}/editar(id=${usuarioLogado.id})}"
               class="user-initial" title="Meu Perfil"
               th:text="${usuarioLogado.nome.substring(0,1).toUpperCase()}">U</a>
            <a th:if="${usuarioLogado == null}"
               href="/usuarios"
               class="user-initial" title="Usuário">
               U
            </a>
            <span class="user-name" th:text="${usuarioLogado != null ? usuarioLogado.nome : 'Usuário'}">Usuário</span>
        </div>

        <!-- Email do usuário para WebSocket global (injeta via Thymeleaf corretamente) -->
        <div data-user-email="[[${#httpServletRequest.remoteUser != null ? #httpServletRequest.remoteUser : ''}]]" style="display:none;"></div>

        <!-- Toast global padronizado -->
        <div id="global-toast" class="notification-toast priority-medium" style="display:none;">
            <div class="toast-icon"><i class="fas fa-info-circle"></i></div>
            <div class="toast-content"><p id="global-toast-body">Mensagem</p></div>
            <button type="button" class="toast-close" aria-label="Fechar" onclick="(function(){var t=document.getElementById('global-toast'); if(t){ t.classList.remove('show'); t.style.display='none'; }})()">&times;</button>
        </div>

        <!-- jQuery fallback (para toasts) -->
        <script>
            if (typeof window.jQuery === 'undefined') {
                var jq = document.createElement('script');
                jq.src = 'https://code.jquery.com/jquery-3.7.0.min.js';
                document.head.appendChild(jq);
            }
        </script>

        <!-- Cliente WebSocket global para toasts -->
        <script src="/js/websocket-notifications.js"></script>
        <script>
            window.globalToast = function(message, icon, level){
                try {
                    var toast = document.getElementById('global-toast');
                    var body = document.getElementById('global-toast-body');
                    var iconEl = toast ? toast.querySelector('.toast-icon i') : null;
                    if (!toast || !body || !iconEl) return;
                    var msg = String(message || '').trim();
                    if (msg.length > 140) msg = msg.substring(0, 137) + '…';
                    body.textContent = msg;
                    iconEl.className = icon ? icon : 'fas fa-info-circle';
                    toast.classList.remove('priority-low','priority-medium','priority-high');
                    var lvl = (level || 'medium').toLowerCase();
                    toast.classList.add('priority-' + (lvl === 'error' ? 'high' : lvl));
                    toast.style.display = 'block';
                    // animação show
                    toast.classList.add('show');
                    clearTimeout(window.__globalToastTimer);
                    window.__globalToastTimer = setTimeout(function(){ toast.classList.remove('show'); toast.style.display='none'; }, 4000);
                } catch (e) {}
            };
        </script>
    </header>
</body>
</html>
