<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"> <!-- define UTF-8 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- responsivo -->
    <title>Topbar - ERP Corporativo</title>
    <link rel="stylesheet" href="/css/fontawesome.min.css"/>
</head>
<body>
    <header class="topbar" th:fragment="topbar" th:inline="text">
        <div class="topbar-title">
            <h1>Sistema ERP Corporativo</h1>
        </div>
        <div class="topbar-actions">
            <button type="button" class="menu-toggle topbar-btn" aria-label="Abrir menu">
                <i class="fas fa-bars"></i>
            </button>
            <!-- Notificações -->
            <a href="#" class="notification-trigger topbar-btn" title="Notificações">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" style="display: none;">0</span>
            </a>

            <!-- Usuário -->
            <a th:if="${usuarioLogado != null}"
               th:href="@{/usuarios/{id}/editar(id=${usuarioLogado.id})}"
               class="user-initial" title="Meu Perfil"
               th:text="${usuarioLogado.nome.substring(0,1).toUpperCase()}">U</a>
            <a th:if="${usuarioLogado == null}"
               href="/usuarios"
               class="user-initial" title="Usuário">
               U
            </a>
            <span class="user-name" th:text="${usuarioLogado != null ? usuarioLogado.nome : 'Usuário'}">Usuário</span>
        </div>

        <!-- Email do usuário para WebSocket global (injeta via Thymeleaf corretamente) -->
        <div data-user-email="[[${#httpServletRequest.remoteUser != null ? #httpServletRequest.remoteUser : ''}]]" style="display:none;"></div>

        <!-- Toast global padronizado -->
        <div id="global-toast" class="notification-toast priority-medium" style="display:none;">
            <div class="toast-icon"><i class="fas fa-info-circle"></i></div>
            <div class="toast-content"><p id="global-toast-body">Mensagem</p></div>
            <button type="button" class="toast-close" aria-label="Fechar" onclick="(function(){var t=document.getElementById('global-toast'); if(t){ t.classList.remove('show'); t.style.display='none'; }})()">&times;</button>
        </div>

        <!-- jQuery fallback (para toasts) -->
        <script>
            if (typeof window.jQuery === 'undefined') {
                var jq = document.createElement('script');
                jq.src = 'https://code.jquery.com/jquery-3.7.0.min.js';
                document.head.appendChild(jq);
            }
        </script>

        <!-- Cliente WebSocket global para toasts -->
        <script src="/js/websocket-notifications.js"></script>
        <script>
            (function(){
                if (typeof window.Swal === 'undefined') {
                    var sw = document.createElement('script');
                    sw.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
                    document.head.appendChild(sw);
                }
                function showGlobalResult(st){
                    try {
                        var total = st.total || 0;
                        var ok = st.processados || 0;
                        var logs = Array.isArray(st.logs) ? st.logs : [];
                        var erros = logs.filter(function(l){ return l && l.status === 'erro'; });
                        var pageSize = 10;
                        var page = 0;
                        var baseHtml =
                          '<div><strong>Processados:</strong> ' + ok + ' de ' + total + '</div>' +
                          (erros.length ? (
                            '<div class="mt-2"><strong>Falhas (' + erros.length + '):</strong>' +
                            '<div id="errorsContainer" style="max-height:220px;overflow:auto;border:1px solid #eee;padding:6px;border-radius:4px"></div>' +
                            '<div class="mt-2 d-flex justify-content-between align-items-center">' +
                              '<button id="errPrev" class="btn btn-sm btn-outline-secondary">Anterior</button>' +
                              '<span id="errPageInfo" class="small text-muted"></span>' +
                              '<button id="errNext" class="btn btn-sm btn-outline-secondary">Próxima</button>' +
                            '</div>' +
                            '</div>'
                          ) : '');
                        function renderPage(){
                            var start = page * pageSize;
                            var slice = erros.slice(start, start + pageSize);
                            var container = document.getElementById('errorsContainer');
                            var info = document.getElementById('errPageInfo');
                            if (container) {
                                container.innerHTML = slice.map(function(e){
                                    return '<div>- ' + (e.colaborador || '-') + ' (' + (e.colaboradorId || '-') + ') • ' + (e.exception || '') + ' • ' + (e.mensagem || '') + '</div>';
                                }).join('') || '<div>Nenhum erro</div>';
                            }
                            if (info) {
                                var totalPages = Math.max(1, Math.ceil(erros.length / pageSize));
                                info.textContent = 'Página ' + (page + 1) + ' de ' + totalPages;
                            }
                            var prev = document.getElementById('errPrev');
                            var next = document.getElementById('errNext');
                            if (prev) prev.disabled = page === 0;
                            if (next) next.disabled = (page + 1) * pageSize >= erros.length;
                        }
                        function showSwal(){
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    title: st.success ? 'Sucesso' : 'Concluído com falhas',
                                    html: baseHtml,
                                    icon: st.success ? 'success' : 'warning',
                                    didOpen: function(){
                                        renderPage();
                                        var prev = document.getElementById('errPrev');
                                        var next = document.getElementById('errNext');
                                        if (prev) prev.addEventListener('click', function(){ if (page > 0) { page--; renderPage(); } });
                                        if (next) next.addEventListener('click', function(){ if ((page + 1) * pageSize < erros.length) { page++; renderPage(); } });
                                    }
                                });
                            } else if (typeof window.globalToast === 'function') {
                                window.globalToast((st.success ? 'Geração automática concluída' : 'Concluída com falhas') + ' (' + ok + '/' + total + ')', 'fas fa-info-circle', st.success ? 'medium' : 'high');
                            }
                        }
                        showSwal();
                    } catch(e){}
                }
                function pollJob(jobId){
                    if (window.__jobPollTimer && window.__jobPollingJobId === jobId) { return; }
                    if (window.__jobPollTimer) { try { clearInterval(window.__jobPollTimer); } catch(e){} }
                    window.__jobPollingJobId = jobId;
                    var polled = false;
                    window.__jobPollTimer = setInterval(function(){
                        fetch('/rh/ponto-escalas/api/escalas/gerar-automatico/status?jobId=' + encodeURIComponent(jobId))
                            .then(function(r){ return r.json(); })
                            .then(function(st){
                                if (st && st.success && st.running === false && !polled) {
                                    polled = true;
                                    try { clearInterval(window.__jobPollTimer); } catch(e){}
                                    window.__jobPollTimer = null;
                                    window.__jobPollingJobId = null;
                                    try {
                                        localStorage.setItem('gerarJobAlertShown', jobId);
                                        localStorage.removeItem('gerarJobId');
                                    } catch(e){}
                                    showGlobalResult(st);
                                }
                            })
                            .catch(function(){});
                    }, 2000);
                }
                try {
                    var existing = localStorage.getItem('gerarJobId');
                    var shown = localStorage.getItem('gerarJobAlertShown');
                    if (existing && existing !== shown) {
                        if (!window.__jobPollTimer || window.__jobPollingJobId !== existing) { pollJob(existing); }
                    }
                    window.__globalJobListener = setInterval(function(){
                        try {
                            var jid = localStorage.getItem('gerarJobId');
                            var shownId = localStorage.getItem('gerarJobAlertShown');
                            if (jid && jid !== shownId) {
                                if (!window.__jobPollTimer || window.__jobPollingJobId !== jid) { pollJob(jid); }
                            }
                        } catch(e){}
                    }, 5000);
                } catch(e){}
            })();
        </script>
        <script>
            window.globalToast = function(message, icon, level){
                try {
                    var toast = document.getElementById('global-toast');
                    var body = document.getElementById('global-toast-body');
                    var iconEl = toast ? toast.querySelector('.toast-icon i') : null;
                    if (!toast || !body || !iconEl) return;
                    var msg = String(message || '').trim();
                    if (msg.length > 140) msg = msg.substring(0, 137) + '…';
                    body.textContent = msg;
                    iconEl.className = icon ? icon : 'fas fa-info-circle';
                    toast.classList.remove('priority-low','priority-medium','priority-high');
                    var lvl = (level || 'medium').toLowerCase();
                    toast.classList.add('priority-' + (lvl === 'error' ? 'high' : lvl));
                    toast.style.display = 'block';
                    // animação show
                    toast.classList.add('show');
                    clearTimeout(window.__globalToastTimer);
                    window.__globalToastTimer = setTimeout(function(){ toast.classList.remove('show'); toast.style.display='none'; }, 4000);
                } catch (e) {}
            };
        </script>
    </header>
</body>
</html>
