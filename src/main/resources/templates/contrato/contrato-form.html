<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${contrato.id != null} ? 'Editar Contrato - Portal CEO' : 'Novo Contrato - Portal CEO'">Contrato</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="/css/corporate.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        .form-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .form-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .form-section-title {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6c757d;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f1f3f5;
        }

        .form-label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9rem;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.6rem 1rem;
            border-color: #dee2e6;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.15);
        }

        .btn-action {
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>

        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>

            <section class="content-area">
                <div class="container-fluid py-4">
                    <!-- Header -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-1">
                                    <li class="breadcrumb-item"><a href="/contratos" class="text-decoration-none text-muted">Contratos</a></li>
                                    <li class="breadcrumb-item active" aria-current="page" th:text="${contrato.id != null} ? 'Editar' : 'Novo'">Novo</li>
                                </ol>
                            </nav>
                            <h1 class="display-6 fw-bold text-dark mb-0" th:text="${contrato.id != null} ? 'Editar Contrato' : 'Novo Contrato'">Novo Contrato</h1>
                        </div>
                    </div>

                    <!-- Form Card -->
                    <div class="row justify-content-center">
                        <div class="col-lg-10">
                            <div class="form-card">
                                <form th:action="@{/contratos/salvar}" th:object="${contrato}" method="post">
                                    <input type="hidden" th:field="*{id}" />
                                    
                                    <div class="p-4">
                                        <!-- Informações Gerais -->
                                        <div class="form-section-title"><i class="fas fa-info-circle me-2"></i>Informações Gerais</div>
                                        
                                        <div class="row g-4 mb-4">
                                            <div class="col-md-4">
                                                <label for="numeroContrato" class="form-label">Número do Contrato</label>
                                                <div class="input-group">
                                                    <span class="input-group-text bg-light"><i class="fas fa-hashtag text-muted"></i></span>
                                                    <input type="text" class="form-control bg-light" id="numeroContrato" th:field="*{numeroContrato}" readonly />
                                                </div>
                                                <div class="form-text text-muted small">Gerado automaticamente pelo sistema</div>
                                            </div>

                                            <div class="col-md-4">
                                                <label for="tipo" class="form-label">Tipo de Contrato <span class="text-danger">*</span></label>
                                                <select class="form-select" id="tipo" th:field="*{tipo}" required>
                                                    <option value="">-- Selecione --</option>
                                                    <option th:each="tipo : ${tiposContrato}" th:value="${tipo}" th:text="${tipo}"></option>
                                                </select>
                                            </div>

                                            <div class="col-md-4">
                                                <label for="status" class="form-label">Status <span class="text-danger">*</span></label>
                                                <select class="form-select" id="status" th:field="*{status}" required>
                                                    <option th:each="status : ${statusContrato}" th:value="${status}" th:text="${status}">Status</option>
                                                </select>
                                            </div>

                                            <div class="col-12">
                                                <label for="descricao" class="form-label">Objeto / Descrição</label>
                                                <textarea class="form-control" id="descricao" th:field="*{descricao}" rows="3" placeholder="Descreva o objeto do contrato..."></textarea>
                                            </div>
                                        </div>

                                        <!-- Valores e Datas -->
                                        <div class="form-section-title"><i class="fas fa-calendar-alt me-2"></i>Vigência e Valores</div>

                                        <div class="row g-4 mb-4">
                                            <div class="col-md-4">
                                                <label for="valorVisual" class="form-label" id="label-valor">Valor Total <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text">R$</span>
                                                    <input type="text" class="form-control" id="valorVisual" required placeholder="0,00" />
                                                    <input type="hidden" id="valorReal" th:field="*{valor}" />
                                                </div>
                                            </div>

                                            <div class="col-md-4">
                                                <label for="dataInicio" class="form-label">Data Início <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="dataInicio" th:field="*{dataInicio}" required />
                                            </div>

                                            <div class="col-md-4">
                                                <label for="dataFim" class="form-label">Data Fim <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control" id="dataFim" th:field="*{dataFim}" required />
                                            </div>
                                        </div>

                                        <!-- Partes Envolvidas -->
                                        <div class="form-section-title"><i class="fas fa-users me-2"></i>Partes Envolvidas</div>

                                        <div class="row g-4 mb-4">
                                            <div class="col-md-6">
                                                <label class="form-label">Departamento Interno</label>
                                                <input type="text" class="form-control bg-light" th:value="${departamentoUsuario != null ? departamentoUsuario.nome : 'N/A'}" readonly disabled />
                                            </div>

                                            <!-- Campos Dinâmicos -->
                                            <div class="col-md-6 vinculo" id="vinculo-fornecedor" style="display:none;">
                                                <label for="fornecedor" class="form-label">Fornecedor Vinculado</label>
                                                <select class="form-select" id="fornecedor" th:field="*{fornecedor}">
                                                    <option value="">-- Selecione o Fornecedor --</option>
                                                    <option th:each="f : ${fornecedores}" th:value="${f.id}" th:text="${f.razaoSocial}"></option>
                                                </select>
                                            </div>

                                            <div class="col-md-6 vinculo" id="vinculo-cliente" style="display:none;">
                                                <label for="cliente" class="form-label">Cliente Vinculado</label>
                                                <select class="form-select" id="cliente" th:field="*{cliente}">
                                                    <option value="">-- Selecione o Cliente --</option>
                                                </select>
                                                <div class="input-group mt-2">
                                                    <span class="input-group-text bg-light"><i class="fas fa-search text-muted"></i></span>
                                                    <input type="text" class="form-control" id="clienteBusca" placeholder="Buscar cliente...">
                                                    <button class="btn btn-outline-secondary" type="button" id="clienteBuscarBtn">Buscar</button>
                                                </div>
                                                <div class="mt-2">
                                                    <label class="form-label" for="clienteTipo">Tipo de Cliente</label>
                                                    <select class="form-select" id="clienteTipo">
                                                        <option value="">Todos</option>
                                                        <option value="PF">Pessoa Física (PF)</option>
                                                        <option value="PJ">Pessoa Jurídica (PJ)</option>
                                                    </select>
                                                </div>
                                                <div class="position-relative mt-2">
                                                    <div id="clienteSugestoes" class="list-group shadow-sm" style="display:none; max-height: 240px; overflow:auto;"></div>
                                                </div>
                                            </div>

                                            <div class="col-md-6 vinculo" id="vinculo-prestador" style="display:none;">
                                                <label for="prestadorServico" class="form-label">Prestador de Serviço</label>
                                                <select class="form-select" id="prestadorServico" th:field="*{prestadorServico}">
                                                    <option value="">-- Selecione o Prestador --</option>
                                                    <option th:each="p : ${prestadoresServico}" th:value="${p.id}" th:text="${p.nome}"></option>
                                                </select>
                                            </div>

                                            <div class="col-md-6 vinculo" id="vinculo-colaborador" style="display:none;">
                                                <label for="colaborador" class="form-label">Colaborador</label>
                                                <select class="form-select" id="colaborador" th:field="*{colaborador}">
                                                    <option value="">-- Selecione o Colaborador --</option>
                                                    <option th:each="col : ${colaboradores}" th:value="${col.id}" th:text="${col.nome}"></option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-header bg-light d-flex justify-content-end gap-2 border-top">
                                        <a th:href="@{/contratos}" class="btn btn-light border btn-action">Cancelar</a>
                                        <button type="submit" class="btn btn-primary btn-action"><i class="fas fa-save me-2"></i>Salvar Contrato</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sidebar.js" defer></script>
    <script th:src="@{/js/notifications.js}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tipoSelect = document.getElementById('tipo');
            const labelValor = document.getElementById('label-valor');
            const vinculos = {
                'FORNECEDOR': document.getElementById('vinculo-fornecedor'),
                'CLIENTE': document.getElementById('vinculo-cliente'),
                'PRESTACAO_SERVICO': document.getElementById('vinculo-prestador'),
                'TRABALHISTA': document.getElementById('vinculo-colaborador')
            };
            const fornecedorSelect = document.getElementById('fornecedor');
            const clienteSelectEl = document.getElementById('cliente');
            const prestadorSelect = document.getElementById('prestadorServico');
            const colaboradorSelect = document.getElementById('colaborador');

            function ajustarVisibilidade() {
                const tipo = tipoSelect.value;
                
                // Hide all
                Object.values(vinculos).forEach(el => {
                    if(el) {
                        el.style.display = 'none';
                    }
                });

                // Show relevant
                if (vinculos[tipo]) {
                    vinculos[tipo].style.display = 'block';
                    vinculos[tipo].classList.add('fade-in');
                }

                // Update label
                if (labelValor) {
                    switch (tipo) {
                        case 'FORNECEDOR': labelValor.innerHTML = 'Valor Total <span class="text-danger">*</span>'; break;
                        case 'CLIENTE': labelValor.innerHTML = 'Valor do Contrato <span class="text-danger">*</span>'; break;
                        case 'PRESTACAO_SERVICO': labelValor.innerHTML = 'Valor do Serviço <span class="text-danger">*</span>'; break;
                        case 'TRABALHISTA': labelValor.innerHTML = 'Salário Mensal <span class="text-danger">*</span>'; break;
                        default: labelValor.innerHTML = 'Valor <span class="text-danger">*</span>'; break;
                    }
                }
                if (tipo === 'CLIENTE') {
                    if (window.carregarClientes) {
                        window.carregarClientes(document.getElementById('clienteBusca') ? document.getElementById('clienteBusca').value : '', 0);
                    }
                }
                if (fornecedorSelect) fornecedorSelect.required = tipo === 'FORNECEDOR';
                if (clienteSelectEl) clienteSelectEl.required = tipo === 'CLIENTE';
                if (prestadorSelect) prestadorSelect.required = tipo === 'PRESTACAO_SERVICO';
                if (colaboradorSelect) colaboradorSelect.required = tipo === 'TRABALHISTA';
            }

            tipoSelect.addEventListener('change', ajustarVisibilidade);
            
            // Initial run
            ajustarVisibilidade();

            // Formatação de Moeda
            const valorVisual = document.getElementById('valorVisual');
            const valorReal = document.getElementById('valorReal');

            function formatarMoeda(valor) {
                if (!valor) return '';
                // Garante que é tratado como número
                let numero = parseFloat(valor);
                if (isNaN(numero)) return '';
                
                // Formata para pt-BR
                return numero.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // Inicializa o valor visual se já houver valor salvo
            if (valorReal.value) {
                valorVisual.value = formatarMoeda(valorReal.value);
            }

            valorVisual.addEventListener('input', function(e) {
                let value = e.target.value;
                
                // Remove tudo que não é dígito
                value = value.replace(/\D/g, "");
                
                if (value === "") {
                    valorVisual.value = "";
                    valorReal.value = "";
                    return;
                }
                
                // Converte para decimal (dividir por 100)
                const decimalValue = parseInt(value) / 100;
                
                // Atualiza o input visual formatado
                e.target.value = decimalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                // Atualiza o input hidden com formato padrão de ponto (ex: 1234.56)
                // Usando toFixed(2) para garantir 2 casas decimais e ponto
                valorReal.value = decimalValue.toFixed(2);
            });

            const clienteSelect = document.getElementById('cliente');
            const clienteBuscaInput = document.getElementById('clienteBusca');
            const clienteBuscarBtn = document.getElementById('clienteBuscarBtn');
            const clienteSugestoes = document.getElementById('clienteSugestoes');
            let clienteBuscaTimer;
            let sugestaoIndex = -1;
            window.carregarClientes = function(q, page) {
                const params = new URLSearchParams({
                    busca: q || '',
                    tipo: (document.getElementById('clienteTipo') ? document.getElementById('clienteTipo').value : ''),
                    page: page || 0,
                    size: 20
                });
                fetch('/clientes/api/select?' + params.toString())
                    .then(r => r.json())
                    .then(data => {
                        if (!clienteSelect) return;
                        clienteSelect.innerHTML = '<option value="">-- Selecione o Cliente --</option>';
                        (data.content || []).forEach(item => {
                            const opt = document.createElement('option');
                            opt.value = item.id;
                            opt.textContent = item.nome;
                            clienteSelect.appendChild(opt);
                        });
                    })
                    .catch(() => {});
            };
            function renderSugestoes(q) {
                if (clienteSugestoes) {
                    clienteSugestoes.style.display = 'block';
                    clienteSugestoes.innerHTML = '<div class="list-group-item"><span class="spinner-border spinner-border-sm me-2"></span>Carregando...</div>';
                }
                const params = new URLSearchParams({
                    busca: q || '',
                    tipo: (document.getElementById('clienteTipo') ? document.getElementById('clienteTipo').value : ''),
                    page: 0,
                    size: 5
                });
                fetch('/clientes/api/select?' + params.toString())
                    .then(r => r.json())
                    .then(data => {
                        if (!clienteSugestoes) return;
                        const list = data.content || [];
                        if (list.length === 0) {
                            clienteSugestoes.style.display = 'none';
                            clienteSugestoes.innerHTML = '';
                            return;
                        }
                        clienteSugestoes.innerHTML = '';
                        sugestaoIndex = -1;
                        list.forEach(item => {
                            const tipo = item.tipoCliente || '';
                            const status = item.status || '';
                            const el = document.createElement('a');
                            el.href = 'javascript:void(0)';
                            el.className = 'list-group-item list-group-item-action';
                            el.innerHTML = '<div class="d-flex w-100 justify-content-between"><div><small class="text-muted d-block">Cliente (' + (tipo || '—') + ')</small><strong>' + (item.nome || '') + '</strong></div><small class="text-muted">' + (tipo || '') + ' | ' + (status || '') + '</small></div>';
                            el.addEventListener('click', function() {
                                let found = false;
                                for (let i = 0; i < clienteSelect.options.length; i++) {
                                    if (String(clienteSelect.options[i].value) === String(item.id)) {
                                        found = true;
                                        break;
                                    }
                                }
                                if (!found) {
                                    const opt = document.createElement('option');
                                    opt.value = item.id;
                                    opt.textContent = item.nome;
                                    clienteSelect.appendChild(opt);
                                }
                                clienteSelect.value = item.id;
                                clienteSugestoes.style.display = 'none';
                                clienteSugestoes.innerHTML = '';
                            });
                            clienteSugestoes.appendChild(el);
                        });
                        clienteSugestoes.style.display = 'block';
                    })
                    .catch(() => {
                        if (clienteSugestoes) {
                            clienteSugestoes.style.display = 'none';
                            clienteSugestoes.innerHTML = '';
                        }
                    });
            }
            function updateActiveSuggestion() {
                const items = clienteSugestoes ? clienteSugestoes.querySelectorAll('.list-group-item') : [];
                items.forEach((el, idx) => {
                    if (idx === sugestaoIndex) el.classList.add('active');
                    else el.classList.remove('active');
                });
            }
            function selectSuggestionByIndex() {
                const items = clienteSugestoes ? clienteSugestoes.querySelectorAll('.list-group-item') : [];
                const el = items[sugestaoIndex];
                if (!el) return;
                const nameEl = el.querySelector('strong');
                const title = nameEl ? nameEl.textContent : '';
                const tipoTextEl = el.querySelector('.text-muted');
                const idOpt = Array.from(clienteSelect.options).find(o => o.textContent === title);
                if (idOpt) {
                    clienteSelect.value = idOpt.value;
                } else {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = title;
                    clienteSelect.appendChild(opt);
                    clienteSelect.value = opt.value;
                }
                if (clienteSugestoes) {
                    clienteSugestoes.style.display = 'none';
                    clienteSugestoes.innerHTML = '';
                }
            }
            if (clienteBuscarBtn) {
                clienteBuscarBtn.addEventListener('click', function() {
                    window.carregarClientes(clienteBuscaInput ? clienteBuscaInput.value : '', 0);
                });
            }
            const clienteTipoSelect = document.getElementById('clienteTipo');
            if (clienteTipoSelect) {
                clienteTipoSelect.addEventListener('change', function() {
                    window.carregarClientes(clienteBuscaInput ? clienteBuscaInput.value : '', 0);
                    renderSugestoes(clienteBuscaInput ? clienteBuscaInput.value : '');
                });
            }
            if (clienteBuscaInput) {
                clienteBuscaInput.addEventListener('input', function() {
                    clearTimeout(clienteBuscaTimer);
                    clienteBuscaTimer = setTimeout(function() {
                        window.carregarClientes(clienteBuscaInput.value, 0);
                        renderSugestoes(clienteBuscaInput.value);
                    }, 300);
                });
                clienteBuscaInput.addEventListener('blur', function() {
                    setTimeout(function() {
                        if (clienteSugestoes) {
                            clienteSugestoes.style.display = 'none';
                            clienteSugestoes.innerHTML = '';
                        }
                    }, 200);
                });
                clienteBuscaInput.addEventListener('keydown', function(e) {
                    const items = clienteSugestoes ? clienteSugestoes.querySelectorAll('.list-group-item') : [];
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (items.length > 0) {
                            sugestaoIndex = Math.min(sugestaoIndex + 1, items.length - 1);
                            updateActiveSuggestion();
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (items.length > 0) {
                            sugestaoIndex = Math.max(sugestaoIndex - 1, 0);
                            updateActiveSuggestion();
                        }
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        selectSuggestionByIndex();
                    } else if (e.key === 'Escape') {
                        if (clienteSugestoes) {
                            clienteSugestoes.style.display = 'none';
                            clienteSugestoes.innerHTML = '';
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>
