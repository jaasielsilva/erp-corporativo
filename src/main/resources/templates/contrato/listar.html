<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gestão de Contratos - Portal CEO</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="/css/corporate.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        .metric-card-modern {
            background: #fff;
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
            height: 100%;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .metric-card-modern:hover {
            transform: translateY(-5px);
        }

        .metric-card-modern .icon-bg {
            position: absolute;
            right: -10px;
            bottom: -10px;
            font-size: 5rem;
            opacity: 0.05;
            transform: rotate(-15deg);
        }

        .metric-card-modern h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
            color: #2c3e50;
        }

        .metric-card-modern p {
            color: #7f8c8d;
            margin: 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .status-badge {
            padding: 0.35em 0.8em;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: 20px;
            text-transform: uppercase;
        }

        .status-ativo { background-color: #e8f5e9; color: #2e7d32; }
        .status-expirado { background-color: #ffebee; color: #c62828; }
        .status-vencendo { background-color: #fff8e1; color: #f57f17; }
        .status-cancelado { background-color: #eceff1; color: #546e7a; }

        .table-modern thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            color: #6c757d;
            padding: 1rem;
        }

        .table-modern tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f3f5;
        }

        .table-modern tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .contract-timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.5rem;
            border-left: 2px solid #e9ecef;
        }
        
        .contract-timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #3498db;
        }
        
        .contract-timeline-date {
            font-size: 0.8rem;
            color: #95a5a6;
            margin-bottom: 0.2rem;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>

        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>

            <section class="content-area">
                <div class="container-fluid py-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="display-6 fw-bold text-dark mb-0">Gestão de Contratos</h1>
                            <p class="text-muted mb-0">Visão geral de todos os contratos corporativos</p>
                        </div>
                        <a href="/contratos/novo" class="btn btn-primary rounded-pill px-4">
                            <i class="fas fa-plus me-2"></i>Novo Contrato
                        </a>
                    </div>

                    <!-- Métricas -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="metric-card-modern">
                                <i class="fas fa-file-contract icon-bg text-primary"></i>
                                <h3 th:text="${metricas.total}">0</h3>
                                <p>Total de Contratos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card-modern">
                                <i class="fas fa-check-circle icon-bg text-success"></i>
                                <h3 th:text="${metricas.ativos}" class="text-success">0</h3>
                                <p>Contratos Ativos</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card-modern">
                                <i class="fas fa-exclamation-triangle icon-bg text-warning"></i>
                                <h3 th:text="${metricas.vencendo}" class="text-warning">0</h3>
                                <p>Vencendo em 30 dias</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card-modern">
                                <i class="fas fa-dollar-sign icon-bg text-info"></i>
                                <h3 th:text="${metricas.valorAtivo != null ? #numbers.formatCurrency(metricas.valorAtivo) : 'R$ 0,00'}">R$ 0,00</h3>
                                <p>Valor Recorrente</p>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros e Tabela -->
                    <div class="card border-0 shadow-sm rounded-3">
                        <div class="card-body p-4">
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                        <input type="text" id="contratosBusca" class="form-control bg-light border-start-0" placeholder="Buscar por número, parte envolvida...">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select id="contratosTipo" class="form-select bg-light">
                                        <option value="">Tipo: Todos</option>
                                        <option th:each="t : ${tiposContrato}" th:value="${t.name()}" th:text="${t.name()}"></option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="contratosStatus" class="form-select bg-light">
                                        <option value="">Status: Todos</option>
                                        <option th:each="s : ${statusContrato}" th:value="${s.name()}" th:text="${s.name()}"></option>
                                    </select>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button id="contratosLimpar" class="btn btn-outline-secondary w-100"><i class="fas fa-sync-alt me-2"></i>Limpar</button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-modern align-middle">
                                    <thead>
                                        <tr>
                                            <th>Nº Contrato</th>
                                            <th>Parte Envolvida</th>
                                            <th>Tipo</th>
                                            <th>Vigência</th>
                                            <th>Status</th>
                                            <th>Valor</th>
                                            <th class="text-end">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="contratosBody">
                                        <tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Carregando dados...</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted small" id="paginationInfo">Mostrando 0 de 0</div>
                                <nav aria-label="Page navigation">
                                    <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                        <!-- Pagination injected by JS -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <!-- Offcanvas Detalhes -->
    <div class="offcanvas offcanvas-end process-offcanvas" tabindex="-1" id="contractOffcanvas" aria-labelledby="contractOffcanvasLabel">
        <div class="offcanvas-header">
            <div>
                <h5 class="offcanvas-title fw-bold" id="contractOffcanvasLabel">Detalhes do Contrato</h5>
                <div class="process-meta mt-2">
                    <span id="detailNumero" class="badge bg-white text-dark bg-opacity-25">#00000</span>
                    <span id="detailStatus" class="badge bg-success">ATIVO</span>
                </div>
            </div>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0">
            <ul class="nav nav-tabs modern-tabs px-3 pt-2" id="contractTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-visao" data-bs-toggle="tab" data-bs-target="#content-visao" type="button" role="tab">Visão Geral</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-historico" data-bs-toggle="tab" data-bs-target="#content-historico" type="button" role="tab">Histórico</button>
                </li>
            </ul>

            <div class="tab-content p-4">
                <!-- Visão Geral -->
                <div class="tab-pane fade show active" id="content-visao" role="tabpanel">
                    <div class="info-card mb-3">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-label">Parte Envolvida</div>
                                <div class="info-value fs-5" id="detailParte">Carregando...</div>
                                <div class="small text-muted" id="detailParteDoc">00.000.000/0000-00</div>
                            </div>
                            <div class="col-6">
                                <div class="info-label">Valor</div>
                                <div class="info-value text-primary fw-bold" id="detailValor">R$ 0,00</div>
                            </div>
                            <div class="col-6">
                                <div class="info-label">Tipo</div>
                                <div class="info-value" id="detailTipo">Serviço</div>
                            </div>
                        </div>
                    </div>

                    <div class="info-card mb-3">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="info-label">Data Início</div>
                                <div class="info-value" id="detailInicio">01/01/2023</div>
                            </div>
                            <div class="col-6">
                                <div class="info-label">Data Fim</div>
                                <div class="info-value" id="detailFim">01/01/2024</div>
                            </div>
                            <div class="col-12">
                                <div class="info-label">Objeto/Descrição</div>
                                <p class="text-muted small mb-0 mt-1" id="detailDescricao">
                                    Descrição detalhada do contrato...
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="#" id="btnEditarContrato" class="btn btn-outline-primary"><i class="fas fa-edit me-2"></i>Editar Contrato</a>
                        <button class="btn btn-outline-danger"><i class="fas fa-ban me-2"></i>Suspender Contrato</button>
                    </div>
                </div>

                <!-- Histórico (Mockado por enquanto) -->
                <div class="tab-pane fade" id="content-historico" role="tabpanel">
                    <div class="contract-timeline-item">
                        <div class="contract-timeline-date" id="detailAtualizacao">Hoje</div>
                        <h6 class="fw-bold mb-1">Última Atualização</h6>
                        <p class="text-muted small mb-0">Sistema registrou alteração.</p>
                    </div>
                    <div class="contract-timeline-item">
                        <div class="contract-timeline-date" id="detailCriacao">01/01/2023</div>
                        <h6 class="fw-bold mb-1">Contrato Criado</h6>
                        <p class="text-muted small mb-0">Contrato cadastrado no sistema.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sidebar.js" defer></script>
    <script th:src="@{/js/notifications.js}"></script>

    <script>
        $(document).ready(function() {
            let currentState = {
                page: 0,
                size: 10,
                busca: '',
                status: '',
                tipo: ''
            };

            // Debounce for search
            let searchTimeout;
            $('#contratosBusca').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentState.busca = $(this).val();
                    loadContratos(0);
                }, 500);
            });

            $('#contratosStatus, #contratosTipo').on('change', function() {
                currentState.status = $('#contratosStatus').val();
                currentState.tipo = $('#contratosTipo').val();
                loadContratos(0);
            });

            $('#contratosLimpar').on('click', function() {
                currentState.busca = '';
                currentState.status = '';
                currentState.tipo = '';
                $('#contratosBusca').val('');
                $('#contratosStatus').val('');
                $('#contratosTipo').val('');
                loadContratos(0);
            });

            function formatCurrency(value) {
                if (value === null || value === undefined) return '—';
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            }

            function formatDate(dateString) {
                if (!dateString) return '—';
                return new Date(dateString).toLocaleDateString('pt-BR');
            }

            function getStatusBadge(status) {
                const map = {
                    'ATIVO': 'status-ativo',
                    'EXPIRADO': 'status-expirado',
                    'VENCENDO': 'status-vencendo',
                    'CANCELADO': 'status-cancelado'
                };
                const cls = map[status] || 'bg-light text-dark';
                return `<span class="status-badge ${cls}">${status || '—'}</span>`;
            }

            function loadContratos(page) {
                currentState.page = page;
                const $tbody = $('#contratosBody');
                $tbody.html('<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Carregando dados...</td></tr>');

                const params = new URLSearchParams({
                    page: currentState.page,
                    size: currentState.size,
                    busca: currentState.busca,
                    status: currentState.status,
                    tipo: currentState.tipo
                });

                $.get(`/contratos/api/listar?${params.toString()}`)
                    .done(function(data) {
                        renderTable(data);
                    })
                    .fail(function() {
                        $tbody.html('<tr><td colspan="7" class="text-center py-4 text-danger"><i class="fas fa-exclamation-circle me-2"></i>Erro ao carregar dados.</td></tr>');
                    });
            }

            function renderTable(data) {
                const $tbody = $('#contratosBody');
                $tbody.empty();

                if (!data.content || data.content.length === 0) {
                    $tbody.html('<tr><td colspan="7" class="text-center py-5 text-muted">Nenhum contrato encontrado.</td></tr>');
                    $('#paginationInfo').text('Mostrando 0 de 0');
                    $('#paginationControls').empty();
                    return;
                }

                data.content.forEach(c => {
                    const row = `
                        <tr class="btn-detail" data-id="${c.id}">
                            <td class="fw-bold text-primary">#${c.numeroContrato || c.id}</td>
                            <td>
                                <div class="fw-semibold">${c.parteNome || '—'}</div>
                            </td>
                            <td><span class="badge bg-light text-dark border">${c.tipo || '—'}</span></td>
                            <td>
                                <div><i class="fas fa-arrow-right text-success me-1 small"></i> ${formatDate(c.dataInicio)}</div>
                                <div><i class="fas fa-arrow-left text-danger me-1 small"></i> ${formatDate(c.dataFim)}</div>
                            </td>
                            <td>${getStatusBadge(c.status)}</td>
                            <td class="fw-bold">${formatCurrency(c.valor)}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-light border btn-detail" data-id="${c.id}"><i class="fas fa-eye"></i></button>
                            </td>
                        </tr>
                    `;
                    $tbody.append(row);
                });

                // Pagination
                $('#paginationInfo').text(`Página ${data.currentPage + 1} de ${data.totalPages} (${data.totalElements} registros)`);
                const $pag = $('#paginationControls');
                $pag.empty();
                
                if (data.hasPrevious) {
                    $pag.append(`<li class="page-item"><button class="page-link" onclick="window.goToPage(${data.currentPage - 1})">Anterior</button></li>`);
                } else {
                    $pag.append(`<li class="page-item disabled"><span class="page-link">Anterior</span></li>`);
                }
                
                if (data.hasNext) {
                    $pag.append(`<li class="page-item"><button class="page-link" onclick="window.goToPage(${data.currentPage + 1})">Próxima</button></li>`);
                } else {
                    $pag.append(`<li class="page-item disabled"><span class="page-link">Próxima</span></li>`);
                }
            }

            window.goToPage = function(page) {
                loadContratos(page);
            };

            $(document).on('click', '.btn-detail', function(e) {
                // Prevent bubbling if clicking inside a button, but handle row click
                // Actually the row has .btn-detail, and the button has .btn-detail. 
                // We want to open offcanvas.
                const id = $(this).data('id');
                openOffcanvas(id);
            });

            function openOffcanvas(id) {
                // Reset UI
                $('#detailNumero').text('Carregando...');
                $('#detailParte').text('Carregando...');
                $('#detailValor').text('...');
                
                const offcanvas = new bootstrap.Offcanvas(document.getElementById('contractOffcanvas'));
                offcanvas.show();

                $.get(`/contratos/api/${id}`)
                    .done(function(data) {
                        $('#detailNumero').text(data.numeroContrato || '#' + data.id);
                        $('#detailStatus').text(data.status || '—')
                            .removeClass('bg-success bg-danger bg-warning bg-secondary')
                            .addClass(data.status === 'ATIVO' ? 'bg-success' : 
                                     (data.status === 'EXPIRADO' ? 'bg-danger' : 'bg-secondary'));
                        
                        $('#detailParte').text(data.parteNome || '—');
                        $('#detailParteDoc').text(data.parteDocumento || '—');
                        $('#detailValor').text(formatCurrency(data.valor));
                        $('#detailTipo').text(data.tipo || '—');
                        $('#detailInicio').text(formatDate(data.dataInicio));
                        $('#detailFim').text(formatDate(data.dataFim));
                        $('#detailDescricao').text(data.descricao || 'Sem descrição.');
                        
                        $('#detailCriacao').text(data.dataCriacao ? formatDate(data.dataCriacao) : '—');
                        $('#detailAtualizacao').text(data.ultimaAtualizacao ? formatDate(data.ultimaAtualizacao) : '—');
                        
                        $('#btnEditarContrato').attr('href', `/contratos/${data.id}/editar`);
                    })
                    .fail(function() {
                        $('#detailNumero').text('Erro');
                        alert('Não foi possível carregar os detalhes.');
                    });
            }

            // Initial load
            loadContratos(0);
        });
    </script>
</body>
</html>