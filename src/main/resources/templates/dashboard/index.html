<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Executivo - ERP Corporativo</title>
    <link rel="icon" type="image/png" href="/img/gerente.png">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <style>
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 800;
            color: #1e293b;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 16px;
            color: #64748b;
            font-weight: 500;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 8px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 600;
        }

        .stat-change.positive {
            background: #dcfce7;
            color: #16a34a;
        }

        .stat-change.negative {
            background: #fef2f2;
            color: #dc2626;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 350px;
        }

        .chart-container-small {
            height: 250px;
        }

        .chart-container-narrow {
            height: 200px;
            width: 60%;
            margin: 0 auto;
        }

        .secondary-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 40px;
        }



        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .performance-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .performance-metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: #64748b;
        }

        .metric-value {
            font-weight: 700;
            color: #1e293b;
        }
    </style>
</head>

<body>
    <!-- Dados do usuário para WebSocket (sem thymeleaf-extras-springsecurity) -->
    <div data-user-email="[[${#httpServletRequest.remoteUser != null ? #httpServletRequest.remoteUser : ''}]]" style="display: none;"></div>

    <div class="app-container">
        <!-- Sidebar -->
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>

        <!-- Conteúdo principal -->
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>

            <section class="content-area">
                <div class="container">
                    <!-- Header -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="mb-0">Dashboard Executivo</h2>

                                </div>
                                <div class="d-flex align-items-center gap-3">
                                    <!-- Indicador de Notificações -->
                                    <div class="position-relative" th:if="${notificacaoesNaoLidas > 0}">
                                        <button class="btn btn-outline-primary position-relative"
                                            onclick="abrirNotificacoes()">
                                            <i class="fas fa-bell"></i>
                                            <span
                                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                                th:text="${notificacaoesNaoLidas}" th:if="${notificacaoesNaoLidas > 0}">
                                                <span class="visually-hidden">notificações não lidas</span>
                                            </span>
                                        </button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Cards de indicadores-chave -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-dollar-sign"></i></div>
                            <div class="stat-number" id="kpiFaturamentoMensal" th:text="${faturamentoMensal}">R$ 2.847.350</div>
                            <div class="stat-label">Faturamento Últimos 12 Meses</div>
                            <div class="stat-change" id="kpiCrescimentoFaturamento"
                                th:class="${crescimentoFaturamento.startsWith('+') ? 'stat-change positive' : 'stat-change negative'}"
                                th:text="${crescimentoFaturamento} + ' vs mês anterior'">+12.5% vs mês anterior</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-shopping-cart"></i></div>
                            <div class="stat-number" id="kpiTotalVendas" th:text="${totalVendas}">1.247</div>
                            <div class="stat-label">Quantidade de Vendas</div>
                            <div class="stat-change" id="kpiCrescimentoVendas"
                                th:class="${crescimentoVendas.startsWith('+') ? 'stat-change positive' : 'stat-change negative'}"
                                th:text="${crescimentoVendas} + ' vs mês anterior'">+8.3% vs mês anterior</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-users"></i></div>
                            <div class="stat-number" id="kpiTotalClientes" th:text="${totalClientes}">3.892</div>
                            <div class="stat-label">Clientes Ativos</div>
                            <div class="stat-change positive" id="kpiNovosClientes"
                                th:text="'+' + ${novosClientes30Dias} + ' novos nos últimos 30 dias'">+156 novos nos últimos 30 dias</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-boxes"></i></div>
                            <div class="stat-number" id="kpiTotalProdutos" th:text="${totalProdutos}">847</div>
                            <div class="stat-label">Produtos em Estoque</div>
                            <div class="stat-change negative" id="kpiProdutosCriticos" th:text="'-' + ${produtosCriticos} + ' produto crítico'">
                                -23 produtos críticos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                            <div class="stat-number" id="kpiTotalFuncionarios" th:text="${totalFuncionarios}">156</div>
                            <div class="stat-label">Funcionários Ativos</div>
                            <div class="stat-change positive" id="kpiContratacoes12Meses"
                                th:text="'+' + ${contratacoes12Meses} + ' contratações nos últimos 12 meses'">+5 contratações nos últimos 12 meses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
                            <div class="stat-number" id="kpiProcessosAdesaoTotal" th:text="${processosAdesaoTotal}">23</div>
                            <div class="stat-label">Processos de Adesão</div>
                            <div class="stat-change"
                                id="kpiProcessosAguardando"
                                th:class="${processosAguardandoAprovacao > 0 ? 'stat-change negative' : 'stat-change positive'}"
                                th:text="${processosAguardandoAprovacao} + ' aguardando aprovação'">
                                5 aguardando aprovação
                            </div>
                        </div>

                    </div>

                    <!-- Gráficos Principais -->
                    <div class="charts-section">
                        <div class="chart-card">
                            <div class="chart-title">
                                <i class="fas fa-chart-line"></i>
                                Evolução de Vendas - Últimos 12 Meses
                            </div>
                            <div class="chart-container">
                                <canvas id="graficoVendas"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                Vendas por Categoria
                            </div>
                            <div class="chart-container-small">
                                <canvas id="graficoCategorias"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Gráficos Secundários -->
                    <div class="secondary-charts">
                        <div class="chart-card">
                            <div class="chart-title">
                                <i class="fas fa-user-lock"></i>
                                Solicitações de Acesso ao Sistema
                            </div>
                            <div class="chart-container-small">
                                <canvas id="graficoSolicitacoes"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">
                                <i class="fas fa-user-plus"></i>
                                Processos de Adesão RH
                            </div>
                            <div class="chart-container-narrow">
                                <canvas id="graficoAdesaoRH"></canvas>
                            </div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                Performance Mensal
                            </div>
                            <div class="chart-container-small">
                                <canvas id="graficoPerformance"></canvas>
                            </div>
                        </div>
                    </div>

                    
                    <!-- Métricas de Performance -->
                    <div class="performance-grid">
                        <div class="performance-card">
                            <h4 style="margin-bottom: 20px; color: #1e293b;"><i class="fas fa-chart-line"></i>
                                Indicadores Financeiros</h4>
                            <div class="performance-metric">
                                <span class="metric-label">Margem de Lucro</span>
                                <span class="metric-value" id="kpiMargemLucro" th:text="${margemLucro}">23.5%</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Ticket Médio</span>
                                <span class="metric-value" id="kpiTicketMedio" th:text="${ticketMedio}">R$ 0,00</span>
                            </div>

                            <div class="performance-metric">
                                <span class="metric-label">ROI Mensal</span>
                                <span class="metric-value" id="kpiRoiMensal" th:text="${roiMensal}">18.7%</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Inadimplência</span>
                                <span class="metric-value" id="kpiInadimplencia" th:text="${inadimplencia}">0,0%</span>
                            </div>

                        </div>
                        <div class="performance-card">
                            <h4 style="margin-bottom: 20px; color: #1e293b;"><i class="fas fa-users"></i> Recursos
                                Humanos</h4>
                            <div class="performance-metric">
                                <span class="metric-label">Taxa de Retenção</span>
                                <span class="metric-value" id="kpiTaxaRetencao" th:text="${taxaRetencao}">94.2%</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Produtividade Média</span>
                                <span class="metric-value" id="kpiProdutividadeMedia" th:text="${produtividadeMedia}">87.3%</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Processos Aprovados</span>
                                <span class="metric-value" th:text="${processosAprovados}">18</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Tempo Médio Aprovação</span>
                                <span class="metric-value" th:text="${tempoMedioAprovacao}">2.3 dias</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Satisfação Interna</span>
                                <span class="metric-value" id="kpiSatisfacaoInterna" th:text="${satisfacaoInterna}">8.7/10</span>
                            </div>
                        </div>
                        <div class="performance-card">
                            <h4 style="margin-bottom: 20px; color: #1e293b;"><i class="fas fa-warehouse"></i> Operações
                            </h4>
                            <div class="performance-metric">
                                <span class="metric-label">Giro de Estoque</span>
                                <span class="metric-value" id="kpiGiroEstoque" th:text="${giroEstoque}">4.2x</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Tempo Médio Entrega</span>
                                <span class="metric-value" id="kpiTempoEntrega" th:text="${tempoEntrega}">2.3 dias</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Taxa de Devolução</span>
                                <span class="metric-value" id="kpiTaxaDevolucao" th:text="${taxaDevolucao}">1.8%</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Eficiência Logística</span>
                                <span class="metric-value" id="kpiEficienciaLogistica" th:text="${eficienciaLogistica}">91.5%</span>
                            </div>
                        </div>
                    </div>

                    <div class="performance-grid" style="margin-top: 20px;">
                        <div class="performance-card">
                            <h4 style="margin-bottom: 20px; color: #1e293b;"><i class="fas fa-info-circle"></i> Informações do Sistema</h4>
                            <div class="performance-metric">
                                <span class="metric-label">Ambiente</span>
                                <span class="metric-value" id="sysAmbiente">—</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Versão</span>
                                <span class="metric-value" id="sysVersao">—</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Uptime</span>
                                <span class="metric-value" id="sysUptime">—</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Memória</span>
                                <span class="metric-value" id="sysMemoria">—</span>
                            </div>
                            <div class="performance-metric">
                                <span class="metric-label">Java</span>
                                <span class="metric-value" id="sysJava">—</span>
                            </div>
                        </div>
                    </div>

                </div>
    </div>

    <!-- Footer -->
    <div th:replace="~{components/footer :: footer}"></div>

    <!-- Scripts Chart.js -->
    <script th:inline="javascript">
        window.LOGS = false;
        if (!window.LOGS) { try { console.log = function(){}; } catch(e){} }
        // Configurações globais dos gráficos
        Chart.defaults.font.family = 'Inter, system-ui, sans-serif';
        Chart.defaults.color = '#64748b';

        // Gráfico Vendas últimos 12 meses
        const ctxVendas = document.getElementById('graficoVendas').getContext('2d');

        // Dados estáticos para teste
        let vendasLabels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        let vendasValores = [15000, 18000, 22000, 19000, 25000, 28000, 32000, 29000, 31000, 35000, 38000, 42000];
        let metaValores = [20000, 20000, 20000, 25000, 25000, 25000, 30000, 30000, 30000, 35000, 35000, 35000];

        // Tentar obter dados dinâmicos
        try {
            const dynamicLabels = [[${ ultimos12MesesLabels }]];
            const dynamicValores = [[${ ultimos12MesesValores }]];
            const dynamicMeta = [[${ metaVendasMensal }]];

            console.log('Vendas - Labels:', dynamicLabels);
            console.log('Vendas - Valores:', dynamicValores);
            console.log('Vendas - Meta:', dynamicMeta);

            if (dynamicLabels && dynamicLabels.length > 0) {
                vendasLabels = dynamicLabels;
                vendasValores = dynamicValores;
                metaValores = dynamicMeta;
                console.log('Usando dados dinâmicos para vendas');
            } else {
                console.log('Usando dados estáticos para vendas');
            }
        } catch (e) {
            console.log('Erro ao carregar dados de vendas, usando estáticos:', e);
        }

        const chartVendas = new Chart(ctxVendas, {
            type: 'line',
            data: {
                labels: vendasLabels,
                datasets: [{
                    label: 'Vendas (R$)',
                    data: vendasValores,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }, {
                    label: 'Meta (R$)',
                    data: metaValores,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        ticks: {
                            callback: function (value) {
                                return 'R$ ' + value.toLocaleString('pt-BR');
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // Gráfico Vendas por Categoria
        const ctxCategorias = document.getElementById('graficoCategorias').getContext('2d');

        // Dados estáticos para teste
        let categoriasLabels = ['Eletrônicos', 'Roupas', 'Casa e Jardim', 'Livros'];
        let categoriasValores = [2500, 1800, 1200, 800];

        // Tentar obter dados dinâmicos
        try {
            const dynamicLabels = [[${ categoriasLabels }]];
            const dynamicValores = [[${ categoriasValores }]];

            console.log('Dados dinâmicos - Labels:', dynamicLabels);
            console.log('Dados dinâmicos - Valores:', dynamicValores);

            if (dynamicLabels && dynamicLabels.length > 0) {
                categoriasLabels = dynamicLabels;
                // Se todos os valores são zero, usar dados estáticos
                const hasNonZeroValues = dynamicValores.some(val => val > 0);
                if (hasNonZeroValues) {
                    categoriasValores = dynamicValores;
                    console.log('Usando dados dinâmicos');
                } else {
                    console.log('Dados dinâmicos são zeros, usando estáticos de fallback');
                }
            } else {
                console.log('Usando dados estáticos de fallback');
            }
        } catch (e) {
            console.log('Erro ao carregar dados dinâmicos, usando estáticos:', e);
        }

        const chartCategorias = new Chart(ctxCategorias, {
            type: 'doughnut',
            data: {
                labels: categoriasLabels,
                datasets: [{
                    data: categoriasValores,
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                    ],
                    borderWidth: 0,
                    hoverBorderWidth: 3,
                    hoverBorderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 20 } },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.label + ': R$ ' +
                                    context.parsed.toLocaleString('pt-BR');
                            }
                        }
                    }
                }
            }
        });

        // Gráfico Solicitações por Status
        const ctxSolicitacoes = document.getElementById('graficoSolicitacoes').getContext('2d');

        // Dados estáticos para teste
        let solicitacoesLabels = ['Pendentes', 'Aprovadas', 'Rejeitadas', 'Em Análise'];
        let solicitacoesValores = [25, 45, 8, 12];

        // Tentar obter dados dinâmicos
        try {
            const dynamicSolicitacoes = [[${ solicitacoesStatus }]];
            console.log('=== DEBUG FRONTEND SOLICITAÇÕES ===');
            console.log('Dados recebidos do backend:', dynamicSolicitacoes);
            console.log('Tipo dos dados:', typeof dynamicSolicitacoes);
            console.log('É array?', Array.isArray(dynamicSolicitacoes));
            console.log('Tamanho do array:', dynamicSolicitacoes ? dynamicSolicitacoes.length : 'null/undefined');

            if (dynamicSolicitacoes && dynamicSolicitacoes.length > 0) {
                // Se todos os valores são zero, usar dados estáticos
                const hasNonZeroValues = dynamicSolicitacoes.some(val => val > 0);
                console.log('Tem valores não-zero?', hasNonZeroValues);

                if (hasNonZeroValues) {
                    solicitacoesValores = dynamicSolicitacoes;
                    console.log('✅ Usando dados dinâmicos para solicitações:', solicitacoesValores);
                } else {
                    console.log('⚠️ Dados de solicitações são zeros, usando estáticos de fallback');
                }
            } else {
                console.log('⚠️ Array vazio ou null, usando dados estáticos para solicitações');
            }
            console.log('Valores finais que serão usados:', solicitacoesValores);
            console.log('=====================================');
        } catch (e) {
            console.log('❌ Erro ao carregar dados de solicitações, usando estáticos:', e);
        }

        const chartSolicitacoes = new Chart(ctxSolicitacoes, {
            type: 'doughnut',
            data: {
                labels: solicitacoesLabels,
                datasets: [{
                    data: solicitacoesValores,
                    backgroundColor: ['#fbbf24', '#10b981', '#ef4444', '#3b82f6'],
                    borderWidth: 0,
                    hoverBorderWidth: 3,
                    hoverBorderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { padding: 15 } }
                }
            }
        });

        // Gráfico Performance Mensal
        const ctxPerformance = document.getElementById('graficoPerformance').getContext('2d');

        // Dados estáticos para teste
        let performanceLabels = ['Vendas', 'Atendimento', 'Logística', 'Qualidade', 'Financeiro'];
        let performanceValores = [85, 92, 78, 88, 91];

        // Tentar obter dados dinâmicos
        try {
            const dynamicPerformance = [[${ performanceIndicadores }]];
            console.log('Performance - Valores:', dynamicPerformance);

            if (dynamicPerformance && dynamicPerformance.length > 0) {
                performanceValores = dynamicPerformance;
                console.log('Usando dados dinâmicos para performance');
            } else {
                console.log('Usando dados estáticos para performance');
            }
        } catch (e) {
            console.log('Erro ao carregar dados de performance, usando estáticos:', e);
        }

        const chartPerformance = new Chart(ctxPerformance, {
            type: 'bar',
            data: {
                labels: performanceLabels,
                datasets: [{
                    label: 'Performance (%)',
                    data: performanceValores,
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(59, 130, 246, 0.8)'
                    ],
                    borderColor: [
                        '#667eea', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'
                    ],
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(0, 0, 0, 0.1)' },
                        ticks: {
                            callback: function (value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // Gráfico Adesão RH
        const ctxAdesaoRH = document.getElementById('graficoAdesaoRH').getContext('2d');

        // Dados estáticos para teste (fallback)
        let adesaoLabels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
        let adesaoValores = [12, 18, 15, 22, 19, 25];

        // Tentar obter dados dinâmicos dos últimos 6 meses
        try {
            const dynamicLabels = [[${ adesaoRHLabels }]];
            const dynamicValores = [[${ adesaoRHValores }]];
            console.log('Adesão RH - Labels:', dynamicLabels);
            console.log('Adesão RH - Valores:', dynamicValores);

            if (dynamicLabels && dynamicLabels.length > 0) {
                adesaoLabels = dynamicLabels;
                console.log('Usando labels dinâmicos para adesão RH');
            }

            if (dynamicValores && dynamicValores.length > 0) {
                adesaoValores = dynamicValores;
                console.log('Usando valores dinâmicos para adesão RH');
            } else {
                console.log('Usando dados estáticos para adesão RH');
            }
        } catch (e) {
            console.log('Erro ao carregar dados de adesão RH, usando estáticos:', e);
        }

        const chartAdesaoRH = new Chart(ctxAdesaoRH, {
            type: 'bar',
            data: {
                labels: adesaoLabels,
                datasets: [{
                    label: 'Adesões RH',
                    data: adesaoValores,
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: '#10b981',
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0, 0, 0, 0.1)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });

        // Animações de entrada para os cards
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Aplicar animações aos cards
        document.querySelectorAll('.stat-card, .chart-card, .performance-card').forEach(card => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(card);
        });

        function atualizarDashboard() {
            fetch('/dashboard/api/metrics')
                .then(r => r.json())
                .then(d => {
                    const t = d && d.totais ? d.totais : {};
                    const g = d && d.graficos ? d.graficos : {};
                    const vf = v => (v === null || typeof v === 'undefined') ? '—' : v;
                    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = vf(val); };
                    el('kpiFaturamentoMensal', t.faturamentoMensal);
                    el('kpiCrescimentoFaturamento', t.crescimentoFaturamento + ' vs mês anterior');
                    el('kpiTotalVendas', t.totalVendas);
                    el('kpiCrescimentoVendas', t.crescimentoVendas + ' vs mês anterior');
                    el('kpiTotalClientes', t.totalClientes);
                    el('kpiNovosClientes', '+' + vf(t.novosClientes30Dias) + ' novos nos últimos 30 dias');
                    el('kpiTotalProdutos', t.totalProdutos);
                    el('kpiProdutosCriticos', '-' + vf(t.produtosCriticos) + ' produto crítico');
                    el('kpiTotalFuncionarios', t.totalFuncionarios);
                    el('kpiContratacoes12Meses', '+' + vf(t.contratacoes12Meses) + ' contratações nos últimos 12 meses');
                    el('kpiProcessosAdesaoTotal', t.processosAdesaoTotal);
                    el('kpiProcessosAguardando', vf(t.processosAguardandoAprovacao) + ' aguardando aprovação');
                    el('kpiMargemLucro', t.margemLucro);
                    el('kpiTicketMedio', t.ticketMedio);
                    el('kpiRoiMensal', t.roiMensal);
                    el('kpiInadimplencia', t.inadimplencia);
                    el('kpiTaxaRetencao', t.taxaRetencao);
                    el('kpiProdutividadeMedia', t.produtividadeMedia);
                    el('kpiSatisfacaoInterna', t.satisfacaoInterna);
                    el('kpiGiroEstoque', t.giroEstoque);
                    el('kpiTempoEntrega', t.tempoEntrega);
                    el('kpiTaxaDevolucao', t.taxaDevolucao);
                    el('kpiEficienciaLogistica', t.eficienciaLogistica);
                    if (g.vendas) {
                        const vl = Array.isArray(g.vendas.labels) ? g.vendas.labels : [];
                        const vv = Array.isArray(g.vendas.valores) ? g.vendas.valores : [];
                        const vm = Array.isArray(g.vendas.meta) ? g.vendas.meta : [];
                        if (vl.length > 0) {
                            chartVendas.data.labels = vl;
                            chartVendas.data.datasets[0].data = vv;
                            chartVendas.data.datasets[1].data = vm;
                            chartVendas.update();
                        }
                    }
                    if (g.categorias) {
                        const cl = Array.isArray(g.categorias.labels) ? g.categorias.labels : [];
                        const cv = Array.isArray(g.categorias.valores) ? g.categorias.valores : [];
                        if (cl.length > 0 && cv.some(v => v > 0)) {
                            chartCategorias.data.labels = cl;
                            chartCategorias.data.datasets[0].data = cv;
                            chartCategorias.update();
                        }
                    }
                    if (g.solicitacoes && Array.isArray(g.solicitacoes.valores)) {
                        chartSolicitacoes.data.datasets[0].data = g.solicitacoes.valores;
                        chartSolicitacoes.update();
                    }
                    if (g.adesao) {
                        const al = Array.isArray(g.adesao.labels) ? g.adesao.labels : [];
                        const av = Array.isArray(g.adesao.valores) ? g.adesao.valores : [];
                        if (al.length > 0) chartAdesaoRH.data.labels = al;
                        if (av.length > 0) chartAdesaoRH.data.datasets[0].data = av;
                        chartAdesaoRH.update();
                    }
                    if (Array.isArray(g.performance) && g.performance.length > 0) {
                        chartPerformance.data.datasets[0].data = g.performance;
                        chartPerformance.update();
                    }
                    const lu = document.getElementById('lastUpdate');
                    if (lu) lu.textContent = new Date().toLocaleString('pt-BR');
                });
        }
        function formatBytes(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
        }

        function formatUptime(ms) {
            const s = Math.floor(ms / 1000);
            const d = Math.floor(s / 86400);
            const h = Math.floor((s % 86400) / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return `${d}d ${h}h ${m}m ${sec}s`;
        }

        function atualizarSistema() {
            fetch('/dashboard/api/system')
                .then(r => r.json())
                .then(d => {
                    const perf = v => (v === null || typeof v === 'undefined') ? '—' : v;
                    const amb = Array.isArray(d.activeProfiles) && d.activeProfiles.length > 0 ? d.activeProfiles.join(', ') : 'default';
                    const mem = d.memory ? `${formatBytes(d.memory.used)} / ${formatBytes(d.memory.total)}` : '—';
                    const up = typeof d.uptimeMillis === 'number' ? formatUptime(d.uptimeMillis) : '—';
                    const ver = d.app && d.app.version ? d.app.version : '—';
                    const jv = perf(d.java);
                    const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
                    el('sysAmbiente', amb);
                    el('sysVersao', ver);
                    el('sysUptime', up);
                    el('sysMemoria', mem);
                    el('sysJava', jv);
                });
        }

        atualizarDashboard();
        atualizarSistema();
        setInterval(() => { atualizarDashboard(); verificarNovasNotificacoes(); atualizarSistema(); }, 300000);

        // Função para abrir painel de notificações
        function abrirNotificacoes() {
            // Criar modal de notificações se não existir
            if (!document.getElementById('modalNotificacoes')) {
                criarModalNotificacoes();
            }

            // Carregar notificações
            carregarNotificacoes();

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalNotificacoes'));
            modal.show();
        }

        function criarModalNotificacoes() {
            const modalHtml = `
                <div class="modal fade" id="modalNotificacoes" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-bell me-2"></i>Notificações
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="filtrarNotificacoes('todas')" id="btnTodas">Todas</button>
                                        <button class="btn btn-sm btn-outline-primary" onclick="filtrarNotificacoes('nao-lidas')" id="btnNaoLidas">Não Lidas</button>
                                    </div>
                                    <button class="btn btn-sm btn-outline-success" onclick="marcarTodasComoLidas()">
                                        <i class="fas fa-check-double me-1"></i>Marcar Todas como Lidas
                                    </button>
                                </div>
                                <div id="listaNotificacoes">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-2 text-muted">Carregando notificações...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function carregarNotificacoes(filtro = 'todas') {
            const endpoint = filtro === 'nao-lidas' ? '/api/notifications/legacy/nao-lidas' : '/api/notifications/legacy';

            fetch(endpoint)
                .then(response => response.json())
                .then(notificacoes => {
                    renderizarNotificacoes(notificacoes);
                })
                .catch(error => {
                    console.error('Erro ao carregar notificações:', error);
                    document.getElementById('listaNotificacoes').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erro ao carregar notificações
                        </div>
                    `;
                });
        }

        function renderizarNotificacoes(notificacoes) {
            const lista = document.getElementById('listaNotificacoes');

            if (!notificacoes || notificacoes.length === 0) {
                lista.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhuma notificação encontrada</p>
                    </div>
                `;
                return;
            }

            let html = '';
            notificacoes.forEach(notificacao => {
                const tipoClass = getTipoNotificacaoClass(notificacao.tipo);
                const tipoIcon = getTipoNotificacaoIcon(notificacao.tipo);
                const dataFormatada = new Date(notificacao.dataHora).toLocaleString('pt-BR');

                html += `
                    <div class="card mb-2 ${notificacao.lida ? 'opacity-75' : 'border-primary'}" data-notificacao-id="${notificacao.id}">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <i class="${tipoIcon} ${tipoClass}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 ${!notificacao.lida ? 'fw-bold' : ''}">${notificacao.titulo}</h6>
                                    <p class="mb-1 small">${notificacao.mensagem}</p>
                                    <small class="text-muted">${dataFormatada}</small>
                                </div>
                                <div class="ms-2">
                                    ${!notificacao.lida ? `
                                        <button class="btn btn-sm btn-outline-primary" onclick="marcarComoLida('${notificacao.id}')" title="Marcar como lida">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    ` : ''}
                                    ${notificacao.url ? `
                                        <a href="${notificacao.url}" class="btn btn-sm btn-outline-info ms-1" title="Ver detalhes">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            lista.innerHTML = html;
        }

        function filtrarNotificacoes(filtro) {
            // Atualizar botões
            document.getElementById('btnTodas').className = filtro === 'todas' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-secondary';
            document.getElementById('btnNaoLidas').className = filtro === 'nao-lidas' ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-outline-primary';

            // Carregar notificações
            carregarNotificacoes(filtro);
        }

        function marcarComoLida(notificacaoId) {
            fetch(`/api/notifications/legacy/${notificacaoId}/marcar-lida`, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Remover da lista ou atualizar visualmente
                        const elemento = document.querySelector(`[data-notificacao-id="${notificacaoId}"]`);
                        if (elemento) {
                            elemento.classList.add('opacity-75');
                            elemento.classList.remove('border-primary');
                            elemento.querySelector('.btn-outline-primary')?.remove();
                        }

                        // Atualizar contador
                        verificarNovasNotificacoes();
                    }
                })
                .catch(error => {
                    console.error('Erro ao marcar notificação como lida:', error);
                });
        }

        function marcarTodasComoLidas() {
            fetch('/api/notifications/legacy/marcar-todas-lidas', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Recarregar notificações
                        carregarNotificacoes();

                        // Atualizar contador
                        verificarNovasNotificacoes();

                        // Mostrar mensagem de sucesso
                        alert('Todas as notificações foram marcadas como lidas!');
                    }
                })
                .catch(error => {
                    console.error('Erro ao marcar todas as notificações como lidas:', error);
                });
        }

        function verificarNovasNotificacoes() {
            fetch('/api/notifications/unread-count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.badge.bg-danger');
                    const botaoNotificacoes = document.querySelector('button[onclick="abrirNotificacoes()"]');

                    if (data.count > 0) {
                        if (badge) {
                            badge.textContent = data.count;
                        }
                        if (botaoNotificacoes && !botaoNotificacoes.closest('.position-relative')) {
                            // Criar indicador se não existir
                            location.reload(); // Recarregar para mostrar o indicador
                        }
                    } else {
                        if (badge) {
                            badge.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar notificações:', error);
                });
        }

        function getTipoNotificacaoClass(tipo) {
            const classes = {
                'info': 'text-info',
                'warning': 'text-warning',
                'success': 'text-success',
                'error': 'text-danger'
            };
            return classes[tipo] || 'text-secondary';
        }

        function getTipoNotificacaoIcon(tipo) {
            const icons = {
                'info': 'fas fa-info-circle',
                'warning': 'fas fa-exclamation-triangle',
                'success': 'fas fa-check-circle',
                'error': 'fas fa-times-circle'
            };
            return icons[tipo] || 'fas fa-bell';
        }
    </script>
    </div>
    </section>
    </main>
    </div>
 
    <!-- Scripts da página: evite duplicar WebSocket; cliente global é carregado no Topbar -->
    <script th:src="@{/js/notifications.js}" defer></script>
    <script src="/js/sidebar.js" defer></script>


</body>

</html>