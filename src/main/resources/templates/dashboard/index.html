<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Executivo - ERP Corporativo</title>
    <link rel="icon" type="image/png" href="/img/gerente.png">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .dash-card {
            background: #ffffff;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .dash-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .dash-card.active-card {
            background-color: #f1f5f9;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
            transform: translateY(2px);
        }

        .dash-card.red {
            border-left-color: #c0392b;
        }

        .dash-card.green {
            border-left-color: #27ae60;
        }

        .dash-card.blue {
            border-left-color: #3498db;
        }

        .dash-card.yellow {
            border-left-color: #f39c12;
        }

        .dash-card.purple {
            border-left-color: #8e44ad;
        }

        .dash-card.dark-red {
            border-left-color: #8b0000;
        }

        .dash-card.orange {
            border-left-color: #d35400;
        }

        .dash-card.gray {
            border-left-color: #7f8c8d;
        }

        .dash-card.success {
            border-left-color: #27ae60;
        }

        .dash-info h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .dash-info p {
            margin: 0;
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .dash-icon {
            font-size: 1.5rem;
            opacity: 0.25;
        }

        .dash-card.red .dash-icon {
            color: #c0392b;
            opacity: 0.8;
        }

        .dash-card.green .dash-icon {
            color: #27ae60;
            opacity: 0.8;
        }

        .dash-card.blue .dash-icon {
            color: #3498db;
            opacity: 0.8;
        }

        .dash-card.yellow .dash-icon {
            color: #f39c12;
            opacity: 0.8;
        }

        .dash-card.purple .dash-icon {
            color: #8e44ad;
            opacity: 0.8;
        }

        .dash-card.dark-red .dash-icon {
            color: #8b0000;
            opacity: 0.8;
        }

        .dash-card.orange .dash-icon {
            color: #d35400;
            opacity: 0.8;
        }

        .dash-card.gray .dash-icon {
            color: #7f8c8d;
            opacity: 0.8;
        }

        .dash-card.success .dash-icon {
            color: #27ae60;
            opacity: 0.8;
        }

        .details-panel {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: none;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 1rem;
        }

        .details-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #94a3b8;
            padding: 0;
            margin: 0;
            width: auto;
        }

        .close-btn:hover {
            color: #c0392b;
        }

        #details-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        #details-table th {
            text-align: left;
            padding: 0.8rem;
            background: #f8fafc;
            color: #64748b;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
        }

        #details-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }

        #details-table tr:hover td {
            background: #f8fafc;
        }

        .badge-status {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-status.pendente {
            background: #fff1f2;
            color: #c0392b;
        }

        .badge-status.pago {
            background: #f0fdf4;
            color: #27ae60;
        }

        .badge-status.ativo {
            background: #eff6ff;
            color: #3498db;
        }

        .badge-status.atencao {
            background: #fef9c3;
            color: #f39c12;
        }

        .badge-status.civil {
            background: #e2e8f0;
            color: #2c3e50;
        }
    </style>
</head>

<body>
    <!-- Dados do usuário para WebSocket (sem thymeleaf-extras-springsecurity) -->
    <div data-user-email="[[${#httpServletRequest.remoteUser != null ? #httpServletRequest.remoteUser : ''}]]" style="display: none;"></div>

    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>

            <section class="content-area">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-3">
                        <div>
                            <h1 class="h2 mb-1">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard Executivo
                            </h1>
                            <p class="text-muted mb-0">Clique nos cards para ver os detalhes abaixo.</p>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dash-card blue" id="card-novos_contatos" onclick="toggleDetails('novos_contatos')">
                            <div class="dash-info">
                                <h3>8</h3>
                                <p>Novos Contatos</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                        </div>

                        <div class="dash-card red" id="card-pagar_medico" onclick="toggleDetails('pagar_medico')">
                            <div class="dash-info">
                                <h3>R$ 12.450</h3>
                                <p>A Pagar (Médicos)</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-user-md"></i>
                            </div>
                        </div>

                        <div class="dash-card yellow" id="card-aguardando_laudo"
                            onclick="toggleDetails('aguardando_laudo')">
                            <div class="dash-info">
                                <h3>5</h3>
                                <p>Aguardando Laudo</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-file-medical-alt"></i>
                            </div>
                        </div>

                        <div class="dash-card red" id="card-pendencias_docs" onclick="toggleDetails('pendencias_docs')">
                            <div class="dash-info">
                                <h3 th:text="${pendenciasDocsCount}">42</h3>
                                <p>Pendências (Docs)</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                        </div>

                        <div class="dash-card orange" id="card-contratos_pendentes"
                            onclick="toggleDetails('contratos_pendentes')">
                            <div class="dash-info">
                                <h3>12</h3>
                                <p>Contratos a Assinar</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-file-signature"></i>
                            </div>
                        </div>

                        <div class="dash-card green" id="card-receber_seguradora"
                            onclick="toggleDetails('receber_seguradora')">
                            <div class="dash-info">
                                <h3>R$ 450k</h3>
                                <p>A Receber (Seg)</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                        </div>

                        <div class="dash-card blue" id="card-processos_ativos"
                            onclick="toggleDetails('processos_ativos')">
                            <div class="dash-info">
                                <h3 th:text="${processosAtivosCount}">1.240</h3>
                                <p>Processos Ativos</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                        </div>

                        <div class="dash-card gray" id="card-contencioso_civil"
                            onclick="toggleDetails('contencioso_civil')">
                            <div class="dash-info">
                                <h3>85</h3>
                                <p>Contencioso / Civil</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-balance-scale"></i>
                            </div>
                        </div>

                        <div class="dash-card success" id="card-processos_arquivados"
                            onclick="toggleDetails('processos_arquivados')">
                            <div class="dash-info">
                                <h3>3.450</h3>
                                <p>Arquivados (Deferidos)</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-archive"></i>
                            </div>
                        </div>

                        <div class="dash-card yellow" id="card-prazos_criticos"
                            onclick="toggleDetails('prazos_criticos')">
                            <div class="dash-info">
                                <h3>15</h3>
                                <p>Prazos Críticos (48h)</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                        </div>

                        <div class="dash-card purple" id="card-produtividade"
                            onclick="toggleDetails('produtividade')">
                            <div class="dash-info">
                                <h3>12</h3>
                                <p>Proc/Func (Dia)</p>
                            </div>
                            <div class="dash-icon">
                                <i class="fas fa-users-cog"></i>
                            </div>
                        </div>
                    </div>

                    <div class="mt-2 mb-3">
                        <small class="text-muted">
                            Tempo médio entre etapas Jurídico:
                            Contato → Docs:
                            <span th:text="${tempoContatoDocs} + ' dias'">0,0 dias</span> |
                            Docs → Análise:
                            <span th:text="${tempoDocsAnalise} + ' dias'">0,0 dias</span> |
                            Análise → Contrato:
                            <span th:text="${tempoAnaliseContrato} + ' dias'">0,0 dias</span>
                        </small>
                    </div>

                    <div id="details-panel" class="details-panel">
                        <div class="details-header">
                            <h3 id="details-title">Detalhes</h3>
                            <button type="button" class="close-btn" onclick="hideDetails()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table id="details-table" class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>Nome / Descrição</th>
                                        <th>Referência</th>
                                        <th>Valor / KPI</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="details-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div th:replace="~{components/footer :: footer}"></div>

    <!-- Scripts da página: global é carregado no Topbar -->
    <script th:src="@{/js/notifications.js}" defer></script>
    <script src="/js/sidebar.js" defer></script>
    
    <script th:inline="javascript">
        /*<![CDATA[*/
        const processosAtivosServer = /*[[${processosAtivos}]]*/ [];
        const pendenciasDocsServer = /*[[${pendenciasDocs}]]*/ [];
        
        // Helper to format currency
        const formatter = new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL',
        });

        const processosAtivosMapped = processosAtivosServer ? processosAtivosServer.map(p => ({
            nome: p.cliente ? (p.cliente.nomeFantasia || p.cliente.nome) : (p.parte || 'Sem Nome'),
            ref: p.tipoDescricao || p.tipo || 'Outros',
            valor: p.valorCausa ? formatter.format(p.valorCausa) : '-',
            status: 'ativo'
        })) : [];

        const pendenciasDocsMapped = pendenciasDocsServer ? pendenciasDocsServer.map(p => {
            let diasTexto = '-';
            if (p.dataPendencia) {
                let data;
                if (typeof p.dataPendencia === 'string') {
                    data = new Date(p.dataPendencia);
                } else if (typeof p.dataPendencia === 'object' && p.dataPendencia.year) {
                    data = new Date(p.dataPendencia.year, (p.dataPendencia.monthValue || p.dataPendencia.month || 1) - 1, p.dataPendencia.dayOfMonth || p.dataPendencia.day || 1);
                }
                if (data && !isNaN(data.getTime())) {
                    const hoje = new Date();
                    const diffMs = hoje.setHours(0,0,0,0) - data.setHours(0,0,0,0);
                    const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    if (dias <= 0) {
                        diasTexto = 'pendente hoje';
                    } else if (dias === 1) {
                        diasTexto = 'pendente há 1 dia';
                    } else {
                        diasTexto = 'pendente há ' + dias + ' dias';
                    }
                }
            }
            return {
                nome: p.cliente ? (p.cliente.nomeFantasia || p.cliente.nome) : (p.parte || 'Sem Nome'),
                ref: p.documentosPendentes ? p.documentosPendentes : 'Documentação incompleta',
                valor: diasTexto,
                status: 'ATENCAO'
            };
        }) : [];
        /*]]>*/
    </script>

    <script>
        let currentOpenCard = null;

        const mockData = {
            'novos_contatos': [
                { nome: 'Carlos Eduardo', ref: 'WhatsApp', valor: '16/01 09:30', status: 'ativo' },
                { nome: 'Fernanda Lima', ref: 'Instagram', valor: '16/01 10:15', status: 'ativo' }
            ],
            'pagar_medico': [
                { nome: 'João Silva', ref: 'Dr. Roberto', valor: 'R$ 450,00', status: 'pendente' },
                { nome: 'Maria Oliveira', ref: 'Dra. Ana', valor: 'R$ 500,00', status: 'pendente' }
            ],
            'aguardando_laudo': [
                { nome: 'Pedro Henrique', ref: 'Dr. Roberto (Ortopedista)', valor: 'Perícia: 10/01', status: 'atencao' },
                { nome: 'Carla Dias', ref: 'Dra. Ana (Psiquiatra)', valor: 'Perícia: 12/01', status: 'pendente' },
                { nome: 'Lucas Santos', ref: 'Dr. Marcos (Neurologista)', valor: 'Perícia: 15/01', status: 'ativo' },
                { nome: 'Fernanda Souza', ref: 'Dr. Roberto (Ortopedista)', valor: 'Perícia: 16/01', status: 'ativo' },
                { nome: 'Mariana Lima', ref: 'Dra. Ana (Psiquiatra)', valor: 'Perícia: 16/01', status: 'ativo' }
            ],
            'pendencias_docs': {
                title: "Pendências de Documentação (Cliente/Seg)",
                columns: ["Nome / Descrição", "Referência", "Valor / KPI", "Status"],
                data: pendenciasDocsMapped
            },
            'contratos_pendentes': [
                { nome: 'Marcos Paulo', ref: 'Desde 15/01', valor: '-', status: 'atencao' },
                { nome: 'Ana Julia', ref: 'Desde 14/01', valor: '-', status: 'atencao' }
            ],
            'receber_seguradora': [
                { nome: 'Amanda Costa', ref: 'Sinistro #9988', valor: 'R$ 15.000', status: 'pago' },
                { nome: 'Bruno Souza', ref: 'Sinistro #7744', valor: 'R$ 8.200', status: 'pago' }
            ],
            'processos_ativos': (typeof processosAtivosMapped !== 'undefined') ? processosAtivosMapped : [],
            'contencioso_civil': [
                { nome: 'Roberto Carlos', ref: 'TJ-SP #12345', valor: 'R$ 50k', status: 'civil' },
                { nome: 'Julia Roberts', ref: 'TJ-RJ #67890', valor: 'R$ 30k', status: 'civil' }
            ],
            'processos_arquivados': [
                { nome: 'Pedro Alcantara', ref: 'Deferido', valor: 'R$ 12.000', status: 'pago' },
                { nome: 'Carla Dias', ref: 'Deferido', valor: 'R$ 8.500', status: 'pago' }
            ],
            'prazos_criticos': [
                { nome: 'Juliana Paes', ref: 'Recurso - 24h', valor: 'Urgente', status: 'pendente' }
            ],
            'produtividade': [
                { nome: 'Ana (Comercial)', ref: 'Atendimentos', valor: '18', status: 'ativo' }
            ]
        };

        function toggleDetails(type) {
            const panel = document.getElementById('details-panel');

            if (currentOpenCard === type) {
                hideDetails();
                return;
            }

            document.querySelectorAll('.dash-card').forEach(c => c.classList.remove('active-card'));
            const currentCard = document.getElementById('card-' + type);
            if (currentCard) {
                currentCard.classList.add('active-card');
            }

            currentOpenCard = type;

            const tbody = document.getElementById('details-body');
            const title = document.getElementById('details-title');
            const theadTr = document.querySelector('#details-table thead tr');

            const titles = {
                'novos_contatos': 'Novos Leads / Contatos Iniciais',
                'pagar_medico': 'Contas a Pagar - Médicos',
                'aguardando_laudo': 'Aguardando Laudo Médico (Pós-Perícia)',
                'pendencias_docs': 'Pendências de Documentação (Cliente/Seg)',
                'contratos_pendentes': 'Contratos Aguardando Assinatura',
                'receber_seguradora': 'Indenizações a Receber',
                'processos_ativos': 'Processos em Andamento',
                'contencioso_civil': 'Processos em Fase Judicial/Civil',
                'processos_arquivados': 'Processos Finalizados / Arquivados',
                'prazos_criticos': 'Prazos Judiciais Críticos',
                'produtividade': 'Produtividade da Equipe'
            };

            let data = mockData[type] || [];
            let columns = ["Nome / Descrição", "Referência", "Valor / KPI", "Status"];
            let panelTitle = titles[type] || 'Detalhes';

            if (!Array.isArray(data) && data.data) {
                // Object format
                columns = data.columns || columns;
                panelTitle = data.title || panelTitle;
                data = data.data;
            }

            title.innerText = panelTitle;
            
            // Update headers
            if (theadTr) {
                theadTr.innerHTML = '';
                columns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    theadTr.appendChild(th);
                });
            }

            tbody.innerHTML = '';

            if (data.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = columns.length;
                cell.className = 'text-center text-muted py-3';
                cell.textContent = 'Nenhum registro encontrado.';
                row.appendChild(cell);
                tbody.appendChild(row);
                panel.style.display = 'block';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');

                const nomeTd = document.createElement('td');
                nomeTd.innerHTML = '<strong>' + item.nome + '</strong>';

                const refTd = document.createElement('td');
                refTd.textContent = item.ref;

                const valorTd = document.createElement('td');
                valorTd.textContent = item.valor;

                const statusTd = document.createElement('td');
                const span = document.createElement('span');
                span.className = 'badge-status ' + (item.status ? item.status.toLowerCase() : 'neutral');
                span.textContent = (item.status || '-').toUpperCase();
                statusTd.appendChild(span);

                row.appendChild(nomeTd);
                row.appendChild(refTd);
                row.appendChild(valorTd);
                row.appendChild(statusTd);

                tbody.appendChild(row);
            });

            panel.style.display = 'block';
        }

        function hideDetails() {
            const panel = document.getElementById('details-panel');
            panel.style.display = 'none';
            document.querySelectorAll('.dash-card').forEach(c => c.classList.remove('active-card'));
            currentOpenCard = null;
        }
    </script>

</body>

</html>
