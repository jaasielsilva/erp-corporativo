<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Contas a Receber - ERP Corporativo</title>

    <!-- CSS principal -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    
    <!-- CSS Módulo Financeiro -->
    <link href="/css/financeiro.css" rel="stylesheet">
</head>

<body>
    <!-- Verificação de permissão -->
    <div th:if="${!podeAcessarFinanceiro}" class="container mt-5">
        <div class="alert alert-danger text-center">
            <h4><i class="fas fa-exclamation-triangle"></i> Acesso Negado</h4>
            <p>Você não tem permissão para acessar o módulo financeiro.</p>
            <a href="/" class="btn btn-primary">Voltar ao Dashboard</a>
        </div>
    </div>

    <div th:if="${podeAcessarFinanceiro}" class="app-container">

        <!-- Sidebar -->
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Topbar -->
            <header th:replace="~{components/topbar :: topbar}"></header>

            <!-- Conteúdo principal -->
            <section class="financeiro-wrapper">

                <!-- Navegação do Módulo -->
                <div class="module-nav">
                    <a href="/financeiro" class="module-nav-link">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                    <a href="/financeiro/contas-pagar" class="module-nav-link">
                        <i class="fas fa-file-invoice-dollar"></i> Contas a Pagar
                    </a>
                    <a href="/financeiro/contas-receber" class="module-nav-link active">
                        <i class="fas fa-hand-holding-usd"></i> Contas a Receber
                    </a>
                    <a href="/financeiro/fluxo-caixa" class="module-nav-link">
                        <i class="fas fa-exchange-alt"></i> Fluxo de Caixa
                    </a>
                    <a href="/financeiro/transferencias" class="module-nav-link">
                        <i class="fas fa-university"></i> Transferências
                    </a>
                    <a href="/financeiro/relatorios" class="module-nav-link">
                        <i class="fas fa-file-alt"></i> Relatórios
                    </a>
                </div>

                <!-- Título -->
                <div class="page-header">
                    <div class="page-title">
                        <i class="fas fa-hand-holding-usd text-primary"></i> Contas a Receber
                    </div>
                    <a href="/financeiro/contas-receber/novo" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Novo Recebimento
                    </a>
                </div>

                <!-- Cards Resumo (KPIs) -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="kpi-card kpi-success">
                            <div class="card-body">
                                <i class="fas fa-wallet kpi-icon"></i>
                                <div class="kpi-title">Total a Receber</div>
                                <div class="kpi-value" th:text="'R$ ' + ${#numbers.formatDecimal(totalReceber, 1, 'COMMA', 2, 'POINT')}">R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card kpi-danger">
                            <div class="card-body">
                                <i class="fas fa-calendar-times kpi-icon"></i>
                                <div class="kpi-title">Contas Vencidas</div>
                                <div class="kpi-value" th:text="${estatisticas['VENCIDA'] ?: 0}">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card kpi-warning">
                            <div class="card-body">
                                <i class="fas fa-chart-line kpi-icon"></i>
                                <div class="kpi-title">Inadimplência</div>
                                <div class="kpi-value" th:text="${inadimplencia} + '%'">0%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="financeiro-table table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Vencimento</th>
                                <th class="text-end">Valor Original</th>
                                <th class="text-end">Valor Recebido</th>
                                <th class="text-center">Status</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="conta : ${contas}">
                                <td th:text="${conta.cliente.nome ?: 'Cliente não informado'}">Cliente</td>
                                <td th:text="${conta.dataVencimento != null ? #temporals.format(conta.dataVencimento, 'dd/MM/yyyy') : 'N/A'}">01/01/2025</td>
                                <td class="col-valor"
                                    th:text="${#numbers.formatDecimal(conta.valorOriginal, 2, 'COMMA', 2, 'POINT') ?: '0,00'}">
                                    0,00</td>
                                <td class="col-valor text-success"
                                    th:text="${#numbers.formatDecimal(conta.valorRecebido ?: 0, 2, 'COMMA', 2, 'POINT')}">
                                    0,00</td>
                                <td class="text-center">
                                    <span th:class="${conta.status == 'RECEBIDA' ? 'badge-status badge-recebido' : 
                                                    (conta.status == 'VENCIDA' ? 'badge-status badge-vencida' : 'badge-status badge-pendente')}"
                                          th:text="${conta.status ?: 'PENDENTE'}">PENDENTE</span>
                                </td>
                                <td class="text-end">
                                    <button th:if="${conta.status != 'RECEBIDA'}"
                                        th:onclick="'registrarPagamento(' + ${conta.id} + ')'"
                                        class="btn btn-sm btn-outline-success" title="Registrar Pagamento">
                                        <i class="fas fa-check-double"></i> Receber
                                    </button>
                                    <a th:href="@{/financeiro/contas-receber/detalhes/{id}(id=${conta.id})}" 
                                       class="btn btn-sm btn-outline-info" title="Detalhes">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(contas)}">
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="fas fa-box-open fa-3x mb-3 text-light-gray"></i><br>
                                    Nenhuma conta a receber encontrada.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="/js/sidebar.js" defer></script>
    <script th:src="@{/js/notifications.js}"></script>

    <!-- Função registrar pagamento (Mantendo lógica original) -->
    <script>
        function registrarPagamento(contaId) {
            // Em uma versão futura, substituir prompt por um modal Bootstrap bonito
            let valorPago = prompt("Informe o valor pago:");
            if (valorPago) {
                // Remove R$ e formata numero se necessário, assumindo entrada simples por enquanto
                valorPago = valorPago.replace(',', '.');
                
                fetch(`/financeiro/api/contas-receber/${contaId}/receber?valor=${valorPago}&usuarioId=1`, {
                    method: 'PUT'
                })
                    .then(res => {
                        if (!res.ok) throw new Error('Erro ao registrar pagamento');
                        return res.json();
                    })
                    .then(data => {
                        alert('Pagamento registrado com sucesso.');
                        location.reload();
                    })
                    .catch(err => alert(err.message));
            }
        }
    </script>
</body>
</html>
