<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Financeiro - Dashboard</title>

    <!-- CSS Global -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">

    <!-- CSS Módulo Financeiro -->
    <link href="/css/financeiro.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header th:replace="~{components/topbar :: topbar}"></header>

            <section class="financeiro-wrapper">

                <!-- Navegação do Módulo -->
                <div class="module-nav">
                    <a href="/financeiro" class="module-nav-link active">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </a>
                    <a href="/financeiro/contas-pagar" class="module-nav-link">
                        <i class="fas fa-file-invoice-dollar"></i> Contas a Pagar
                    </a>
                    <a href="/financeiro/contas-receber" class="module-nav-link">
                        <i class="fas fa-hand-holding-usd"></i> Contas a Receber
                    </a>
                    <a href="/financeiro/fluxo-caixa" class="module-nav-link">
                        <i class="fas fa-exchange-alt"></i> Fluxo de Caixa
                    </a>
                    <a href="/financeiro/transferencias" class="module-nav-link">
                        <i class="fas fa-university"></i> Transferências
                    </a>
                    <a href="/financeiro/relatorios" class="module-nav-link">
                        <i class="fas fa-file-alt"></i> Relatórios
                    </a>
                </div>

                <!-- Cabeçalho -->
                <div class="page-header">
                    <div class="page-title">
                        <i class="fas fa-coins text-primary"></i> Visão Geral Financeira
                    </div>
                    <div class="text-muted small">
                        <i class="far fa-calendar-alt"></i> <span
                            th:text="${#dates.format(#dates.createNow(), 'dd/MM/yyyy')}">Data</span>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="kpi-card kpi-success">
                            <div class="card-body">
                                <i class="fas fa-arrow-down kpi-icon"></i>
                                <div class="kpi-title">A Receber</div>
                                <div class="kpi-value"
                                    th:text="${totalReceber != null ? 'R$ ' + #numbers.formatDecimal(totalReceber, 1, 'POINT', 2, 'COMMA') : 'R$ 0,00'}">
                                    R$ 0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card kpi-danger">
                            <div class="card-body">
                                <i class="fas fa-arrow-up kpi-icon"></i>
                                <div class="kpi-title">A Pagar</div>
                                <div class="kpi-value"
                                    th:text="${totalPagar != null ? 'R$ ' + #numbers.formatDecimal(totalPagar, 1, 'POINT', 2, 'COMMA') : 'R$ 0,00'}">R$
                                    0,00</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="kpi-card kpi-primary">
                            <div class="card-body">
                                <i class="fas fa-wallet kpi-icon"></i>
                                <div class="kpi-title">Saldo Atual</div>
                                <div class="kpi-value"
                                    th:text="${saldoAtual != null ? 'R$ ' + #numbers.formatDecimal(saldoAtual, 1, 'POINT', 2, 'COMMA') : 'R$ 0,00'}">R$
                                    0,00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráfico de Fluxo de Caixa -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white border-bottom py-3">
                                <h6 class="mb-0 fw-bold text-secondary"><i
                                        class="fas fa-chart-area text-primary me-2"></i> Fluxo de Caixa (Últimos 30
                                    dias)</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="dashboardChart" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Atalhos Rápidos e Transações Recentes -->
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header bg-white border-bottom py-3">
                                <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-bolt text-warning me-2"></i>
                                    Ações Rápidas</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-3">
                                    <a href="/financeiro/contas-pagar/nova"
                                        class="btn btn-outline-danger text-start p-3">
                                        <i class="fas fa-plus-circle me-2"></i> Nova Conta a Pagar
                                    </a>
                                    <a href="/financeiro/contas-receber/nova"
                                        class="btn btn-outline-success text-start p-3">
                                        <i class="fas fa-plus-circle me-2"></i> Nova Conta a Receber
                                    </a>
                                    <a href="/financeiro/transferencias" class="btn btn-outline-primary text-start p-3">
                                        <i class="fas fa-exchange-alt me-2"></i> Nova Transferência
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0">
                            <div
                                class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-history text-info me-2"></i>
                                    Últimas Transações</h6>
                                <a href="/financeiro/fluxo-caixa" class="btn btn-sm btn-link text-decoration-none">Ver
                                    todas</a>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush"
                                    th:if="${not #lists.isEmpty(recentTransactions)}">
                                    <div class="list-group-item d-flex justify-content-between align-items-center"
                                        th:each="t : ${recentTransactions}">
                                        <div>
                                            <div class="fw-bold text-dark" th:text="${t.descricao}">Descrição</div>
                                            <small class="text-muted"
                                                th:text="${#temporals.format(t.data, 'dd/MM/yyyy')}">Data</small>
                                        </div>
                                        <span class="badge rounded-pill"
                                            th:classappend="${#strings.equals(t.tipoMovimento?.name(), 'ENTRADA') ? 'bg-success' : 'bg-danger'}"
                                            th:text="${#strings.equals(t.tipoMovimento?.name(), 'ENTRADA') ? '+' : '-'} + ' ' + 'R$ ' + ${#numbers.formatDecimal(t.valor, 1, 'POINT', 2, 'COMMA')}">
                                            Valor
                                        </span>

                                    </div>
                                </div>
                                <div class="text-center py-4" th:if="${#lists.isEmpty(recentTransactions)}">
                                    <p class="text-muted mb-0">Nenhuma transação recente encontrada.</p>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-top py-3" th:if="${recentTransactionsPage != null && recentTransactionsPage.totalPages > 1}">
                                <div class="pagination">
                                    <span class="pagination-info" th:text="|Página ${recentTransactionsPage.number + 1} de ${recentTransactionsPage.totalPages} (${totalRecentTransactions} transações)|"></span>

                                    <a th:if="${recentTransactionsPage.hasPrevious()}" class="btn btn-secondary" th:href="@{/financeiro(page=${recentTransactionsPage.number - 1})}">
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </a>
                                    <span th:unless="${recentTransactionsPage.hasPrevious()}" class="btn btn-secondary disabled">
                                        <i class="fas fa-chevron-left"></i> Anterior
                                    </span>

                                    <a th:if="${recentTransactionsPage.hasNext()}" class="btn btn-secondary" th:href="@{/financeiro(page=${recentTransactionsPage.number + 1})}">
                                        Próxima <i class="fas fa-chevron-right"></i>
                                    </a>
                                    <span th:unless="${recentTransactionsPage.hasNext()}" class="btn btn-secondary disabled">
                                        Próxima <i class="fas fa-chevron-right"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sidebar.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fetch chart data via API
            const hoje = new Date().toISOString().split('T')[0];
            const trintaDiasAtras = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            fetch(`/api/financeiro/graficos/fluxo-caixa?inicio=${trintaDiasAtras}&fim=${hoje}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('dashboardChart').getContext('2d');
                    const labels = data.fluxoDiario.map(item => new Date(item.data).toLocaleDateString('pt-BR'));
                    const saldos = data.fluxoDiario.map(item => item.saldoAcumulado);

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Saldo Acumulado (R$)',
                                data: saldos,
                                borderColor: '#0d6efd',
                                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed.y !== null) {
                                                label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        borderDash: [2, 2]
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => console.error('Erro ao carregar gráfico:', error));
        });
    </script>
</body>

</html>