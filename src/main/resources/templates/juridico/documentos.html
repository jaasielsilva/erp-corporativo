<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${pageTitle} + ' - ERP Corporativo'">Documentos Jurídicos - ERP Corporativo</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="/css/corporate.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .card-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
        }

        .card-highlight .fa {
            font-size: 2rem;
            opacity: 0.8;
        }

        .upload-area {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.08);
        }

        .table thead {
            background: #667eea;
            color: #fff;
        }

        .badge-category {
            background: #764ba2;
            color: #fff;
            font-size: 0.95em;
        }

        .loading-spinner {
            text-align: center;
            padding: 40px 0;
        }

        .template-search-results {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 4px);
            z-index: 1050;
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.12);
            max-height: 280px;
            overflow: auto;
        }

        .template-search-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .template-search-item:last-child {
            border-bottom: none;
        }

        .template-search-item:hover {
            background: rgba(102, 126, 234, 0.08);
        }

        /* Hover and Click effects for Quick Template Buttons */
        .btn-template-action {
            display: inline-block;
            font-weight: 400;
            line-height: 1.5;
            text-align: center;
            text-decoration: none;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid #dee2e6;
            background-color: #fff !important;
            color: #212529;
        }
        
        .btn-template-action:hover {
            background-color: #f0f4ff !important;
            border-color: #764ba2 !important;
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            color: #0d6efd !important;
        }

        .btn-template-action:active {
            transform: scale(0.95);
            background-color: #e9ecef !important;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.125);
        }

        @media (max-width: 768px) {
            .upload-area {
                padding: 20px 10px;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            <section class="content-area">
                <div class="container-fluid py-4">

                    <!-- Header e Ações Principais -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1"><i class="fas fa-folder-open me-2 text-primary"></i>Biblioteca de Documentos</h4>
                            <p class="text-muted mb-0 small">Gestão de arquivos e modelos jurídicos</p>
                        </div>
                        <div class="d-flex gap-2">
                             <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#templatesCollapse" aria-expanded="false" aria-controls="templatesCollapse">
                                <i class="fas fa-magic me-2"></i>Gerador de Documentos
                            </button>
                            <button onclick="abrirUploadSwal()" class="btn btn-primary shadow-sm">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Novo Documento
                            </button>
                        </div>
                    </div>

                    <!-- Templates Rápidos (Collapsible) -->
                    <div class="collapse mb-4" id="templatesCollapse">
                        <div class="card border-0 shadow-sm bg-light">
                            <div class="card-body">
                                <h6 class="card-title fw-bold text-primary mb-3"><i class="fas fa-bolt me-2"></i>Templates Rápidos</h6>
                                <div class="row g-3">
                                    <div class="col-md-5 position-relative d-flex flex-column justify-content-end">
                                        <label class="form-label fw-semibold small">Cliente (PF)</label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-user-search text-muted"></i></span>
                                            <input id="procClienteBusca" class="form-control border-start-0" type="text" autocomplete="off" placeholder="Buscar por nome ou CPF..." />
                                        </div>
                                        <input id="procClienteId" type="hidden" />
                                        <div id="procClienteResultados" class="template-search-results d-none shadow-sm"></div>
                                        <div id="procClienteSelecionadoResumo" class="small text-muted mt-1 ms-1 position-absolute top-100 start-0">Nenhum cliente selecionado.</div>
                                    </div>
                                    <div class="col-md-7 d-flex flex-column justify-content-end">
                                        <label class="form-label fw-semibold small">Gerar PDF</label>
                                        <div class="d-flex gap-2">
                                            <button id="btnGerarProcuracaoAdJudicia" type="button" class="btn-template-action flex-grow-1 text-start">
                                                <i class="fas fa-file-contract text-danger me-2"></i>Procuração Ad Judicia
                                            </button>
                                            <button id="btnGerarContratoPrestacaoServicosAdvocaticios" type="button" class="btn-template-action flex-grow-1 text-start">
                                                <i class="fas fa-file-signature text-primary me-2"></i>Contrato Honorários
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Principal: Filtros e Tabela -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body p-0">
                            
                            <!-- Barra de Filtros -->
                            <div class="p-3 border-bottom bg-light bg-opacity-50">
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <div class="input-group">
                                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                                            <input type="text" id="filtroDocBusca" class="form-control border-start-0" placeholder="Buscar por título, descrição ou autor...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select id="filtroDocCategoria" class="form-select">
                                            <option value="">Todas as categorias</option>
                                            <option th:each="c : ${categoriasDocumentos}" th:value="${c.nome}" th:text="${c.nome}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <button onclick="carregarDocs(0)" class="btn btn-light border w-100 fw-semibold text-primary">
                                            <i class="fas fa-filter me-1"></i> Filtrar
                                        </button>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <span class="text-muted small align-middle mt-2 d-inline-block">
                                            <i class="fas fa-file me-1"></i> <span th:text="${totalDocumentos ?: 0}">0</span> arquivos
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Tabela -->
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="bg-light text-secondary">
                                        <tr class="text-center small text-uppercase fw-bold">
                                            <th style="width: 10%;" class="border-bottom-0">Protocolo</th>
                                            <th style="width: 35%;" class="text-start border-bottom-0">Documento</th>
                                            <th style="width: 15%;" class="border-bottom-0">Categoria</th>
                                            <th style="width: 15%;" class="border-bottom-0">Autor</th>
                                            <th style="width: 15%;" class="border-bottom-0">Data</th>
                                            <th style="width: 10%;" class="text-end border-bottom-0 pe-4">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="docsTableBody" class="border-top-0 text-center">
                                        <!-- Loading State -->
                                        <tr class="loading-spinner">
                                            <td colspan="6" class="py-5 text-center text-muted">
                                                <i class="fas fa-circle-notch fa-spin fa-2x mb-2"></i>
                                                <p class="mb-0 small">Carregando documentos...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Paginação -->
                            <div class="d-flex justify-content-between align-items-center p-3 border-top bg-light bg-opacity-10">
                                <span id="docsPageInfo" class="text-muted small fw-semibold">Página 1 de 1</span>
                                <div class="btn-group shadow-sm">
                                    <button id="docsPrev" class="btn btn-white border btn-sm px-3" onclick="mudarPaginaDocs(-1)" disabled>
                                        <i class="fas fa-chevron-left me-1"></i> Anterior
                                    </button>
                                    <button id="docsNext" class="btn btn-white border btn-sm px-3" onclick="mudarPaginaDocs(1)" disabled>
                                        Próximo <i class="fas fa-chevron-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção de Modelos (Bottom) -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold text-secondary"><i class="fas fa-copy me-2 text-warning"></i>Modelos Oficiais</h6>
                            <button th:if="${isAdmin or isMaster}" onclick="abrirModeloSwal()" class="btn btn-sm btn-light text-primary fw-semibold border">
                                <i class="fas fa-plus me-1"></i> Novo Modelo
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle text-center">
                                <thead class="bg-light text-secondary">
                                    <tr class="small text-uppercase fw-bold">
                                        <th class="text-start ps-4">Nome do Modelo</th>
                                        <th>Categoria</th>
                                        <th>Versão</th>
                                        <th class="text-end pe-4">Opções</th>
                                    </tr>
                                </thead>
                                <tbody id="modelosTableBody">
                                    <tr th:if="${modelosDocumentos == null or modelosDocumentos.isEmpty()}">
                                        <td colspan="4" class="text-center py-4 text-muted">Nenhum modelo cadastrado.</td>
                                    </tr>
                                    <tr th:each="m : ${modelosDocumentos}">
                                        <td class="text-start ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3 fs-4 text-primary opacity-75"><i class="fas fa-file-contract"></i></div>
                                                <div>
                                                    <div class="fw-semibold text-dark" th:text="${m.nome}">Contrato</div>
                                                    <div class="small text-muted">Modelo Oficial</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span class="badge bg-light text-dark border fw-normal" th:text="${m.categoria}">Geral</span></td>
                                        <td><span class="badge bg-info bg-opacity-10 text-info border fw-normal" th:text="'v' + ${m.versao}">v1.0</span></td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-sm btn-primary" data-action="modelo-usar" th:data-id="${m.id}" title="Gerar Documento a partir deste modelo">
                                                    <i class="fas fa-magic me-1"></i> Gerar
                                                </button>
                                                <a th:href="@{/juridico/api/modelos/{id}/download(id=${m.id})}" class="btn btn-sm btn-white border text-secondary" title="Baixar Modelo">
                                                    <i class="fas fa-download"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Footer -->
            <footer th:replace="~{components/footer :: footer}"></footer>

        </main>
    </div>

    <!-- Scripts -->
    <script>var CAN_PREVIEW = false; var CAN_DOWNLOAD = false;</script>
    <script th:inline="javascript">
        var IS_ADMIN = /*[[${isAdmin}]]*/ false;
        var IS_MASTER = /*[[${isMaster}]]*/ false;
        var IS_RH = /*[[${isRH}]]*/ false;
        var IS_JURIDICO = /*[[${isJuridico}]]*/ false;
        CAN_PREVIEW = IS_ADMIN || IS_MASTER || IS_RH || IS_JURIDICO;
        CAN_DOWNLOAD = IS_ADMIN || IS_MASTER || IS_RH || IS_JURIDICO;
    </script>
    <script src="/js/sidebar.js" defer></script>
    <script src="/js/notifications.js"></script> <!-- Se usar notificação customizada -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Modal Detalhes Documento -->
    <div class="modal fade" id="docDetalhesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="docDetalhesTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="docDetalhesBody"></div>
                <div class="modal-footer">
                    <a id="docDownloadBtn" href="#" class="btn btn-primary" target="_blank"><i
                            class="fas fa-download"></i> Baixar</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalUploadDoc" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cloud-upload-alt text-primary"></i> Upload de Documento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formUploadDoc" enctype="multipart/form-data" autocomplete="off">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Título *</label>
                                <input id="docTitulo" name="titulo" class="form-control" type="text" maxlength="120"
                                    required placeholder="Ex.: Contrato de Locação" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Categoria *</label>
                                <select id="docCategoria" name="categoria" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    <option th:each="c : ${categoriasDocumentos}" th:value="${c.nome}"
                                        th:text="${c.nome}"></option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Descrição</label>
                                <input id="docDescricao" name="descricao" class="form-control" type="text"
                                    maxlength="200" placeholder="Breve descrição" />
                            </div>
                            <div class="col-md-12 mt-2">
                                <label class="form-label fw-semibold">Arquivo *</label>
                                <input id="docArquivo" name="file" class="form-control" type="file"
                                    accept=".pdf,.doc,.docx,.png,.jpg" required />
                                <small class="text-muted">Tipos permitidos: PDF, DOC, DOCX, PNG, JPG. Máx.
                                    10MB.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="btnUploadDocumento" type="button" class="btn btn-success"><i class="fas fa-upload"></i>
                        Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalUploadModelo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-alt text-primary"></i> Adicionar Modelo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formUploadModelo">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Arquivo (Word/PDF)</label>
                            <input id="modeloFiles" class="form-control" type="file" accept=".pdf,.doc,.docx" multiple />
                            <small class="text-muted">Tipos: PDF, DOC, DOCX. Máx. 10MB.</small>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-8">
                                <label class="form-label fw-semibold">Categoria</label>
                                <input id="modeloCategoria" class="form-control" type="text"
                                    placeholder="Ex: Contratos, Procurações" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Versão</label>
                                <input id="modeloVersao" class="form-control" type="text" value="1.0.0" />
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="btnUploadModelos" type="button" class="btn btn-primary"><i class="fas fa-plus"></i>
                        Adicionar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // UX Loading
        function showDocsLoading(show) {
            $('#docsLoading').toggleClass('d-none', !show);
        }

        // Notificação
        function notify(type, title, message, priority = 'medium', options = {}) {
            if (typeof showToast === 'function') {
                showToast({ type, title, message, priority, ...options });
            } else {
                const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
                alert(`${icon} ${title}: ${message}`);
            }
        }

        $(function () {
            // Função para abrir Upload via SweetAlert2
            window.abrirUploadSwal = function() {
                // Reaproveita as options do select oculto (renderizado pelo Thymeleaf)
                const optionsHtml = $('#docCategoria').html();
                
                Swal.fire({
                    title: 'Upload de Documento',
                    html: `
                        <div class="text-start">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Título *</label>
                                <input id="swalDocTitulo" class="form-control" placeholder="Ex.: Contrato de Locação" maxlength="120">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Categoria *</label>
                                <select id="swalDocCategoria" class="form-select">
                                    ${optionsHtml}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Descrição</label>
                                <input id="swalDocDescricao" class="form-control" placeholder="Breve descrição" maxlength="200">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Arquivo *</label>
                                <input id="swalDocArquivo" type="file" class="form-control" accept=".pdf,.doc,.docx,.png,.jpg">
                                <div class="form-text small">Tipos permitidos: PDF, DOC, DOCX, PNG, JPG. Máx. 10MB.</div>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-upload"></i> Enviar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#198754',
                    cancelButtonColor: '#6c757d',
                    focusConfirm: false,
                    showLoaderOnConfirm: true,
                    preConfirm: () => {
                        const titulo = document.getElementById('swalDocTitulo').value.trim();
                        const categoria = document.getElementById('swalDocCategoria').value;
                        const descricao = document.getElementById('swalDocDescricao').value.trim();
                        const fileInput = document.getElementById('swalDocArquivo');
                        const file = fileInput.files[0];

                        if (!titulo || !categoria || !file) {
                            Swal.showValidationMessage('Preencha todos os campos obrigatórios (Título, Categoria e Arquivo)');
                            return false;
                        }

                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('titulo', titulo);
                        formData.append('categoria', categoria);
                        formData.append('descricao', descricao);

                        return $.ajax({
                            url: '/juridico/api/documentos/upload-multipart',
                            method: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false
                        }).catch(error => {
                            const msg = error.responseJSON && error.responseJSON.erro ? error.responseJSON.erro : 'Erro no upload';
                            Swal.showValidationMessage(msg);
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Sucesso!',
                            text: 'Documento enviado com sucesso.',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.reload();
                        });
                    }
                });
            };

            // Antigo Upload (desativado/mantido apenas como referência se precisar)
            /*
            $('#btnUploadDocumento').on('click', function () {
                // ... (código antigo)
            });
            */


            // Listagem paginada via API
            let docsPage = 0;
            let docsTotalPages = 1;
            const docsSize = 10;

                    function renderDocs(items) {
                const $tbody = $('#docsTableBody');
                $tbody.empty();
                if (!items || items.length === 0) {
                    $tbody.append('<tr><td colspan=\"6\" class=\"text-center py-4 text-muted\">Nenhum documento encontrado.</td></tr>');
                    return;
                }
                items.forEach((d, index) => {
                    const lower = (d.caminhoArquivo || '').toLowerCase();
                    const ct = (d.contentType || '').toLowerCase();
                    const fn = (d.originalFilename || '').toLowerCase();
                    const isPdf = ct.includes('pdf') || lower.endsWith('.pdf') || fn.endsWith('.pdf');
                    const isImg = ct.startsWith('image/') || lower.endsWith('.png') || lower.endsWith('.jpg') || lower.endsWith('.jpeg') || fn.endsWith('.png') || fn.endsWith('.jpg') || fn.endsWith('.jpeg');
                    const isWord = ct.includes('word') || lower.endsWith('.doc') || lower.endsWith('.docx') || fn.endsWith('.doc') || fn.endsWith('.docx');
                    
                    let iconClass = 'fa-file';
                    let iconColor = 'text-secondary';
                    if (isPdf) { iconClass = 'fa-file-pdf'; iconColor = 'text-danger'; }
                    else if (isImg) { iconClass = 'fa-file-image'; iconColor = 'text-info'; }
                    else if (isWord) { iconClass = 'fa-file-word'; iconColor = 'text-primary'; }

                    const docIdFormatted = d.id ? '#' + String(d.id).padStart(4, '0') : '—';
                    const dataCriado = d.criadoEm ? new Date(d.criadoEm).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '—';
                    const hasSignature = d.autentiqueId && d.linkAssinatura;
                    const canPreviewDoc = CAN_PREVIEW && (isPdf || isImg);
                    const canDownloadDoc = CAN_DOWNLOAD;
                    const canSendSign = isPdf && CAN_DOWNLOAD;
                    const canSignEmpresa = hasSignature;
                    const canSync = hasSignature;

                    let statusBadgeHtml = '';
                    if (hasSignature) {
                        const status = (d.statusAssinatura || '').toUpperCase();
                        let statusClass = 'bg-primary bg-opacity-10 text-primary border';
                        let statusIcon = 'fa-paper-plane';
                        let statusText = 'Enviado para assinatura';
                        if (status === 'ASSINADO') {
                            statusClass = 'bg-success bg-opacity-10 text-success border';
                            statusIcon = 'fa-check-circle';
                            statusText = 'Assinado';
                        } else if (status === 'PENDENTE') {
                            statusClass = 'bg-warning bg-opacity-10 text-warning border';
                            statusIcon = 'fa-clock';
                            if (d.detalheStatusAssinatura) {
                                statusText = d.detalheStatusAssinatura;
                            } else {
                                statusText = 'Pendente de assinatura';
                            }
                        }
                        statusBadgeHtml = `<div class="small mt-1"><span class="badge ${statusClass}"><i class="fas ${statusIcon} me-1"></i>${statusText}</span></div>`;
                    }

                    const actions = `
                        <div class="d-flex justify-content-end gap-1">
                            <a class="btn btn-sm btn-white border text-secondary ${canPreviewDoc ? '' : 'disabled'}"
                               href="${canPreviewDoc ? `/juridico/documentos/preview/${d.id}` : '#'}"
                               target="_blank" title="Visualizar" tabindex="${canPreviewDoc ? '0' : '-1'}" aria-disabled="${canPreviewDoc ? 'false' : 'true'}">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a class="btn btn-sm btn-white border text-primary ${canDownloadDoc ? '' : 'disabled'}"
                               href="${canDownloadDoc ? `/juridico/documentos/download/${d.id}` : '#'}"
                               target="_blank" title="Baixar" tabindex="${canDownloadDoc ? '0' : '-1'}" aria-disabled="${canDownloadDoc ? 'false' : 'true'}">
                                <i class="fas fa-download"></i>
                            </a>
                            <button type="button"
                                    class="btn btn-sm btn-success border text-white ${canSendSign ? '' : 'disabled'}"
                                    data-action="doc-assinar" data-id="${d.id}"
                                    title="Enviar para assinatura ao cliente"
                                    ${canSendSign ? '' : 'disabled'}>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                            <a class="btn btn-sm btn-outline-success border ${canSignEmpresa ? '' : 'disabled'}"
                               href="${canSignEmpresa ? (d.linkAssinaturaEmpresa || d.linkAssinatura) : '#'}"
                               target="_blank" title="Assinar como escritório"
                               tabindex="${canSignEmpresa ? '0' : '-1'}" aria-disabled="${canSignEmpresa ? 'false' : 'true'}">
                                <i class="fas fa-pen-nib"></i>
                            </a>
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary border ${canSync ? '' : 'disabled'}"
                                    data-action="doc-sync" data-id="${d.id}"
                                    title="Sincronizar status da assinatura"
                                    ${canSync ? '' : 'disabled'}>
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-white border text-danger"
                                    data-action="doc-excluir" data-id="${d.id}" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>`;

                    // Tratamento visual do Autor
                    let autorDisplay;
                    if (d.autor && d.autor.trim() !== '' && d.autor.toLowerCase() !== 'sistema') {
                        // Autor Humano
                        autorDisplay = `
                            <div class="d-inline-flex align-items-center gap-1 text-secondary" title="${d.autor}">
                                <i class="fas fa-user-circle text-primary opacity-75"></i>
                                <span class="d-inline-block text-truncate" style="max-width: 120px;">${d.autor}</span>
                            </div>`;
                    } else {
                        // Sistema / Automático
                        autorDisplay = `
                            <span class="badge bg-light text-secondary border fw-normal" title="Gerado automaticamente pelo sistema">
                                <i class="fas fa-robot me-1"></i>Sistema
                            </span>`;
                    }

                    $tbody.append(`
                <tr class="align-middle">
                    <td class="text-center text-muted small font-monospace">${docIdFormatted}</td>
                    <td class="text-start">
                        <div class="d-flex align-items-center">
                            <div class="me-3 fs-4 ${iconColor}"><i class="fas ${iconClass}"></i></div>
                            <div>
                                <div class="fw-semibold text-dark">${d.titulo || 'Sem título'}</div>
                                <div class="small text-muted text-truncate" style="max-width: 250px;">${d.descricao || d.originalFilename || '—'}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge bg-light text-dark border fw-normal">${d.categoria || 'Geral'}</span></td>
                    <td>${autorDisplay}</td>
                    <td class="small text-secondary">
                        ${dataCriado}
                        ${statusBadgeHtml}
                    </td>
                    <td>${actions}</td>
                </tr>`);
                });
            }

            function atualizarDocsPaginacao() {
                $('#docsPageInfo').text(`Página ${docsPage + 1} de ${docsTotalPages}`);
                $('#docsPrev').prop('disabled', docsPage <= 0);
                $('#docsNext').prop('disabled', docsPage >= docsTotalPages - 1);
            }

            function carregarDocs(page = 0) {
                const categoria = $('#filtroDocCategoria').val();
                const search = $('#filtroDocBusca').val()?.trim();
                showDocsLoading(true);
                $.get('/juridico/api/documentos', { categoria, search, page, size: docsSize })
                    .done(res => {
                        docsPage = res.page || 0;
                        docsTotalPages = res.totalPages || 1;
                        renderDocs(res.content);
                        atualizarDocsPaginacao();
                    })
                    .fail(() => {
                        notify('error', 'Falha ao listar', 'Não foi possível carregar os documentos.', 'high');
                        $('#docsTableBody').html('<tr><td colspan=\"6\" class=\"text-center py-4 text-muted\">Erro ao carregar documentos.</td></tr>');
                    })
                    .always(() => showDocsLoading(false));
            }

            $('#btnBuscarDocs').on('click', () => carregarDocs(0));
            $('#docsPrev').on('click', () => { if (docsPage > 0) carregarDocs(docsPage - 1); });
            $('#docsNext').on('click', () => { if (docsPage < docsTotalPages - 1) carregarDocs(docsPage + 1); });

            // Carregar ao abrir
            carregarDocs(0);

            function atualizarMetrics() {
                $.get('/juridico/api/documentos/metrics')
                    .done(res => {
                        const total = (res && typeof res.total !== 'undefined') ? res.total : '—';
                        const catCount = (res && Array.isArray(res.categorias)) ? res.categorias.length : '—';
                        $('#metricTotalDocs').text(total);
                        $('#metricCategoriasCount').text(catCount);
                    });
            }
            atualizarMetrics();
            setInterval(atualizarMetrics, 30000);

            let procDebounce = null;
            let procSelecionado = null;

            let lastSearchResults = []; // Armazena resultados da busca para acesso ao selecionar

            function hideProcResultados() {
                $('#procClienteResultados').addClass('d-none').empty();
            }

            function setProcSelecionado(cliente) {
                procSelecionado = cliente;
                $('#procClienteId').val(cliente ? cliente.id : '');
                const nome = cliente ? (cliente.nomeFantasia || cliente.nome || '—') : '—';
                const tipo = cliente ? (cliente.tipoCliente || '—') : '—';
                const status = cliente ? (cliente.status || '—') : '—';
                $('#procClienteSelecionadoResumo').text(cliente ? `${nome} | Tipo: ${tipo} | Status: ${status}` : 'Nenhum cliente selecionado.');
            }

            $('#procClienteBusca').on('input', function () {
                const q = ($(this).val() || '').trim();
                setProcSelecionado(null);
                if (!q) {
                    hideProcResultados();
                    return;
                }
                if (procDebounce) clearTimeout(procDebounce);
                procDebounce = setTimeout(() => {
                    $.get('/clientes/avancado/api/busca', { busca: q, tipoCliente: 'PF', ativo: true, size: 8, page: 0 })
                        .done(res => {
                            const items = (res && res.content) ? res.content : [];
                            lastSearchResults = items; // Guarda para uso no click
                            const $box = $('#procClienteResultados');
                            $box.empty();
                            if (!items.length) {
                                $box.append(`<div class="template-search-item text-muted">Nenhum cliente encontrado</div>`);
                                $box.removeClass('d-none');
                                return;
                            }
                            items.forEach(c => {
                                const display = (c.nomeFantasia || c.nome || '—');
                                const extra = [c.tipoCliente, c.status].filter(Boolean).join(' | ');
                                $box.append(`
                            <div class="template-search-item" data-id="${c.id}">
                                <div class="fw-semibold">${display}</div>
                                <div class="small text-muted">${extra}</div>
                            </div>
                        `);
                            });
                            $box.removeClass('d-none');
                        })
                        .fail(() => {
                            hideProcResultados();
                            notify('error', 'Falha na busca', 'Não foi possível buscar clientes.', 'high');
                        });
                }, 250);
            });

            $(document).on('click', '#procClienteResultados .template-search-item', function () {
                const id = $(this).attr('data-id');
                if (!id) return;
                // Busca o objeto completo nos resultados armazenados
                const cliente = lastSearchResults.find(c => c.id == id);
                if (cliente) {
                    setProcSelecionado(cliente);
                    const nome = cliente.nomeFantasia || cliente.nome || '';
                    $('#procClienteBusca').val(nome);
                }
                hideProcResultados();
            });

            $(document).on('click', function (e) {
                const $t = $(e.target);
                if ($t.closest('#procClienteResultados').length || $t.closest('#procClienteBusca').length) return;
                hideProcResultados();
            });

            async function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'documento.pdf';
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }

            function getFilenameFromContentDisposition(cd) {
                if (!cd) return null;
                const match = /filename="?([^"]+)"?/i.exec(cd);
                return match ? match[1] : null;
            }

            $('#btnGerarProcuracaoAdJudicia').on('click', async function () {
                const $btn = $(this);
                const id = $('#procClienteId').val();
                if (!id) {
                    notify('error', 'Seleção obrigatória', 'Selecione um cliente PF para gerar a procuração.', 'high');
                    return;
                }
                try {
                    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Gerando...');
            const resp = await fetch(`/juridico/api/templates/procuracao-ad-judicia/pdf?clienteId=${encodeURIComponent(id)}`, {
                method: 'GET',
                headers: { 'Accept': 'application/pdf, application/json' }
            });
                    if (!resp.ok) {
                        const txt = await resp.text();
                        let msg = 'Falha ao gerar procuração';
                        try {
                            const j = JSON.parse(txt);
                            msg = j.erro || msg;
                        } catch (_) { }
                        notify('error', 'Erro', msg, 'high');
                        return;
                    }
                    const cd = resp.headers.get('content-disposition');
                    const filename = getFilenameFromContentDisposition(cd) || 'procuracao_ad_judicia.pdf';
                    const blob = await resp.blob();
                    await downloadBlob(blob, filename);
                    notify('success', 'PDF gerado', 'Download iniciado.', 'low');
                    carregarDocs(0);
                    atualizarMetrics();
                } catch (e) {
                    notify('error', 'Erro', 'Não foi possível gerar o PDF.', 'high');
                } finally {
                    $btn.prop('disabled', false).html('<i class="fas fa-file-pdf"></i> Gerar PDF');
                }
            });

            $('#btnGerarContratoPrestacaoServicosAdvocaticios').on('click', async function () {
                const $btn = $(this);
                const id = $('#procClienteId').val();
                if (!id) {
                    notify('error', 'Seleção obrigatória', 'Selecione um cliente PF para gerar o contrato.', 'high');
                    return;
                }
                try {
                    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Gerando...');
            const resp = await fetch(`/juridico/api/templates/contrato-prestacao-servicos-advocaticios/pdf?clienteId=${encodeURIComponent(id)}`, {
                method: 'GET',
                headers: { 'Accept': 'application/pdf, application/json' }
            });
                    if (!resp.ok) {
                        const txt = await resp.text();
                        let msg = 'Falha ao gerar contrato';
                        try {
                            const j = JSON.parse(txt);
                            msg = j.erro || msg;
                        } catch (_) { }
                        notify('error', 'Erro', msg, 'high');
                        return;
                    }
                    const cd = resp.headers.get('content-disposition');
                    const filename = getFilenameFromContentDisposition(cd) || 'contrato_prestacao_servicos_advocaticios.pdf';
                    const blob = await resp.blob();
                    await downloadBlob(blob, filename);
                    notify('success', 'PDF gerado', 'Download iniciado.', 'low');
                    carregarDocs(0);
                    atualizarMetrics();
                } catch (e) {
                    notify('error', 'Erro', 'Não foi possível gerar o PDF.', 'high');
                } finally {
                    $btn.prop('disabled', false).html('<i class="fas fa-file-pdf"></i> Gerar PDF');
                }
            });

            $(document).on('click', '[data-action="modelo-usar"]', function () {
                const id = $(this).attr('data-id');
                const categoriasOptions = $('#filtroDocCategoria option').map((i, o) => {
                    const val = $(o).val();
                    const text = $(o).text();
                    return val ? `<option value="${val}">${text}</option>` : '';
                }).get().join('');

                Swal.fire({
                    title: 'Gerar Documento',
                    html: `
                        <div class="text-start">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Título *</label>
                                <input id="swal-titulo" class="form-control" placeholder="Ex: Contrato de Prestação de Serviços">
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Categoria</label>
                                <select id="swal-categoria" class="form-select">
                                    <option value="">(usar a do modelo)</option>
                                    ${categoriasOptions}
                                </select>
                            </div>
                            <div class="mb-0">
                                <label class="form-label fw-semibold">Descrição</label>
                                <input id="swal-descricao" class="form-control" placeholder="Breve descrição do documento">
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Gerar',
                    cancelButtonText: 'Cancelar',
                    focusConfirm: false,
                    preConfirm: () => {
                        const titulo = document.getElementById('swal-titulo').value;
                        const categoria = document.getElementById('swal-categoria').value;
                        const descricao = document.getElementById('swal-descricao').value;

                        if (!titulo) {
                            Swal.showValidationMessage('O título é obrigatório');
                            return false;
                        }
                        return { titulo, categoria, descricao };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const { titulo, categoria, descricao } = result.value;
                        
                        Swal.fire({
                            title: 'Gerando...',
                            text: 'Aguarde enquanto o documento é criado.',
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading()
                        });

                        $.post('/juridico/api/documentos/gerar', { modeloId: id, titulo, categoria, descricao })
                            .done(res => {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Sucesso!',
                                    text: 'Documento gerado com sucesso.',
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                setTimeout(() => carregarDocs(0), 1000);
                            })
                            .fail(xhr => {
                                const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Falha ao gerar documento';
                                Swal.fire('Erro', msg, 'error');
                            });
                    }
                });
            });

            $(document).on('click', '[data-action="doc-detalhes"]', function () {
                const id = $(this).attr('data-id');
                $.get(`/juridico/api/documentos/${id}`)
                    .done(d => {
                        $('#docDetalhesTitle').text(d.titulo || 'Documento');
                        const corpo = `
                    <div>
                        <p><b>Categoria:</b> ${d.categoria || '—'}</p>
                        <p><b>Descrição:</b> ${d.descricao || '—'}</p>
                        <p><b>Caminho:</b> ${d.caminhoArquivo || '—'}</p>
                        <p><b>Criado em:</b> ${d.criadoEm || '—'}</p>
                        <p><b>Autor:</b> ${d.autor || '—'}</p>
                        <p><b>Status da assinatura:</b> ${d.statusAssinatura || (d.autentiqueId ? '—' : 'Não enviado')}</p>
                    </div>`;
                        $('#docDetalhesBody').html(corpo);
                        $('#docDownloadBtn').attr('href', `/juridico/documentos/download/${id}`);
                        const modal = new bootstrap.Modal(document.getElementById('docDetalhesModal'));
                        modal.show();
                    })
                    .fail(() => notify('error', 'Falha ao carregar', 'Não foi possível obter detalhes do documento.', 'high'));
            });

            $(document).on('click', '[data-action="doc-excluir"]', async function () {
                const id = $(this).attr('data-id');
                const result = await Swal.fire({
                    title: 'Atenção',
                    text: 'Confirma excluir este documento?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sim, excluir',
                    cancelButtonText: 'Cancelar'
                });

                if (!result.isConfirmed) return;
                
                $.ajax({ url: `/juridico/api/documentos/${id}`, method: 'DELETE' })
                    .done(() => { notify('success', 'Excluído', 'Documento removido com sucesso.'); carregarDocs(0); })
                    .fail(xhr => {
                        const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Falha ao excluir documento';
                        notify('error', 'Erro', msg, 'high');
                    });
            });

            $(document).on('click', '[data-action="doc-sync"]', function () {
                if ($(this).prop('disabled')) return;
                const id = $(this).attr('data-id');
                const $btn = $(this);
                const originalHtml = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
                $.ajax({
                    url: `/juridico/api/documentos/${id}/sincronizar-assinatura`,
                    method: 'PUT'
                })
                    .done(res => {
                        notify('success', 'Status atualizado', 'Status da assinatura sincronizado com sucesso.', 'medium');
                        carregarDocs(docsPage);
                    })
                    .fail(xhr => {
                        const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Falha ao sincronizar status da assinatura';
                        notify('error', 'Erro', msg, 'high');
                    })
                    .always(() => {
                        $btn.prop('disabled', false).html(originalHtml);
                    });
            });

            $(document).on('click', '[data-action="doc-assinar"]', async function () {
                if ($(this).hasClass('disabled') || $(this).prop('disabled')) return;
                const id = $(this).attr('data-id');
                const { value: email } = await Swal.fire({
                    title: 'Enviar para assinatura',
                    input: 'email',
                    inputLabel: 'E-mail do destinatário',
                    inputPlaceholder: 'cliente@exemplo.com',
                    showCancelButton: true,
                    confirmButtonText: 'Enviar',
                    cancelButtonText: 'Cancelar',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Informe um e-mail válido';
                        }
                        return null;
                    }
                });
                if (!email) return;
                Swal.fire({
                    title: 'Enviando...',
                    text: 'Aguarde enquanto o documento é enviado para assinatura.',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });
                $.post(`/juridico/api/documentos/${id}/enviar-assinatura`, { email })
                    .done(res => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Enviado!',
                            text: 'Documento enviado para assinatura com sucesso.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        carregarDocs(docsPage);
                    })
                    .fail(xhr => {
                        const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Falha ao enviar para assinatura';
                        Swal.fire('Erro', msg, 'error');
                    });
            });

            // Função para abrir Modelo via SweetAlert2
            window.abrirModeloSwal = function() {
                Swal.fire({
                    title: 'Adicionar Modelo',
                    html: `
                        <div class="text-start">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Arquivo (Word/PDF)</label>
                                <input id="swalModeloFiles" class="form-control" type="file" accept=".pdf,.doc,.docx" multiple>
                                <div class="form-text small">Tipos: PDF, DOC, DOCX. Máx. 10MB.</div>
                            </div>
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">Categoria</label>
                                    <input id="swalModeloCategoria" class="form-control" placeholder="Ex: Contratos, Procurações">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Versão</label>
                                    <input id="swalModeloVersao" class="form-control" value="1.0.0">
                                </div>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-plus"></i> Adicionar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#0d6efd',
                    cancelButtonColor: '#6c757d',
                    focusConfirm: false,
                    showLoaderOnConfirm: true,
                    preConfirm: () => {
                        const filesInput = document.getElementById('swalModeloFiles');
                        const files = filesInput.files;
                        const categoria = document.getElementById('swalModeloCategoria').value.trim();
                        const versao = document.getElementById('swalModeloVersao').value.trim();

                        if (!files || files.length === 0) {
                            Swal.showValidationMessage('Selecione ao menos um arquivo.');
                            return false;
                        }

                        const fd = new FormData();
                        Array.from(files).forEach(f => fd.append('files', f));
                        if (categoria) fd.append('categoria', categoria);
                        if (versao) fd.append('versao', versao);

                        return $.ajax({
                            url: '/juridico/api/modelos/upload-batch',
                            method: 'POST',
                            data: fd,
                            processData: false,
                            contentType: false,
                        }).catch(error => {
                            const msg = error.responseJSON && error.responseJSON.erro ? error.responseJSON.erro : 'Falha ao criar modelos';
                            Swal.showValidationMessage(msg);
                        });
                    },
                    allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        const res = result.value;
                        Swal.fire({
                            icon: 'success',
                            title: 'Modelos adicionados',
                            text: (res.criados?.length || 0) + ' modelos criados',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            window.location.reload();
                        });
                    }
                });
            };

            // Antigo Modelo (desativado)
            /*
            $('#btnUploadModelos').on('click', function () {
               // ...
            });
            */
        });
    </script>

</body>

</html>
