<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${pageTitle} + ' - ERP Corporativo'">Documentos Jurídicos - ERP Corporativo</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="/css/corporate.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            <section class="content-area">
                <div class="container-fluid py-4">
                    <div class="mb-4">
                        <h1 class="display-6 text-muted"><i class="fas fa-folder-open"></i> Documentos Jurídicos</h1>
                        <p class="text-muted">Categorias, documentos recentes e modelos.</p>
                    </div>

                    <!-- Upload Rápido (agora com arquivo) -->
                    <div class="card p-3 mb-4 shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-cloud-upload-alt"></i> Upload de Documento</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Título</label>
                                <input id="docTitulo" class="form-control" type="text" placeholder="Ex.: Contrato de Locação" required />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Categoria</label>
                                <select id="docCategoria" class="form-select">
                                    <option th:each="c : ${categoriasDocumentos}" th:value="${c.nome}" th:text="${c.nome}"></option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">Descrição</label>
                                <input id="docDescricao" class="form-control" type="text" placeholder="Breve descrição" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Arquivo</label>
                                <input id="docArquivo" class="form-control" type="file" accept=".pdf,.doc,.docx,.png,.jpg" />
                                <small class="text-muted">Tipos comuns permitidos. Limite típico 10MB.</small>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="btnUploadDocumento" class="btn btn-primary"><i class="fas fa-save"></i> Enviar</button>
                        </div>
                    </div>

                    <!-- Listagem Paginada -->
                    <div class="card p-3 mb-4 shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-list"></i> Documentos (paginado)</h5>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Categoria</label>
                                <select id="filtroDocCategoria" class="form-select">
                                    <option value="">Todas</option>
                                    <option th:each="c : ${categoriasDocumentos}" th:value="${c.nome}" th:text="${c.nome}"></option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Busca</label>
                                <input id="filtroDocBusca" class="form-control" type="text" placeholder="Título ou descrição" />
                            </div>
                            <div class="col-md-3">
                                <button id="btnBuscarDocs" class="btn btn-primary w-100"><i class="fas fa-search"></i> Buscar</button>
                            </div>
                        </div>
                        <div class="table-responsive mt-3">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Título</th>
                                        <th>Categoria</th>
                                        <th>Descrição</th>
                                        <th>Arquivo</th>
                                        <th>Criado em</th>
                                    </tr>
                                </thead>
                                <tbody id="docsTableBody">
                                    <tr><td colspan="5" class="text-muted">Use os filtros para listar documentos.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="small" id="docsPageInfo">Página 1 de 1</div>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm" id="docsPrev" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                                <button class="btn btn-outline-secondary btn-sm" id="docsNext" disabled>Próxima <i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Categorias -->
                    <div class="card p-3 mb-4 shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-tags"></i> Categorias</h5>
                        <div th:if="${categoriasDocumentos != null and !categoriasDocumentos.isEmpty()}" class="d-flex flex-wrap gap-2">
                            <span class="badge bg-secondary" th:each="c : ${categoriasDocumentos}" th:text="|${c.nome} (${c.quantidade})|">Categoria</span>
                        </div>
                        <div th:if="${categoriasDocumentos == null or categoriasDocumentos.isEmpty()}" class="text-muted">Nenhuma categoria.</div>
                    </div>

                    <div class="row g-3">
                        <!-- Documentos Recentes -->
                        <div class="col-md-6">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-clock"></i> Documentos Recentes</h5>
                                <div th:if="${documentosRecentes != null and !documentosRecentes.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="d : ${documentosRecentes}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${d.titulo}">Título</div>
                                                    <small class="text-muted">Categoria: <span th:text="${d.categoria}">—</span></small>
                                                </div>
                                                <div class="text-end">
                                                    <div class="small text-muted" th:text="${d.dataUpload}">—</div>
                                                    <span class="badge bg-info" th:text="${d.autor}">Autor</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${documentosRecentes == null or documentosRecentes.isEmpty()}" class="text-muted">Nenhum documento recente.</div>
                            </div>
                        </div>

                        <!-- Modelos de Documentos -->
                        <div class="col-md-6">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-file-alt"></i> Modelos de Documentos</h5>
                                <div th:if="${modelosDocumentos != null and !modelosDocumentos.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="m : ${modelosDocumentos}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${m.nome}">Modelo</div>
                                                    <small class="text-muted">Categoria: <span th:text="${m.categoria}">—</span></small>
                                                </div>
                                                <span class="badge bg-secondary" th:text="|v${m.versao}|">v1.0</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${modelosDocumentos == null or modelosDocumentos.isEmpty()}" class="text-muted">Nenhum modelo disponível.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function() {
            function notify(type, title, message, priority = 'medium', options = {}) {
                if (typeof showToast === 'function') {
                    showToast({ type, title, message, priority, ...options });
                } else {
                    const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
                    alert(`${icon} ${title}: ${message}`);
                }
            }

            $('#btnUploadDocumento').on('click', function() {
                const $btn = $(this);
                const titulo = $('#docTitulo').val()?.trim();
                const categoria = $('#docCategoria').val();
                const descricao = $('#docDescricao').val()?.trim();
                const file = $('#docArquivo')[0]?.files?.[0];

                if (!titulo || !categoria) {
                    notify('error', 'Campos obrigatórios', 'Informe Título e Categoria.');
                    return;
                }

                const originalHtml = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Enviando...');

                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('titulo', titulo);
                    formData.append('categoria', categoria);
                    formData.append('descricao', descricao || '');
                    $.ajax({
                        url: '/juridico/api/documentos/upload-multipart',
                        method: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(res) {
                            notify('success', 'Documento enviado', res.id ? `ID ${res.id}` : 'Upload concluído', 'low', { durationMs: 6000 });
                            setTimeout(() => window.location.reload(), 1200);
                        },
                        error: function(xhr) {
                            const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Erro no upload de arquivo';
                            notify('error', 'Falha no upload', msg, 'high', { sticky: true });
                        },
                        complete: function() {
                            $btn.prop('disabled', false).html(originalHtml);
                        }
                    });
                } else {
                    $.ajax({
                        url: '/juridico/api/documentos/upload',
                        method: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ titulo, categoria, descricao }),
                        success: function(res) {
                            notify('success', 'Documento enviado', res.id ? `ID ${res.id}` : 'Documento criado', 'low', { durationMs: 6000 });
                            setTimeout(() => window.location.reload(), 1200);
                        },
                        error: function(xhr) {
                            const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Erro no upload';
                            notify('error', 'Falha no upload', msg, 'high', { sticky: true });
                        },
                        complete: function() {
                            $btn.prop('disabled', false).html(originalHtml);
                        }
                    });
                }
            });

            // Listagem paginada via API
            let docsPage = 0;
            let docsTotalPages = 1;
            const docsSize = 10;

            function renderDocs(items) {
                const $tbody = $('#docsTableBody');
                $tbody.empty();
                if (!items || items.length === 0) {
                    $tbody.append('<tr><td colspan="5" class="text-center text-muted">Nenhum documento encontrado.</td></tr>');
                    return;
                }
                items.forEach(d => {
                    const link = d.caminhoArquivo ? `<a href="${d.caminhoArquivo}" target="_blank"><i class='fas fa-file'></i> Abrir</a>` : '<span class="text-muted">—</span>';
                    $tbody.append(`
                        <tr>
                            <td>${d.titulo || '—'}</td>
                            <td>${d.categoria || '—'}</td>
                            <td>${d.descricao || '—'}</td>
                            <td>${link}</td>
                            <td>${d.criadoEm || '—'}</td>
                        </tr>
                    `);
                });
            }

            function atualizarDocsPaginacao() {
                $('#docsPageInfo').text(`Página ${docsPage + 1} de ${docsTotalPages}`);
                $('#docsPrev').prop('disabled', docsPage <= 0);
                $('#docsNext').prop('disabled', docsPage >= docsTotalPages - 1);
            }

            function carregarDocs(page = 0) {
                const categoria = $('#filtroDocCategoria').val();
                const search = $('#filtroDocBusca').val()?.trim();
                $('#docsTableBody').html('<tr><td colspan="5" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>');
                $.get('/juridico/api/documentos', { categoria, search, page, size: docsSize })
                    .done(res => {
                        docsPage = res.page || 0;
                        docsTotalPages = res.totalPages || 1;
                        renderDocs(res.content);
                        atualizarDocsPaginacao();
                    })
                    .fail(() => {
                        notify('error', 'Falha ao listar', 'Não foi possível carregar os documentos.', 'high');
                        $('#docsTableBody').html('<tr><td colspan="5" class="text-center text-muted">Erro ao carregar documentos.</td></tr>');
                    });
            }

            $('#btnBuscarDocs').on('click', () => carregarDocs(0));
            $('#docsPrev').on('click', () => { if (docsPage > 0) carregarDocs(docsPage - 1); });
            $('#docsNext').on('click', () => { if (docsPage < docsTotalPages - 1) carregarDocs(docsPage + 1); });
        });
    </script>
</body>
</html>
