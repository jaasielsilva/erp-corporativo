<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${pageTitle} ?: 'Jurídico > Previdenciário (INSS)'">Jurídico > Previdenciário (INSS)</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/notifications.css}" />
    <link rel="stylesheet" th:href="@{/css/corporate.css}" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>

            <section class="content-area container-fluid py-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h1 class="h4 mb-1"><i class="fas fa-scale-balanced me-2"></i>Previdenciário (INSS)</h1>
                        <p class="text-muted mb-0">Processos e andamento por etapa</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a th:href="@{/api/juridico/relatorios/previdenciario/export}"
                            th:if="${#authorization.expression('hasAuthority(''JURIDICO_PREVIDENCIARIO_EXPORTAR'')')}"
                            class="btn btn-outline-success">
                            <i class="fas fa-file-excel me-2"></i>Exportar
                        </a>
                        <a class="btn btn-primary" href="/juridico/previdenciario/novo">
                            <i class="fas fa-plus me-2"></i>Novo processo
                        </a>
                    </div>
                </div>

                <div th:if="${sucesso}" class="alert alert-success" th:text="${sucesso}"></div>
                <div th:if="${erro}" class="alert alert-danger" th:text="${erro}"></div>

                <!-- Filtros e Busca -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="filtroBusca" class="form-control border-start-0" placeholder="Buscar por cliente ou protocolo...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="filtroStatus" class="form-select">
                            <option value="">Todos os status</option>
                            <option value="ABERTO">Aberto</option>
                            <option value="EM_ANDAMENTO">Em Andamento</option>
                            <option value="SUSPENSO">Suspenso</option>
                            <option value="ENCERRADO">Encerrado</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr class="text-center align-middle">
                                        <th style="width: 120px;">Processo</th>
                                        <th>Cliente</th>
                                        <th>Etapa</th>
                                        <th>Status</th>
                                        <th>Responsável</th>
                                        <th style="width: 180px;">Abertura</th>
                                        <th style="width: 140px;">Decisão</th>
                                        <th style="width: 140px;">Valor da causa</th>
                                        <th style="width: 120px;">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="procTableBody">
                                    <!-- Conteúdo carregado via AJAX -->
                                    <tr>
                                        <td colspan="9" class="text-center py-5">
                                            <i class="fas fa-spinner fa-spin fa-2x mb-2 text-primary"></i>
                                            <p class="text-muted mb-0">Carregando processos...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Paginação -->
                <nav aria-label="Navegação de página" class="mt-3">
                    <ul class="pagination justify-content-center" id="pagination">
                    </ul>
                </nav>
            </section>

            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <!-- Offcanvas de Detalhes do Processo (Inovação Jurídica) -->
    <div class="offcanvas offcanvas-end process-offcanvas" tabindex="-1" id="procDetailOffcanvas"
        aria-labelledby="procDetailOffcanvasLabel">
        <div class="offcanvas-header">
            <div>
                <h5 class="offcanvas-title fw-bold" id="procDetailOffcanvasLabel">Detalhes do Processo</h5>
                <div class="process-meta">
                    <span id="procDetailNumeroHeader"
                        class="badge bg-white text-dark bg-opacity-25">0000000-00.0000.0.00.0000</span>
                    <span id="procDetailStatusHeader" class="badge bg-success">EM ANDAMENTO</span>
                </div>
            </div>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0">
            <!-- Navegação em Abas Modernas -->
            <ul class="nav nav-tabs modern-tabs px-3 pt-2" id="procTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-resumo" data-bs-toggle="tab"
                        data-bs-target="#content-resumo" type="button" role="tab">Resumo</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-timeline" data-bs-toggle="tab" data-bs-target="#content-timeline"
                        type="button" role="tab">Timeline</button>
                </li>
            </ul>

            <div class="tab-content p-4">
                <!-- Conteúdo Resumo -->
                <div class="tab-pane fade show active" id="content-resumo" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-12 mb-2">
                            <h6 class="text-muted text-uppercase small fw-bold mb-3">Informações Gerais</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-balance-scale me-1"></i> Etapa Atual</div>
                                <div class="info-value" id="procDetailEtapa">—</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-tag me-1"></i> Tipo</div>
                                <div class="info-value" id="procDetailTipo">Previdenciária</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-user-friends me-1"></i> Parte Contrária</div>
                                <div class="info-value" id="procDetailParte">INSS</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-file-alt me-1"></i> Protocolo INSS</div>
                                <div class="info-value" id="procDetailProtocolo">—</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label"><i class="far fa-calendar-alt me-1"></i> Abertura</div>
                                <div class="info-value" id="procDetailDataAbertura">—</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card border-0 bg-light">
                                <div class="info-label">Ações Rápidas</div>
                                <a id="btnDetalhesCompleto" href="#" class="btn btn-sm btn-outline-info w-100 mb-2"><i
                                        class="fas fa-external-link-alt"></i> Ver Detalhes</a>
                                <a id="btnEditarOffcanvas" href="#" class="btn btn-sm btn-outline-primary w-100 mb-2"><i
                                        class="fas fa-edit"></i> Editar Completo</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="content-timeline" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Linha do Tempo</h6>
                    </div>

                    <div class="timeline-wrapper mb-4">
                        <div class="timeline">
                            <div class="timeline-progress"></div>

                            <div class="timeline-item active" id="previd-step-1">
                                <div class="timeline-marker">1</div>
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h3 class="card-title mb-0">Contato</h3>
                                        <span class="status-badge neutral" id="previd-status-1">Novo</span>
                                    </div>
                                    <div class="card-content p-3">
                                        <p class="mb-2">Msg cliente.</p>
                                        <button class="btn btn-primary btn-sm" id="previd-btn-iniciar">
                                            <i class="fas fa-play me-1"></i> Iniciar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-item neutral" id="previd-step-2">
                                <div class="timeline-marker">2</div>
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h3 class="card-title mb-0">Solicitação</h3>
                                        <span class="status-badge neutral" id="previd-status-2">Aguardando</span>
                                    </div>
                                    <div class="card-content p-3">
                                        <p class="mb-2">Docs enviados.</p>
                                        <button class="btn btn-primary btn-sm mb-2" id="previd-btn-enviado" disabled>
                                            <i class="fas fa-check me-1"></i> Enviado
                                        </button>
                                        <details>
                                            <summary>Ver Lista</summary>
                                            <ul class="mb-1">
                                                <li>RG/CNH</li>
                                                <li>Comp. Residência</li>
                                                <li>CTPS</li>
                                                <li>Holerites</li>
                                                <li>Docs Médicos</li>
                                                <li>Prontuário</li>
                                                <li>Dados Bancários</li>
                                                <li>B.O / C.A.T</li>
                                            </ul>
                                        </details>
                                        <div style="font-size:0.75rem; color:#64748b; margin-top:0.3rem;">
                                            <i class="fas fa-clock me-1"></i> Data: <span id="previd-data-envio">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-item neutral" id="previd-step-3">
                                <div class="timeline-marker">3</div>
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h3 class="card-title mb-0">Análise</h3>
                                        <span class="status-badge neutral" id="previd-status-3">Bloqueado</span>
                                    </div>
                                    <div class="card-content p-3">
                                        <p class="mb-2">Triagem.</p>
                                        <div class="alert-box alert-danger mb-2" id="previd-pendencias-box" style="display:none;">
                                            Pendente
                                        </div>
                                        <div id="previd-analise-info" style="display:none; font-size:0.75rem; color:#64748b; margin-top:0.3rem;">
                                            <i class="fas fa-clock me-1"></i> Data: <span id="previd-data-analise">-</span>
                                        </div>
                                        <div class="btn-row mt-2 d-flex gap-2">
                                            <button class="btn btn-success btn-sm" id="previd-btn-ok" disabled>OK</button>
                                            <button class="btn btn-warning btn-sm" id="previd-btn-pendente" disabled>Pendente</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-item neutral" id="previd-step-4">
                                <div class="timeline-marker">4</div>
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h3 class="card-title mb-0">Contrato</h3>
                                        <span class="status-badge neutral" id="previd-status-4">Bloqueado</span>
                                    </div>
                                    <div class="card-content p-3">
                                        <p class="mb-2">Formalização.</p>
                                        <div class="d-flex justify-content-between align-items-center mb-2" style="font-size:0.8rem;">
                                            <span>Status:</span>
                                            <span id="previd-contrato-status" style="font-weight:bold;">Não Enviado</span>
                                        </div>
                                        <div class="btn-row d-flex gap-2">
                                            <button class="btn btn-primary btn-sm" id="previd-btn-env-contrato" disabled>Enviar</button>
                                            <button class="btn btn-success btn-sm" id="previd-btn-conf-assinatura" style="display:none;">Confirmar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="timeline-item neutral" id="previd-step-5">
                                <div class="timeline-marker">5</div>
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h3 class="card-title mb-0">Médico</h3>
                                        <span class="status-badge neutral" id="previd-status-5">Bloqueado</span>
                                    </div>
                                    <div class="card-content p-3">
                                        <p class="mb-2">Perícia.</p>
                                        <div class="alert-box alert-danger mb-2" id="previd-alerta-pagamento" style="display:none;">
                                            PAGAMENTO PENDENTE
                                        </div>
                                        <div class="btn-row d-flex gap-2">
                                            <button class="btn btn-danger btn-sm" id="previd-btn-pgto-medico" disabled>$ Pagar</button>
                                            <button class="btn btn-primary btn-sm" id="previd-btn-laudo" disabled>Laudo</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="previdTimeline" class="timeline-modern">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Carregando histórico...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/js/sidebar.js}"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script th:inline="javascript">
        const sucessoMsg = /*[[${sucesso}]]*/ null;
        const erroMsg = /*[[${erro}]]*/ null;

        let currentPage = 0;
        let currentSize = 10;
        let currentSearch = '';
        let currentStatus = '';
        let debounceTimer;

        if (typeof Swal !== 'undefined') {
            if (sucessoMsg) {
                Swal.fire({ icon: 'success', title: 'Sucesso', text: sucessoMsg });
            }
            if (erroMsg) {
                Swal.fire({ icon: 'error', title: 'Erro', text: erroMsg });
            }
        }

        function notify(type, title, message) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: title,
                    text: message,
                    icon: type,
                    confirmButtonColor: '#0d6efd'
                });
            } else if (typeof toastr !== 'undefined') {
                if (type === 'error') toastr.error(message, title);
                else if (type === 'success') toastr.success(message, title);
                else if (type === 'warning') toastr.warning(message, title);
                else toastr.info(message, title);
            } else {
                alert(title + "\n" + message);
            }
        }

        $(function () {
            window.loadProcessos = function(page) {
                currentPage = page;
                $('#procTableBody').html('<tr><td colspan="9" class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x mb-2 text-primary"></i><p class="text-muted mb-0">Carregando processos...</p></td></tr>');
                
                const params = new URLSearchParams({
                    page: page,
                    size: currentSize
                });
                
                if (currentSearch) params.append('search', currentSearch);
                if (currentStatus) params.append('status', currentStatus);

                fetch(`/juridico/previdenciario/api/processos?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        renderRows(data.content);
                        renderPagination(data);
                    })
                    .catch(error => {
                        console.error('Erro ao carregar processos:', error);
                        $('#procTableBody').html('<tr><td colspan="9" class="text-center py-5 text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0">Erro ao carregar dados.</p></td></tr>');
                    });
            };

            function renderRows(processos) {
                const tbody = $('#procTableBody');
                tbody.empty();

                if (!processos || processos.length === 0) {
                    tbody.html('<tr><td colspan="9" class="text-center py-5"><p class="text-muted mb-0">Nenhum processo encontrado.</p></td></tr>');
                    return;
                }

                processos.forEach(p => {
                    // Badge de Status
                    let statusBadgeClass = 'bg-secondary';
                    if (p.statusAtual === 'EM_ANDAMENTO') statusBadgeClass = 'bg-success';
                    else if (p.statusAtual === 'SUSPENSO') statusBadgeClass = 'bg-warning text-dark';
                    else if (p.statusAtual === 'ENCERRADO') statusBadgeClass = 'bg-dark';

                    // Formatar data
                    let dataAbertura = '—';
                    let anoAbertura = new Date().getFullYear();
                    if (p.dataAbertura) {
                        const d = new Date(p.dataAbertura);
                        dataAbertura = d.toLocaleDateString('pt-BR');
                        anoAbertura = d.getFullYear();
                    }
                    
                    // Padronizar ID (ex: 0004/2026)
                    const idPadrao = String(p.id).padStart(4, '0') + '/' + anoAbertura;
                    
                    // Formatar valor
                    let valorCausa = '—';
                    if (p.valorCausa !== null && p.valorCausa !== undefined) {
                         valorCausa = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(p.valorCausa);
                    }

                    const html = `
                        <tr class="proc-row cursor-pointer text-center align-middle" data-id="${p.id}" style="cursor: pointer;">
                            <td><span class="fw-bold text-secondary">${idPadrao}</span></td>
                            <td class="fw-bold text-primary">${p.cliente ? p.cliente.nome : '—'}</td>
                            <td><span class="badge bg-light text-dark border">${p.etapaAtual || '—'}</span></td>
                            <td><span class="badge ${statusBadgeClass}">${p.statusAtual || '—'}</span></td>
                            <td>
                                <div class="d-flex align-items-center justify-content-center" style="display: flex !important; align-items: center !important; justify-content: center !important;">
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; min-width: 32px; font-weight: bold; display: flex !important; justify-content: center !important; align-items: center !important;">
                                        ${p.responsavel && p.responsavel.nome ? p.responsavel.nome.charAt(0) : '?'}
                                    </div>
                                    <small class="text-nowrap">${p.responsavel ? p.responsavel.nome : '—'}</small>
                                </div>
                            </td>
                            <td>${dataAbertura}</td>
                            <td>${p.resultadoDecisao || '—'}</td>
                            <td>${valorCausa}</td>
                            <td>
                                <a href="/juridico/previdenciario/${p.id}" class="btn btn-sm btn-light" onclick="event.stopPropagation()">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                            </td>
                        </tr>
                    `;
                    tbody.append(html);
                });
            }

            function renderPagination(data) {
                const el = $('#pagination');
                el.empty();
                
                const totalPages = data.totalPages || 0;
                const totalElements = data.totalElements || 0;
                const page = data.currentPage || 0;
                
                if (totalElements === 0) return;

                // Anterior
                const prevDisabled = !data.hasPrevious ? 'disabled' : '';
                el.append(`
                    <li class="page-item ${prevDisabled}">
                        <a class="page-link" href="#" onclick="loadProcessos(${page - 1}); return false;">Anterior</a>
                    </li>
                `);

                // Páginas
                let startPage = Math.max(0, page - 2);
                let endPage = Math.min(totalPages - 1, page + 2);
                
                for (let i = startPage; i <= endPage; i++) {
                    const active = i === page ? 'active' : '';
                    el.append(`
                        <li class="page-item ${active}">
                            <a class="page-link" href="#" onclick="loadProcessos(${i}); return false;">${i + 1}</a>
                        </li>
                    `);
                }

                // Próxima
                const nextDisabled = !data.hasNext ? 'disabled' : '';
                el.append(`
                    <li class="page-item ${nextDisabled}">
                        <a class="page-link" href="#" onclick="loadProcessos(${page + 1}); return false;">Próxima</a>
                    </li>
                `);
                
                // Info
                el.after(`<div class="text-center mt-2 text-muted small">Mostrando página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} registros)</div>`);
            }

            loadProcessos(0);

            $('#filtroBusca').on('input', function() {
                clearTimeout(debounceTimer);
                currentSearch = $(this).val();
                debounceTimer = setTimeout(() => loadProcessos(0), 500);
            });

            $('#filtroStatus').on('change', function() {
                currentStatus = $(this).val();
                loadProcessos(0);
            });

            function abrirDetalhesProcesso(id) {
                if (!id) return;

                $('#procDetailNumeroHeader').text('Carregando...');
                $('#procDetailStatusHeader').text('...');
                $('#procDetailEtapa').text('...');
                $('#procDetailProtocolo').text('...');
                $('#procDetailDataAbertura').text('...');

                $('#previdTimeline').html('<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>Carregando histórico...</p></div>');

                $('.timeline-item').removeClass('active completed neutral').addClass('neutral');
                $('.status-badge').text('Bloqueado').removeClass('neutral success warning danger').addClass('neutral');
                $('button[id^="previd-btn-"]').prop('disabled', true);
                $('#previd-pendencias-box').hide();
                $('#previd-analise-info').hide();
                $('#previd-alerta-pagamento').hide();
                $('#previd-btn-conf-assinatura').hide();

                const offcanvasEl = document.getElementById('procDetailOffcanvas');
                if (offcanvasEl) {
                    const offcanvas = new bootstrap.Offcanvas(offcanvasEl);
                    offcanvas.show();

                    const firstTabEl = document.querySelector('#procTabs button[data-bs-target="#content-resumo"]');
                    if (firstTabEl) {
                        const tab = new bootstrap.Tab(firstTabEl);
                        tab.show();
                    }
                }

                $('#procDetailOffcanvas').attr('data-proc-id', id);

                $.get(`/juridico/previdenciario/api/processos/${id}`)
                    .done(res => {
                        $('#procDetailNumeroHeader').text(res.numero || 'Novo Processo');

                        const status = res.status || '—';
                        const statusBadge = $('#procDetailStatusHeader');
                        statusBadge.text(status);
                        statusBadge.removeClass('bg-success bg-warning bg-secondary bg-dark text-dark text-white');

                        if (status === 'EM_ANDAMENTO') statusBadge.addClass('bg-success text-white');
                        else if (status === 'SUSPENSO') statusBadge.addClass('bg-warning text-dark');
                        else if (status === 'ENCERRADO') statusBadge.addClass('bg-dark text-white');
                        else statusBadge.addClass('bg-secondary text-white');

                        $('#procDetailEtapa').text(res.etapa || '—');
                        $('#procDetailProtocolo').text(res.numero || '—');
                        $('#procDetailDataAbertura').text(res.dataAbertura ? new Date(res.dataAbertura).toLocaleDateString('pt-BR') : '—');

                        $('#btnDetalhesCompleto').attr('href', `/juridico/previdenciario/${id}`);
                        $('#btnEditarOffcanvas').attr('href', `/juridico/previdenciario/${id}`);

                        carregarTimelinePrevid(id);
                        atualizarEstadoTimelinePrevid(res);
                    })
                    .fail(() => {
                    });
            }

            function renderTimeline(items) {
                const $container = $('#previdTimeline');
                $container.empty();

                if (!items || items.length === 0) {
                    $container.html('<div class="text-center text-muted py-4"><p>Nenhum histórico disponível.</p></div>');
                    return;
                }

                items.forEach(item => {
                    let iconClass = 'fa-circle';
                    if (item.titulo && item.titulo.includes('ABERTURA')) iconClass = 'fa-file-signature';
                    else if (item.titulo && item.titulo.includes('DECISAO')) iconClass = 'fa-gavel';
                    
                    let dataFormatada = item.data;
                    try {
                        if (item.data) {
                            const d = new Date(item.data);
                            dataFormatada = d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                                ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        }
                    } catch (e) { }

                    $container.append(`
                        <div class="timeline-item-modern">
                            <div class="timeline-icon-modern">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="timeline-content-modern">
                                <span class="timeline-date-modern">${dataFormatada || '—'}</span>
                                <h5 class="timeline-title-modern">${item.titulo || 'Evento'}</h5>
                                <div class="timeline-desc-modern">${item.descricao || ''}</div>
                                ${item.usuario ? `<small class="text-muted mt-2 d-block border-top pt-2"><i class="fas fa-user-circle me-1"></i> ${item.usuario}</small>` : ''}
                            </div>
                        </div>
                    `);
                });
            }

            $(document).on('click', '.proc-row', function (e) {
                if ($(e.target).closest('a').length > 0 || $(e.target).closest('button').length > 0) return;
                
                const id = $(this).data('id');
                if (id) abrirDetalhesProcesso(id);
            });
            
            const params = new URLSearchParams(window.location.search);
            const openId = params.get('openProcessId');
            if (openId) {
                abrirDetalhesProcesso(openId);
            }

            function carregarTimelinePrevid(id) {
                $.get(`/juridico/previdenciario/api/processos/${id}/historico`)
                    .done(timeline => {
                        renderTimeline(timeline);
                    })
                    .fail(() => {
                        renderTimeline([]);
                    });
            }

            function atualizarEstadoTimelinePrevid(p) {
                const etapa = p.etapa;

                const setStep = (num, status, badgeText, badgeClass) => {
                    const $el = $(`#previd-step-${num}`);
                    $el.removeClass('neutral active completed').addClass(status);
                    $(`#previd-status-${num}`).text(badgeText).removeClass('neutral success warning danger').addClass(badgeClass);
                };

                if (etapa === 'CADASTRO') {
                    setStep(1, 'active', 'Ação Necessária', 'warning');
                    $('#previd-btn-iniciar').prop('disabled', false);
                } else {
                    setStep(1, 'completed', 'Concluído', 'success');
                    $('#previd-btn-iniciar').prop('disabled', true);
                }

                if (etapa === 'DOCUMENTACAO') {
                    setStep(2, 'active', 'Aguardando Envio', 'warning');
                    $('#previd-btn-enviado').prop('disabled', false);
                } else if (['CADASTRO'].includes(etapa)) {
                    setStep(2, 'neutral', 'Aguardando', 'neutral');
                } else {
                    setStep(2, 'completed', 'Concluído', 'success');
                    $('#previd-btn-enviado').prop('disabled', true);
                }

                if (p.dataEnvioDocumentacao) {
                    const d = new Date(p.dataEnvioDocumentacao);
                    $('#previd-data-envio').text(d.toLocaleDateString('pt-BR'));
                } else {
                    $('#previd-data-envio').text('-');
                }

                if (etapa === 'ANALISE') {
                    setStep(3, 'active', 'Em Análise', 'warning');
                    $('#previd-btn-ok').prop('disabled', false);
                    $('#previd-btn-pendente').prop('disabled', false);
                } else if (['DOCUMENTACAO', 'CADASTRO'].includes(etapa)) {
                    setStep(3, 'neutral', 'Bloqueado', 'neutral');
                } else {
                    setStep(3, 'completed', 'Concluído', 'success');
                    $('#previd-btn-ok').prop('disabled', true);
                    $('#previd-btn-pendente').prop('disabled', true);
                }

                if (p.pendenciaAnalise) {
                    $('#previd-pendencias-box').show();
                } else {
                    $('#previd-pendencias-box').hide();
                }

                if (p.dataAnalise) {
                    const d = new Date(p.dataAnalise);
                    $('#previd-analise-info').show();
                    $('#previd-data-analise').text(d.toLocaleDateString('pt-BR'));
                } else {
                    $('#previd-analise-info').hide();
                    $('#previd-data-analise').text('-');
                }

                if (etapa === 'CONTRATO') {
                    setStep(4, 'active', 'Em Formalização', 'warning');
                    $('#previd-btn-env-contrato').prop('disabled', false);
                } else if (['CADASTRO', 'DOCUMENTACAO', 'ANALISE'].includes(etapa)) {
                    setStep(4, 'neutral', 'Bloqueado', 'neutral');
                    $('#previd-btn-env-contrato').prop('disabled', true);
                } else {
                    setStep(4, 'completed', 'Concluído', 'success');
                    $('#previd-btn-env-contrato').prop('disabled', true);
                }

                const statusContrato = p.statusContrato || 'NAO_ENVIADO';
                if (statusContrato === 'NAO_ENVIADO') {
                    $('#previd-contrato-status').text('Não Enviado');
                    $('#previd-btn-conf-assinatura').hide();
                } else if (statusContrato === 'ENVIADO') {
                    $('#previd-contrato-status').text('Enviado');
                    $('#previd-btn-conf-assinatura').show().prop('disabled', false);
                } else if (statusContrato === 'ASSINADO') {
                    $('#previd-contrato-status').text('Assinado');
                    $('#previd-btn-conf-assinatura').hide();
                }

                if (etapa === 'MEDICO') {
                    setStep(5, 'active', 'Em Andamento', 'warning');
                    $('#previd-btn-pgto-medico').prop('disabled', false);
                    $('#previd-btn-laudo').prop('disabled', !p.dataPagamentoMedico);
                } else if (['CADASTRO', 'DOCUMENTACAO', 'ANALISE', 'CONTRATO'].includes(etapa)) {
                    setStep(5, 'neutral', 'Bloqueado', 'neutral');
                    $('#previd-btn-pgto-medico').prop('disabled', true);
                    $('#previd-btn-laudo').prop('disabled', true);
                } else {
                    setStep(5, 'completed', 'Concluído', 'success');
                    $('#previd-btn-pgto-medico').prop('disabled', true);
                    $('#previd-btn-laudo').prop('disabled', true);
                }

                if (p.statusMedico === 'PENDENTE_PAGAMENTO') {
                    $('#previd-alerta-pagamento').show();
                } else {
                    $('#previd-alerta-pagamento').hide();
                }

                if (p.dataPagamentoMedico) {
                    $('#previd-alerta-pagamento').hide();
                    $('#previd-btn-laudo').prop('disabled', false);
                }
            }

            function apiAction(urlPattern, msg) {
                const procId = $('#procDetailOffcanvas').attr('data-proc-id');
                if(!procId) return;
                $.post(urlPattern.replace('{id}', procId))
                    .done(() => {
                        notify('success', 'Sucesso', msg);
                        $.get(`/juridico/previdenciario/api/processos/${procId}`)
                            .done(data => {
                                atualizarEstadoTimelinePrevid(data);
                                carregarTimelinePrevid(procId);
                            });
                    })
                    .fail(() => notify('error', 'Erro', 'Falha ao processar ação.'));
            }

            $('#previd-btn-iniciar').click(() => apiAction('/juridico/previdenciario/{id}/acoes/iniciar', 'Processo iniciado!'));
            $('#previd-btn-enviado').click(() => apiAction('/juridico/previdenciario/{id}/acoes/enviar-docs', 'Documentação enviada!'));
            $('#previd-btn-ok').click(() => apiAction('/juridico/previdenciario/{id}/acoes/analise-ok', 'Análise aprovada!'));
            $('#previd-btn-pendente').click(() => apiAction('/juridico/previdenciario/{id}/acoes/analise-pendente', 'Pendência registrada.'));
            $('#previd-btn-env-contrato').click(() => apiAction('/juridico/previdenciario/{id}/acoes/enviar-contrato', 'Contrato enviado!'));
            $('#previd-btn-conf-assinatura').click(() => apiAction('/juridico/previdenciario/{id}/acoes/assinar-contrato', 'Contrato assinado!'));
            $('#previd-btn-pgto-medico').click(() => apiAction('/juridico/previdenciario/{id}/acoes/pagar-medico', 'Pagamento médico registrado!'));
            $('#previd-btn-laudo').click(() => apiAction('/juridico/previdenciario/{id}/acoes/laudo-medico', 'Laudo médico emitido!'));
        });
    </script>
</body>

</html>
