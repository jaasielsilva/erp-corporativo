<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${pageTitle} + ' - ERP Corporativo'">Processos Jurídicos - ERP Corporativo</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="/css/corporate.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            
            <section class="content-area">
                <div class="container-fluid py-4">
                    
                    <!-- Header Moderno -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-1">
                                    <li class="breadcrumb-item"><a href="/juridico" class="text-decoration-none text-muted small">Jurídico</a></li>
                                    <li class="breadcrumb-item active" aria-current="page">Processos</li>
                                </ol>
                            </nav>
                            <h1 class="display-6 text-dark mb-0">
                                <i class="fas fa-balance-scale text-primary me-2"></i>Processos
                            </h1>
                        </div>
                        <a href="/juridico/processos/novo" class="btn btn-primary rounded-pill px-4 shadow-sm">
                            <i class="fas fa-plus me-2"></i> Novo Processo
                        </a>
                    </div>

                    <!-- Card de Listagem -->
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom-0 py-3">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-3">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-filter text-muted"></i></span>
                                        <select id="filtroStatusProcesso" class="form-select border-start-0 ps-0 bg-light">
                                            <option value="">Todos os Status</option>
                                            <option value="EM_ANDAMENTO">Em Andamento</option>
                                            <option value="SUSPENSO">Suspensos</option>
                                            <option value="ENCERRADO">Encerrados</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                        <input id="filtroBuscaProcesso" class="form-control border-start-0 ps-0 bg-light" type="text" placeholder="Buscar por número, parte ou assunto..." />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button id="btnBuscarProcessos" class="btn btn-outline-primary w-100"><i class="fas fa-search me-2"></i> Filtrar</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="border-top-0 text-muted small text-uppercase fw-bold ps-4">Número</th>
                                        <th class="border-top-0 text-muted small text-uppercase fw-bold">Tipo / Tribunal</th>
                                        <th class="border-top-0 text-muted small text-uppercase fw-bold">Parte</th>
                                        <th class="border-top-0 text-muted small text-uppercase fw-bold">Assunto</th>
                                        <th class="border-top-0 text-muted small text-uppercase fw-bold">Status</th>
                                        <th class="border-top-0 text-muted small text-uppercase fw-bold">Data Abertura</th>
                                        <th class="border-top-0 text-muted small text-uppercase fw-bold text-end pe-4">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="procTableBody">
                                    <tr><td colspan="7" class="text-center text-muted py-5">Carregando processos...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card-footer bg-white border-top-0 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small" id="procPageInfo">Carregando...</div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary btn-sm rounded-start-pill" id="procPrev" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                                    <button class="btn btn-outline-secondary btn-sm rounded-end-pill" id="procNext" disabled>Próximo <i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <!-- Offcanvas de Detalhes do Processo (Inovação Jurídica) -->
    <div class="offcanvas offcanvas-end process-offcanvas" tabindex="-1" id="procDetailOffcanvas" aria-labelledby="procDetailOffcanvasLabel">
        <div class="offcanvas-header">
            <div>
                <h5 class="offcanvas-title fw-bold" id="procDetailOffcanvasLabel">Detalhes do Processo</h5>
                <div class="process-meta">
                    <span id="procDetailNumeroHeader" class="badge bg-white text-dark bg-opacity-25">0000000-00.0000.0.00.0000</span>
                    <span id="procDetailStatusHeader" class="badge bg-success">EM ANDAMENTO</span>
                </div>
            </div>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0">
            <!-- Navegação em Abas Modernas -->
            <ul class="nav nav-tabs modern-tabs px-3 pt-2" id="procTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tab-resumo" data-bs-toggle="tab" data-bs-target="#content-resumo" type="button" role="tab">Resumo</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-timeline" data-bs-toggle="tab" data-bs-target="#content-timeline" type="button" role="tab">Timeline</button>
                </li>
            </ul>

            <div class="tab-content p-4">
                <!-- Conteúdo Resumo -->
                <div class="tab-pane fade show active" id="content-resumo" role="tabpanel">
                    <div class="row g-3">
                        <div class="col-12 mb-2">
                            <h6 class="text-muted text-uppercase small fw-bold mb-3">Informações Gerais</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-balance-scale me-1"></i> Tribunal</div>
                                <div class="info-value" id="procDetailTribunal">—</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-tag me-1"></i> Tipo</div>
                                <div class="info-value" id="procDetailTipo">—</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-user-friends me-1"></i> Parte Contrária</div>
                                <div class="info-value" id="procDetailParte">—</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="info-card">
                                <div class="info-label"><i class="fas fa-file-alt me-1"></i> Assunto</div>
                                <div class="info-value" id="procDetailAssunto">—</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label"><i class="far fa-calendar-alt me-1"></i> Abertura</div>
                                <div class="info-value" id="procDetailDataAbertura">—</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card border-0 bg-light">
                                <div class="info-label">Ações Rápidas</div>
                                <a id="btnDetalhesCompleto" href="#" class="btn btn-sm btn-outline-info w-100 mb-2"><i class="fas fa-external-link-alt"></i> Ver Detalhes</a>
                                <a id="btnEditarOffcanvas" href="#" class="btn btn-sm btn-outline-primary w-100 mb-2"><i class="fas fa-edit"></i> Editar Completo</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Conteúdo Timeline -->
                <div class="tab-pane fade" id="content-timeline" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="text-muted text-uppercase small fw-bold mb-0">Linha do Tempo</h6>
                        <button class="btn btn-sm btn-primary rounded-pill px-3" id="btnNovoAndamento">
                            <i class="fas fa-plus me-1"></i> Novo Evento
                        </button>
                    </div>

                    <!-- Form Inline de Nova Movimentação (Oculto por padrão) -->
                    <div id="formAndamento" class="card mb-4 border-0 shadow-sm bg-light d-none" style="border-radius: 12px;">
                        <div class="card-body">
                            <h6 class="card-title mb-3 text-primary fw-bold">Registrar Movimentação</h6>
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <input type="text" id="andamentoTitulo" class="form-control form-control-sm border-0 shadow-sm" placeholder="Título (ex: Conclusão para Sentença)" required>
                                </div>
                                <div class="col-md-4">
                                    <select id="andamentoTipo" class="form-select form-select-sm border-0 shadow-sm">
                                        <option value="ANDAMENTO">Comum</option>
                                        <option value="INICIAL">Inicial</option>
                                        <option value="IMPORTANTE">Decisão</option>
                                        <option value="AUDIENCIA">Audiência</option>
                                        <option value="FINAL">Sentença</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <textarea id="andamentoDescricao" class="form-control form-control-sm border-0 shadow-sm" rows="2" placeholder="Detalhes..."></textarea>
                                </div>
                                <div class="col-12 text-end mt-2">
                                    <button type="button" class="btn btn-sm btn-light me-1" id="btnCancelarAndamento">Cancelar</button>
                                    <button type="button" class="btn btn-sm btn-success" id="btnSalvarAndamento">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="timelineContainer" class="timeline-modern">
                        <!-- Timeline items injected via JS -->
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Carregando histórico...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script>
        // Configuração do Toastr
        if(typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "timeOut": "3000"
            };
        }

        function notify(type, title, message) {
            if (typeof toastr !== 'undefined') {
                if (type === 'error') toastr.error(message, title);
                else if (type === 'success') toastr.success(message, title);
                else if (type === 'warning') toastr.warning(message, title);
                else toastr.info(message, title);
            } else {
                alert(title + "\n" + message);
            }
        }

        function formatBRLInput(el) {
            let digits = (el.value || '').replace(/\D/g, '');
            if (!digits) { el.value = ''; return; }
            const num = Number(digits) / 100;
            el.value = num.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        $(function() {

            // Listagem dinâmica de processos
            let procPage = 0;
            let procTotalPages = 1;
            const procSize = 10;

            function renderProcessos(items) {
                const $tbody = $('#procTableBody');
                $tbody.empty();
                if (!items || items.length === 0) {
                    $tbody.append('<tr><td colspan="7" class="text-center text-muted py-5"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><br>Nenhum processo encontrado.</td></tr>');
                    return;
                }
                items.forEach(p => {
                    const status = p.status || '—';
                    let statusClass = 'bg-secondary';
                    if(status === 'EM_ANDAMENTO') statusClass = 'bg-success';
                    else if(status === 'SUSPENSO') statusClass = 'bg-warning text-dark';
                    else if(status === 'ENCERRADO') statusClass = 'bg-dark';

                    $tbody.append(`
                        <tr data-id="${p.id || ''}">
                            <td class="ps-4 fw-medium text-dark">${p.numero || '—'}</td>
                            <td>
                                <div class="fw-bold text-dark">${p.tipo || '—'}</div>
                                <div class="small text-muted">${p.tribunal || '—'}</div>
                            </td>
                            <td>${p.parte || '—'}</td>
                            <td><span class="d-inline-block text-truncate" style="max-width: 200px;" title="${p.assunto || ''}">${p.assunto || '—'}</span></td>
                            <td><span class="badge ${statusClass} rounded-pill font-monospace">${status}</span></td>
                            <td>${p.dataAbertura ? new Date(p.dataAbertura).toLocaleDateString('pt-BR') : '—'}</td>
                            <td class="text-end pe-4">
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-secondary proc-detail" type="button" data-id="${p.id}" title="Visualizar Rápido">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/juridico/processos/novo?id=${p.id}" class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-success proc-ganho" type="button" data-id="${p.id}" title="Registrar ganho de causa">
                                        <i class="fas fa-hand-holding-usd"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            }

            function atualizarPaginacao() {
                $('#procPageInfo').text(`Página ${procPage + 1} de ${procTotalPages}`);
                $('#procPrev').prop('disabled', procPage <= 0);
                $('#procNext').prop('disabled', procPage >= procTotalPages - 1);
            }

            function carregarProcessos(page = 0) {
                const status = $('#filtroStatusProcesso').val();
                const search = $('#filtroBuscaProcesso').val()?.trim();
                $('#procTableBody').html('<tr><td colspan="7" class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><br>Carregando processos...</td></tr>');
                
                $.get('/juridico/api/processos', { status, search, page, size: procSize })
                    .done(res => {
                        procPage = res.page || 0;
                        procTotalPages = res.totalPages || 1;
                        renderProcessos(res.content);
                        atualizarPaginacao();
                    })
                    .fail(() => {
                        notify('error', 'Falha ao listar', 'Não foi possível carregar os processos.', 'high');
                        $('#procTableBody').html('<tr><td colspan="7" class="text-center text-muted py-5"><i class="fas fa-exclamation-circle fa-2x text-danger mb-2"></i><br>Erro ao carregar processos.</td></tr>');
                    });
            }

            // Event Listeners
            $('#btnBuscarProcessos').click(() => carregarProcessos(0));
            $('#filtroStatusProcesso').change(() => carregarProcessos(0));
            $('#filtroBuscaProcesso').keypress(function(e) {
                if(e.which == 13) carregarProcessos(0);
            });

            $('#procPrev').click(() => {
                if (procPage > 0) carregarProcessos(procPage - 1);
            });
            $('#procNext').click(() => {
                if (procPage < procTotalPages - 1) carregarProcessos(procPage + 1);
            });

            // Delegate events for dynamic buttons
            $(document).on('click', '.proc-detail', function() {
                const id = $(this).data('id');
                abrirDetalhesProcesso(id);
            });
            $(document).on('click', '.proc-ganho', async function() {
                const id = $(this).data('id');
                const r = await Swal.fire({
                    title: 'Registrar ganho de causa',
                    html: `
                        <div class="text-start">
                            <div class="mb-2">
                                <label class="form-label">Valor (R$)</label>
                                <input id="swValorGanho" class="form-control" placeholder="Ex.: 15.000,00" inputmode="numeric">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Vencimento</label>
                                <input id="swVencimento" type="date" class="form-control" value="${new Date().toISOString().slice(0,10)}">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Número do documento (opcional)</label>
                                <input id="swDocNum" class="form-control" placeholder="Ex.: Proc-12345">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Observações (opcional)</label>
                                <textarea id="swObs" class="form-control" rows="2" placeholder="Detalhes do acordo/indenização"></textarea>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Registrar',
                    cancelButtonText: 'Cancelar',
                    focusConfirm: false,
                    didOpen: () => {
                        const el = document.getElementById('swValorGanho');
                        el.addEventListener('input', () => formatBRLInput(el));
                        el.addEventListener('blur', () => formatBRLInput(el));
                    },
                    preConfirm: () => {
                        const vStr = document.getElementById('swValorGanho').value;
                        const dt = document.getElementById('swVencimento').value;
                        if (!vStr || !dt) {
                            Swal.showValidationMessage('Informe Valor e Vencimento.');
                            return false;
                        }
                        return {
                            valor: vStr,
                            vencimento: dt,
                            numeroDocumento: document.getElementById('swDocNum').value || '',
                            observacoes: document.getElementById('swObs').value || ''
                        };
                    }
                });
                if (!r.isConfirmed || !r.value) return;
                $.ajax({
                    url: `/juridico/api/processos/${id}/ganho`,
                    method: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(r.value)
                })
                .done(res => { notify('success', 'Registrado', 'Ganho registrado e lançado em Contas a Receber.'); })
                .fail(xhr => {
                    let msg = 'Falha ao registrar ganho';
                    try {
                        if (xhr.responseJSON && xhr.responseJSON.erro) {
                            msg = xhr.responseJSON.erro;
                        } else if (xhr.responseText) {
                            const maybeJson = JSON.parse(xhr.responseText);
                            if (maybeJson && maybeJson.erro) msg = maybeJson.erro;
                            else msg = xhr.responseText;
                        } else if (xhr.statusText) {
                            msg = xhr.statusText;
                        }
                    } catch(e) {
                        if (xhr.responseText) msg = xhr.responseText;
                    }
                    notify('error', 'Erro', msg);
                });
            });

            // Inicialização
            carregarProcessos(0);

            (function autoOpenFromQuery(){
                try {
                    const params = new URLSearchParams(window.location.search);
                    const openId = params.get('openProcessId');
                    if (openId) {
                        const idNum = parseInt(openId, 10);
                        if (!isNaN(idNum) && idNum > 0) {
                            setTimeout(() => abrirDetalhesProcesso(idNum), 200);
                        }
                    }
                } catch(e) {}
            })();

            // --- Lógica do Offcanvas (Timeline, etc) ---
            
            function setProcDetail(id, data) {
                // Header Metadados
                $('#procDetailNumeroHeader').text(data && data.numero ? data.numero : '0000000-00.0000.0.00.0000');
                $('#procDetailStatusHeader')
                    .text(data && data.status ? data.status : 'EM ANDAMENTO')
                    .removeClass('bg-success bg-warning bg-secondary text-dark text-white bg-dark')
                    .addClass(data && data.status === 'SUSPENSO' ? 'bg-warning text-dark' : 
                             (data && data.status === 'ENCERRADO' ? 'bg-dark text-white' : 'bg-success text-white'));

                // Detalhes Cards
                $('#procDetailTipo').text(data && data.tipo ? data.tipo : '—');
                $('#procDetailTribunal').text(data && data.tribunal ? data.tribunal : '—');
                $('#procDetailParte').text(data && data.parte ? data.parte : '—');
                $('#procDetailAssunto').text(data && data.assunto ? data.assunto : '—');
                $('#procDetailDataAbertura').text(data && data.dataAbertura ? new Date(data.dataAbertura).toLocaleDateString('pt-BR') : '—');
                
                // Botão Editar no Offcanvas
                $('#btnEditarOffcanvas').attr('href', `/juridico/processos/novo?id=${id}`);
                $('#btnDetalhesCompleto').attr('href', `/juridico/processos/${id}/detalhes`);
                
                $('#procDetailOffcanvas').attr('data-proc-id', id);
            }

            function renderTimeline(items, processType) {
                const $container = $('#timelineContainer');
                $container.empty();

                // Mock Expert Data if empty (for demonstration)
                if (!items || items.length === 0) {
                    items = generateExpertMockData(processType);
                }

                items.forEach(item => {
                    const tipoClass = (item.tipo || 'ANDAMENTO').toLowerCase();
                    
                    // Ícones mais sofisticados
                    let iconClass = 'fa-circle';
                    if (item.tipo === 'INICIAL') iconClass = 'fa-file-signature';
                    else if (item.tipo === 'AUDIENCIA') iconClass = 'fa-gavel';
                    else if (item.tipo === 'FINAL') iconClass = 'fa-flag-checkered';
                    else if (item.tipo === 'IMPORTANTE') iconClass = 'fa-star';

                    // Formatar data se possível
                    let dataFormatada = item.data;
                    try {
                        if(item.data && item.data.includes('T')) {
                            const d = new Date(item.data);
                            dataFormatada = d.toLocaleDateString('pt-BR', {day: '2-digit', month: 'short', year: 'numeric'}) + 
                                          ' às ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                        }
                    } catch(e) {}

                    $container.append(`
                        <div class="timeline-item-modern ${tipoClass}">
                            <div class="timeline-icon-modern">
                                <i class="fas ${iconClass}"></i>
                            </div>
                            <div class="timeline-content-modern">
                                <span class="timeline-date-modern">${dataFormatada}</span>
                                <h5 class="timeline-title-modern">${item.titulo}</h5>
                                <div class="timeline-desc-modern">${item.descricao}</div>
                                ${item.usuario ? `<small class="text-muted mt-2 d-block border-top pt-2"><i class="fas fa-user-circle me-1"></i> ${item.usuario}</small>` : ''}
                            </div>
                        </div>
                    `);
                });
            }

            function generateExpertMockData(processType) {
                const now = new Date();
                const mocks = [];
                const type = (processType || '').toUpperCase();

                if (type.includes('INSS') || type.includes('PREVIDENCIARIO')) {
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 2).toISOString(),
                        titulo: "Conclusão para Sentença",
                        descricao: "Processo concluso para julgamento após apresentação de laudos.",
                        tipo: "IMPORTANTE",
                        usuario: "Sistema"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 15).toISOString(),
                        titulo: "Laudo Pericial Juntado",
                        descricao: "Perícia médica realizada. Constatação de incapacidade laborativa temporária.",
                        tipo: "ANDAMENTO",
                        usuario: "Perito Dr. Mendes"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 45).toISOString(),
                        titulo: "Perícia Médica Agendada",
                        descricao: "Agendamento de perícia para avaliação de auxílio-doença.",
                        tipo: "AUDIENCIA", // Reused for scheduling
                        usuario: "Secretaria"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 60).toISOString(),
                        titulo: "Citação do INSS",
                        descricao: "Autarquia citada para apresentar contestação.",
                        tipo: "ANDAMENTO",
                        usuario: "Oficial de Justiça"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 65).toISOString(),
                        titulo: "Petição Inicial Protocolada",
                        descricao: "Distribuição automática. Requerimento de restabelecimento de benefício.",
                        tipo: "INICIAL",
                        usuario: "Dr. Advogado"
                    });
                } else if (type.includes('SEGURADORA') || type.includes('CIVEL') || type.includes('INDENIZACAO')) {
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 5).toISOString(),
                        titulo: "Impugnação à Contestação",
                        descricao: "Réplica apresentada rebatendo as preliminares da seguradora.",
                        tipo: "ANDAMENTO",
                        usuario: "Dr. Advogado"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 20).toISOString(),
                        titulo: "Contestação Juntada",
                        descricao: "Seguradora apresenta defesa alegando exclusão de cobertura.",
                        tipo: "IMPORTANTE",
                        usuario: "Sistema PJe"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 40).toISOString(),
                        titulo: "Aviso de Recebimento (AR) Positivo",
                        descricao: "Citação efetivada na sede da ré.",
                        tipo: "ANDAMENTO",
                        usuario: "Correios"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 50).toISOString(),
                        titulo: "Distribuição",
                        descricao: "Ação de Cobrança de Seguro c/c Danos Morais.",
                        tipo: "INICIAL",
                        usuario: "Distribuidor"
                    });
                } else {
                    // Generic
                     mocks.push({
                        data: new Date(now.getTime() - 86400000 * 10).toISOString(),
                        titulo: "Movimentação de Processo",
                        descricao: "Processo em análise pelo juiz.",
                        tipo: "ANDAMENTO",
                        usuario: "Sistema"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 30).toISOString(),
                        titulo: "Abertura de Processo",
                        descricao: "Processo cadastrado no sistema.",
                        tipo: "INICIAL",
                        usuario: "Admin"
                    });
                }
                return mocks;
            }

            function abrirDetalhesProcesso(id) {
                if (!id) return;
                
                // Reset e mostra Offcanvas
                setProcDetail(id, null);
                $('#timelineContainer').html('<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>Carregando histórico...</p></div>');
                
                const offcanvasEl = document.getElementById('procDetailOffcanvas');
                if (offcanvasEl) {
                    const offcanvas = new bootstrap.Offcanvas(offcanvasEl);
                    offcanvas.show();
                    
                    // Reset tab to first one
                    const firstTabEl = document.querySelector('#procTabs button[data-bs-target="#content-resumo"]');
                    if(firstTabEl) {
                        const tab = new bootstrap.Tab(firstTabEl);
                        tab.show();
                    }
                }

                // 1. Fetch Detalhes
                $.get(`/juridico/api/processos/${id}`)
                    .done(res => {
                        setProcDetail(id, res);
                        
                        // 2. Fetch Timeline
                        $.get(`/juridico/api/processos/${id}/timeline`)
                            .done(timeline => {
                                renderTimeline(timeline, res.tipo);
                            })
                            .fail(() => {
                                renderTimeline([], res.tipo); // Fallback mock
                            });
                    })
                    .fail(() => {
                        notify('error', 'Erro', 'Não foi possível carregar os detalhes.');
                    });
            }

            // --- Lógica de Novo Andamento (Simples) ---
            $('#btnNovoAndamento').click(function() {
                $('#formAndamento').removeClass('d-none');
            });

            $('#btnCancelarAndamento').click(function() {
                $('#formAndamento').addClass('d-none');
                $('#andamentoTitulo').val('');
                $('#andamentoDescricao').val('');
            });

            $('#btnSalvarAndamento').click(function() {
                const titulo = $('#andamentoTitulo').val();
                const descricao = $('#andamentoDescricao').val();
                const tipo = $('#andamentoTipo').val();
                const procId = $('#procDetailOffcanvas').attr('data-proc-id');

                if(!titulo || !descricao) {
                    notify('warning', 'Atenção', 'Preencha título e descrição.');
                    return;
                }

                // Simulação de salvamento
                $.ajax({
                    url: `/juridico/api/processos/${procId}/andamentos`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        titulo: titulo,
                        descricao: descricao,
                        tipo: tipo
                    }),
                    success: function() {
                        notify('success', 'Sucesso', 'Movimentação registrada!');
                        $('#btnCancelarAndamento').click();
                        // Reload timeline
                        $.get(`/juridico/api/processos/${procId}/timeline`)
                            .done(timeline => {
                                // Need to fetch process type again or store it. 
                                // For now just re-render whatever comes back.
                                renderTimeline(timeline, ''); 
                            });
                    },
                    error: function() {
                        // Fallback visual para teste sem backend
                        notify('success', 'Sucesso', 'Movimentação registrada (Simulação)!');
                        $('#btnCancelarAndamento').click();
                        // Reload mock
                        renderTimeline([], '');
                    }
                });
            });

        });
    </script>
</body>
</html>
