<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${pageTitle} + ' - ERP Corporativo'">Processos Jurídicos - ERP Corporativo</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="/css/corporate.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            <section class="content-area">
                <div class="container-fluid py-4">
                    <div class="mb-4">
                        <h1 class="display-6 text-muted"><i class="fas fa-balance-scale"></i> Processos Jurídicos</h1>
                        <p class="text-muted">Cadastro rápido, visão por status, audiências e prazos.</p>
                    </div>

                    <!-- Filtros e Listagem Dinâmica -->
                    <div class="card p-3 mb-4 shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-filter"></i> Buscar Processos</h5>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Status</label>
                                <select id="filtroStatusProcesso" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="EM_ANDAMENTO">Em Andamento</option>
                                    <option value="SUSPENSO">Suspensos</option>
                                    <option value="ENCERRADO">Encerrados</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Busca</label>
                                <input id="filtroBuscaProcesso" class="form-control" type="text" placeholder="Número, parte ou assunto" />
                            </div>
                            <div class="col-md-3">
                                <button id="btnBuscarProcessos" class="btn btn-primary w-100"><i class="fas fa-search"></i> Buscar</button>
                            </div>
                        </div>
                        <div class="table-responsive mt-3">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Tipo</th>
                                        <th>Tribunal</th>
                                        <th>Parte</th>
                                        <th>Assunto</th>
                                        <th>Status</th>
                                        <th>Aberto em</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="procTableBody">
                                    <tr><td colspan="8" class="text-muted">Use os filtros para listar processos.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="small" id="procPageInfo">Página 1 de 1</div>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm" id="procPrev" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                                <button class="btn btn-outline-secondary btn-sm" id="procNext" disabled>Próxima <i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Novo Processo -->
                    <div class="card p-3 mb-4 shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Novo Processo</h5>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Número</label>
                                <input id="procNumero" class="form-control" type="text" placeholder="Ex.: 1234567-89.2025.8.26.0100" required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Tipo</label>
                                <input id="procTipo" class="form-control" type="text" placeholder="Cível, Trabalhista, etc." required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Tribunal</label>
                                <input id="procTribunal" class="form-control" type="text" placeholder="TJ/SP, TRT-2, etc." required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Parte</label>
                                <input id="procParte" class="form-control" type="text" placeholder="Autor/Réu" required />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Assunto</label>
                                <input id="procAssunto" class="form-control" type="text" placeholder="Resumo do objeto do processo" required />
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="btnCriarProcesso" class="btn btn-success"><i class="fas fa-save"></i> Criar Processo</button>
                        </div>
                    </div>

                    <!-- Visão por Status -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-play text-secondary"></i> Em Andamento</h5>
                                <div th:if="${processosAndamento != null and !processosAndamento.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${processosAndamento}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.numero}">0000000-00.0000.0.00.0000</div>
                                                    <small class="text-muted" th:text="${p.tipo}">Tipo</small>
                                                </div>
                                                <span class="badge bg-secondary">Andamento</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${processosAndamento == null or processosAndamento.isEmpty()}" class="text-muted">Nenhum processo em andamento.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-pause text-warning"></i> Suspensos</h5>
                                <div th:if="${processosSuspensos != null and !processosSuspensos.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${processosSuspensos}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.numero}">0000000-00.0000.0.00.0000</div>
                                                    <small class="text-muted" th:text="${p.tipo}">Tipo</small>
                                                </div>
                                                <span class="badge bg-warning text-dark">Suspenso</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${processosSuspensos == null or processosSuspensos.isEmpty()}" class="text-muted">Nenhum processo suspenso.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-archive text-muted"></i> Encerrados</h5>
                                <div th:if="${processosEncerrados != null and !processosEncerrados.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${processosEncerrados}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.numero}">0000000-00.0000.0.00.0000</div>
                                                    <small class="text-muted" th:text="${p.tipo}">Tipo</small>
                                                </div>
                                                <span class="badge bg-secondary">Encerrado</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${processosEncerrados == null or processosEncerrados.isEmpty()}" class="text-muted">Nenhum processo encerrado.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Próximas Audiências e Prazos Críticos -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-gavel"></i> Próximas Audiências</h5>
                                <div th:if="${proximasAudiencias != null and !proximasAudiencias.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="a : ${proximasAudiencias}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${a.processoNumero}">Proc. 000000</div>
                                                    <small class="text-muted" th:text="${a.tipo}">Audiência</small>
                                                </div>
                                                <span class="badge bg-info" th:text="${a.dataHora}">2025-01-01</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${proximasAudiencias == null or proximasAudiencias.isEmpty()}" class="text-muted">Nenhuma audiência próxima.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Prazos Críticos</h5>
                                <div th:if="${prazosCriticos != null and !prazosCriticos.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${prazosCriticos}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.acao}">Ação</div>
                                                    <small class="text-muted" th:text="${p.parte}">Parte</small>
                                                </div>
                                                <span class="badge bg-danger" th:text="${p.proximoPrazo}">2025-01-01</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${prazosCriticos == null or prazosCriticos.isEmpty()}" class="text-muted">Nenhum prazo crítico.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <div class="modal fade" id="procDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Processo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="procTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="tab-resumo" data-bs-toggle="tab" data-bs-target="#content-resumo" type="button" role="tab">Resumo</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tab-timeline" data-bs-toggle="tab" data-bs-target="#content-timeline" type="button" role="tab">Timeline</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="content-resumo" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="fw-semibold text-muted">Número</div>
                                    <div id="procDetailNumero">—</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="fw-semibold text-muted">Status</div>
                                    <div id="procDetailStatus">—</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="fw-semibold text-muted">Tipo</div>
                                    <div id="procDetailTipo">—</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="fw-semibold text-muted">Tribunal</div>
                                    <div id="procDetailTribunal">—</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="fw-semibold text-muted">Parte</div>
                                    <div id="procDetailParte">—</div>
                                </div>
                                <div class="col-md-6">
                                    <div class="fw-semibold text-muted">Aberto em</div>
                                    <div id="procDetailDataAbertura">—</div>
                                </div>
                                <div class="col-12">
                                    <div class="fw-semibold text-muted">Assunto</div>
                                    <div id="procDetailAssunto">—</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Timeline -->
                        <div class="tab-pane fade" id="content-timeline" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-muted mb-0">Histórico de Movimentações</h6>
                                <button class="btn btn-sm btn-outline-primary" id="btnNovoAndamento" type="button">
                                    <i class="fas fa-plus"></i> Nova Movimentação
                                </button>
                            </div>
                            
                            <!-- Form Inline de Nova Movimentação (Oculto por padrão) -->
                            <div id="formAndamento" class="card mb-4 border-light bg-light d-none">
                                <div class="card-body">
                                    <h6 class="card-title mb-3">Registrar Movimentação</h6>
                                    <div class="row g-2">
                                        <div class="col-md-8">
                                            <input type="text" id="andamentoTitulo" class="form-control form-control-sm" placeholder="Título (ex: Conclusão para Sentença)" required>
                                        </div>
                                        <div class="col-md-4">
                                            <select id="andamentoTipo" class="form-select form-select-sm">
                                                <option value="ANDAMENTO">Andamento Comum</option>
                                                <option value="INICIAL">Inicial / Distribuição</option>
                                                <option value="IMPORTANTE">Decisão / Importante</option>
                                                <option value="AUDIENCIA">Audiência / Perícia</option>
                                                <option value="FINAL">Sentença / Final</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <textarea id="andamentoDescricao" class="form-control form-control-sm" rows="2" placeholder="Descrição detalhada da movimentação..."></textarea>
                                        </div>
                                        <div class="col-12 text-end mt-2">
                                            <button type="button" class="btn btn-sm btn-secondary me-1" id="btnCancelarAndamento">Cancelar</button>
                                            <button type="button" class="btn btn-sm btn-success" id="btnSalvarAndamento">Salvar Movimentação</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div id="timelineContainer" class="timeline">
                                <!-- Timeline items injected via JS -->
                                <div class="text-center text-muted py-3">Carregando histórico...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function() {
            function notify(type, title, message, priority = 'medium', options = {}) {
                if (typeof showToast === 'function') {
                    showToast({ type, title, message, priority, ...options });
                } else {
                    const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
                    alert(`${icon} ${title}: ${message}`);
                }
            }

            // Listagem dinâmica de processos
            let procPage = 0;
            let procTotalPages = 1;
            const procSize = 10;

            function renderProcessos(items) {
                const $tbody = $('#procTableBody');
                $tbody.empty();
                if (!items || items.length === 0) {
                    $tbody.append('<tr><td colspan="8" class="text-center text-muted">Nenhum processo encontrado.</td></tr>');
                    return;
                }
                items.forEach(p => {
                    const status = p.status || '—';
                    $tbody.append(`
                        <tr data-id="${p.id || ''}">
                            <td>${p.numero || '—'}</td>
                            <td>${p.tipo || '—'}</td>
                            <td>${p.tribunal || '—'}</td>
                            <td>${p.parte || '—'}</td>
                            <td>${p.assunto || '—'}</td>
                            <td><span class="badge bg-secondary">${status}</span></td>
                            <td>${p.dataAbertura || '—'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary proc-detail" type="button" data-id="${p.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }

            function atualizarPaginacao() {
                $('#procPageInfo').text(`Página ${procPage + 1} de ${procTotalPages}`);
                $('#procPrev').prop('disabled', procPage <= 0);
                $('#procNext').prop('disabled', procPage >= procTotalPages - 1);
            }

            function carregarProcessos(page = 0) {
                const status = $('#filtroStatusProcesso').val();
                const search = $('#filtroBuscaProcesso').val()?.trim();
                $('#procTableBody').html('<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>');
                $.get('/juridico/api/processos', { status, search, page, size: procSize })
                    .done(res => {
                        procPage = res.page || 0;
                        procTotalPages = res.totalPages || 1;
                        renderProcessos(res.content);
                        atualizarPaginacao();
                    })
                    .fail(() => {
                        notify('error', 'Falha ao listar', 'Não foi possível carregar os processos.', 'high');
                        $('#procTableBody').html('<tr><td colspan="8" class="text-center text-muted">Erro ao carregar processos.</td></tr>');
                    });
            }

            function setProcDetail(id, data) {
                $('#procDetailNumero').text(data && data.numero ? data.numero : '—');
                $('#procDetailTipo').text(data && data.tipo ? data.tipo : '—');
                $('#procDetailTribunal').text(data && data.tribunal ? data.tribunal : '—');
                $('#procDetailParte').text(data && data.parte ? data.parte : '—');
                $('#procDetailAssunto').text(data && data.assunto ? data.assunto : '—');
                $('#procDetailStatus').text(data && data.status ? data.status : '—');
                $('#procDetailDataAbertura').text(data && data.dataAbertura ? data.dataAbertura : '—');
                $('#procDetailModal').attr('data-proc-id', id);
            }

            function renderTimeline(items, processType) {
                const $container = $('#timelineContainer');
                $container.empty();

                // Mock Expert Data if empty (for demonstration)
                if (!items || items.length === 0) {
                    items = generateExpertMockData(processType);
                }

                items.forEach(item => {
                    const tipoClass = (item.tipo || 'ANDAMENTO').toLowerCase();
                    const icon = item.tipo === 'INICIAL' ? '<i class="fas fa-file-contract"></i>' :
                                 item.tipo === 'AUDIENCIA' ? '<i class="fas fa-gavel"></i>' :
                                 item.tipo === 'FINAL' ? '<i class="fas fa-check-double"></i>' :
                                 item.tipo === 'IMPORTANTE' ? '<i class="fas fa-exclamation"></i>' :
                                 '<i class="fas fa-circle"></i>';

                    // Formatar data se possível
                    let dataFormatada = item.data;
                    try {
                        if(item.data && item.data.includes('T')) {
                            const d = new Date(item.data);
                            dataFormatada = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                        }
                    } catch(e) {}

                    $container.append(`
                        <div class="timeline-item ${tipoClass}">
                            <div class="timeline-icon d-flex align-items-center justify-content-center text-primary" style="font-size: 10px;">
                                <!-- Icon handled by CSS but could be explicit -->
                            </div>
                            <div class="timeline-content shadow-sm">
                                <span class="timeline-date"><i class="far fa-clock"></i> ${dataFormatada}</span>
                                <h5 class="timeline-title">${item.titulo}</h5>
                                <div class="timeline-desc">${item.descricao}</div>
                                ${item.usuario ? `<small class="text-muted mt-2 d-block"><i class="fas fa-user"></i> ${item.usuario}</small>` : ''}
                            </div>
                        </div>
                    `);
                });
            }

            function generateExpertMockData(processType) {
                const now = new Date();
                const mocks = [];
                const type = (processType || '').toUpperCase();

                if (type.includes('INSS') || type.includes('PREVIDENCIARIO')) {
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 2).toISOString(),
                        titulo: "Conclusão para Sentença",
                        descricao: "Processo concluso para julgamento após apresentação de laudos.",
                        tipo: "IMPORTANTE",
                        usuario: "Sistema"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 15).toISOString(),
                        titulo: "Laudo Pericial Juntado",
                        descricao: "Perícia médica realizada. Constatação de incapacidade laborativa temporária.",
                        tipo: "ANDAMENTO",
                        usuario: "Perito Dr. Mendes"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 45).toISOString(),
                        titulo: "Perícia Médica Agendada",
                        descricao: "Agendamento de perícia para avaliação de auxílio-doença.",
                        tipo: "AUDIENCIA", // Reused for scheduling
                        usuario: "Secretaria"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 60).toISOString(),
                        titulo: "Citação do INSS",
                        descricao: "Autarquia citada para apresentar contestação.",
                        tipo: "ANDAMENTO",
                        usuario: "Oficial de Justiça"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 65).toISOString(),
                        titulo: "Petição Inicial Protocolada",
                        descricao: "Distribuição automática. Requerimento de restabelecimento de benefício.",
                        tipo: "INICIAL",
                        usuario: "Dr. Advogado"
                    });
                } else if (type.includes('SEGURADORA') || type.includes('CIVEL') || type.includes('INDENIZACAO')) {
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 5).toISOString(),
                        titulo: "Impugnação à Contestação",
                        descricao: "Réplica apresentada rebatendo as preliminares da seguradora.",
                        tipo: "ANDAMENTO",
                        usuario: "Dr. Advogado"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 20).toISOString(),
                        titulo: "Contestação Juntada",
                        descricao: "Seguradora apresenta defesa alegando exclusão de cobertura.",
                        tipo: "IMPORTANTE",
                        usuario: "Sistema PJe"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 40).toISOString(),
                        titulo: "Aviso de Recebimento (AR) Positivo",
                        descricao: "Citação efetivada na sede da ré.",
                        tipo: "ANDAMENTO",
                        usuario: "Correios"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 50).toISOString(),
                        titulo: "Distribuição",
                        descricao: "Ação de Cobrança de Seguro c/c Danos Morais.",
                        tipo: "INICIAL",
                        usuario: "Distribuidor"
                    });
                } else {
                    // Generic
                     mocks.push({
                        data: new Date(now.getTime() - 86400000 * 10).toISOString(),
                        titulo: "Movimentação de Processo",
                        descricao: "Processo em análise pelo juiz.",
                        tipo: "ANDAMENTO",
                        usuario: "Sistema"
                    });
                    mocks.push({
                        data: new Date(now.getTime() - 86400000 * 30).toISOString(),
                        titulo: "Abertura de Processo",
                        descricao: "Processo cadastrado no sistema.",
                        tipo: "INICIAL",
                        usuario: "Admin"
                    });
                }
                return mocks;
            }

            function abrirDetalhesProcesso(id) {
                if (!id) return;
                
                // Reset e mostra modal
                setProcDetail(id, null);
                $('#timelineContainer').html('<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>');
                
                const modalEl = document.getElementById('procDetailModal');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                    
                    // Reset tab to first one
                    const firstTabEl = document.querySelector('#procTabs button[data-bs-target="#content-resumo"]');
                    if(firstTabEl) {
                        const tab = new bootstrap.Tab(firstTabEl);
                        tab.show();
                    }
                }

                // 1. Fetch Detalhes
                $.get(`/juridico/api/processos/${id}`)
                    .done(res => {
                        setProcDetail(id, res);
                        
                        // 2. Fetch Timeline (passando o tipo do processo para o mock se falhar ou vier vazio)
                        $.get(`/juridico/api/processos/${id}/timeline`)
                            .done(timelineData => {
                                renderTimeline(timelineData, res.tipo);
                            })
                            .fail(() => {
                                // Fallback para mock se endpoint falhar (ex: ambiente dev sem banco populado)
                                renderTimeline([], res.tipo);
                            });
                    })
                    .fail(() => {
                        notify('error', 'Falha ao abrir', 'Não foi possível carregar detalhes do processo.', 'high');
                    });
            }

            $('#btnBuscarProcessos').on('click', () => carregarProcessos(0));
            $('#procPrev').on('click', () => { if (procPage > 0) carregarProcessos(procPage - 1); });
            $('#procNext').on('click', () => { if (procPage < procTotalPages - 1) carregarProcessos(procPage + 1); });
            $(document).on('click', '.proc-detail', function(e) {
                e.preventDefault();
                e.stopPropagation();
                abrirDetalhesProcesso($(this).data('id'));
            });

            $('#btnCriarProcesso').on('click', function() {
                const $btn = $(this);
                const payload = {
                    numero: $('#procNumero').val()?.trim(),
                    tipo: $('#procTipo').val()?.trim(),
                    tribunal: $('#procTribunal').val()?.trim(),
                    parte: $('#procParte').val()?.trim(),
                    assunto: $('#procAssunto').val()?.trim()
                };

                if (!payload.numero || !payload.tipo || !payload.tribunal || !payload.parte || !payload.assunto) {
                    notify('error', 'Campos obrigatórios', 'Preencha todos os campos do processo.');
                    return;
                }

                const originalHtml = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');

                $.ajax({
                    url: '/juridico/api/processos',
                    method: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(payload),
                    success: function(res) {
                        notify('success', 'Processo criado', `ID: ${res.id}`, 'low', { durationMs: 6000 });
                        carregarProcessos(0);
                    },
                    error: function(xhr) {
                        const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Erro ao criar processo';
                        notify('error', 'Falha na criação', msg, 'high', { sticky: true });
                    },
                    complete: function() {
                        $btn.prop('disabled', false).html(originalHtml);
                    }
                });
            });

            try {
                const openId = new URLSearchParams(window.location.search).get('openProcessId');
                if (openId) {
                    abrirDetalhesProcesso(openId);
                }
            } catch (e) {}
        });
    </script>
</body>
</html>
