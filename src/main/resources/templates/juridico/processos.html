<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${pageTitle} + ' - ERP Corporativo'">Processos Jurídicos - ERP Corporativo</title>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="/css/corporate.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            <section class="content-area">
                <div class="container-fluid py-4">
                    <div class="mb-4">
                        <h1 class="display-6 text-muted"><i class="fas fa-balance-scale"></i> Processos Jurídicos</h1>
                        <p class="text-muted">Cadastro rápido, visão por status, audiências e prazos.</p>
                    </div>

                    <!-- Filtros e Listagem Dinâmica -->
                    <div class="card p-3 mb-4 shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-filter"></i> Buscar Processos</h5>
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Status</label>
                                <select id="filtroStatusProcesso" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="EM_ANDAMENTO">Em Andamento</option>
                                    <option value="SUSPENSO">Suspensos</option>
                                    <option value="ENCERRADO">Encerrados</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Busca</label>
                                <input id="filtroBuscaProcesso" class="form-control" type="text" placeholder="Número, parte ou assunto" />
                            </div>
                            <div class="col-md-3">
                                <button id="btnBuscarProcessos" class="btn btn-primary w-100"><i class="fas fa-search"></i> Buscar</button>
                            </div>
                        </div>
                        <div class="table-responsive mt-3">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Tipo</th>
                                        <th>Tribunal</th>
                                        <th>Parte</th>
                                        <th>Assunto</th>
                                        <th>Status</th>
                                        <th>Aberto em</th>
                                    </tr>
                                </thead>
                                <tbody id="procTableBody">
                                    <tr><td colspan="7" class="text-muted">Use os filtros para listar processos.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="small" id="procPageInfo">Página 1 de 1</div>
                            <div class="btn-group">
                                <button class="btn btn-outline-secondary btn-sm" id="procPrev" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                                <button class="btn btn-outline-secondary btn-sm" id="procNext" disabled>Próxima <i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Novo Processo -->
                    <div class="card p-3 mb-4 shadow-sm">
                        <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Novo Processo</h5>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Número</label>
                                <input id="procNumero" class="form-control" type="text" placeholder="Ex.: 1234567-89.2025.8.26.0100" required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Tipo</label>
                                <input id="procTipo" class="form-control" type="text" placeholder="Cível, Trabalhista, etc." required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Tribunal</label>
                                <input id="procTribunal" class="form-control" type="text" placeholder="TJ/SP, TRT-2, etc." required />
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold">Parte</label>
                                <input id="procParte" class="form-control" type="text" placeholder="Autor/Réu" required />
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">Assunto</label>
                                <input id="procAssunto" class="form-control" type="text" placeholder="Resumo do objeto do processo" required />
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="btnCriarProcesso" class="btn btn-success"><i class="fas fa-save"></i> Criar Processo</button>
                        </div>
                    </div>

                    <!-- Visão por Status -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-play text-secondary"></i> Em Andamento</h5>
                                <div th:if="${processosAndamento != null and !processosAndamento.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${processosAndamento}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.numero}">0000000-00.0000.0.00.0000</div>
                                                    <small class="text-muted" th:text="${p.tipo}">Tipo</small>
                                                </div>
                                                <span class="badge bg-secondary">Andamento</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${processosAndamento == null or processosAndamento.isEmpty()}" class="text-muted">Nenhum processo em andamento.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-pause text-warning"></i> Suspensos</h5>
                                <div th:if="${processosSuspensos != null and !processosSuspensos.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${processosSuspensos}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.numero}">0000000-00.0000.0.00.0000</div>
                                                    <small class="text-muted" th:text="${p.tipo}">Tipo</small>
                                                </div>
                                                <span class="badge bg-warning text-dark">Suspenso</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${processosSuspensos == null or processosSuspensos.isEmpty()}" class="text-muted">Nenhum processo suspenso.</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-archive text-muted"></i> Encerrados</h5>
                                <div th:if="${processosEncerrados != null and !processosEncerrados.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${processosEncerrados}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.numero}">0000000-00.0000.0.00.0000</div>
                                                    <small class="text-muted" th:text="${p.tipo}">Tipo</small>
                                                </div>
                                                <span class="badge bg-secondary">Encerrado</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${processosEncerrados == null or processosEncerrados.isEmpty()}" class="text-muted">Nenhum processo encerrado.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Próximas Audiências e Prazos Críticos -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-gavel"></i> Próximas Audiências</h5>
                                <div th:if="${proximasAudiencias != null and !proximasAudiencias.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="a : ${proximasAudiencias}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${a.processo}">Proc. 000000</div>
                                                    <small class="text-muted" th:text="${a.tipo}">Audiência</small>
                                                </div>
                                                <span class="badge bg-info" th:text="${a.data}">2025-01-01</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${proximasAudiencias == null or proximasAudiencias.isEmpty()}" class="text-muted">Nenhuma audiência próxima.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3 shadow-sm">
                                <h5 class="mb-3"><i class="fas fa-exclamation-triangle text-warning"></i> Prazos Críticos</h5>
                                <div th:if="${prazosCriticos != null and !prazosCriticos.isEmpty()}">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item" th:each="p : ${prazosCriticos}">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <div class="fw-semibold" th:text="${p.acao}">Ação</div>
                                                    <small class="text-muted" th:text="${p.responsavel}">Responsável</small>
                                                </div>
                                                <span class="badge bg-danger" th:text="${p.dataLimite}">2025-01-01</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div th:if="${prazosCriticos == null or prazosCriticos.isEmpty()}" class="text-muted">Nenhum prazo crítico.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function() {
            function notify(type, title, message, priority = 'medium', options = {}) {
                if (typeof showToast === 'function') {
                    showToast({ type, title, message, priority, ...options });
                } else {
                    const icon = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
                    alert(`${icon} ${title}: ${message}`);
                }
            }

            // Listagem dinâmica de processos
            let procPage = 0;
            let procTotalPages = 1;
            const procSize = 10;

            function renderProcessos(items) {
                const $tbody = $('#procTableBody');
                $tbody.empty();
                if (!items || items.length === 0) {
                    $tbody.append('<tr><td colspan="7" class="text-center text-muted">Nenhum processo encontrado.</td></tr>');
                    return;
                }
                items.forEach(p => {
                    const status = p.status || '—';
                    $tbody.append(`
                        <tr>
                            <td>${p.numero || '—'}</td>
                            <td>${p.tipo || '—'}</td>
                            <td>${p.tribunal || '—'}</td>
                            <td>${p.parte || '—'}</td>
                            <td>${p.assunto || '—'}</td>
                            <td><span class="badge bg-secondary">${status}</span></td>
                            <td>${p.dataAbertura || '—'}</td>
                        </tr>
                    `);
                });
            }

            function atualizarPaginacao() {
                $('#procPageInfo').text(`Página ${procPage + 1} de ${procTotalPages}`);
                $('#procPrev').prop('disabled', procPage <= 0);
                $('#procNext').prop('disabled', procPage >= procTotalPages - 1);
            }

            function carregarProcessos(page = 0) {
                const status = $('#filtroStatusProcesso').val();
                const search = $('#filtroBuscaProcesso').val()?.trim();
                $('#procTableBody').html('<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>');
                $.get('/juridico/api/processos', { status, search, page, size: procSize })
                    .done(res => {
                        procPage = res.page || 0;
                        procTotalPages = res.totalPages || 1;
                        renderProcessos(res.content);
                        atualizarPaginacao();
                    })
                    .fail(() => {
                        notify('error', 'Falha ao listar', 'Não foi possível carregar os processos.', 'high');
                        $('#procTableBody').html('<tr><td colspan="7" class="text-center text-muted">Erro ao carregar processos.</td></tr>');
                    });
            }

            $('#btnBuscarProcessos').on('click', () => carregarProcessos(0));
            $('#procPrev').on('click', () => { if (procPage > 0) carregarProcessos(procPage - 1); });
            $('#procNext').on('click', () => { if (procPage < procTotalPages - 1) carregarProcessos(procPage + 1); });

            $('#btnCriarProcesso').on('click', function() {
                const $btn = $(this);
                const payload = {
                    numero: $('#procNumero').val()?.trim(),
                    tipo: $('#procTipo').val()?.trim(),
                    tribunal: $('#procTribunal').val()?.trim(),
                    parte: $('#procParte').val()?.trim(),
                    assunto: $('#procAssunto').val()?.trim()
                };

                if (!payload.numero || !payload.tipo || !payload.tribunal || !payload.parte || !payload.assunto) {
                    notify('error', 'Campos obrigatórios', 'Preencha todos os campos do processo.');
                    return;
                }

                const originalHtml = $btn.html();
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Salvando...');

                $.ajax({
                    url: '/juridico/processos',
                    method: 'POST',
                    data: payload,
                    success: function(res) {
                        notify('success', 'Processo criado', `Número: ${res.numero}`, 'low', { durationMs: 6000 });
                        setTimeout(() => window.location.reload(), 1200);
                    },
                    error: function(xhr) {
                        const msg = xhr.responseJSON && xhr.responseJSON.erro ? xhr.responseJSON.erro : 'Erro ao criar processo';
                        notify('error', 'Falha na criação', msg, 'high', { sticky: true });
                    },
                    complete: function() {
                        $btn.prop('disabled', false).html(originalHtml);
                    }
                });
            });
        });
    </script>
</body>
</html>
