<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Auditoria RH - Exportações</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            <section class="content-area">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h1 class="h5 text-muted mb-1"><i class="fas fa-file-export me-2"></i>Exportações</h1>
                            <small class="text-muted">Logs de exportações de dados sensíveis</small>
                        </div>
                        <a href="/rh/auditoria" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i>Voltar</a>
                    </div>
                    <form id="filtroLogs" class="row g-2 mb-3" onsubmit="event.preventDefault(); carregarLogs();">
                        <input type="hidden" id="categoriaPadrao" th:value="${categoria}" />
                        <div class="col-md-3">
                            <label class="form-label">Usuário</label>
                            <input type="text" class="form-control" id="filtroUsuario" placeholder="email ou usuário" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Recurso</label>
                            <input type="text" class="form-control" id="filtroRecurso" placeholder="/rota" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Início</label>
                            <input type="datetime-local" class="form-control" id="filtroInicio" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fim</label>
                            <input type="datetime-local" class="form-control" id="filtroFim" />
                        </div>
                        <div class="col-12 d-flex flex-wrap gap-2 align-items-center">
                            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search me-1"></i>Filtrar</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="resetarFiltro()"><i class="fas fa-undo me-1"></i>Limpar</button>
                            <div class="vr d-none d-md-block"></div>
                            <div class="btn-group btn-group-sm" role="group" aria-label="Períodos">
                                <button type="button" class="btn btn-outline-secondary" onclick="setPeriodoHoras(1)">Últimas 1h</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setPeriodoHoras(24)">Últimas 24h</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setPeriodoDias(7)">Últimos 7 dias</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="setPeriodoMesAtual()">Mês atual</button>
                            </div>
                            <div class="vr d-none d-md-block"></div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked onchange="toggleAutoRefresh(this.checked)">
                                <label class="form-check-label" for="autoRefreshToggle">Atualização automática</label>
                            </div>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="exportarCsv()"><i class="fas fa-file-csv me-1"></i>Exportar CSV</button>
                        </div>
                    </form>
                    <div class="card">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Usuário</th>
                                        <th>Ação</th>
                                        <th>Recurso</th>
                                        <th>IP</th>
                                        <th>Sucesso</th>
                                    </tr>
                                </thead>
                                <tbody id="logsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Carregando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-end align-items-center p-2">
                            <div id="pagination" class="d-flex align-items-center gap-2"></div>
                        </div>
                    </div>
                </div>
            </section>
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>
    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script>
        function resetarFiltro(){
            document.getElementById('filtroUsuario').value = '';
            document.getElementById('filtroRecurso').value = '';
            document.getElementById('filtroInicio').value = '';
            document.getElementById('filtroFim').value = '';
            carregarLogs();
        }
        function setPeriodoHoras(h){
            const fim = new Date();
            const inicio = new Date(fim.getTime() - h*60*60*1000);
            document.getElementById('filtroInicio').value = inicio.toISOString().slice(0,16);
            document.getElementById('filtroFim').value = fim.toISOString().slice(0,16);
            carregarLogs();
        }
        function setPeriodoDias(d){
            const fim = new Date();
            const inicio = new Date(fim.getTime() - d*24*60*60*1000);
            document.getElementById('filtroInicio').value = inicio.toISOString().slice(0,16);
            document.getElementById('filtroFim').value = fim.toISOString().slice(0,16);
            carregarLogs();
        }
        function setPeriodoMesAtual(){
            const fim = new Date();
            const inicio = new Date(fim.getFullYear(), fim.getMonth(), 1, 0, 0, 0);
            document.getElementById('filtroInicio').value = inicio.toISOString().slice(0,16);
            document.getElementById('filtroFim').value = fim.toISOString().slice(0,16);
            carregarLogs();
        }
        function getPageSize(){ const el = document.getElementById('pageSize'); return el ? (Number(el.value)||20) : 20; }
        function renderPagination(data){
            const el = document.getElementById('pagination');
            if(!el) return;
            const page = Number(data.currentPage ?? data.number ?? 0);
            const totalPages = Number(data.totalPages ?? 1);
            const totalElements = Number(data.totalElements ?? 0);
            const hasPrev = Boolean(data.hasPrevious ?? (page > 0));
            const hasNext = Boolean(data.hasNext ?? (page < Math.max(totalPages-1,0)));
            let html = '';
            html += `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} registros)</span>`;
            html += hasPrev ? `<a class="btn btn-secondary btn-sm" href="#" onclick="goToPage(${page - 1});return false;"><i class="fas fa-chevron-left"></i> Anterior</a>` : `<span class="btn btn-secondary btn-sm disabled"><i class="fas fa-chevron-left"></i> Anterior</span>`;
            html += hasNext ? `<a class="btn btn-secondary btn-sm" href="#" onclick="goToPage(${page + 1});return false;">Próxima <i class="fas fa-chevron-right"></i></a>` : `<span class="btn btn-secondary btn-sm disabled">Próxima <i class="fas fa-chevron-right"></i></span>`;
            el.innerHTML = html;
        }
        function goToPage(p){ carregarLogs(Math.max(0, Number(p)||0)); }
        function carregarLogs(page=0){
            page = Number(page) || 0; window.__auditCurrentPage = page;
            const categoria = document.getElementById('categoriaPadrao')?.value || 'EXPORTACAO';
            const usuario = document.getElementById('filtroUsuario').value.trim();
            const recurso = document.getElementById('filtroRecurso').value.trim();
            const inicio = document.getElementById('filtroInicio').value;
            const fim = document.getElementById('filtroFim').value;
            const params = new URLSearchParams({categoria, usuario, recurso, page, size: getPageSize()});
            if(inicio) params.append('inicio', inicio);
            if(fim) params.append('fim', fim);
            fetch('/api/rh/auditoria/logs?' + params.toString())
                .then(r => {
                    if(!r.ok){
                        const tbody = document.getElementById('logsTableBody');
                        if(r.status === 403){
                            if(window.globalToast){ window.globalToast('Acesso negado', 'fas fa-shield-alt', 'danger'); }
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Acesso negado</td></tr>';
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar</td></tr>';
                        }
                        return null;
                    }
                    return r.json();
                })
                .then(data => {
                    if(!data) return;
                    const tbody = document.getElementById('logsTableBody');
                    tbody.innerHTML = '';
                    const content = data.content || [];
                    if(content.length === 0){
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sem registros</td></tr>';
                        renderPagination(data); return;
                    }
                    for(const item of content){
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><span class="text-muted">${(item.criadoEm||'').replace('T',' ')}</span></td>
                            <td>${item.usuario||'-'}</td>
                            <td><span class="badge bg-secondary">${item.acao||'-'}</span></td>
                            <td><code>${item.recurso||'-'}</code></td>
                            <td>${item.ipOrigem||'-'}</td>
                            <td>${item.sucesso ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-danger">Falha</span>'}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                    renderPagination(data);
                })
                .catch(() => {
                    const tbody = document.getElementById('logsTableBody');
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar</td></tr>';
                });
        }
        function toggleAutoRefresh(on){
            if(window.__auditAuto){ clearInterval(window.__auditAuto); window.__auditAuto = null; }
            if(on){ window.__auditAuto = setInterval(() => carregarLogs(window.__auditCurrentPage||0), 60000); }
        }
        function exportarCsv(){
            const categoria = document.getElementById('categoriaPadrao')?.value || 'EXPORTACAO';
            const usuario = document.getElementById('filtroUsuario').value.trim();
            const recurso = document.getElementById('filtroRecurso').value.trim();
            const inicio = document.getElementById('filtroInicio').value;
            const fim = document.getElementById('filtroFim').value;
            const params = new URLSearchParams({categoria, usuario, recurso, page: 0, size: 1000});
            if(inicio) params.append('inicio', inicio);
            if(fim) params.append('fim', fim);
            window.location.href = '/api/rh/auditoria/logs/csv?' + params.toString();
        }
        document.addEventListener('DOMContentLoaded', () => { carregarLogs(0); toggleAutoRefresh(true); });
    </script>
</body>
</html>
