<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Avaliação - Periodicidade</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            <section class="content-area">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <h1 class="h4 mb-3"><i class="fas fa-chart-line me-2"></i>Avaliação - Periodicidade (Ciclos)</h1>
                            <div class="card">
                                <div class="card-body">
                                    <form class="mb-3" onsubmit="event.preventDefault(); abrirCiclo();">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Colaborador</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="buscaColabAva" placeholder="Buscar por nome/email" oninput="buscarColaboradoresAva(this.value)" />
                                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarColaboradoresAva(document.getElementById('buscaColabAva').value)"><i class="fas fa-search"></i></button>
                                                </div>
                                                <select class="form-select mt-2" id="colabAvaSelect"></select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Início</label>
                                                <input type="date" class="form-control" id="avaInicio" required />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Fim</label>
                                                <input type="date" class="form-control" id="avaFim" required />
                                            </div>
                                        </div>
                                        <div class="mt-3 d-flex gap-2">
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Abrir Ciclo</button>
                                            <button type="button" class="btn btn-secondary" onclick="resetCicloForm()"><i class="fas fa-undo me-2"></i>Limpar</button>
                                        </div>
                                    </form>
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Colaborador</th>
                                                    <th>Período</th>
                                                    <th>Status</th>
                                                    <th>Nota</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tbodyCiclos"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>
    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script>
        let pageAva = 0; let sizeAva = 20;
        function buscarColaboradoresAva(q){
            $.get('/rh/colaboradores/api/listar', { page: 0, size: 20, q: q || '' })
                .done(function(resp){
                    const sel=document.getElementById('colabAvaSelect'); sel.innerHTML='';
                    (resp.content||[]).forEach(function(c){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.nome + ' (' + (c.email||'') + ')'; sel.appendChild(o); });
                    if ((resp.content||[]).length===0 && typeof showToast==='function'){ showToast({ title: 'Avaliações', message: 'Nenhum colaborador encontrado.', priority: 'MEDIUM' }); }
                })
                .fail(function(){ if (typeof showToast==='function'){ showToast({ title: 'Avaliações', message: 'Falha ao buscar colaboradores.', priority: 'HIGH' }); } });
        }
        function abrirCiclo(){
            const colaboradorId = document.getElementById('colabAvaSelect').value;
            const inicio = document.getElementById('avaInicio').value;
            const fim = document.getElementById('avaFim').value;
            if(!colaboradorId){ if (typeof showToast==='function'){ showToast({ title: 'Avaliações', message: 'Selecione um colaborador.', priority: 'MEDIUM' }); } return; }
            $.post('/api/rh/avaliacao/ciclos', { colaboradorId, inicio, fim })
                .done(function(resp){ if(resp.success){ showToast({ title: 'Avaliações', message: 'Ciclo criado (ID ' + resp.id + ')', priority: 'LOW' }); carregarCiclos(); } else { showToast({ title: 'Avaliações', message: resp.message || 'Falha ao criar ciclo', priority: 'HIGH' }); } })
                .fail(function(xhr){ const msg=(xhr.responseJSON&&xhr.responseJSON.message)?xhr.responseJSON.message:'Erro ao criar ciclo'; showToast({ title: 'Avaliações', message: msg, priority: 'HIGH' }); });
        }
        function carregarCiclos(){
            $.get('/api/rh/avaliacao/ciclos', { page: pageAva, size: sizeAva })
                .done(function(page){ const tbody=document.getElementById('tbodyCiclos'); tbody.innerHTML=''; (page.content||[]).forEach(function(a){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.id}</td><td>${a.colaboradorNome||'-'}</td><td>${(a.periodoInicio||'')} a ${(a.periodoFim||'')}</td><td>${a.status||'-'}</td><td>${a.nota||''}</td>`; tbody.appendChild(tr); }); })
                .fail(function(){ showToast({ title: 'Avaliações', message: 'Falha ao carregar ciclos.', priority: 'HIGH' }); });
        }
        function resetCicloForm(){ document.getElementById('buscaColabAva').value=''; document.getElementById('avaInicio').value=''; document.getElementById('avaFim').value=''; buscarColaboradoresAva(''); }
        $(document).ready(function(){ buscarColaboradoresAva(''); carregarCiclos(); });
    </script>
</body>
</html>
