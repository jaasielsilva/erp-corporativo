<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Adesão aos Benefícios - ERP Corporativo</title>

  <link href="/css/style.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
  <link href="/css/notifications.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/benefits-modal.css}">

</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <h1>Adesão aos Benefícios</h1>
        <h2>Gerenciamento de adesões e cancelamentos de benefícios</h2>

        <div class="action-buttons">
          <button type="button" onclick="abrirModalAdesao()" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nova Adesão
          </button>
        </div>

        <article class="card">
          <h3><i class="fas fa-list"></i> Adesões e Cancelamentos</h3>
          <table class="table-list">
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>Benefício</th>
                <th>Tipo</th>
                <th>Data Solicitação</th>
                <th>Data Vigência</th>
                <th>Valor Total Colaborador</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="adesao : ${adesoes}" th:if="${adesao != null}">
                <td>
                  <strong
                    th:text="${adesao.colaborador != null ? adesao.colaborador.nome : 'Colaborador não informado'}">Nome
                    do
                    Colaborador</strong><br>
                  <small
                    th:text="${adesao.colaborador != null && adesao.colaborador.departamento != null ? adesao.colaborador.departamento.nome : 'Departamento não informado'}"
                    class="text-muted">Departamento</small>
                </td>
                <td>
                  <i class="fas fa-heartbeat text-primary"></i>
                  <strong th:text="${adesao.planoSaude != null ? adesao.planoSaude.nome : 'Plano não definido'}">Nome do
                    Plano</strong><br>
                  <small
                    th:text="${adesao.quantidadeDependentes != null && adesao.quantidadeDependentes > 0 ? 'Familiar (' + adesao.quantidadeDependentes + ' dependente' + (adesao.quantidadeDependentes > 1 ? 's' : '') + ')' : 'Individual'}"
                    class="text-muted">Tipo de Cobertura</small>
                </td>
                <td>
                  <span class="tipo-badge"
                    th:classappend="${adesao.status != null ? adesao.status.name().toLowerCase() : 'indefinido'}"
                    th:text="${adesao.status != null ? adesao.status.name() : 'INDEFINIDO'}">Status</span>
                </td>
                <td
                  th:text="${adesao.dataAdesao != null ? #temporals.format(adesao.dataAdesao, 'dd/MM/yyyy') : 'Não informado'}">
                  Data
                  Adesão</td>
                <td
                  th:text="${adesao.dataVigenciaInicio != null ? #temporals.format(adesao.dataVigenciaInicio, 'dd/MM/yyyy') : 'Não informado'}">
                  Data
                  Vigência</td>
                <td>
                  <span th:if="${adesao.valorTotalMensal != null}"
                    th:text="|R$ ${#numbers.formatDecimal(adesao.valorTotalMensal, 1, 'COMMA', 2, 'POINT')}|">
                    Valor
                  </span>
                  <span th:unless="${adesao.valorTotalMensal != null}" class="text-muted">
                    Não calculado
                  </span>
                </td>

                <td>
                  <span class="status-badge"
                    th:classappend="'status-' + ${adesao.status != null ? adesao.status.name().toLowerCase() : 'indefinido'}"
                    th:text="${adesao.status != null ? adesao.status.name() : 'INDEFINIDO'}">Status</span>
                </td>
                <td>
                  <button type="button"
                    th:attr="onclick='verDetalhesAdesao(' + ${adesao.id != null ? adesao.id : 0} + ')'" class="btn-icon"
                    title="Ver Detalhes" th:disabled="${adesao.id == null}">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
              <tr th:if="${adesoes == null || adesoes.isEmpty()}">
                <td colspan="8" class="text-center text-muted py-4">
                  <i class="fas fa-info-circle"></i> Nenhuma adesão encontrada
                </td>
              </tr>

              <!-- ✅ Modal fora da tabela -->
              <div id="modalAdesao" class="modal" style="display: none;">
                <div class="modal-content">
                  <span class="close" onclick="fecharModalAdesao()">&times;</span>
                  <h2>Nova Adesão - Plano de Saúde</h2>

                  <form id="formAdesao" method="post" th:action="@{/rh/beneficios/plano-saude/adesao/salvar}">


                    <!-- Colaborador -->
                    <div class="form-group">
                      <label for="colaborador">Colaborador</label>
                      <select id="colaborador" name="colaboradorId" required>
                        <option value="">Selecione</option>
                        <option th:each="colaborador : ${colaboradores}" th:value="${colaborador.id}"
                          th:text="${colaborador.nome}"></option>
                      </select>
                    </div>

                    <!-- Plano de Saúde -->
                    <div class="form-group">
                      <label for="planoSaude">Plano de Saúde *</label>
                      <select id="planoSaude" name="planoId" required>
                        <option value="">Selecione um plano</option>
                        <option th:each="plano : ${plano_de_saude}" th:value="${plano.id}"
                          th:text="${plano.nome + ' - ' + plano.operadora + ' (R$ ' + #numbers.formatDecimal(plano.valorTitular, 1, 2) + ')'}"
                          th:attr="data-valor-titular=${plano.valorTitular}, data-valor-dependente=${plano.valorDependente}"></option>
                      </select>
                    </div>

                    <!-- Tipo de Adesão -->
                    <div class="form-group">
                      <label for="tipoAdesao">Tipo de Adesão *</label>
                      <select id="tipoAdesao" name="tipoAdesao" required>
                        <option value="">Selecione</option>
                        <option value="NOVA">Nova Adesão</option>
                        <option value="INCLUSAO_DEPENDENTE">Inclusão de Dependente</option>
                        <option value="ALTERACAO_PLANO">Alteração de Plano</option>
                      </select>
                    </div>

                    <!-- Dependentes -->
                    <div class="form-group">
                      <label for="dependentes">Quantidade de Dependentes</label>
                      <input type="number" id="dependentes" name="quantidadeDependentes" min="0" value="0">
                    </div>

                    <!-- Data de Vigência -->
                    <div class="form-group">
                      <label for="dataVigencia">Data de Vigência *</label>
                      <input type="date" id="dataVigencia" name="dataVigencia" required>
                    </div>

                    <!-- Resumo de Valores -->
                    <div class="form-group" id="resumoValores" style="display: none;">
                      <div class="card" style="background-color: #f8f9fa; padding: 15px; border: 1px solid #dee2e6;">
                        <h5>Resumo de Valores</h5>
                        <div class="row">
                          <div class="col-md-6">
                            <p><strong>Valor Titular:</strong> <span id="valorTitular">R$ 0,00</span></p>
                            <p><strong>Valor Dependentes:</strong> <span id="valorDependentes">R$ 0,00</span></p>
                          </div>
                          <div class="col-md-6">
                            <p><strong>Total Mensal:</strong> <span id="valorTotal" style="font-size: 1.2em; color: #007bff;">R$ 0,00</span></p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Observações -->
                    <div class="form-group">
                      <label for="observacoes">Observações</label>
                      <textarea id="observacoes" name="observacoes" rows="3" placeholder="Informações adicionais sobre a adesão..."></textarea>
                    </div>

                    <!-- Botões -->
                    <div class="form-actions">
                      <button type="submit" class="btn btn-primary">Salvar</button>
                      <button type="button" class="btn btn-secondary" onclick="fecharModalAdesao()">Cancelar</button>
                    </div>

                  </form>
                </div>
              </div>


            </tbody>
          </table>
        </article>


  </div>
  </div>
  </div>

  </section>

  <footer th:replace="~{components/footer :: footer}"></footer>
  </main>
  </div>

  <script src="/js/sidebar.js" defer></script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script th:src="@{/js/notifications.js}"></script>
  
  <!-- Dados dos planos para JavaScript -->
  <script th:inline="javascript">
    window.valoresPlanosJson = /*[[${valoresPlanosJson}]]*/ {};
  </script>
  
  <script src="/js/adesao.js" defer></script>


</body>

</html>