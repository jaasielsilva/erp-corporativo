<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adesão aos Benefícios - ERP Corporativo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link rel="stylesheet" th:href="@{/css/adesao.css}" />
  <style>
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex; justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 5px;
      width: 400px; max-width: 90%;
    }
    .close { cursor: pointer; float: right; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .modal-footer { margin-top: 15px; text-align: right; }
    .btn-icon { border: none; background: none; cursor: pointer; margin: 0 2px; }
    .form-control { width: 100%; margin: 5px 0 10px 0; padding: 5px; }
  </style>
</head>

<body>
<div class="app-container">
  <aside th:replace="~{components/sidebar :: sidebar}"></aside>
  <main class="main-content">
    <header th:replace="~{components/topbar :: topbar}"></header>
    <section class="content-area">
      <h1>Adesão aos Benefícios</h1>
      <h2>Gerenciamento de adesões e cancelamentos de benefícios</h2>

      <div class="action-buttons">
        <button onclick="abrirModalAdesao()" class="btn btn-primary"><i class="fas fa-plus"></i> Nova Adesão</button>
      </div>

      <article class="card">
        <h3><i class="fas fa-list"></i> Adesões e Cancelamentos</h3>
        <table class="table-list">
          <thead>
            <tr>
              <th>Colaborador</th>
              <th>Benefício</th>
              <th>Tipo</th>
              <th>Data Solicitação</th>
              <th>Data Vigência</th>
              <th>Valor Total Colaborador</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="adesaoMap : ${adesoes}">
              <td>
                <strong th:text="${adesaoMap.adesao.colaborador.nome}">Nome Colaborador</strong><br>
                <small th:text="${adesaoMap.adesao.colaborador.departamento.nome}">Departamento</small>
              </td>
              <td>
                <i class="fas fa-heartbeat"></i>
                <strong th:text="${adesaoMap.adesao.planoSaude.nome}">Plano de Saúde</strong><br>
                <small th:text="${adesaoMap.adesao.quantidadeDependentes > 0 ? 'Familiar (' + adesaoMap.adesao.quantidadeDependentes + ' dependentes)' : 'Individual'}">Individual</small>
              </td>
              <td><span class="tipo-badge adesao">Adesão</span></td>
              <td th:text="${#temporals.format(adesaoMap.adesao.dataAdesao, 'dd/MM/yyyy')}"></td>
              <td th:text="${#temporals.format(adesaoMap.adesao.dataVigenciaInicio, 'dd/MM/yyyy')}"></td>
              <td th:text="'R$ ' + ${#numbers.formatDecimal(adesaoMap.valorTotalAtual, 1, 'COMMA', 2, 'POINT')}"></td>
              <td><span th:text="${adesaoMap.adesao.statusDescricao}">Ativa</span></td>
              <td>
                <button th:attr="onclick='verDetalhesAdesao(' + ${adesaoMap.adesao.id} + ')'" class="btn-icon" title="Ver Detalhes">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </article>

      <!-- Modal Nova Adesão -->
      <div id="modalAdesao" class="modal" style="display:none;">
        <div class="modal-content">
          <div class="modal-header">
            <h3><i class="fas fa-plus"></i> Nova Adesão de Benefício</h3>
            <span class="close" onclick="fecharModalAdesao()">&times;</span>
          </div>
          <form id="formAdesao">
            <label>Colaborador:</label>
            <select name="colaboradorId" required class="form-control">
              <option value="" disabled selected>Selecione um colaborador</option>
              <option th:each="col : ${colaboradores}" th:value="${col.id}" th:text="${col.nome} + ' - ' + ${col.departamento.nome}"></option>
            </select>

            <label>Benefício / Plano de Saúde:</label>
            <select name="planoId" required class="form-control" id="planoSelect" onchange="atualizarValor()">
              <option value="" disabled selected>Selecione um plano de saúde</option>
              <option th:each="p : ${plano_de_saude}" th:value="${p.id}" th:text="${p.nome}"></option>
            </select>

            <label>Quantidade de Dependentes:</label>
            <input type="number" name="quantidadeDependentes" min="0" value="0" class="form-control" id="qtdDependentes" oninput="atualizarValor()">

            <label>Valor Total Mensal:</label>
            <input type="text" name="valorTotal" readonly class="form-control" id="valorTotal">

            <label>Data de Vigência:</label>
            <input type="date" name="dataVigencia" required class="form-control">

            <label>Tipo de Adesão:</label>
            <select name="tipoAdesao" required class="form-control">
              <option value="" disabled selected>Selecione...</option>
              <option value="ADESAO">Nova Adesão</option>
              <option value="ALTERACAO">Alteração</option>
              <option value="CANCELAMENTO">Cancelamento</option>
            </select>

            <label>Observações:</label>
            <textarea name="observacoes" class="form-control" rows="3" placeholder="Informações adicionais..."></textarea>

            <div class="form-check">
              <input type="checkbox" name="processarImediatamente" class="form-check-input">
              <label class="form-check-label">Processar imediatamente</label>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="fecharModalAdesao()">Cancelar</button>
              <button type="submit" class="btn btn-primary">Salvar Adesão</button>
            </div>
          </form>
        </div>
      </div>

    </section>
    <footer th:replace="~{components/footer :: footer}"></footer>
  </main>
</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const valoresPlanos = /*[[${valoresPlanosJson}]]*/ {};
  /*]]>*/
</script>

<script>
function abrirModalAdesao() { document.getElementById("modalAdesao").style.display = 'flex'; atualizarValor(); }
function fecharModalAdesao() { document.getElementById("modalAdesao").style.display = 'none'; }

function atualizarValor() {
  const planoSelect = document.getElementById("planoSelect");
  const qtd = parseInt(document.getElementById("qtdDependentes").value) || 0;
  const valorInput = document.getElementById("valorTotal");

  if (!planoSelect.value) { valorInput.value = ""; return; }
  const plano = valoresPlanos[String(planoSelect.value)];
  if (!plano) { valorInput.value = ""; return; }

  const total = parseFloat(plano.titular) + (parseFloat(plano.dependente) * qtd);
  valorInput.value = isNaN(total) ? "" : "R$ " + total.toFixed(2);
}

document.getElementById("formAdesao").addEventListener("submit", function(e){
  e.preventDefault();
  const formData = new FormData(this);
  const data = {
    colaboradorId: formData.get("colaboradorId"),
    planoId: formData.get("planoId"),
    quantidadeDependentes: parseInt(formData.get("quantidadeDependentes") || 0),
    valorTotal: formData.get("valorTotal"),
    dataVigencia: formData.get("dataVigencia"),
    tipoAdesao: formData.get("tipoAdesao"),
    observacoes: formData.get("observacoes"),
    processarImediatamente: formData.get("processarImediatamente") != null
  };

  fetch("/rh/beneficios/adesao", {
    method: "POST",
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  }).then(resp => {
    if(resp.ok){ alert("Adesão criada!"); fecharModalAdesao(); location.reload(); }
    else{ alert("Erro ao criar adesão."); }
  }).catch(err => { console.error(err); alert("Erro de comunicação."); });
});

document.getElementById("planoSelect").addEventListener("change", atualizarValor);
document.getElementById("qtdDependentes").addEventListener("input", atualizarValor);
</script>

</body>
</html>
