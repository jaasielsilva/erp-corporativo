<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Adesão aos Benefícios - ERP Corporativo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="stylesheet" th:href="@{/css/sidebar.css}">
  <link rel="stylesheet" th:href="@{/css/adesao.css}">
  <link rel="stylesheet" th:href="@{/css/benefits-modal.css}">

</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <h1>Adesão aos Benefícios</h1>
        <h2>Gerenciamento de adesões e cancelamentos de benefícios</h2>

        <div class="action-buttons">
          <button type="button" onclick="abrirModalAdesao()" class="btn btn-primary">
            <i class="fas fa-plus"></i> Nova Adesão
          </button>
        </div>

        <article class="card">
          <h3><i class="fas fa-list"></i> Adesões e Cancelamentos</h3>
          <table class="table-list">
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>Benefício</th>
                <th>Tipo</th>
                <th>Data Solicitação</th>
                <th>Data Vigência</th>
                <th>Valor Total Colaborador</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="adesao : ${adesoes}" th:if="${adesao != null}">
                <td>
                  <strong
                    th:text="${adesao.colaborador != null ? adesao.colaborador.nome : 'Colaborador não informado'}">Nome
                    do
                    Colaborador</strong><br>
                  <small
                    th:text="${adesao.colaborador != null && adesao.colaborador.departamento != null ? adesao.colaborador.departamento.nome : 'Departamento não informado'}"
                    class="text-muted">Departamento</small>
                </td>
                <td>
                  <i class="fas fa-heartbeat text-primary"></i>
                  <strong th:text="${adesao.planoSaude != null ? adesao.planoSaude.nome : 'Plano não definido'}">Nome do
                    Plano</strong><br>
                  <small
                    th:text="${adesao.quantidadeDependentes != null && adesao.quantidadeDependentes > 0 ? 'Familiar (' + adesao.quantidadeDependentes + ' dependente' + (adesao.quantidadeDependentes > 1 ? 's' : '') + ')' : 'Individual'}"
                    class="text-muted">Tipo de Cobertura</small>
                </td>
                <td>
                  <span class="tipo-badge"
                    th:classappend="${adesao.status != null ? adesao.status.name().toLowerCase() : 'indefinido'}"
                    th:text="${adesao.status != null ? adesao.status.name() : 'INDEFINIDO'}">Status</span>
                </td>
                <td
                  th:text="${adesao.dataAdesao != null ? #temporals.format(adesao.dataAdesao, 'dd/MM/yyyy') : 'Não informado'}">
                  Data
                  Adesão</td>
                <td
                  th:text="${adesao.dataVigenciaInicio != null ? #temporals.format(adesao.dataVigenciaInicio, 'dd/MM/yyyy') : 'Não informado'}">
                  Data
                  Vigência</td>
                <td>
                  <span th:if="${adesao.valorTotalMensal != null}"
                    th:text="'R$ ' + #numbers.formatDecimal(adesao.valorTotalMensal, 1, 'COMMA', 2, 'POINT')">Valor</span>
                  <span th:unless="${adesao.valorTotalMensal != null}" class="text-muted">Não calculado</span>
                </td>
                <td>
                  <span class="status-badge"
                    th:classappend="'status-' + ${adesao.status != null ? adesao.status.name().toLowerCase() : 'indefinido'}"
                    th:text="${adesao.status != null ? adesao.status.name() : 'INDEFINIDO'}">Status</span>
                </td>
                <td>
                  <button type="button"
                    th:attr="onclick='verDetalhesAdesao(' + ${adesao.id != null ? adesao.id : 0} + ')'" class="btn-icon"
                    title="Ver Detalhes" th:disabled="${adesao.id == null}">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
              <tr th:if="${adesoes == null || adesoes.isEmpty()}">
                <td colspan="8" class="text-center text-muted py-4">
                  <i class="fas fa-info-circle"></i> Nenhuma adesão encontrada
                </td>
              </tr>
            </tbody>
          </table>
        </article>

        <!-- Modal para Nova Adesão de Benefícios -->
        <div id="modalAdesao" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalAdesaoLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content benefits-modal">
            <div class="modal-header benefits-header">
              <div class="header-content">
                <div class="header-icon">
                  <i class="fas fa-gift"></i>
                </div>
                <div class="header-text">
                  <h3>Nova Adesão de Benefício</h3>
                  <p class="modal-subtitle">Selecione o tipo de benefício e preencha as informações</p>
                </div>
              </div>
              <span class="close" onclick="fecharModalAdesao()">&times;</span>
            </div>
            <div class="modal-body benefits-body">
              <!-- Etapa 1: Seleção do Tipo de Benefício -->
              <div class="benefits-step" id="step-benefit-type">
                <div class="step-header">
                  <h6 class="step-title">
                    <span class="step-number">1</span>
                    Selecione o Tipo de Benefício
                  </h6>
                  <p class="step-description">Escolha qual benefício deseja adicionar para o colaborador</p>
                </div>
                <div class="benefits-grid">
                  <div class="benefit-card" data-benefit="plano-saude">
                    <div class="benefit-icon">
                      <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="benefit-info">
                      <h6>Plano de Saúde</h6>
                      <p>Assistência médica e hospitalar</p>
                    </div>
                    <div class="benefit-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                  <div class="benefit-card" data-benefit="vale-refeicao">
                    <div class="benefit-icon">
                      <i class="fas fa-utensils"></i>
                    </div>
                    <div class="benefit-info">
                      <h6>Vale Refeição</h6>
                      <p>Auxílio alimentação para refeições</p>
                    </div>
                    <div class="benefit-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                  <div class="benefit-card" data-benefit="vale-transporte">
                    <div class="benefit-icon">
                      <i class="fas fa-bus"></i>
                    </div>
                    <div class="benefit-info">
                      <h6>Vale Transporte</h6>
                      <p>Auxílio para deslocamento</p>
                    </div>
                    <div class="benefit-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                  <div class="benefit-card" data-benefit="vale-alimentacao">
                    <div class="benefit-icon">
                      <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="benefit-info">
                      <h6>Vale Alimentação</h6>
                      <p>Auxílio para compras em supermercados</p>
                    </div>
                    <div class="benefit-arrow">
                      <i class="fas fa-chevron-right"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Etapa 2: Formulário Dinâmico -->
              <div class="benefits-step" id="step-form" style="display: none;">
                <div class="step-header">
                  <button type="button" class="btn-back" onclick="voltarEtapa()">
                    <i class="fas fa-arrow-left"></i>
                    Voltar
                  </button>
                  <h6 class="step-title">
                    <span class="step-number">2</span>
                    <span id="selected-benefit-title">Informações do Benefício</span>
                  </h6>
                </div>
                
                <form id="formAdesao" method="post" class="benefits-form">
                  <input type="hidden" id="tipoBeneficio" name="tipoBeneficio">
                  
                  <!-- Seção Colaborador (comum a todos) -->
                  <div class="form-section">
                    <h6 class="section-title">
                      <i class="fas fa-user"></i>
                      Colaborador
                    </h6>
                    <div class="form-group">
                      <label for="colaboradorId">Selecione o Colaborador <span class="required">*</span></label>
                      <select id="colaboradorId" name="colaboradorId" required class="form-control">
                        <option value="" disabled selected>Selecione um colaborador</option>
                        <option th:each="col : ${colaboradores}" th:if="${col != null}" th:value="${col.id}"
                          th:text="${col.nome != null ? col.nome : 'Nome não informado'} + ${col.departamento != null && col.departamento.nome != null ? ' - ' + col.departamento.nome : ' - Departamento não informado'}">
                        </option>
                      </select>
                    </div>
                  </div>

                  <!-- Formulário Plano de Saúde -->
                  <div class="form-section benefit-form" id="form-plano-saude" style="display: none;">
                    <h6 class="section-title">
                      <i class="fas fa-heartbeat"></i>
                      Detalhes do Plano de Saúde
                    </h6>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="planoSaudeId">Plano de Saúde <span class="required">*</span></label>
                        <select id="planoSaudeId" name="planoId" required class="form-control">
                          <option value="" disabled selected>Selecione um plano de saúde</option>
                          <option th:each="p : ${plano_de_saude}" th:if="${p != null}" th:value="${p.id}"
                            th:text="${p.nome != null ? p.nome : 'Plano Indefinido'}"></option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="tipoAdesao">Tipo de Adesão <span class="required">*</span></label>
                        <select id="tipoAdesao" name="tipoAdesao" required class="form-control">
                          <option value="" disabled selected>Selecione...</option>
                          <option value="ADESAO">Nova Adesão</option>
                          <option value="ALTERACAO">Alteração</option>
                          <option value="CANCELAMENTO">Cancelamento</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="quantidadeDependentes">Qtd. Dependentes</label>
                        <input type="number" id="quantidadeDependentes" name="quantidadeDependentes" min="0" max="10" value="0" class="form-control">
                        <small class="form-text text-muted">Máx. 10 dependentes por adesão</small>
                      </div>
                      <div class="form-group">
                        <label for="dataVigencia">Data de Vigência <span class="required">*</span></label>
                        <input type="date" id="dataVigencia" name="dataVigencia" required class="form-control">
                      </div>
                      <div class="form-group">
                        <label for="valorTotal">Valor Total Mensal</label>
                        <div class="input-group">
                          <div class="input-group-prepend">
                            <span class="input-group-text">R$</span>
                          </div>
                          <input type="text" id="valorTotal" name="valorTotal" readonly class="form-control" placeholder="0,00">
                        </div>
                        <small class="form-text text-muted">Valor calculado automaticamente</small>
                      </div>
                    </div>
                  </div>

                  <!-- Formulário Vale Refeição -->
                  <div class="form-section benefit-form" id="form-vale-refeicao" style="display: none;">
                    <h6 class="section-title">
                      <i class="fas fa-utensils"></i>
                      Detalhes do Vale Refeição
                    </h6>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="valorValeRefeicao">Valor Mensal <span class="required">*</span></label>
                        <div class="input-group">
                          <span class="input-group-text">R$</span>
                          <input type="number" class="form-control" id="valorValeRefeicao" name="valorMensal" step="0.01" min="0" required>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="dataInicioVR">Data de Início <span class="required">*</span></label>
                        <input type="date" class="form-control" id="dataInicioVR" name="dataInicio" required>
                      </div>
                      <div class="form-group">
                        <label for="fornecedorVR">Fornecedor</label>
                        <select class="form-control" id="fornecedorVR" name="fornecedorId">
                          <option value="">Selecione o fornecedor</option>
                          <option value="1">Ticket Restaurante</option>
                          <option value="2">Sodexo</option>
                          <option value="3">Alelo</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Formulário Vale Transporte -->
                  <div class="form-section benefit-form" id="form-vale-transporte" style="display: none;">
                    <h6 class="section-title">
                      <i class="fas fa-bus"></i>
                      Detalhes do Vale Transporte
                    </h6>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="valorValeTransporte">Valor Mensal <span class="required">*</span></label>
                        <div class="input-group">
                          <span class="input-group-text">R$</span>
                          <input type="number" class="form-control" id="valorValeTransporte" name="valorMensal" step="0.01" min="0" required>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="dataInicioVT">Data de Início <span class="required">*</span></label>
                        <input type="date" class="form-control" id="dataInicioVT" name="dataInicio" required>
                      </div>
                      <div class="form-group">
                        <label for="tipoTransporte">Tipo de Transporte</label>
                        <select class="form-control" id="tipoTransporte" name="tipoTransporte">
                          <option value="">Selecione o tipo</option>
                          <option value="ONIBUS">Ônibus</option>
                          <option value="METRO">Metrô</option>
                          <option value="TREM">Trem</option>
                          <option value="INTEGRADO">Integrado</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Formulário Vale Alimentação -->
                  <div class="form-section benefit-form" id="form-vale-alimentacao" style="display: none;">
                    <h6 class="section-title">
                      <i class="fas fa-shopping-cart"></i>
                      Detalhes do Vale Alimentação
                    </h6>
                    <div class="form-row">
                      <div class="form-group">
                        <label for="valorValeAlimentacao">Valor Mensal <span class="required">*</span></label>
                        <div class="input-group">
                          <span class="input-group-text">R$</span>
                          <input type="number" class="form-control" id="valorValeAlimentacao" name="valorMensal" step="0.01" min="0" required>
                        </div>
                      </div>
                      <div class="form-group">
                        <label for="dataInicioVA">Data de Início <span class="required">*</span></label>
                        <input type="date" class="form-control" id="dataInicioVA" name="dataInicio" required>
                      </div>
                      <div class="form-group">
                        <label for="fornecedorVA">Fornecedor</label>
                        <select class="form-control" id="fornecedorVA" name="fornecedorId">
                          <option value="">Selecione o fornecedor</option>
                          <option value="1">Ticket Alimentação</option>
                          <option value="2">Sodexo</option>
                          <option value="3">Alelo</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Seção Observações (comum a todos) -->
                  <div class="form-section">
                    <h6 class="section-title">
                      <i class="fas fa-comment-alt"></i>
                      Observações
                    </h6>
                    <div class="form-group full-width">
                      <label for="observacoes">Observações Adicionais</label>
                      <textarea id="observacoes" name="observacoes" class="form-control" rows="3" placeholder="Informações adicionais sobre a adesão..."></textarea>
                    </div>
                  </div>

                  <div class="form-check full-width">
                    <input type="checkbox" id="processarImediatamente" name="processarImediatamente" class="form-check-input">
                    <label class="form-check-label" for="processarImediatamente">Processar imediatamente</label>
                  </div>

                  <div class="modal-footer full-width">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalAdesao()">Cancelar</button>
                    <button type="submit" id="btnSalvarAdesao" class="btn btn-primary" style="display: none;">
                      <span class="btn-text">Salvar Adesão</span>
                      <span class="btn-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Salvando...
                      </span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    const valoresPlanos = /*[[${valoresPlanosJson}]]*/ {};
    /*]]>*/
  </script>

  <script>
    // Funções globais
    function abrirModalAdesao() {
      const modal = document.getElementById("modalAdesao");
      if (modal) {
        modal.classList.add('show');
        atualizarValor();
      }
    }

    function fecharModalAdesao() {
      const modal = document.getElementById("modalAdesao");
      if (modal) {
        modal.classList.remove('show');
        document.getElementById("formAdesao").reset();
        document.getElementById("valorTotal").value = "";
        const infoDiv = document.getElementById('info-plano-selecionado');
        if (infoDiv) infoDiv.remove();
      }
    }

    window.abrirModalAdesao = abrirModalAdesao;
    window.fecharModalAdesao = fecharModalAdesao;

    function formatarMoeda(valor) {
      if (valor === null || valor === undefined || isNaN(valor)) return '0,00';
      return parseFloat(valor).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function atualizarValor() {
      const planoSelect = document.getElementById('planoSaudeId');
      const qtdDependentesInput = document.getElementById('quantidadeDependentes');
      const valorTotalInput = document.getElementById('valorTotal');

      if (!planoSelect || !qtdDependentesInput || !valorTotalInput) return;

      const planoId = planoSelect.value;
      let qtdDependentes = parseInt(qtdDependentesInput.value) || 0;
      if (qtdDependentes < 0) qtdDependentes = 0;
      if (qtdDependentes > 10) qtdDependentes = 10;

      if (planoId && valoresPlanos && valoresPlanos[planoId]) {
        const valorTitular = valoresPlanos[planoId].titular || 0;
        const valorDependente = valoresPlanos[planoId].dependente || 0;
        const valorTotal = valorTitular + (valorDependente * qtdDependentes);

        valorTotalInput.value = formatarMoeda(valorTotal);
        atualizarInfoPlano(planoId, qtdDependentes, valorTotal);
      } else {
        valorTotalInput.value = formatarMoeda(0);
        const infoDiv = document.getElementById('info-plano-selecionado');
        if (infoDiv) infoDiv.remove();
      }
    }

    function atualizarInfoPlano(planoId, qtdDependentes, valorTotal) {
      let infoDiv = document.getElementById('info-plano-selecionado');
      if (!infoDiv) {
        infoDiv = document.createElement('div');
        infoDiv.id = 'info-plano-selecionado';
        infoDiv.className = 'alert alert-info mt-2';
        document.getElementById('planoSaudeId').parentNode.appendChild(infoDiv);
      }

      const valorTitular = valoresPlanos[planoId].titular || 0;
      const valorDependente = valoresPlanos[planoId].dependente || 0;

      infoDiv.innerHTML = `
        <small>
          <strong>Detalhes do Plano:</strong><br>
          • Titular: R$ ${formatarMoeda(valorTitular)}<br>
          ${qtdDependentes > 0 ? `• Dependentes (${qtdDependentes}): R$ ${formatarMoeda(valorDependente * qtdDependentes)}<br>` : ''}
          <strong>Total Mensal: R$ ${formatarMoeda(valorTotal)}</strong>
        </small>
      `;
    }

    document.addEventListener("DOMContentLoaded", function () {
      const formAdesao = document.getElementById("formAdesao");
      if (formAdesao) {
        formAdesao.addEventListener("submit", function (e) {
          e.preventDefault();
          // Validações básicas
          const colaboradorId = document.querySelector('[name="colaboradorId"]').value;
          const planoId = document.querySelector('[name="planoId"]').value;
          const dataVigencia = document.querySelector('[name="dataVigencia"]').value;
          const tipoAdesao = document.querySelector('[name="tipoAdesao"]').value;

          if (!colaboradorId || !planoId || !dataVigencia || !tipoAdesao) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
          }

          const formData = new FormData(this);
          const valorTotalLimpo = formData.get("valorTotal").replace(/[R$\s.,]/g, '').replace(/([0-9]{2})$/, '.$1');

          const data = {
            colaboradorId: parseInt(colaboradorId),
            planoId: parseInt(planoId),
            quantidadeDependentes: parseInt(formData.get("quantidadeDependentes") || 0),
            valorTotal: parseFloat(valorTotalLimpo) || 0,
            dataVigencia: dataVigencia,
            tipoAdesao: tipoAdesao,
            observacoes: formData.get("observacoes") || '',
            processarImediatamente: formData.get("processarImediatamente") != null
          };

          const submitBtn = this.querySelector('button[type="submit"]');
          const btnText = submitBtn.querySelector('.btn-text');
          const btnLoading = submitBtn.querySelector('.btn-loading');

          submitBtn.disabled = true;
          if (btnText) btnText.style.display = 'none';
          if (btnLoading) btnLoading.style.display = 'inline';

          fetch("/rh/beneficios/adesao", {
            method: "POST",
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
          }).then(resp => resp.json())
            .then(result => {
              if (result.success) {
                alert(`Adesão salva com sucesso!\nID: ${result.adesaoId}\nValor Total: R$ ${formatarMoeda(result.valorTotal)}`);
                fecharModalAdesao();
                location.reload();
              } else {
                alert('Erro ao salvar adesão: ' + (result.message || 'Erro desconhecido'));
              }
            }).catch(err => {
              console.error('Erro:', err);
              alert('Erro ao salvar adesão. Detalhes: ' + err.message);
            }).finally(() => {
              submitBtn.disabled = false;
              if (btnText) btnText.style.display = 'inline';
              if (btnLoading) btnLoading.style.display = 'none';
            });
        });
      }

      const planoSelect = document.getElementById("planoSaudeId");
      if (planoSelect) planoSelect.addEventListener("change", atualizarValor);

      const qtdDependentes = document.getElementById("quantidadeDependentes");
      if (qtdDependentes) qtdDependentes.addEventListener("input", atualizarValor);
    });

    function verDetalhesAdesao(adesaoId) {
      if (!adesaoId) { alert('ID da adesão não encontrado'); return; }
      window.location.href = `/rh/beneficios/adesao/detalhes/${adesaoId}`;
    }
  </script>

  <!-- jQuery necessário para o modal -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- Bootstrap JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Script do novo modal de benefícios -->
  <script th:src="@{/js/benefits.js}"></script>

</body>

</html>