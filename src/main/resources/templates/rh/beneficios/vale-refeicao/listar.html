<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vale Refeição - ERP Corporativo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
</head>
<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>

        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>

            <section class="content-area">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-utensils"></i> Vale Refeição</h1>
                    <div>
                        <a th:href="@{/rh/beneficios/vale-refeicao/novo}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Novo Vale
                        </a>
                        <a th:href="@{/rh/beneficios/vale-refeicao/relatorios}" class="btn btn-info">
                            <i class="fas fa-chart-bar"></i> Relatórios
                        </a>
                    </div>
                </div>

                <!-- Mensagens -->
                <div th:if="${mensagem}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle"></i> <span th:text="${mensagem}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle"></i> <span th:text="${erro}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Cards de Estatísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Vales Ativos</h6>
                                        <h4 th:text="${#lists.size(valesAtivos)}">0</h4>
                                    </div>
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Gasto Total</h6>
                                        <h4 th:text="${#numbers.formatCurrency(totalGastoMes)}">R$ 0,00</h4>
                                        <small th:text="${mesReferencia}"></small>
                                    </div>
                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Subsídio Empresa</h6>
                                        <h4 th:text="${#numbers.formatCurrency(subsidioEmpresaMes)}">R$ 0,00</h4>
                                        <small th:text="${mesReferencia}"></small>
                                    </div>
                                    <i class="fas fa-building fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="card-title">Total Vales</h6>
                                        <h4 th:text="${#lists.size(vales)}">0</h4>
                                    </div>
                                    <i class="fas fa-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ações Rápidas -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-bolt"></i> Ações Rápidas</h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/rh/beneficios/vale-refeicao/gerar-mes}" method="post" class="row g-3">
                            <div class="col-md-2">
                                <label for="mes" class="form-label">Mês</label>
                                <select class="form-select" id="mes" name="mes" required>
                                    <option value="1">Janeiro</option>
                                    <option value="2">Fevereiro</option>
                                    <option value="3">Março</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Maio</option>
                                    <option value="6">Junho</option>
                                    <option value="7">Julho</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Setembro</option>
                                    <option value="10">Outubro</option>
                                    <option value="11">Novembro</option>
                                    <option value="12">Dezembro</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="ano" class="form-label">Ano</label>
                                <input type="number" class="form-control" id="ano" name="ano" th:value="${#temporals.year(#temporals.createNow())}" required>
                            </div>
                            <div class="col-md-3">
                                <label for="valorDiario" class="form-label">Valor Diário Padrão</label>
                                <input type="number" class="form-control" id="valorDiario" name="valorDiario" step="0.01" value="25.00" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-success d-block">
                                    <i class="fas fa-magic"></i> Gerar Vales do Mês
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Lista de Vales -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Lista de Vales Refeição</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(vales)}" class="text-center text-muted py-4">
                            <i class="fas fa-utensils fa-3x mb-3"></i>
                            <h5>Nenhum vale refeição encontrado</h5>
                            <p>Clique em "Novo Vale" para começar</p>
                        </div>

                        <div th:if="${!#lists.isEmpty(vales)}" class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Colaborador</th>
                                        <th>Período</th>
                                        <th>Valor Diário</th>
                                        <th>Dias Úteis</th>
                                        <th>Total Mês</th>
                                        <th>Desconto</th>
                                        <th>Subsídio Empresa</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="vale : ${vales}">
                                        <td>
                                            <strong th:text="${vale.colaborador.nome}"></strong><br>
                                            <small class="text-muted" th:text="${vale.colaborador.cargo?.nome}"></small>
                                        </td>
                                        <td th:text="${vale.mesReferencia + '/' + vale.anoReferencia}"></td>
                                        <td th:text="${#numbers.formatCurrency(vale.valorDiario)}"></td>
                                        <td th:text="${vale.diasUteis}"></td>
                                        <td th:text="${#numbers.formatCurrency(vale.valorTotalMes)}"></td>
                                        <td th:text="${#numbers.formatCurrency(vale.valorDesconto)}"></td>
                                        <td th:text="${#numbers.formatCurrency(vale.valorSubsidioEmpresa)}"></td>
                                        <td>
                                            <span class="badge bg-secondary" th:text="${vale.tipoDescricao}"></span>
                                        </td>
                                        <td>
                                            <span th:class="'badge ' + (${vale.status.name() == 'ATIVO'} ? 'bg-success' : 
                                                             ${vale.status.name() == 'SUSPENSO'} ? 'bg-warning' : 'bg-danger')"
                                                  th:text="${vale.statusDescricao}"></span>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a th:href="@{/rh/beneficios/vale-refeicao/editar/{id}(id=${vale.id})}" 
                                                   class="btn btn-sm btn-outline-primary" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                
                                                <button th:if="${vale.status.name() == 'ATIVO'}" 
                                                        type="button" class="btn btn-sm btn-outline-warning" 
                                                        th:onclick="'suspenderVale(' + ${vale.id} + ')'" 
                                                        title="Suspender">
                                                    <i class="fas fa-pause"></i>
                                                </button>
                                                
                                                <button th:if="${vale.status.name() == 'SUSPENSO'}" 
                                                        type="button" class="btn btn-sm btn-outline-success" 
                                                        th:onclick="'reativarVale(' + ${vale.id} + ')'" 
                                                        title="Reativar">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                                
                                                <button th:if="${vale.status.name() != 'CANCELADO'}" 
                                                        type="button" class="btn btn-sm btn-outline-danger" 
                                                        th:onclick="'cancelarVale(' + ${vale.id} + ')'" 
                                                        title="Cancelar">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        th:onclick="'excluirVale(' + ${vale.id} + ')'" 
                                                        title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function suspenderVale(id) {
            const motivo = prompt('Motivo da suspensão:');
            if (motivo) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/rh/beneficios/vale-refeicao/suspender/${id}`;
                
                const motivoInput = document.createElement('input');
                motivoInput.type = 'hidden';
                motivoInput.name = 'motivo';
                motivoInput.value = motivo;
                form.appendChild(motivoInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function reativarVale(id) {
            if (confirm('Confirma a reativação do vale refeição?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/rh/beneficios/vale-refeicao/reativar/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function cancelarVale(id) {
            const motivo = prompt('Motivo do cancelamento:');
            if (motivo) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/rh/beneficios/vale-refeicao/cancelar/${id}`;
                
                const motivoInput = document.createElement('input');
                motivoInput.type = 'hidden';
                motivoInput.name = 'motivo';
                motivoInput.value = motivo;
                form.appendChild(motivoInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }

        function excluirVale(id) {
            if (confirm('Confirma a exclusão do vale refeição? Esta ação não pode ser desfeita.')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/rh/beneficios/vale-refeicao/excluir/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>