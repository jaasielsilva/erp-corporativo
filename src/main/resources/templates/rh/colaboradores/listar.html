<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Colaboradores - Listar - ERP Corporativo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link href="/css/style.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
  <link href="/css/notifications.css" rel="stylesheet">

</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <h1>Gestão de Colaboradores</h1>
        <h2>Lista de todos os colaboradores da empresa</h2>

        <!-- Mensagens de Sucesso e Erro -->
        <div th:if="${mensagem}" class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          <span th:text="${mensagem}"></span>
        </div>

        <div th:if="${erro}" class="alert alert-error">
          <i class="fas fa-exclamation-circle"></i>
          <span th:text="${erro}"></span>
        </div>


        <!-- botão ajustado para o tamanho do conteúdo -->
        <div class="action-buttons">
          <a href="/rh/colaboradores/novo" class="btn btn-primary"
            style="flex: 0 0 auto; width: auto; display: inline-flex; align-items: center; gap: 6px;">
            <i class="fas fa-plus"></i> Novo Colaborador
          </a>
          <div class="search-box">
            <input id="buscarColaborador" type="text" placeholder="Buscar por nome, email ou CPF" autocomplete="off" />
          </div>
        </div>



        <article class="card">
          <h3>Colaboradores Cadastrados</h3>
          <div id="loading" class="loading" style="display:none"><i class="fas fa-spinner fa-spin"></i> Carregando...
          </div>
          <table class="table-list">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Cargo</th>
                <th>Departamento</th>
                <th>Admissão</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="colaboradoresBody">
            </tbody>
          </table>

        </article>

        <div id="pagination" class="pagination"></div>
      </section>


    </main>
  </div>

  <!-- Modal de Confirmação de Desligamento -->
  <div id="desligamentoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content-desligamento">
      <div class="modal-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Desligamento</h3>
        <button type="button" class="modal-close" onclick="closeDesligamentoModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="warning-message">
          <i class="fas fa-user-times warning-icon"></i>
          <div class="warning-text">
            <h4>Tem certeza que deseja desligar este colaborador?</h4>
            <p>Colaborador: <strong id="colaboradorNome"></strong></p>
            <p class="warning-note">
              <i class="fas fa-info-circle"></i>
              Esta ação não pode ser desfeita. O colaborador será marcado como inativo no sistema.
            </p>
            <div class="confirm-section">
              <label class="confirm-label">
                <input type="checkbox" name="confirmarDesligamento" required form="desligamentoForm">
                Confirmo que revisei o caso e autorizo o desligamento definitivo.
              </label>
              <div class="confirm-input">
                <label for="confirmarTexto">Digite <strong>DESLIGAR</strong> para confirmar</label>
                <input id="confirmarTexto" name="confirmarTexto" type="text" placeholder="DESLIGAR" required
                  form="desligamentoForm">
              </div>
              <p class="warning-note">
                Esta operação requer confirmação por perfis ADMIN ou RH.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDesligamentoModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <form id="desligamentoForm" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-user-times"></i> Confirmar Desligamento
          </button>
        </form>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    window.podeAcessarRH = [[${ podeAcessarRH } ?: false]];
  </script>
  <script>
    let currentPage = 0;
    let query = '';
    let debounceTimer;

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }

    function formatDateBr(v) {
      if (!v) return '-';
      if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}/.test(v)) {
        const [y, m, d] = v.split('T')[0].split('-');
        return `${d}/${m}/${y}`;
      }
      if (Array.isArray(v) && v.length >= 3) {
        const y = v[0], m = (`0${v[1]}`).slice(-2), d = (`0${v[2]}`).slice(-2);
        return `${d}/${m}/${y}`;
      }
      try {
        const dt = new Date(v);
        const d = (`0${dt.getDate()}`).slice(-2);
        const m = (`0${dt.getMonth() + 1}`).slice(-2);
        const y = dt.getFullYear();
        return `${d}/${m}/${y}`;
      } catch { return '-'; }
    }

    function renderRows(items) {
      const tbody = document.getElementById('colaboradoresBody');
      tbody.innerHTML = '';
      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum colaborador encontrado</td></tr>';
        return;
      }
      const rows = items.map(it => {
        const nome = it.nome || '-';
        const cargo = it.cargo || '-';
        const dep = it.departamento || '-';
        const adm = formatDateBr(it.dataAdmissao);
        return `<tr>
          <td>${nome}</td>
          <td>${cargo}</td>
          <td>${dep}</td>
          <td>${adm}</td>
          <td><span class="status-badge status-ativo">ATIVO</span></td>
          <td class="actions">
          <a href="/rh/colaboradores/ficha/${it.id}" class="btn btn-sm btn-info" title="Ver Ficha"><i class="fas fa-eye"></i></a>
          <a href="/rh/colaboradores/editar/${it.id}" class="btn btn-sm btn-warning" title="Editar"><i class="fas fa-edit"></i></a>
          ${window.podeAcessarRH ? `<button type="button" class="btn btn-sm btn-danger" title="Desligar Colaborador" onclick="openDesligamentoModal('${it.id}', '${nome}')"><i class="fas fa-user-times"></i></button>` : ''}
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    }

    function renderPagination(data) {
      const el = document.getElementById('pagination');
      const totalPages = data.totalPages || 0;
      const totalElements = data.totalElements || 0;
      const page = data.currentPage || 0;
      const hasPrev = data.hasPrevious;
      const hasNext = data.hasNext;
      let html = '';
      html += `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} colaboradores)</span>`;
      html += hasPrev ? `<a class="btn btn-secondary" href="#" onclick="goToPage(${page - 1});return false;"><i class="fas fa-chevron-left"></i> Anterior</a>` : `<span class="btn btn-secondary disabled"><i class="fas fa-chevron-left"></i> Anterior</span>`;
      html += hasNext ? `<a class="btn btn-secondary" href="#" onclick="goToPage(${page + 1});return false;">Próxima <i class="fas fa-chevron-right"></i></a>` : `<span class="btn btn-secondary disabled">Próxima <i class="fas fa-chevron-right"></i></span>`;
      el.innerHTML = html;
    }

    function loadColaboradores(page = 0) {
      currentPage = page;
      showLoading(true);
      fetch(`/rh/colaboradores/api/listar?page=${page}&size=20&q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => { renderRows(data.content); renderPagination(data); })
        .catch(() => { renderRows([]); renderPagination({ currentPage: 0, totalPages: 1, totalElements: 0, hasPrevious: false, hasNext: false }); })
        .finally(() => showLoading(false));
    }

    function goToPage(p) { loadColaboradores(Math.max(0, p)); }

    document.addEventListener('DOMContentLoaded', function () {
      const input = document.getElementById('buscarColaborador');
      if (input) {
        input.addEventListener('input', function (e) {
          clearTimeout(debounceTimer);
          query = e.target.value;
          debounceTimer = setTimeout(() => loadColaboradores(0), 250);
        });
      }
      loadColaboradores(0);
    });
  </script>
  <script>
    function openDesligamentoModal(colaboradorId, colaboradorNome) {
      document.getElementById('colaboradorNome').textContent = colaboradorNome;
      document.getElementById('desligamentoForm').action = '/rh/colaboradores/desativar/' + colaboradorId;
      document.getElementById('desligamentoModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeDesligamentoModal() {
      document.getElementById('desligamentoModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    // Fechar modal ao clicar fora dele
    document.getElementById('desligamentoModal').addEventListener('click', function (e) {
      if (e.target === this) {
        closeDesligamentoModal();
      }
    });

    // Fechar modal com ESC
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        closeDesligamentoModal();
      }
    });
  </script>
  <!-- Script de notifica��es --> <!-- jQuery necess�rio para o sistema de notifica��es -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>


  <script th:src="@{/js/notifications.js}"></script>
  <script th:src="@{/js/sidebar.js}"></script>

  <!-- Footer -->
  <div th:replace="~{components/footer :: footer}"></div>
</body>

</html>