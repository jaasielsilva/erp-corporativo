<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Férias - Solicitar</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
<body>
    <div class="app-container">
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        <main class="main-content">
            <header th:replace="~{components/topbar :: topbar}"></header>
            <section class="content-area">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <h1 class="h4 mb-3"><i class="fas fa-sun me-2"></i>Férias - Solicitar</h1>
                            <div class="card">
                                <div class="card-body">
                                    <form id="formSolicitar" onsubmit="event.preventDefault(); solicitarFerias();">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Colaborador</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="buscaColaborador" placeholder="Buscar por nome/email" oninput="buscarColaboradores(this.value)" />
                                                    <button class="btn btn-outline-secondary" type="button" onclick="buscarColaboradores(document.getElementById('buscaColaborador').value)"><i class="fas fa-search"></i></button>
                                                </div>
                                                <small class="text-muted">Selecione abaixo o colaborador</small>
                                                <select class="form-select mt-2" id="colaboradorSelect"></select>
                                                <div class="d-flex align-items-center gap-2 mt-2">
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnPrevCol" onclick="mudarPaginaCol(-1)"><i class="fas fa-chevron-left"></i></button>
                                                    <span class="text-muted" id="infoPagina">Página 1</span>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnNextCol" onclick="mudarPaginaCol(1)"><i class="fas fa-chevron-right"></i></button>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Início</label>
                                                <input type="date" class="form-control" id="inicio" required />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Fim</label>
                                                <input type="date" class="form-control" id="fim" required />
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Observações</label>
                                                <textarea class="form-control" id="observacoes" rows="3" placeholder="Opcional"></textarea>
                                            </div>
                                        </div>
                                        <div class="mt-3 d-flex gap-2">
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane me-2"></i>Solicitar</button>
                                            <button type="button" class="btn btn-secondary" onclick="resetForm()"><i class="fas fa-undo me-2"></i>Limpar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>
    <script src="/js/sidebar.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script th:src="@{/js/notifications.js}"></script>
    <script>
        let pagina = 0;
        let hasPrev = false;
        let hasNext = false;
        function buscarColaboradores(q) {
            $.get('/rh/colaboradores/api/listar', { page: pagina, size: 20, q: q || '' })
                .done(function (resp) {
                    const sel = document.getElementById('colaboradorSelect');
                    sel.innerHTML = '';
                    const content = resp.content || [];
                    content.forEach(function (c) {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.nome + ' (' + (c.email || '') + ')';
                        sel.appendChild(opt);
                    });
                    if (content.length > 0) { sel.selectedIndex = 0; }
                    if (content.length === 0) {
                        if (typeof showToast === 'function') { showToast({ title: 'Férias', message: 'Nenhum colaborador encontrado para a busca.', priority: 'MEDIUM' }); }
                    }
                    hasPrev = !!resp.hasPrevious;
                    hasNext = !!resp.hasNext;
                    pagina = resp.currentPage || 0;
                    document.getElementById('btnPrevCol').disabled = !hasPrev;
                    document.getElementById('btnNextCol').disabled = !hasNext;
                    document.getElementById('infoPagina').textContent = 'Página ' + (pagina + 1) + ' de ' + ((resp.totalPages || 1));
                })
                .fail(function () {
                    if (typeof showToast === 'function') { showToast({ title: 'Férias', message: 'Falha ao carregar colaboradores.', priority: 'HIGH' }); }
                });
        }
        function mudarPaginaCol(delta) {
            const novaPagina = pagina + delta;
            if (novaPagina < 0) return;
            pagina = novaPagina;
            buscarColaboradores(document.getElementById('buscaColaborador').value);
        }
        function solicitarFerias() {
            const colaboradorId = document.getElementById('colaboradorSelect').value;
            const inicio = document.getElementById('inicio').value;
            const fim = document.getElementById('fim').value;
            const observacoes = document.getElementById('observacoes').value;
            if (!colaboradorId) { if (typeof showToast === 'function') { showToast({ title: 'Férias', message: 'Selecione um colaborador.', priority: 'MEDIUM' }); } return; }
            $.post('/api/rh/ferias/solicitacoes', { colaboradorId, inicio, fim, observacoes })
                .done(function (resp) {
                    if (resp.success) {
                        if (typeof showToast === 'function') { showToast({ title: 'Férias', message: 'Solicitação registrada com sucesso (ID ' + resp.id + ')', priority: 'LOW' }); }
                        resetForm();
                    } else {
                        if (typeof showToast === 'function') { showToast({ title: 'Férias', message: (resp.message || 'Falha ao solicitar'), priority: 'HIGH' }); }
                    }
                })
                .fail(function (xhr) {
                    const msg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Erro ao enviar solicitação';
                    if (typeof showToast === 'function') { showToast({ title: 'Férias', message: msg, priority: 'HIGH' }); }
                });
        }
        function resetForm() {
            document.getElementById('buscaColaborador').value = '';
            document.getElementById('inicio').value = '';
            document.getElementById('fim').value = '';
            document.getElementById('observacoes').value = '';
            buscarColaboradores('');
        }
        $(document).ready(function () { buscarColaboradores(''); });
    </script>
</body>
</html>
