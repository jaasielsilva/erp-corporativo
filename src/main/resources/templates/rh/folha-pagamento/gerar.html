<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerar Folha de Pagamento - ERP Corporativo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <!-- Removido bloco duplicado de alerts superiores para evitar conflito visual -->

        <div class="alert-container-right">
          <!-- Alerts server-side removidos: apenas alertas dinâmicos via JavaScript -->
        </div>
        <h1>Gerar Folha de Pagamento</h1>

        <article id="processamentoStatusCard" class="card" style="display:none;">
          <h3><i class="fas fa-sync-alt"></i> Status de Processamento</h3>
          <div id="processamentoAlert" class="alert alert-info" role="alert">
            <i id="processamentoAlertIcon" class="fas fa-sync-alt"></i>
            <span id="processamentoStatusText">Processando...</span>
            <small id="processamentoStatusInfo" style="display:block;margin-top:4px"></small>
            <div style="margin-top:8px">
              <div class="progress" style="height:16px;background:#eee;border-radius:8px;overflow:hidden">
                <div id="processamentoProgressBar" class="progress-bar" style="width:0%;background:#0d6efd;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600">
                  <span id="processamentoProgressBadge">0%</span>
                </div>
              </div>
              <small id="processamentoProgressText" style="display:block;margin-top:6px;color:#555">0% • Processando…</small>
              <small id="processamentoTempoInfo" style="display:block;margin-top:2px;color:#777"></small>
            </div>
            <div style="margin-top:8px; display:flex; align-items:center; gap:8px">
              <button id="toggleLogsBtn" type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleProcessamentoLogs()">
                <i class="fas fa-list"></i> Ver detalhes
              </button>
              <small style="color:#888">Mensagens de processamento (últimos eventos)</small>
            </div>
          </div>
          <div id="processamentoLogsContainer" class="card" style="display:none; margin-top:8px;">
            <div style="padding:8px 10px;">
              <h4 style="font-size:14px; margin:0 0 6px 0; color:#333"><i class="fas fa-stream"></i> Mensagens de Processamento</h4>
              <div id="processamentoLogsBox" style="max-height:160px; overflow:auto; background:#f8f9fa; border:1px solid #ddd; border-radius:6px; padding:8px; font-size:12px; line-height:1.4; color:#333"></div>
            </div>
          </div>
          <div class="form-actions">
            <a id="abrirFolhaBtn" href="#" class="btn btn-success" style="display:none;">
              <i class="fas fa-eye"></i> Visualizar Folha
            </a>
          </div>
        </article>

        <!-- Configurações da Folha -->
        <article class="card">
          <h3><i class="fas fa-cog"></i> Configurações da Folha</h3>
          <div th:if="${existeFolhaAtual}" class="alert alert-warning" role="alert">
            Já existe folha para <span th:text="${mesAtual}"></span>/<span th:text="${anoAtual}"></span>.
          </div>
          <form id="processarFolhaForm" class="form-container" th:action="@{/rh/folha-pagamento/processar}" method="post" onsubmit="return processarFolhaAsync(event)">
            <div class="form-row">
              <div class="form-group">
                <label for="mesReferencia">Mês de Referência *</label>
                <select id="mesReferencia" name="mes" required class="form-control">
                  <option th:each="m : ${#numbers.sequence(1,12)}" th:value="${m}" th:text="${m}"></option>
                </select>
              </div>
              <div class="form-group">
                <label for="anoReferencia">Ano de Referência *</label>
                <select id="anoReferencia" name="ano" required class="form-control">
                  <option th:each="a : ${#numbers.sequence(anoAtual-2,anoAtual+1)}" th:value="${a}" th:text="${a}"
                    th:selected="${a == anoAtual}"></option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="departamento">Departamento</label>
                <select id="departamento" name="departamento" class="form-control">
                  <option value="">Todos os departamentos</option>
                  <option th:each="d : ${departamentos}" th:value="${d.id}" th:text="${d.nome}"></option>
                </select>
              </div>
              <div class="form-group">
                <label for="tipoFolha">Tipo de Folha</label>
                <select id="tipoFolha" name="tipoFolha" class="form-control">
                  <option value="normal" selected>Folha Normal</option>
                  <option value="complementar">Folha Complementar</option>
                  <option value="decimo_terceiro">13º Salário</option>
                  <option value="ferias">Férias</option>
                </select>
              </div>
            </div>

            <div class="form-actions">
              <div style="display:flex;align-items:center;gap:12px">
                <button type="submit" class="btn btn-primary" th:disabled="${existeFolhaAtual}">
                  <i class="fas fa-cogs"></i> Processar Folha
                </button>
                <button type="button" id="btnFolhaPause" class="btn btn-warning" disabled>
                  <i class="fas fa-pause"></i> Pausar
                </button>
                <button type="button" id="btnFolhaResume" class="btn btn-success" disabled>
                  <i class="fas fa-play"></i> Retomar
                </button>
                <button type="button" id="btnFolhaCancel" class="btn btn-danger" disabled>
                  <i class="fas fa-stop"></i> Cancelar
                </button>
                
              </div>
            </div>
          </form>
        </article>

        <!-- Resumo dos Colaboradores -->
        <article class="card">
          <h3><i class="fas fa-users"></i> Colaboradores Incluídos</h3>
          

          <table class="table-list">
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>Cargo</th>
                <th>Departamento</th>
                <th>Salário Base</th>
                <th>Dias Trabalhados</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="colaboradoresResumoBody"></tbody>



          </table>

          <div id="paginationResumo" class="pagination"></div>
        </article>


      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script th:src="@{/js/script.js}"></script>
  <script th:src="@{/js/notifications.js}"></script>
  <div id="desligamentoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content-desligamento">
      <div class="modal-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Desligamento</h3>
        <button type="button" class="modal-close" onclick="closeDesligamentoModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="warning-message">
          <i class="fas fa-user-times warning-icon"></i>
          <div class="warning-text">
            <h4>Tem certeza que deseja desligar este colaborador?</h4>
            <p>Colaborador: <strong id="colaboradorNome"></strong></p>
            <div class="confirm-section">
              <label class="confirm-label">
                <input type="checkbox" name="confirmarDesligamento" required form="desligamentoForm">
                Confirmo que revisei o caso e autorizo o desligamento definitivo.
              </label>
              <div class="confirm-input">
                <label for="confirmarTexto">Digite <strong>DESLIGAR</strong> para confirmar</label>
                <input id="confirmarTexto" name="confirmarTexto" type="text" placeholder="DESLIGAR" required form="desligamentoForm">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDesligamentoModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <form id="desligamentoForm" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-user-times"></i> Confirmar Desligamento
          </button>
        </form>
      </div>
    </div>
  </div>
  <script>
    let etapaAtual = 0;

    function calcularFolha() {
      // Simular processamento
      const btn = event.target;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check"></i> Calculado';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');

        // Habilitar próxima etapa
        document.querySelector('button[onclick="revisarCalculos()"]').disabled = false;
        etapaAtual = 1;

        alert('Folha calculada com sucesso!');
      }, 3000);
    }

    function revisarCalculos() {
      if (etapaAtual >= 1) {
        alert('Cálculos revisados e aprovados!');
        document.querySelector('button[onclick="gerarHolerites()"]').disabled = false;
        etapaAtual = 2;
      }
    }

    function gerarHolerites() {
      if (etapaAtual >= 2) {
        alert('Holerites gerados com sucesso!');
        document.querySelector('button[onclick="aprovarFolha()"]').disabled = false;
        etapaAtual = 3;
      }
    }

    function aprovarFolha() {
      if (etapaAtual >= 3) {
        if (confirm('Tem certeza que deseja aprovar a folha de pagamento? Esta ação não pode ser desfeita.')) {
          alert('Folha de pagamento aprovada e processada!');
        }
      }
    }
  </script>
  <script>
    let currentResumoPage = 0;
    function showResumoLoading(show) {
      const tbody = document.getElementById('colaboradoresResumoBody');
      if (show) tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>';
    }
    function renderResumoRows(items) {
      const tbody = document.getElementById('colaboradoresResumoBody');
      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum colaborador encontrado</td></tr>';
        return;
      }
      const rows = items.map(c => {
        const salario = c.salario != null ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(c.salario) : 'R$ 0,00';
        const dias = `${(c.diasTrabalhados ?? 0)}/${(c.diasUteisMes ?? 0)}`;
        const ok = !!c.temEscala;
        const alertClass = ok ? 'alert alert-success' : 'alert alert-danger';
        const icon = ok ? 'fa-check-circle' : 'fa-exclamation-triangle';
        const statusHtml = `<div class="${alertClass}" role="alert" style="padding:6px 10px;display:inline-flex;align-items:center;gap:6px"><i class="fas ${icon}"></i><span>${ok ? 'true' : 'false'}</span></div>`;
        const desligarBtn = window.podeAcessarRH ? `<button type="button" class="btn btn-sm btn-danger" title="Desligar Colaborador" data-id="${c.id}" data-nome="${c.nome}" onclick="openDesligamentoFromDataset(this)"><i class="fas fa-user-times"></i></button>` : '';
        return `<tr>
          <td>${c.nome ?? '-'}</td>
          <td>${c.cargoNome ?? '-'}</td>
          <td>${c.departamentoNome ?? '-'}</td>
          <td>${salario}</td>
          <td>${dias}</td>
          <td>${statusHtml}</td>
          <td class="actions">
            <a href="/rh/ponto-escalas/escalas" class="btn btn-sm btn-outline-primary" title="Escalas"><i class="fas fa-calendar"></i></a>
            <a href="/rh/colaboradores/ficha/${c.id}" class="btn btn-sm btn-info" title="Ver Ficha"><i class="fas fa-eye"></i></a>
            <a href="/rh/colaboradores/editar/${c.id}" class="btn btn-sm btn-warning" title="Editar"><i class="fas fa-edit"></i></a>
            ${desligarBtn}
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    }
    function renderResumoPagination(data) {
      const el = document.getElementById('paginationResumo');
      const totalPages = data.totalPages || 0;
      const totalElements = data.totalElements || 0;
      const page = data.currentPage || 0;
      const hasPrev = data.hasPrevious;
      const hasNext = data.hasNext;
      let html = '';
      html += `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} colaboradores)</span>`;
      html += hasPrev ? `<a class="btn btn-secondary" href="#" onclick="loadResumo(${page - 1});return false;"><i class="fas fa-chevron-left"></i> Anterior</a>` : `<span class="btn btn-secondary disabled"><i class="fas fa-chevron-left"></i> Anterior</span>`;
      html += hasNext ? `<a class="btn btn-secondary" href="#" onclick="loadResumo(${page + 1});return false;">Próxima <i class="fas fa-chevron-right"></i></a>` : `<span class="btn btn-secondary disabled">Próxima <i class="fas fa-chevron-right"></i></span>`;
      el.innerHTML = html;
    }
    function loadResumo(page = 0) {
      currentResumoPage = page;
      showResumoLoading(true);
      fetch(`/rh/folha-pagamento/api/colaboradores-resumo?page=${page}&size=10`)
        .then(r => r.json())
        .then(data => { renderResumoRows(data.content); renderResumoPagination(data); })
        .catch(() => { renderResumoRows([]); renderResumoPagination({ currentPage: 0, totalPages: 1, totalElements: 0, hasPrevious: false, hasNext: false }); });
    }
    document.addEventListener('DOMContentLoaded', function() { loadResumo(0); });
  </script>
  <script>
    function openDesligamentoFromDataset(el) {
      const id = el.dataset.id;
      const nome = el.dataset.nome;
      document.getElementById('colaboradorNome').textContent = nome;
      document.getElementById('desligamentoForm').action = '/rh/colaboradores/desativar/' + id;
      document.getElementById('desligamentoModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function closeDesligamentoModal() {
      document.getElementById('desligamentoModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    document.getElementById('desligamentoModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDesligamentoModal();
      }
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDesligamentoModal();
      }
    });
  </script>
  <!-- jQuery e notificações (deduplicados) -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script th:src="@{/js/sidebar.js}"></script>

</body>

</html>
 <script th:inline="javascript">
    window.podeAcessarRH = /*[[${podeAcessarRH}]]*/ false;
</script>

  <script>
    // Adiciona botão "X" e auto-hide APENAS nos alerts dinâmicos do container direito
    function enhanceAlerts() {
      const container = document.querySelector('.alert-container-right');
      if (!container) return;
      container.querySelectorAll('.alert').forEach(a => {
        // Adiciona botão de fechar se não existir
        if (!a.querySelector('.alert-close-x')) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'alert-close-x';
          btn.setAttribute('aria-label', 'Fechar');
          btn.innerHTML = '&times;';
          btn.style.cssText = 'float:right;background:transparent;border:none;font-size:18px;line-height:1;color:#000;opacity:.6;cursor:pointer;margin-left:8px';
          btn.onclick = () => { a.remove(); };
          a.insertAdjacentElement('afterbegin', btn);
        }
        // Auto-esconde após 4 segundos
        if (!a.dataset.autohideBound) {
          a.dataset.autohideBound = '1';
          setTimeout(() => { if (a.isConnected) a.remove(); }, 4000);
        }
      });
    }
    document.addEventListener('DOMContentLoaded', enhanceAlerts);

    // Deduplicação simples de mensagens para evitar alerts repetidos em curto intervalo
    const recentAlerts = new Map(); // texto -> timestamp
    let __lastStatus = null;
    let __statusNotified = false;
    let __stopPolling = false;
    function mostrarAlerta(tipo, texto) {
      const container = document.querySelector('.alert-container-right');
      if (!container) return;
      const now = Date.now();
      const last = recentAlerts.get(texto);
      if (last && (now - last) < 2500) {
        // Ignora duplicata recente
        return;
      }
      recentAlerts.set(texto, now);
      const el = document.createElement('div');
      el.className = `alert alert-${tipo}`;
      el.setAttribute('role', 'alert');
      const icon = tipo === 'success' ? 'fa-check-circle' : (tipo === 'warning' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle');
      // inclui botão de fechar "X" e escapa o texto
      const safeText = escapeHtml(String(texto ?? ''));
      el.innerHTML = `<button type="button" class="alert-close-x" aria-label="Fechar" style="float:right;background:transparent;border:none;font-size:18px;line-height:1;color:#000;opacity:.6;cursor:pointer;margin-left:8px" onclick="this.closest('.alert').remove()">&times;</button>` +
                     `<i class="fas ${icon}"></i> <span>${safeText}</span>`;
      container.prepend(el);
      // auto-esconde em 4 segundos
      setTimeout(() => { if (el.isConnected) el.remove(); }, 5000);
    }
    let processamentoInterval = null;
    let processamentoJobId = null;
    let processamentoStartAt = null;
    let processamentoEndAt = null;
    let processamentoMesRef = null;
    let processamentoAnoRef = null;
    let processarBtnEl = null;
    let processarBtnOriginalHtml = null;
    // Progresso fake até termos dados reais
    let fakeProgressInterval = null;
    let fakeProgressPct = 0;
    let hasRealProgress = false;
    // Inline alert ao lado do botão
    function showInlineLoadingAlert(text = 'Status de Processamento') {
      const box = document.getElementById('processarInlineAlert');
      const span = document.getElementById('processarInlineAlertText');
      if (!box || !span) return;
      span.textContent = text;
      box.className = 'alert alert-info';
      box.style.display = 'inline-flex';
    }
    function updateInlineLoadingAlert(text) {
      const span = document.getElementById('processarInlineAlertText');
      const box = document.getElementById('processarInlineAlert');
      if (!span || !box || box.style.display === 'none') return;
      span.textContent = text;
    }
    function hideInlineLoadingAlert() {
      const box = document.getElementById('processarInlineAlert');
      if (box) box.style.display = 'none';
    }
    function startFakeProgress(maxCap = 85) {
      stopFakeProgress();
      fakeProgressPct = 0;
      fakeProgressInterval = setInterval(() => {
        if (hasRealProgress) { stopFakeProgress(); return; }
        fakeProgressPct = Math.min(maxCap, fakeProgressPct + 1.5); // ~1.5% por tick
        const progressBar = document.getElementById('processamentoProgressBar');
        const progressText = document.getElementById('processamentoProgressText');
        const progressBadge = document.getElementById('processamentoProgressBadge');
        if (progressBar) progressBar.style.width = fakeProgressPct + '%';
        if (progressBadge) progressBadge.textContent = `${Math.floor(fakeProgressPct)}%`;
        if (progressText) progressText.textContent = `${Math.floor(fakeProgressPct)}% • Processando…`;
        updateInlineLoadingAlert(`Status de Processamento • ${Math.floor(fakeProgressPct)}%`);
      }, 200);
    }
    function stopFakeProgress() {
      if (fakeProgressInterval) { clearInterval(fakeProgressInterval); fakeProgressInterval = null; }
    }
    function mostrarStatusCard(show) {
      const card = document.getElementById('processamentoStatusCard');
      card.style.display = show ? 'block' : 'none';
    }
    function atualizarStatusUI(data) {
      const statusText = document.getElementById('processamentoStatusText');
      const statusInfo = document.getElementById('processamentoStatusInfo');
      const abrirBtn = document.getElementById('abrirFolhaBtn');
      const alertBox = document.getElementById('processamentoAlert');
      const alertIcon = document.getElementById('processamentoAlertIcon');
      const progressBar = document.getElementById('processamentoProgressBar');
      const progressText = document.getElementById('processamentoProgressText');
      const progressBadge = document.getElementById('processamentoProgressBadge');
      const tempoInfo = document.getElementById('processamentoTempoInfo');
      const logsBox = document.getElementById('processamentoLogsBox');
      const status = (data && data.status) ? data.status : 'DESCONHECIDO';
      statusText.textContent = status;
      statusInfo.textContent = (data && data.message) ? data.message : '';
      let cls = 'alert alert-info';
      let icon = 'fas fa-sync-alt';
      if (status === 'CONCLUIDO') { cls = 'alert alert-success'; icon = 'fas fa-check-circle'; }
      else if (status === 'ERRO') { cls = 'alert alert-danger'; icon = 'fas fa-exclamation-triangle'; }
      alertBox.className = cls;
      alertIcon.className = icon;
      if (data && data.folhaId) {
        abrirBtn.href = '/rh/folha-pagamento/visualizar/' + data.folhaId;
        abrirBtn.style.display = status === 'CONCLUIDO' ? 'inline-block' : 'none';
      } else {
        abrirBtn.style.display = 'none';
      }

      // Progresso e tempo
      const total = (data && typeof data.total === 'number') ? data.total : null;
      const processed = (data && typeof data.processed === 'number') ? data.processed : null;
      const pct = (data && typeof data.progressPct === 'number') ? data.progressPct : null;
      const lastFlushMs = (data && typeof data.lastFlushMs === 'number') ? data.lastFlushMs : null;
      const elapsedMs = (data && typeof data.elapsedMs === 'number') ? data.elapsedMs : null;
      const etaMs = (data && typeof data.etaMs === 'number') ? data.etaMs : null;
      // Determina pct a exibir: real se existir, senão fake
      let displayPct = pct;
      if (typeof pct === 'number') {
        hasRealProgress = true;
      } else if (!hasRealProgress) {
        displayPct = Math.floor(fakeProgressPct);
      }
      if (status === 'CONCLUIDO') {
        displayPct = 100;
      }
      if (progressBar && displayPct != null) {
        const p = Math.max(0, Math.min(100, displayPct));
        progressBar.style.width = p + '%';
      }
      if (progressBadge && displayPct != null) {
        progressBadge.textContent = `${Math.floor(displayPct)}%`;
      }
      if (progressText) {
        if (processed != null && total != null && typeof pct === 'number') {
          progressText.textContent = `${Math.floor(displayPct)}% • ${processed}/${total} processados`;
          updateInlineLoadingAlert(`Status de Processamento • ${Math.floor(displayPct)}% (${processed}/${total})`);
        } else {
          progressText.textContent = `${Math.floor(displayPct || 0)}% • Processando…`;
          updateInlineLoadingAlert(`Status de Processamento • ${Math.floor(displayPct || 0)}%`);
        }
      }
      if (tempoInfo) {
        let texto = '';
        if (elapsedMs != null) {
          texto += `Tempo decorrido: ${(elapsedMs/1000).toFixed(1)}s`;
        }
        // taxa média de processamento
        if (processed != null && elapsedMs != null && elapsedMs > 0) {
          const rate = processed / (elapsedMs/1000);
          texto += texto ? ' • ' : '';
          texto += `Itens/s: ${rate.toFixed(1)}`;
        }
        if (etaMs != null && etaMs >= 0) {
          texto += texto ? ' • ' : '';
          texto += `Estimado restante: ${(etaMs/1000).toFixed(1)}s`;
        }
        if (lastFlushMs != null) {
          texto += texto ? ' • ' : '';
          texto += `Último flush: ${lastFlushMs} ms`;
        }
        tempoInfo.textContent = texto;
      }

      // Renderizar logs em tempo real
      if (logsBox && data && Array.isArray(data.logs)) {
        const html = data.logs.map(l => `<div>${escapeHtml(l)}</div>`).join('');
        logsBox.innerHTML = html;
        // Auto-scroll para o final
        logsBox.scrollTop = logsBox.scrollHeight;
      }
    }
    function toggleProcessamentoLogs() {
      const cont = document.getElementById('processamentoLogsContainer');
      const btn = document.getElementById('toggleLogsBtn');
      if (!cont || !btn) return;
      const show = cont.style.display === 'none';
      cont.style.display = show ? 'block' : 'none';
      btn.innerHTML = show ? '<i class="fas fa-list"></i> Ocultar detalhes' : '<i class="fas fa-list"></i> Ver detalhes';
    }
    function escapeHtml(str) {
      if (typeof str !== 'string') return '';
      return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
    }
    async function pollStatus() {
      if (!processamentoJobId) return;
      try {
        const r = await fetch('/rh/folha-pagamento/status-processamento?jobId=' + encodeURIComponent(processamentoJobId));
        const data = await r.json();
        atualizarStatusUI(data);
        if (data.paused === true) {
          mostrarAlerta('warning', 'Processamento pausado.');
          window.globalToast && window.globalToast('Folha pausada', 'fas fa-pause');
        }
        if (data.canceled === true || data.status === 'CANCELADO') {
          __stopPolling = true;
          mostrarAlerta('danger', 'Processamento cancelado.');
          window.globalToast && window.globalToast('Folha cancelada', 'fas fa-stop');
          stopFakeProgress();
          hideInlineLoadingAlert();
          if (processarBtnEl) processarBtnEl.disabled = false;
          clearTimeout(processamentoInterval);
          processamentoInterval = null;
          return;
        }
        if (data.status === 'CONCLUIDO') {
          __stopPolling = true;
          // Garante que o card de status permaneça visível no sucesso
          mostrarStatusCard(true);
          // Abre automaticamente o container de logs e ajusta o texto do botão
          const cont = document.getElementById('processamentoLogsContainer');
          const btn = document.getElementById('toggleLogsBtn');
          if (cont) cont.style.display = 'block';
          if (btn) btn.innerHTML = '<i class="fas fa-list"></i> Ocultar detalhes';
          if (!__statusNotified || __lastStatus !== 'CONCLUIDO') {
            mostrarAlerta('success', 'Folha processada com sucesso.');
            __statusNotified = true;
          }
          processamentoEndAt = performance.now();
          const durationMs = processamentoStartAt ? (processamentoEndAt - processamentoStartAt) : null;
          try {
            const metrics = {
              jobId: processamentoJobId,
              folhaId: data.folhaId || null,
              status: data.status,
              mes: processamentoMesRef,
              ano: processamentoAnoRef,
              durationMs: durationMs != null ? Math.round(durationMs) : null,
              startedAt: window.processamentoStartIso || null,
              endedAt: new Date().toISOString(),
              userAgent: navigator.userAgent
            };
            console.log(`[Métricas Folha] Tempo total ${(durationMs/1000).toFixed(2)}s | mes=${processamentoMesRef}/${processamentoAnoRef} | jobId=${processamentoJobId} | folhaId=${data.folhaId ?? '-'}`);
            fetch('/rh/folha-pagamento/metrics/processamento', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(metrics)
            }).catch(() => {});
          } catch (_) {}
          clearTimeout(processamentoInterval);
          processamentoInterval = null;
          // Finaliza progresso fake e restaura botão
          stopFakeProgress();
          hideInlineLoadingAlert();
          if (processarBtnEl) {
            processarBtnEl.disabled = false;
            if (processarBtnOriginalHtml) processarBtnEl.innerHTML = processarBtnOriginalHtml;
          }
          // Redireciona para visualizar a folha após 5s, se disponível; senão recarrega a página
          setTimeout(() => {
            if (data.folhaId) {
              window.location.href = '/rh/folha-pagamento/visualizar/' + data.folhaId;
            } else {
              window.location.reload();
            }
          }, 5000);
        } else if (data.status === 'ERRO') {
          __stopPolling = true;
          if (!__statusNotified || __lastStatus !== 'ERRO') {
            mostrarAlerta('danger', 'Erro no processamento: ' + (data.message || ''));
            __statusNotified = true;
          }
          processamentoEndAt = performance.now();
          const durationMs = processamentoStartAt ? (processamentoEndAt - processamentoStartAt) : null;
          try {
            const metrics = {
              jobId: processamentoJobId,
              folhaId: data.folhaId || null,
              status: data.status,
              mes: processamentoMesRef,
              ano: processamentoAnoRef,
              durationMs: durationMs != null ? Math.round(durationMs) : null,
              startedAt: window.processamentoStartIso || null,
              endedAt: new Date().toISOString(),
              userAgent: navigator.userAgent,
              errorMessage: data.message || null
            };
            console.log(`[Métricas Folha] ERRO após ${(durationMs/1000).toFixed(2)}s | mes=${processamentoMesRef}/${processamentoAnoRef} | jobId=${processamentoJobId}`);
            fetch('/rh/folha-pagamento/metrics/processamento', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(metrics)
            }).catch(() => {});
          } catch (_) {}
          clearTimeout(processamentoInterval);
          processamentoInterval = null;
          // Finaliza progresso fake e mantém botão desativado conforme fluxo solicitado
          stopFakeProgress();
          hideInlineLoadingAlert();
          if (processarBtnEl) {
            processarBtnEl.disabled = true;
            if (processarBtnOriginalHtml) processarBtnEl.innerHTML = processarBtnOriginalHtml;
          }
          // Recarrega a página após 5s para limpar estado
          setTimeout(() => { window.location.reload(); }, 5000);
        }
        __lastStatus = data.status;
        if (data && typeof data.processed === 'number') {
          if (window.__lastProcessedCount == null) {
            window.__lastProcessedCount = data.processed;
            window.__noChangeTicks = 0;
            window.__pollMs = 2500;
          } else if (data.processed === window.__lastProcessedCount) {
            window.__noChangeTicks = (window.__noChangeTicks || 0) + 1;
            if (window.__noChangeTicks >= 5) {
              window.__pollMs = Math.min(5000, (window.__pollMs || 2500) * 1.5);
            }
          } else {
            window.__lastProcessedCount = data.processed;
            window.__noChangeTicks = 0;
            window.__pollMs = 2500;
          }
        }
      } catch (e) {
        clearInterval(processamentoInterval);
        processamentoInterval = null;
      }
    }
    function scheduleNextPoll() {
      if (__stopPolling) return;
      if (processamentoInterval) { clearTimeout(processamentoInterval); processamentoInterval = null; }
      const delay = window.__pollMs || 2500;
      processamentoInterval = setTimeout(() => {
        if (__stopPolling) { clearTimeout(processamentoInterval); processamentoInterval = null; return; }
        pollStatus().then(scheduleNextPoll);
      }, delay);
    }
    async function processarFolhaAsync(e) {
      e.preventDefault();
      const form = document.getElementById('processarFolhaForm');
      const mes = document.getElementById('mesReferencia').value;
      const ano = document.getElementById('anoReferencia').value;
      const departamento = document.getElementById('departamento').value;
      const tipoFolha = document.getElementById('tipoFolha').value;
      const btn = form.querySelector('button[type="submit"]');
      const original = btn.innerHTML;
      processarBtnEl = btn;
      processarBtnOriginalHtml = original;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
      showInlineLoadingAlert('Status de Processamento • 0%');
      try {
        processamentoStartAt = performance.now();
        processamentoMesRef = mes;
        processamentoAnoRef = ano;
        window.processamentoStartIso = new Date().toISOString();
        const res = await fetch('/rh/folha-pagamento/processar-async', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: (() => {
            let params = `mes=${encodeURIComponent(mes)}&ano=${encodeURIComponent(ano)}&tipoFolha=${encodeURIComponent(tipoFolha)}`;
            if (departamento && departamento.trim() !== '') {
              params += `&departamento=${encodeURIComponent(departamento)}`;
            }
            return params;
          })()
        });
        const data = await res.json();
        if (res.status === 202 && data.accepted && data.jobId) {
          processamentoJobId = data.jobId;
          mostrarStatusCard(true);
          atualizarStatusUI({ status: 'AGENDADO', message: 'Processamento agendado' });
          // Inicia progresso fake até termos dados reais do backend
          hasRealProgress = false;
          startFakeProgress(85);
          window.__pollMs = 2500;
          window.__lastProcessedCount = null;
          window.__noChangeTicks = 0;
          __stopPolling = false;
          __statusNotified = false;
          __lastStatus = null;
          scheduleNextPoll();
          // habilita controles
          document.getElementById('btnFolhaPause').disabled = false;
          document.getElementById('btnFolhaResume').disabled = false;
          document.getElementById('btnFolhaCancel').disabled = false;
          window.globalToast && window.globalToast('Processamento de folha iniciado', 'fas fa-play');
          // Mantém o botão desativado até concluir ou erro
        } else {
          mostrarAlerta('danger', 'Não foi possível iniciar o processamento.');
          btn.disabled = false;
          btn.innerHTML = original;
          hideInlineLoadingAlert();
        }
      } catch {
        mostrarAlerta('danger', 'Erro ao iniciar processamento.');
        btn.disabled = false;
        btn.innerHTML = original;
        hideInlineLoadingAlert();
      }
      return false;
    }
    async function pauseJob(){
      if (!processamentoJobId) return;
      try {
        await fetch('/rh/folha-pagamento/processar/pause?jobId=' + encodeURIComponent(processamentoJobId), { method: 'POST' });
        mostrarAlerta('warning', 'Pausado');
        window.globalToast && window.globalToast('Folha pausada', 'fas fa-pause');
      } catch {}
    }
    async function resumeJob(){
      if (!processamentoJobId) return;
      try {
        await fetch('/rh/folha-pagamento/processar/resume?jobId=' + encodeURIComponent(processamentoJobId), { method: 'POST' });
        mostrarAlerta('success', 'Retomado');
        window.globalToast && window.globalToast('Folha retomada', 'fas fa-play');
      } catch {}
    }
    async function cancelJob(){
      if (!processamentoJobId) return;
      try {
        await fetch('/rh/folha-pagamento/processar/cancel?jobId=' + encodeURIComponent(processamentoJobId), { method: 'POST' });
        mostrarAlerta('danger', 'Cancelado');
        window.globalToast && window.globalToast('Folha cancelada', 'fas fa-stop');
      } catch {}
    }
    document.getElementById('btnFolhaPause').addEventListener('click', pauseJob);
    document.getElementById('btnFolhaResume').addEventListener('click', resumeJob);
    document.getElementById('btnFolhaCancel').addEventListener('click', cancelJob);
  </script>
