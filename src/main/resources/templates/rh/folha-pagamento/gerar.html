<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gerar Folha de Pagamento - ERP Corporativo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <div th:if="${mensagem}" class="alert alert-success" role="alert">
          <i class="fas fa-check-circle"></i>
          <span th:text="${mensagem}"></span>
        </div>
        <div th:if="${erro}" class="alert alert-danger" role="alert">
          <i class="fas fa-exclamation-triangle"></i>
          <span th:text="${erro}"></span>
        </div>

        <div class="alert-container-right">
          <div th:if="${mensagem}" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i>
            <span th:text="${mensagem}"></span>
          </div>
          <div th:if="${erro}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${erro}"></span>
          </div>
        </div>
        <h1>Gerar Folha de Pagamento</h1>

        <!-- Configurações da Folha -->
        <article class="card">
          <h3><i class="fas fa-cog"></i> Configurações da Folha</h3>
          <div th:if="${existeFolhaAtual}" class="alert alert-warning" role="alert">
            Já existe folha para <span th:text="${mesAtual}"></span>/<span th:text="${anoAtual}"></span>.
          </div>
          <form id="processarFolhaForm" class="form-container" th:action="@{/rh/folha-pagamento/processar}" method="post" onsubmit="return processarFolhaAsync(event)">
            <div class="form-row">
              <div class="form-group">
                <label for="mesReferencia">Mês de Referência *</label>
                <select id="mesReferencia" name="mes" required class="form-control">
                  <option th:each="m : ${#numbers.sequence(1,12)}" th:value="${m}" th:text="${m}"></option>
                </select>
              </div>
              <div class="form-group">
                <label for="anoReferencia">Ano de Referência *</label>
                <select id="anoReferencia" name="ano" required class="form-control">
                  <option th:each="a : ${#numbers.sequence(anoAtual-2,anoAtual+1)}" th:value="${a}" th:text="${a}"
                    th:selected="${a == anoAtual}"></option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="departamento">Departamento</label>
                <select id="departamento" name="departamento" class="form-control">
                  <option value="">Todos os departamentos</option>
                  <option th:each="d : ${departamentos}" th:value="${d.id}" th:text="${d.nome}"></option>
                </select>
              </div>
              <div class="form-group">
                <label for="tipoFolha">Tipo de Folha</label>
                <select id="tipoFolha" name="tipoFolha" class="form-control">
                  <option value="normal" selected>Folha Normal</option>
                  <option value="complementar">Folha Complementar</option>
                  <option value="decimo_terceiro">13º Salário</option>
                  <option value="ferias">Férias</option>
                </select>
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary" th:disabled="${existeFolhaAtual}">
                <i class="fas fa-cogs"></i> Processar Folha
              </button>
            </div>
          </form>
        </article>

        <!-- Resumo dos Colaboradores -->
        <article class="card">
          <h3><i class="fas fa-users"></i> Colaboradores Incluídos</h3>
          

          <table class="table-list">
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>Cargo</th>
                <th>Departamento</th>
                <th>Salário Base</th>
                <th>Dias Trabalhados</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="colaboradoresResumoBody"></tbody>



          </table>

          <div id="paginationResumo" class="pagination"></div>
        </article>


      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script th:src="@{/js/script.js}"></script>
  <div id="desligamentoModal" class="modal-overlay" style="display: none;">
    <div class="modal-content-desligamento">
      <div class="modal-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Desligamento</h3>
        <button type="button" class="modal-close" onclick="closeDesligamentoModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="warning-message">
          <i class="fas fa-user-times warning-icon"></i>
          <div class="warning-text">
            <h4>Tem certeza que deseja desligar este colaborador?</h4>
            <p>Colaborador: <strong id="colaboradorNome"></strong></p>
            <div class="confirm-section">
              <label class="confirm-label">
                <input type="checkbox" name="confirmarDesligamento" required form="desligamentoForm">
                Confirmo que revisei o caso e autorizo o desligamento definitivo.
              </label>
              <div class="confirm-input">
                <label for="confirmarTexto">Digite <strong>DESLIGAR</strong> para confirmar</label>
                <input id="confirmarTexto" name="confirmarTexto" type="text" placeholder="DESLIGAR" required form="desligamentoForm">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDesligamentoModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <form id="desligamentoForm" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-user-times"></i> Confirmar Desligamento
          </button>
        </form>
      </div>
    </div>
  </div>
  <script>
    let etapaAtual = 0;

    function calcularFolha() {
      // Simular processamento
      const btn = event.target;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
      btn.disabled = true;

      setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check"></i> Calculado';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');

        // Habilitar próxima etapa
        document.querySelector('button[onclick="revisarCalculos()"]').disabled = false;
        etapaAtual = 1;

        alert('Folha calculada com sucesso!');
      }, 3000);
    }

    function revisarCalculos() {
      if (etapaAtual >= 1) {
        alert('Cálculos revisados e aprovados!');
        document.querySelector('button[onclick="gerarHolerites()"]').disabled = false;
        etapaAtual = 2;
      }
    }

    function gerarHolerites() {
      if (etapaAtual >= 2) {
        alert('Holerites gerados com sucesso!');
        document.querySelector('button[onclick="aprovarFolha()"]').disabled = false;
        etapaAtual = 3;
      }
    }

    function aprovarFolha() {
      if (etapaAtual >= 3) {
        if (confirm('Tem certeza que deseja aprovar a folha de pagamento? Esta ação não pode ser desfeita.')) {
          alert('Folha de pagamento aprovada e processada!');
        }
      }
    }
  </script>
  <script>
    let currentResumoPage = 0;
    function showResumoLoading(show) {
      const tbody = document.getElementById('colaboradoresResumoBody');
      if (show) tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</td></tr>';
    }
    function renderResumoRows(items) {
      const tbody = document.getElementById('colaboradoresResumoBody');
      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum colaborador encontrado</td></tr>';
        return;
      }
      const rows = items.map(c => {
        const salario = c.salario != null ? new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(c.salario) : 'R$ 0,00';
        const dias = `${(c.diasTrabalhados ?? 0)}/${(c.diasUteisMes ?? 0)}`;
        const statusClass = c.status === 'ATIVO' ? 'status-ativo' : (c.status === 'SUSPENSO' ? 'status-afastado' : 'status-ferias');
        const desligarBtn = window.podeAcessarRH ? `<button type="button" class="btn btn-sm btn-danger" title="Desligar Colaborador" data-id="${c.id}" data-nome="${c.nome}" onclick="openDesligamentoFromDataset(this)"><i class="fas fa-user-times"></i></button>` : '';
        return `<tr>
          <td>${c.nome ?? '-'}</td>
          <td>${c.cargoNome ?? '-'}</td>
          <td>${c.departamentoNome ?? '-'}</td>
          <td>${salario}</td>
          <td>${dias}</td>
          <td><span class="status-badge ${statusClass}"><span>${c.status ?? '-'}</span></span></td>
          <td class="actions">
            <a href="/rh/colaboradores/ficha/${c.id}" class="btn btn-sm btn-info" title="Ver Ficha"><i class="fas fa-eye"></i></a>
            <a href="/rh/colaboradores/editar/${c.id}" class="btn btn-sm btn-warning" title="Editar"><i class="fas fa-edit"></i></a>
            ${desligarBtn}
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    }
    function renderResumoPagination(data) {
      const el = document.getElementById('paginationResumo');
      const totalPages = data.totalPages || 0;
      const totalElements = data.totalElements || 0;
      const page = data.currentPage || 0;
      const hasPrev = data.hasPrevious;
      const hasNext = data.hasNext;
      let html = '';
      html += `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} colaboradores)</span>`;
      html += hasPrev ? `<a class="btn btn-secondary" href="#" onclick="loadResumo(${page - 1});return false;"><i class="fas fa-chevron-left"></i> Anterior</a>` : `<span class="btn btn-secondary disabled"><i class="fas fa-chevron-left"></i> Anterior</span>`;
      html += hasNext ? `<a class="btn btn-secondary" href="#" onclick="loadResumo(${page + 1});return false;">Próxima <i class="fas fa-chevron-right"></i></a>` : `<span class="btn btn-secondary disabled">Próxima <i class="fas fa-chevron-right"></i></span>`;
      el.innerHTML = html;
    }
    function loadResumo(page = 0) {
      currentResumoPage = page;
      showResumoLoading(true);
      fetch(`/rh/folha-pagamento/api/colaboradores-resumo?page=${page}&size=10`)
        .then(r => r.json())
        .then(data => { renderResumoRows(data.content); renderResumoPagination(data); })
        .catch(() => { renderResumoRows([]); renderResumoPagination({ currentPage: 0, totalPages: 1, totalElements: 0, hasPrevious: false, hasNext: false }); });
    }
    document.addEventListener('DOMContentLoaded', function() { loadResumo(0); });
  </script>
  <script>
    function openDesligamentoFromDataset(el) {
      const id = el.dataset.id;
      const nome = el.dataset.nome;
      document.getElementById('colaboradorNome').textContent = nome;
      document.getElementById('desligamentoForm').action = '/rh/colaboradores/desativar/' + id;
      document.getElementById('desligamentoModal').style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function closeDesligamentoModal() {
      document.getElementById('desligamentoModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    document.getElementById('desligamentoModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDesligamentoModal();
      }
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeDesligamentoModal();
      }
    });
  </script>
  <!-- jQuery e notificações (deduplicados) -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script th:src="@{/js/sidebar.js}"></script>

</body>

</html>
  <script th:inline="javascript">
    window.podeAcessarRH = [[${podeAcessarRH}?:false]];
  </script>
  <script>
    function mostrarAlerta(tipo, texto) {
      const container = document.querySelector('.alert-container-right');
      if (!container) return;
      const el = document.createElement('div');
      el.className = `alert alert-${tipo}`;
      el.setAttribute('role', 'alert');
      el.innerHTML = `<i class="fas ${tipo === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i> <span>${texto}</span>`;
      container.prepend(el);
      setTimeout(() => { el.remove(); }, 8000);
    }
    async function processarFolhaAsync(e) {
      e.preventDefault();
      const form = document.getElementById('processarFolhaForm');
      const mes = document.getElementById('mesReferencia').value;
      const ano = document.getElementById('anoReferencia').value;
      const btn = form.querySelector('button[type="submit"]');
      const original = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
      try {
        const res = await fetch('/rh/folha-pagamento/processar-async', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `mes=${encodeURIComponent(mes)}&ano=${encodeURIComponent(ano)}`
        });
        const data = await res.json();
        if (res.status === 202 && data.accepted) {
          mostrarAlerta('success', 'Processamento da folha iniciado. Você será notificado.');
        } else {
          mostrarAlerta('danger', 'Não foi possível iniciar o processamento.');
        }
      } catch {
        mostrarAlerta('danger', 'Erro ao iniciar processamento.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = original;
      }
      return false;
    }
  </script>