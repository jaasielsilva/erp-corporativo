<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Holerites - ERP Corporativo</title>
  <meta th:if="${periodoReferencia != null}" th:attr="content=${'Holerite - ' + periodoReferencia}" name="title" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" th:if="${pdf == null}" />
  <link rel="stylesheet" th:href="@{/css/style.css}" th:if="${pdf == null}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" th:if="${pdf == null}" />
  <style>
    .holerite-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .holerite-header {
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 2px solid #007bff;
    }
    
    .empresa-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .empresa-logo {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }
    
    .periodo-info {
      text-align: right;
      font-size: 14px;
      color: #666;
    }
    
    .funcionario-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }
    
    .holerite-body {
      padding: 20px;
    }
    
    .valores-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 20px;
    }
    
    .valores-section {
      border: 1px solid #e9ecef;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .valores-header {
      background: #f8f9fa;
      padding: 10px 15px;
      font-weight: bold;
      border-bottom: 1px solid #e9ecef;
    }
    
    .valores-header.proventos {
      background: #d4edda;
      color: #155724;
    }
    
    .valores-header.descontos {
      background: #f8d7da;
      color: #721c24;
    }
    
    .valor-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 15px;
      border-bottom: 1px solid #f8f9fa;
    }
    
    .valor-item:last-child {
      border-bottom: none;
    }
    
    .valor-item.total {
      background: #f8f9fa;
      font-weight: bold;
      border-top: 2px solid #dee2e6;
    }
    
    .resumo-final {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .resumo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      text-align: center;
    }
    
    .resumo-item {
      padding: 15px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .resumo-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
    }
    
    .resumo-valor {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .resumo-valor.liquido {
      color: #2196f3;
      font-size: 24px;
    }
    
    .holerite-footer {
      background: #f8f9fa;
      padding: 15px 20px;
      border-top: 1px solid #dee2e6;
      font-size: 12px;
      color: #666;
      text-align: center;
    }
    
    .print-actions {
      margin-bottom: 20px;
      text-align: center;
    }
    
    @media print {
      .print-actions, .sidebar, .topbar, .action-buttons {
        display: none !important;
      }
      
      .main-content {
        margin-left: 0 !important;
      }
      
      .content-area {
        padding: 0 !important;
      }
      
      .holerite-container {
        box-shadow: none;
        border: 1px solid #000;
        max-width: 100%;
        margin: 0;
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}" th:if="${pdf == null}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}" th:if="${pdf == null}"></header>

      <section class="content-area">
        <h1>Holerite</h1>
        <h2 th:text="${periodoReferencia}"></h2>

        <div class="action-buttons" th:if="${pdf == null}">
          <a th:href="@{/rh/folha-pagamento}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
          </a>
          <a th:href="@{/rh/folha-pagamento/relatorios}" class="btn btn-info">
            <i class="fas fa-chart-bar"></i> Relatórios
          </a>
        </div>

        <!-- Filtros -->
        <article class="card">
          <h3><i class="fas fa-filter"></i> Filtros</h3>
          <form class="form-container">
            <div class="form-row">
              <div class="form-group">
                <label for="colaboradorSelect">Colaborador</label>
                <select id="colaboradorSelect" name="colaborador" class="form-control" onchange="carregarHolerite()">
                  <option value="">Selecione um colaborador...</option>
                  <option value="1" selected>João Silva - Desenvolvedor Senior</option>
                  <option value="2">Maria Santos - Analista de Vendas</option>
                  <option value="3">Carlos Oliveira - Gerente Financeiro</option>
                  <option value="4">Ana Costa - Designer</option>
                  <option value="5">Pedro Lima - Analista de Marketing</option>
                </select>
              </div>
              <div class="form-group">
                <label for="mesAno">Mês/Ano</label>
                <select id="mesAno" name="mesAno" class="form-control" onchange="carregarHolerite()">
                  <option value="11/2023" selected>Novembro/2023</option>
                  <option value="10/2023">Outubro/2023</option>
                  <option value="09/2023">Setembro/2023</option>
                  <option value="08/2023">Agosto/2023</option>
                </select>
              </div>
            </div>
          </form>
        </article>

        <!-- Ações de Impressão -->
        <div class="print-actions">
          <button id="btn-print" onclick="window.print()" class="btn btn-primary">
            <i class="fas fa-print"></i> Imprimir Holerite
          </button>
          <a id="btn-pdf" th:href="@{/rh/folha-pagamento/holerite/{id}/pdf(id=${holerite.id})}" class="btn btn-success" onclick="baixarPDF()">
            <i class="fas fa-file-pdf"></i> Baixar PDF
          </a>
          <button id="btn-email" onclick="enviarEmail()" class="btn btn-info">
            <i class="fas fa-envelope"></i> Enviar por Email
          </button>
        </div>

        <!-- Holerite -->
        <div class="holerite-container" th:attr="data-holerite-id=${holerite.id}">
          <!-- Cabeçalho -->
          <div class="holerite-header">
            <div class="empresa-info">
              <div class="empresa-logo">
                <i class="fas fa-building"></i> ERP CORPORATIVO LTDA
              </div>
              <div class="periodo-info">
                <strong>HOLERITE</strong><br>
                Competência: <span th:text="${periodoReferencia}"></span><br>
                Emitido em: <span th:text="${dataReferencia}"></span>
              </div>
            </div>
            
            <div class="funcionario-info">
              <div>
                <strong>Funcionário:</strong> <span th:text="${holerite.colaborador.nome}"></span><br>
                <strong>Cargo:</strong> <span th:text="${holerite.colaborador.cargo != null ? holerite.colaborador.cargo.nome : '-'}"></span><br>
                <strong>Departamento:</strong> <span th:text="${holerite.colaborador.departamento != null ? holerite.colaborador.departamento.nome : '-'}"></span><br>
                <strong>Admissão:</strong> <span th:text="${#temporals.format(holerite.colaborador.dataAdmissao, 'dd/MM/yyyy')}"></span>
              </div>
              <div>
                <strong>E-mail:</strong> <span th:text="${holerite.colaborador.email != null ? holerite.colaborador.email : '-'}"></span><br>
                <strong>CPF:</strong> <span th:text="${holerite.colaborador.cpf}"></span><br>
                <strong>Salário Base:</strong> <span th:text="${#numbers.formatCurrency(holerite.salarioBase)}"></span><br>
                <strong>Dias Trabalhados:</strong> <span th:text="${holerite.diasTrabalhados}"></span>
              </div>
            </div>
          </div>

          <!-- Corpo do Holerite -->
          <div class="holerite-body">
            <div class="valores-grid">
              <!-- Proventos -->
              <div class="valores-section">
                <div class="valores-header proventos">
                  <i class="fas fa-plus-circle"></i> PROVENTOS
                </div>
                <div class="valor-item">
                  <span>Salário Base</span>
                  <span th:text="${#numbers.formatCurrency(holerite.salarioBase)}"></span>
                </div>
                <div class="valor-item">
                  <span>Horas Extras</span>
                  <span th:text="${#numbers.formatCurrency(holerite.horasExtras)}"></span>
                </div>
                <div class="valor-item">
                  <span>Adicional Noturno</span>
                  <span>R$ 0,00</span>
                </div>
                <div class="valor-item">
                  <span>Comissões</span>
                  <span>R$ 0,00</span>
                </div>
                <div class="valor-item">
                  <span>Vale Refeição</span>
                  <span th:text="${#numbers.formatCurrency(holerite.valeRefeicao)}"></span>
                </div>
                <div class="valor-item">
                  <span>Vale Transporte</span>
                  <span th:text="${#numbers.formatCurrency(holerite.valeTransporte)}"></span>
                </div>
                <div class="valor-item total">
                  <span>TOTAL PROVENTOS</span>
                  <span th:text="${#numbers.formatCurrency(holerite.totalProventos)}"></span>
                </div>
              </div>

              <!-- Descontos -->
              <div class="valores-section">
                <div class="valores-header descontos">
                  <i class="fas fa-minus-circle"></i> DESCONTOS
                </div>
                <div class="valor-item">
                  <span>INSS</span>
                  <span th:text="${#numbers.formatCurrency(holerite.descontoInss)}"></span>
                </div>
                <div class="valor-item">
                  <span>IRRF</span>
                  <span th:text="${#numbers.formatCurrency(holerite.descontoIrrf)}"></span>
                </div>
                <div class="valor-item">
                  <span>Plano de Saúde</span>
                  <span th:text="${#numbers.formatCurrency(holerite.descontoPlanoSaude)}"></span>
                </div>
                <div class="valor-item">
                  <span>Desconto VR</span>
                  <span th:text="${#numbers.formatCurrency(holerite.descontoValeRefeicao)}"></span>
                </div>
                <div class="valor-item">
                  <span>Desconto VT</span>
                  <span th:text="${#numbers.formatCurrency(holerite.descontoValeTransporte)}"></span>
                </div>
                <div class="valor-item total">
                  <span>TOTAL DESCONTOS</span>
                  <span th:text="${#numbers.formatCurrency(holerite.totalDescontos)}"></span>
                </div>
              </div>
            </div>

            <!-- Resumo Final -->
            <div class="resumo-final">
              <div class="resumo-grid">
                <div class="resumo-item">
                  <div class="resumo-label">Total Proventos</div>
                  <div class="resumo-valor" th:text="${#numbers.formatCurrency(holerite.totalProventos)}"></div>
                </div>
                <div class="resumo-item">
                  <div class="resumo-label">Total Descontos</div>
                  <div class="resumo-valor" th:text="${#numbers.formatCurrency(holerite.totalDescontos)}"></div>
                </div>
                <div class="resumo-item">
                  <div class="resumo-label">Salário Líquido</div>
                  <div class="resumo-valor liquido" th:text="${#numbers.formatCurrency(holerite.salarioLiquido)}"></div>
                </div>
              </div>
            </div>

            <!-- Informações Adicionais -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
              <h4 style="margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Informações Adicionais</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                <div>
                  <strong>Base INSS:</strong> <span th:text="${#numbers.formatCurrency(holerite.salarioBase.add(holerite.horasExtras))}"></span><br>
                  <strong>Base IRRF:</strong> <span th:text="${#numbers.formatCurrency(holerite.salarioBase.add(holerite.horasExtras).subtract(holerite.descontoInss))}"></span><br>
                  <strong>Depósito FGTS (8%):</strong> <span th:text="${#numbers.formatCurrency(holerite.salarioBase.add(holerite.horasExtras).multiply(0.08))}"></span>
                </div>
                <div>
                  <strong>Dependentes IR:</strong> 0<br>
                  <strong>Salário Família:</strong> R$ 0,00<br>
                  <strong>13º Proporcional:</strong> R$ 708,33
                </div>
              </div>
            </div>
          </div>

          <!-- Rodapé -->
          <div class="holerite-footer">
            <p><strong>ERP Corporativo Ltda</strong></p>
            <p>Rua das Empresas, 123 - Centro - São Paulo/SP - CEP: 01234-567</p>
            <p>Este documento foi gerado eletronicamente e é válido sem assinatura.</p>
          </div>
        </div>

        <!-- Lista de Holerites Disponíveis -->
        <article class="card" style="margin-top: 30px;">
          <h3><i class="fas fa-list"></i> Holerites Disponíveis</h3>
          <table class="table-list">
            <thead>
              <tr>
                <th>Colaborador</th>
                <th>Competência</th>
                <th>Salário Bruto</th>
                <th>Descontos</th>
                <th>Salário Líquido</th>
                <th>Status</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="h : ${holerite.folhaPagamento != null ? holerite.folhaPagamento.holerites : {}}">
                <td th:text="${h.colaborador.nome}"></td>
                <td th:text="${h.folhaPagamento.mesReferencia + '/' + h.folhaPagamento.anoReferencia}"></td>
                <td th:text="${#numbers.formatCurrency(h.totalProventos)}"></td>
                <td th:text="${#numbers.formatCurrency(h.totalDescontos)}"></td>
                <td th:text="${#numbers.formatCurrency(h.salarioLiquido)}"></td>
                <td><span class="status-badge status-ativo">Disponível</span></td>
                <td>
                  <a th:href="@{/rh/folha-pagamento/holerite/{id}(id=${h.id})}" class="btn-icon" title="Visualizar">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a th:href="@{/rh/folha-pagamento/holerite/{id}/pdf(id=${h.id})}" class="btn-icon" title="Baixar PDF">
                    <i class="fas fa-download"></i>
                  </a>
                </td>
              </tr>
              <tr>
                <td>Maria Santos</td>
                <td>Nov/2023</td>
                <td>R$ 6.000,00</td>
                <td>R$ 1.580,00</td>
                <td>R$ 4.420,00</td>
                <td><span class="status-badge status-ativo">Disponível</span></td>
                <td>
                  <button onclick="visualizarHolerite(2)" class="btn-icon" title="Visualizar">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button onclick="baixarPDF(2)" class="btn-icon" title="Baixar PDF">
                    <i class="fas fa-download"></i>
                  </button>
                  <button onclick="enviarEmail(2)" class="btn-icon" title="Enviar Email">
                    <i class="fas fa-envelope"></i>
                  </button>
                </td>
              </tr>
              <tr>
                <td>Carlos Oliveira</td>
                <td>Nov/2023</td>
                <td>R$ 12.000,00</td>
                <td>R$ 3.240,00</td>
                <td>R$ 8.760,00</td>
                <td><span class="status-badge status-ativo">Disponível</span></td>
                <td>
                  <button onclick="visualizarHolerite(3)" class="btn-icon" title="Visualizar">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button onclick="baixarPDF(3)" class="btn-icon" title="Baixar PDF">
                    <i class="fas fa-download"></i>
                  </button>
                  <button onclick="enviarEmail(3)" class="btn-icon" title="Enviar Email">
                    <i class="fas fa-envelope"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </article>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script th:if="${pdf == null}" th:src="@{/js/script.js}"></script>
  <script th:if="${pdf == null}">
    function carregarHolerite() {
      const colaborador = document.getElementById('colaboradorSelect').value;
      const mesAno = document.getElementById('mesAno').value;
      
      if (colaborador && mesAno) {
        // Simular carregamento de dados
        console.log(`Carregando holerite para colaborador ${colaborador} - ${mesAno}`);
        // Aqui seria feita a requisição para carregar os dados do holerite
      }
    }
    
    function visualizarHolerite(id) {
      // Carregar dados do holerite específico
      console.log(`Visualizando holerite ${id}`);
      // Atualizar o holerite exibido
    }
    
    function baixarPDF(id) {
      const btn = document.getElementById('btn-pdf');
      const targetId = id || document.querySelector('[data-holerite-id]')?.getAttribute('data-holerite-id');
      if (!targetId) {
        alert('Holerite não identificado.');
        return;
      }
      if (btn) {
        btn.classList.add('disabled');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF...';
      }
      // Navegação padrão para download (Content-Disposition: attachment)
      window.location.href = `/rh/folha-pagamento/holerite/${targetId}/pdf`;
      // Reverter estado depois de pequeno atraso (navegação troca de página normalmente)
      setTimeout(() => {
        if (btn) {
          btn.classList.remove('disabled');
          btn.innerHTML = '<i class="fas fa-file-pdf"></i> Baixar PDF';
        }
      }, 3000);
    }
    
    function enviarEmail(id) {
      const btn = document.getElementById('btn-email');
      const targetId = id || document.querySelector('.holerite-container')?.getAttribute('data-holerite-id');
      if (!targetId) {
        alert('Holerite não identificado.');
        return;
      }
      const email = prompt('Digite o email de destino (deixe vazio para usar o do colaborador):') || '';
      const params = new URLSearchParams();
      if (email) params.set('email', email);
      if (btn) {
        btn.classList.add('disabled');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      }
      fetch(`/rh/folha-pagamento/holerite/${targetId}/email`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString()
      }).then(async (res) => {
        const text = await res.text();
        alert(text || (res.ok ? 'Holerite enviado.' : 'Falha ao enviar holerite por email'));
      }).catch(() => {
        alert('Erro de comunicação ao enviar email');
      }).finally(() => {
        if (btn) {
          btn.classList.remove('disabled');
          btn.innerHTML = '<i class="fas fa-envelope"></i> Enviar por Email';
        }
      });
    }
  </script>
  
  <script th:if="${pdf == null}" th:src="@{/js/sidebar.js}"></script>

</body>

</html>
