<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Holerites do Colaborador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>
<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>
      <section class="content-area">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1><i class="fas fa-user"></i> Holerites de <span th:text="${colaborador.nome}"></span></h1>
          <a th:href="@{/rh/folha-pagamento}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
        </div>

        <div class="card">
          <div class="card-body table-responsive">
            <div id="loading" class="loading" style="display:none"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
            <div class="d-flex justify-content-end mb-2" style="gap:12px;">
              <div style="width:160px;">
                <select id="pageSizeSelect" class="form-select" aria-label="Itens por página">
                  <option value="10">10 por página</option>
                  <option value="20" selected>20 por página</option>
                  <option value="50">50 por página</option>
                  <option value="100">100 por página</option>
                </select>
              </div>
            </div>
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Competência</th>
                  <th>Salário Base</th>
                  <th>Proventos</th>
                  <th>Descontos</th>
                  <th>Líquido</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="holeritesBody"></tbody>
            </table>
          </div>
        </div>
        <div id="pagination" class="pagination"></div>
      </section>
    </main>
  </div>
  <script th:inline="javascript">window.colaboradorId = [[${colaborador.id}]];</script>
  <script>
    let currentPage = 0;
    let pageSize = 20;

    function brl(v) {
      try { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v ?? 0); } catch { return v ?? 0; }
    }

    function showLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }

    function renderRows(items) {
      const tbody = document.getElementById('holeritesBody');
      tbody.innerHTML = '';
      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum registro encontrado</td></tr>';
        return;
      }
      const rows = items.map(it => {
        const comp = `${String(it.mes).padStart(2, '0')}/${it.ano}`;
        const id = it.id;
        return `<tr>
          <td>${comp}</td>
          <td>${brl(it.salarioBase)}</td>
          <td>${brl(it.totalProventos)}</td>
          <td>${brl(it.totalDescontos)}</td>
          <td>${brl(it.salarioLiquido)}</td>
          <td>
            <a href="/rh/folha-pagamento/holerite/${id}" class="btn btn-sm btn-outline-primary" title="Ver Holerite"><i class="fas fa-file-invoice"></i></a>
            <a href="/rh/folha-pagamento/holerite/${id}/pdf" class="btn btn-sm btn-outline-success" title="Baixar PDF"><i class="fas fa-file-pdf"></i></a>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    }

    function renderPagination(data) {
      const el = document.getElementById('pagination');
      const totalPages = data.totalPages || 0;
      const totalElements = data.totalElements || 0;
      const page = data.currentPage || 0;
      const hasPrev = data.hasPrevious;
      const hasNext = data.hasNext;
      let html = '';
      html += `<div class="d-flex justify-content-between align-items-center flex-wrap" style="gap:8px;">`;
      html += `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} registros)</span>`;
      html += `<div class="btn-group" role="group" aria-label="Navegação">`;
      html += hasPrev ? `<a class="btn btn-outline-secondary" href="#" onclick="goToPage(0);return false;" title="Primeira"><i class="fas fa-angles-left"></i></a>` : `<span class="btn btn-outline-secondary disabled"><i class="fas fa-angles-left"></i></span>`;
      html += hasPrev ? `<a class="btn btn-outline-secondary" href="#" onclick="goToPage(${page - 1});return false;" title="Anterior"><i class="fas fa-chevron-left"></i></a>` : `<span class="btn btn-outline-secondary disabled"><i class="fas fa-chevron-left"></i></span>`;
      const start = Math.max(0, page - 2);
      const end = Math.min(totalPages - 1, page + 2);
      for (let i = start; i <= end; i++) {
        if (totalPages <= 0) break;
        html += i === page
          ? `<span class="btn btn-primary">${i + 1}</span>`
          : `<a class="btn btn-outline-secondary" href="#" onclick="goToPage(${i});return false;">${i + 1}</a>`;
      }
      html += hasNext ? `<a class="btn btn-outline-secondary" href="#" onclick="goToPage(${page + 1});return false;" title="Próxima"><i class="fas fa-chevron-right"></i></a>` : `<span class="btn btn-outline-secondary disabled"><i class="fas fa-chevron-right"></i></span>`;
      html += hasNext ? `<a class="btn btn-outline-secondary" href="#" onclick="goToPage(${totalPages - 1});return false;" title="Última"><i class="fas fa-angles-right"></i></a>` : `<span class="btn btn-outline-secondary disabled"><i class="fas fa-angles-right"></i></span>`;
      html += `</div>`;
      html += `</div>`;
      el.innerHTML = html;
    }

    function loadHolerites(page = 0) {
      currentPage = page;
      showLoading(true);
      const url = `/rh/folha-pagamento/api/colaborador/${window.colaboradorId}/holerites?page=${page}&size=${pageSize}`;
      fetch(url)
        .then(r => r.json())
        .then(data => { renderRows(data.content); renderPagination(data); })
        .catch(() => { renderRows([]); renderPagination({ currentPage: 0, totalPages: 1, totalElements: 0, hasPrevious: false, hasNext: false }); })
        .finally(() => showLoading(false));
    }

    function goToPage(p) { loadHolerites(Math.max(0, p)); }

    document.addEventListener('DOMContentLoaded', function() {
      const sizeSel = document.getElementById('pageSizeSelect');
      if (sizeSel) {
        sizeSel.addEventListener('change', function(e) {
          pageSize = parseInt(e.target.value, 10) || 20;
          loadHolerites(0);
        });
      }
      loadHolerites(0);
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script th:src="@{/js/sidebar.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
