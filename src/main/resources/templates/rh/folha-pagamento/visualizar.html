<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visualizar Folha</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/sidebar.css}" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>
<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>
      <section class="content-area">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 style="display:flex; align-items:center; gap:12px;">
            <i class="fas fa-eye"></i> Folha
            <span th:text="${folha.mesReferencia + '/' + folha.anoReferencia}"></span>
            <span class="status-badge"
                  th:classappend="${folha.status.name() == 'EM_PROCESSAMENTO' ? ' status-warning' : (folha.status.name() == 'PROCESSADA' ? ' status-ativo' : (folha.status.name() == 'FECHADA' ? ' status-inativo' : ' status-suspenso'))}"
                  th:text="${folha.status.name()}"></span>
          </h1>
          <div class="btn-group">
            <form th:action="@{/rh/folha-pagamento/fechar/{id}(id=${folha.id})}" method="post" th:if="${folha.status.name() == 'PROCESSADA'}">
              <button class="btn btn-success" title="Fechar folha"><i class="fas fa-lock"></i> Fechar</button>
            </form>
            <form th:action="@{/rh/folha-pagamento/cancelar/{id}(id=${folha.id})}" method="post" th:if="${folha.status.name() != 'FECHADA'}">
              <button class="btn btn-danger" title="Cancelar folha"><i class="fas fa-times"></i> Cancelar</button>
            </form>
          </div>
        </div>

        <div class="action-buttons" style="margin-bottom:12px;">
          <div class="search-box">
            <input id="buscarHoleriteFolha" type="text" placeholder="Buscar por nome" autocomplete="off" />
          </div>
        </div>

        <div class="alert alert-warning" role="alert" th:if="${resumo.quantidadeHolerites == 0}">
          Nenhum holerite foi gerado para esta folha. Verifique colaboradores ativos e gere novamente em
          <a class="alert-link" th:href="@{/rh/folha-pagamento/gerar}">Gerar Folha</a>.
        </div>

        <div class="row mb-3">
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <div class="text-muted">Proventos</div>
                <h4 class="text-primary" th:text="${#numbers.formatCurrency(resumo.totalProventos)}"></h4>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <div class="text-muted">Descontos</div>
                <h4 class="text-danger" th:text="${#numbers.formatCurrency(resumo.totalDescontos)}"></h4>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <div class="text-muted">Líquido</div>
                <h4 class="text-success" th:text="${#numbers.formatCurrency(resumo.totalLiquido)}"></h4>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card text-center">
              <div class="card-body">
                <div class="text-muted">Holerites</div>
                <h4 th:text="${resumo.quantidadeHolerites}"></h4>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body table-responsive">
            <div id="holeritesLoading" class="loading" style="display:none"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
            <table class="table-list">
              <thead>
                <tr>
                  <th class="text-center">Colaborador</th>
                  <th class="text-center">Departamento</th>
                  <th class="text-center">Salário Base</th>
                  <th class="text-center">Proventos</th>
                  <th class="text-center">Descontos</th>
                  <th class="text-center">Líquido</th>
                  <th class="text-center">Ações</th>
                </tr>
              </thead>
              <tbody id="holeritesBody"></tbody>
            </table>
            <div id="holeritesPagination" class="pagination"></div>
          </div>
        </div>
      </section>
    </main>
  </div>
  <script th:inline="javascript">window.folhaId = [[${folha.id}]];</script>
  <script>
    let currentPage = 0;
    let query = '';
    let debounceTimer;

    function brl(v) {
      try { return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v ?? 0); } catch { return v ?? 0; }
    }

    function showLoading(show) { const el = document.getElementById('holeritesLoading'); if (el) el.style.display = show ? 'block' : 'none'; }

    function renderRows(items) {
      const tbody = document.getElementById('holeritesBody');
      tbody.innerHTML = '';
      if (!items || items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum registro encontrado</td></tr>';
        return;
      }
      const rows = items.map(it => {
        const nome = it.nome || '-';
        const dep = it.departamento || '-';
        const id = it.id;
        return `<tr>
          <td class="text-center">${nome}</td>
          <td class="text-center">${dep}</td>
          <td class="text-center">${brl(it.salarioBase)}</td>
          <td class="text-center">${brl(it.totalProventos)}</td>
          <td class="text-center">${brl(it.totalDescontos)}</td>
          <td class="text-center">${brl(it.salarioLiquido)}</td>
          <td class="actions">
            <a href="/rh/folha-pagamento/holerite/${id}" class="btn btn-sm btn-info" title="Ver"><i class="fas fa-eye"></i></a>
            <a href="/rh/folha-pagamento/holerite/${id}/pdf" class="btn btn-sm btn-success" title="PDF"><i class="fas fa-file-pdf"></i></a>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = rows;
    }

    function renderPagination(data) {
      const el = document.getElementById('holeritesPagination');
      const totalPages = data.totalPages || 0;
      const totalElements = data.totalElements || 0;
      const page = data.currentPage || 0;
      const hasPrev = data.hasPrevious;
      const hasNext = data.hasNext;
      let html = '';
      html += `<span class="pagination-info">Página ${page + 1} de ${Math.max(totalPages, 1)} (${totalElements} registros)</span>`;
      html += hasPrev ? `<a class="btn btn-secondary" href="#" onclick="goToPage(${page - 1});return false;"><i class="fas fa-chevron-left"></i> Anterior</a>` : `<span class="btn btn-secondary disabled"><i class="fas fa-chevron-left"></i> Anterior</span>`;
      html += hasNext ? `<a class="btn btn-secondary" href="#" onclick="goToPage(${page + 1});return false;">Próxima <i class="fas fa-chevron-right"></i></a>` : `<span class="btn btn-secondary disabled">Próxima <i class="fas fa-chevron-right"></i></span>`;
      if (el) el.innerHTML = html;
    }

    function loadHolerites(page = 0) {
      currentPage = page;
      showLoading(true);
      const url = `/rh/folha-pagamento/api/folha/${window.folhaId}/holerites?page=${page}&size=20&q=${encodeURIComponent(query)}`;
      fetch(url)
        .then(r => r.json())
        .then(data => { renderRows(data.content); renderPagination(data); })
        .catch(() => { renderRows([]); renderPagination({ currentPage: 0, totalPages: 1, totalElements: 0, hasPrevious: false, hasNext: false }); })
        .finally(() => showLoading(false));
    }

    function goToPage(p) { loadHolerites(Math.max(0, p)); }

    document.addEventListener('DOMContentLoaded', function() {
      const input = document.getElementById('buscarHoleriteFolha');
      if (input) {
        input.addEventListener('input', function(e) {
          clearTimeout(debounceTimer);
          query = e.target.value;
          debounceTimer = setTimeout(() => loadHolerites(0), 250);
        });
      }
      loadHolerites(0);
    });
  </script>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script th:src="@{/js/sidebar.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
