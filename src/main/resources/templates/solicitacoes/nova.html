<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nova Solicitação de Acesso - ERP Corporativo</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <link rel="stylesheet" th:href="@{/css/style.css}" />
  <link rel="stylesheet" th:href="@{/css/solicitações-nova.css}" />

</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <h1>Nova Solicitação de Acesso</h1>
        <h2>Preencha os dados para solicitar acesso ao sistema</h2>

        <div class="action-buttons">
          <a href="/solicitacoes" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar às Solicitações
          </a>
        </div>

        <!-- Mensagens de Sucesso e Erro -->
        <div th:if="${mensagem}" class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          <span th:text="${mensagem}"></span>
        </div>

        <div th:if="${erro}" class="alert alert-danger">
          <i class="fas fa-exclamation-triangle"></i>
          <span th:text="${erro}"></span>
        </div>

        <form class="form-container" method="post" action="/solicitacoes/nova" th:object="${solicitacaoAcesso}">

          <!-- Informações do Colaborador -->
          <div class="form-section">
            <h3><i class="fas fa-user"></i> Informações do Colaborador</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="colaborador" class="required">Colaborador</label>
                <select id="colaborador" name="colaborador.id" class="form-control" required>
                  <option value="">Selecione o colaborador...</option>
                  <!-- Colaboradores serão carregados via AJAX -->
                </select>
              </div>

              <div class="form-group">
                <label for="tipoUsuario" class="required">Tipo de Usuário</label>
                <select id="tipoUsuario" name="tipoUsuario" class="form-control" required>
                  <option value="">Selecione o tipo...</option>
                  <option value="FUNCIONARIO">Funcionário CLT</option>
                  <option value="TERCEIRIZADO">Terceirizado</option>
                  <option value="ESTAGIARIO">Estagiário</option>
                  <option value="CONSULTOR">Consultor</option>
                  <option value="REPRESENTANTE">Representante</option>
                </select>
              </div>
            </div>

            <!-- Informações do colaborador selecionado -->
            <div id="colaboradorInfo" class="colaborador-info hidden">
              <h4><i class="fas fa-info-circle"></i> Dados do Colaborador</h4>
              <div class="colaborador-details">
                <div><strong>Nome:</strong> <span id="colaboradorNome"></span></div>
                <div><strong>Email:</strong> <span id="colaboradorEmail"></span></div>
                <div><strong>CPF:</strong> <span id="colaboradorCpf"></span></div>
                <div><strong>Cargo:</strong> <span id="colaboradorCargo"></span></div>
                <div><strong>Departamento:</strong> <span id="colaboradorDepartamento"></span></div>
              </div>
            </div>
          </div>

          <!-- Módulos de Acesso -->
          <div class="form-section">
            <h3><i class="fas fa-th-large"></i> Módulos de Acesso</h3>
            <p>Selecione os módulos que o usuário deve ter acesso:</p>

            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="modulo_RH" name="modulos" value="RH">
                <label for="modulo_RH">
                  <i class="fas fa-users"></i> Recursos Humanos
                </label>
              </div>

              <div class="checkbox-item">
                <input type="checkbox" id="modulo_FINANCEIRO" name="modulos" value="FINANCEIRO">
                <label for="modulo_FINANCEIRO">
                  <i class="fas fa-dollar-sign"></i> Financeiro
                </label>
              </div>

              <div class="checkbox-item">
                <input type="checkbox" id="modulo_VENDAS" name="modulos" value="VENDAS">
                <label for="modulo_VENDAS">
                  <i class="fas fa-chart-line"></i> Vendas
                </label>
              </div>

              <div class="checkbox-item">
                <input type="checkbox" id="modulo_COMPRAS" name="modulos" value="COMPRAS">
                <label for="modulo_COMPRAS">
                  <i class="fas fa-shopping-cart"></i> Compras
                </label>
              </div>

              <div class="checkbox-item">
                <input type="checkbox" id="modulo_ESTOQUE" name="modulos" value="ESTOQUE">
                <label for="modulo_ESTOQUE">
                  <i class="fas fa-warehouse"></i> Estoque
                </label>
              </div>

              <div class="checkbox-item">
                <input type="checkbox" id="modulo_MARKETING" name="modulos" value="MARKETING">
                <label for="modulo_MARKETING">
                  <i class="fas fa-bullhorn"></i> Marketing
                </label>
              </div>

              <div class="checkbox-item">
                <input type="checkbox" id="modulo_TI" name="modulos" value="TI">
                <label for="modulo_TI">
                  <i class="fas fa-laptop-code"></i> TI
                </label>
              </div>

              <div class="checkbox-item">
                <input type="checkbox" id="modulo_JURIDICO" name="modulos" value="JURIDICO">
                <label for="modulo_JURIDICO">
                  <i class="fas fa-balance-scale"></i> Jurídico
                </label>
              </div>
            </div>
          </div>

          <!-- Nível de Acesso e Configurações -->
          <div class="form-section">
            <h3><i class="fas fa-key"></i> Configurações de Acesso</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="nivelSolicitado" class="required">Nível de Acesso</label>
                <select id="nivelSolicitado" name="nivelSolicitado" class="form-control" required>
                  <option value="">Selecione o nível...</option>
                  <option value="CONSULTA">Consulta</option>
                  <option value="OPERACIONAL">Operacional</option>
                  <option value="SUPERVISAO">Supervisão</option>
                  <option value="COORDENACAO">Coordenação</option>
                  <option value="GERENCIAL">Gerencial</option>
                  <option value="ADMINISTRATIVO">Administrativo</option>
                </select>
              </div>

              <div class="form-group">
                <label for="prazoAcesso">Prazo de Acesso</label>
                <select id="prazoAcesso" name="prazoAcesso" class="form-control">
                  <option value="PERMANENTE">Permanente</option>
                  <option value="TEMPORARIO">Temporário</option>
                </select>
              </div>
            </div>

            <!-- Campos para acesso temporário -->
            <div id="camposTemporarios" class="form-row hidden">
              <div class="form-group">
                <label for="dataInicio">Data de Início</label>
                <input type="date" id="dataInicio" name="dataInicio" class="form-control">
              </div>

              <div class="form-group">
                <label for="dataFim">Data de Fim</label>
                <input type="date" id="dataFim" name="dataFim" class="form-control">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="prioridade">Prioridade</label>
                <select id="prioridade" name="prioridade" class="form-control">
                  <option value="BAIXA">Baixa</option>
                  <option value="MEDIA" selected>Média</option>
                  <option value="ALTA">Alta</option>
                  <option value="URGENTE">Urgente</option>
                </select>
              </div>

              <div class="form-group">
                <label for="dataLimite">Data Limite (se urgente)</label>
                <input type="date" id="dataLimite" name="dataLimite" class="form-control">
              </div>
            </div>
          </div>

          <!-- Justificativa -->
          <div class="form-section">
            <h3><i class="fas fa-comment-alt"></i> Justificativa</h3>

            <div class="form-group">
              <label for="justificativa" class="required">Justificativa Detalhada</label>
              <textarea id="justificativa" name="justificativa" class="form-control" rows="5"
                placeholder="Descreva detalhadamente a necessidade de acesso, as atividades que serão realizadas e a importância para o trabalho do colaborador. Mínimo de 50 caracteres."
                required minlength="50"></textarea>
              <small class="text-muted">Mínimo de 50 caracteres</small>
            </div>

            <div class="form-group">
              <label for="sistemasEspecificos">Sistemas Específicos (opcional)</label>
              <textarea id="sistemasEspecificos" name="sistemasEspecificos" class="form-control" rows="3"
                placeholder="Se necessário, especifique sistemas, relatórios ou funcionalidades específicas que o usuário precisa acessar."></textarea>
            </div>
          </div>
          
          <!-- Botões de Ação -->
          <div class="form-actions" style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
            <a href="/solicitacoes" class="btn btn-secondary">
              <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i> Enviar Solicitação
            </button>
          </div>
        </form>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <script>
    // Carregar colaboradores via AJAX
    document.addEventListener('DOMContentLoaded', function () {
      // Limpar cache antigo ao carregar a página (para fins de depuração)
      // localStorage.removeItem('colaboradores_cache');
      // localStorage.removeItem('colaboradores_cache_time');
      
      carregarColaboradores();
      configurarEventListeners();
    });

    function carregarColaboradores() {
      // Verificar se já existe cache válido
      const cacheKey = 'colaboradores_cache';
      const cacheTime = 'colaboradores_cache_time';
      const cacheValidity = 5 * 60 * 1000; // 5 minutos
      
      const cachedData = localStorage.getItem(cacheKey);
      const cachedTime = localStorage.getItem(cacheTime);
      
      // Verificar se o cache é válido (menos de 5 minutos)
      if (cachedData && cachedTime && (Date.now() - parseInt(cachedTime)) < cacheValidity) {
        //console.log('Usando colaboradores do cache');
        preencherSelectColaboradores(JSON.parse(cachedData));
        return;
      }
      
      // Se não houver cache válido, buscar do servidor
      fetch('/solicitacoes/colaboradores')
        .then(response => response.json())
        .then(colaboradores => {
          // Salvar no cache
          localStorage.setItem(cacheKey, JSON.stringify(colaboradores));
          localStorage.setItem(cacheTime, Date.now().toString());
          
          preencherSelectColaboradores(colaboradores);
        })
        .catch(error => {
          console.error('Erro ao carregar colaboradores:', error);
          // Em caso de erro, tentar usar cache mesmo que esteja expirado
          if (cachedData) {
            console.log('Usando cache expirado como fallback');
            preencherSelectColaboradores(JSON.parse(cachedData));
          }
        });
    }
    
    function preencherSelectColaboradores(colaboradores) {
      const select = document.getElementById('colaborador');
      // Limpar opções existentes
      select.innerHTML = '<option value="">Selecione o colaborador...</option>';
      
      // Verificar se há colaboradores
      if (!colaboradores || colaboradores.length === 0) {
        console.warn('Nenhum colaborador encontrado');
        // Adicionar opção indicando que não há colaboradores
        const option = document.createElement('option');
        option.textContent = 'Nenhum colaborador disponível';
        option.disabled = true;
        select.appendChild(option);
        return;
      }
      
      //console.log('Carregando ' + colaboradores.length + ' colaboradores');
      
      colaboradores.forEach(colaborador => {
        const option = document.createElement('option');
        option.value = colaborador.id;
        option.textContent = `${colaborador.nome} - ${colaborador.cargo || 'N/A'} (${colaborador.departamento || 'N/A'})`;
        option.dataset.email = colaborador.email;
        option.dataset.cpf = colaborador.cpf;
        option.dataset.cargo = colaborador.cargo || 'N/A';
        option.dataset.departamento = colaborador.departamento || 'N/A';
        select.appendChild(option);
      });
    }

    function configurarEventListeners() {
      // Mostrar informações do colaborador selecionado
      document.getElementById('colaborador').addEventListener('change', function () {
        const selectedOption = this.options[this.selectedIndex];
        const infoDiv = document.getElementById('colaboradorInfo');

        if (selectedOption.value) {
          // Extrair apenas o nome do texto completo
          const nomeCompleto = selectedOption.textContent.split(' - ')[0];
          document.getElementById('colaboradorNome').textContent = nomeCompleto;
          document.getElementById('colaboradorEmail').textContent = selectedOption.dataset.email || 'N/A';
          document.getElementById('colaboradorCpf').textContent = selectedOption.dataset.cpf || 'N/A';
          document.getElementById('colaboradorCargo').textContent = selectedOption.dataset.cargo || 'N/A';
          document.getElementById('colaboradorDepartamento').textContent = selectedOption.dataset.departamento || 'N/A';
          infoDiv.classList.remove('hidden');
        } else {
          infoDiv.classList.add('hidden');
        }
      });

      // Mostrar/ocultar campos de acesso temporário
      document.getElementById('prazoAcesso').addEventListener('change', function () {
        const camposTemporarios = document.getElementById('camposTemporarios');
        if (this.value === 'TEMPORARIO') {
          camposTemporarios.classList.remove('hidden');
          document.getElementById('dataInicio').required = true;
          document.getElementById('dataFim').required = true;
        } else {
          camposTemporarios.classList.add('hidden');
          document.getElementById('dataInicio').required = false;
          document.getElementById('dataFim').required = false;
        }
      });

      // Validação de datas
      document.getElementById('dataInicio').addEventListener('change', function () {
        const dataFim = document.getElementById('dataFim');
        if (this.value) {
          dataFim.min = this.value;
        }
      });

      // Contador de caracteres para justificativa
      document.getElementById('justificativa').addEventListener('input', function () {
        const minLength = 50;
        const currentLength = this.value.length;
        const small = this.nextElementSibling;

        if (currentLength < minLength) {
          small.textContent = `Mínimo de 50 caracteres (${currentLength}/${minLength})`;
          small.style.color = '#ef4444';
        } else {
          small.textContent = `${currentLength} caracteres`;
          small.style.color = '#10b981';
        }
      });

      // Validação do formulário antes do envio
      document.querySelector('form').addEventListener('submit', function (e) {
        const colaborador = document.getElementById('colaborador').value;
        const modulos = document.querySelectorAll('input[name="modulos"]:checked');
        const justificativa = document.getElementById('justificativa').value;

        if (!colaborador) {
          alert('Por favor, selecione um colaborador.');
          e.preventDefault();
          return;
        }

        if (modulos.length === 0) {
          alert('Por favor, selecione pelo menos um módulo de acesso.');
          e.preventDefault();
          return;
        }

        if (justificativa.length < 50) {
          alert('A justificativa deve ter pelo menos 50 caracteres.');
          e.preventDefault();
          return;
        }

        // Validação para acesso temporário
        const prazoAcesso = document.getElementById('prazoAcesso').value;
        if (prazoAcesso === 'TEMPORARIO') {
          const dataInicio = document.getElementById('dataInicio').value;
          const dataFim = document.getElementById('dataFim').value;

          if (!dataInicio || !dataFim) {
            alert('Para acesso temporário, as datas de início e fim são obrigatórias.');
            e.preventDefault();
            return;
          }

          if (new Date(dataInicio) >= new Date(dataFim)) {
            alert('A data de fim deve ser posterior à data de início.');
            e.preventDefault();
            return;
          }
        }
      });
    }
  </script>
  
  <!-- jQuery necessário para o sistema de notificações -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- Script de notificações -->
  <script th:src="@{/js/notifications.js}"></script>

</body>

</html>
