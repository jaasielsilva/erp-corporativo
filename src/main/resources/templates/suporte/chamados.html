<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lista de Chamados - Suporte - ERP Corporativo</title>

    <!-- CSS Files -->
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* ===== PADRÃO EMPRESARIAL - CORES CONSISTENTES ===== */
        :root {
            --primary-color: #1e293b;
            --secondary-color: #334155;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #06b6d4;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .content-area {
            background-color: var(--light-bg);
            min-height: calc(100vh - 80px);
            padding: 2rem 0;
        }

        /* ===== CARDS PADRONIZADOS ===== */
        .card-empresarial {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .card-empresarial:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header-empresarial {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 12px 12px 0 0;
            padding: 1.5rem;
            font-weight: 600;
        }

        /* ===== BADGES DE STATUS PADRONIZADOS ===== */
        .badge-status {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge-aberto {
            background-color: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #93c5fd;
        }

        .badge-em-andamento {
            background-color: #fef3c7;
            color: #d97706;
            border: 1px solid #fcd34d;
        }

        .badge-resolvido {
            background-color: #d1fae5;
            color: #059669;
            border: 1px solid #6ee7b7;
        }

        .badge-fechado {
            background-color: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c4b5fd;
        }

        /* ===== BADGES DE PRIORIDADE PADRONIZADOS ===== */
        .badge-prioridade {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .badge-baixa {
            background-color: #d1fae5;
            color: #059669;
            border: 1px solid #6ee7b7;
        }

        .badge-media {
            background-color: #fef3c7;
            color: #d97706;
            border: 1px solid #fcd34d;
        }

        .badge-alta {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fca5a5;
        }

        .badge-urgente {
            background-color: #fecaca;
            color: #b91c1c;
            border: 1px solid #f87171;
            animation: pulse-urgente 2s infinite;
        }

        @keyframes pulse-urgente {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ===== INDICADORES SLA ===== */
        .sla-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .sla-ok {
            background-color: #d1fae5;
            color: #059669;
        }

        .sla-atencao {
            background-color: #fef3c7;
            color: #d97706;
        }

        .sla-vencido {
            background-color: #fee2e2;
            color: #dc2626;
            animation: pulse-urgente 2s infinite;
        }

        /* ===== TABELA MODERNA ===== */
        .table-empresarial {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: var(--card-bg);
        }

        .table-empresarial thead th {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            border: none;
            padding: 1rem;
        }

        .table-empresarial tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border-color);
        }

        .table-empresarial tbody tr:hover {
            background-color: #f8fafc;
            transform: translateY(-1px);
        }

        .table-empresarial tbody td {
            padding: 1rem;
            vertical-align: middle;
            border: none;
        }

        /* ===== BOTÕES PADRONIZADOS ===== */
        .btn-empresarial {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-empresarial:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary-empresarial {
            background: linear-gradient(135deg, var(--accent-color) 0%, #2563eb 100%);
            color: white;
        }

        .btn-success-empresarial {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
        }

        .btn-warning-empresarial {
            background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);
            color: white;
        }

        .btn-danger-empresarial {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            color: white;
        }

        /* ===== CARDS DE ESTATÍSTICAS ===== */
        .stats-card-empresarial {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .stats-card-empresarial:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stats-icon-empresarial {
            width: 3rem;
            height: 3rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.25rem;
            color: white;
        }

        .stats-number-empresarial {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .stats-label-empresarial {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* ===== FILTROS ===== */
        .filters-card-empresarial {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .form-control-empresarial,
        .form-select-empresarial {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-control-empresarial:focus,
        .form-select-empresarial:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
        }

        /* ===== AVALIAÇÃO POR ESTRELAS ===== */
        .rating-stars {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .star {
            font-size: 16px;
            color: #e5e7eb;
            transition: color 0.3s ease;
        }

        .star.filled {
            color: #fbbf24;
        }

        /* ===== BREADCRUMB PERSONALIZADO ===== */
        .breadcrumb-empresarial {
            background: transparent;
            padding: 0;
            margin-bottom: 2rem;
        }

        .breadcrumb-empresarial .breadcrumb-item a {
            color: var(--accent-color);
            text-decoration: none;
        }

        .breadcrumb-empresarial .breadcrumb-item.active {
            color: var(--text-secondary);
        }

        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 768px) {
            .content-area {
                padding: 1rem 0;
            }
            
            .table-responsive {
                font-size: 0.875rem;
            }
            
            .btn-empresarial {
                padding: 0.375rem 0.75rem;
                font-size: 0.875rem;
            }
            
            .badge-status,
            .badge-prioridade {
                padding: 0.375rem 0.75rem;
                font-size: 0.7rem;
            }
        }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
        }

        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 0.3rem solid #f3f4f6;
            border-top: 0.3rem solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header th:replace="~{components/topbar :: topbar}"></header>

            <!-- Content Area -->
            <section class="content-area">
                <div class="container-fluid">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" class="breadcrumb-empresarial">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/suporte"
                                    <i class="fas fa-headset me-1"></i>Suporte
                                </a>
                            >/li>
                        </ol>
                    </nav>

                    <!-- Header -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                <div>
                                    <h1 class="h3 mb-0" style="color: var(--text-primary);">
                                        <i class="fas fa-list me-2" style="color: var(--accent-color);"></i>
                                        Lista de Chamados
                                    </h1>
                                    <p class="mb-0" style="color: var(--text-secondary);">Gerencie todos os chamados de suporte</p>
                                </div>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="/suporte/chamados/novo" class="btn btn-primary-empresarial" th:if="${podeCriar}">
                                        <i class="fas fa-plus"></i> Novo Chamado
                                    </a>
                                    <button class="btn btn-empresarial" style="background: var(--secondary-color); color: white;" onclick="atualizarDados()">
                                        <i class="fas fa-sync-alt"></i> Atualizar
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-empresarial dropdown-toggle" style="background: var(--info-color); color: white;" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-download"></i> Exportar
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportarExcel()">
                                                <i class="fas fa-file-excel me-2 text-success"></i>Excel
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportarPDF()">
                                                <i class="fas fa-file-pdf me-2 text-danger"></i>PDF
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Estatísticas -->
                    <div class="row mb-4" id="estatisticas">
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stats-card-empresarial">
                                <div class="stats-icon-empresarial" style="background: linear-gradient(135deg, var(--accent-color) 0%, #2563eb 100%);">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <div class="stats-number-empresarial" id="totalChamados">0</div>
                                <div class="stats-label-empresarial">Total de Chamados</div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stats-card-empresarial">
                                <div class="stats-icon-empresarial" style="background: linear-gradient(135deg, var(--warning-color) 0%, #d97706 100%);">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stats-number-empresarial" style="color: var(--warning-color);" id="chamadosAbertos">0</div>
                                <div class="stats-label-empresarial">Chamados Abertos</div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stats-card-empresarial">
                                <div class="stats-icon-empresarial" style="background: linear-gradient(135deg, var(--info-color) 0%, #0891b2 100%);">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="stats-number-empresarial" style="color: var(--info-color);" id="chamadosAndamento">0</div>
                                <div class="stats-label-empresarial">Em Andamento</div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6 mb-4">
                            <div class="stats-card-empresarial">
                                <div class="stats-icon-empresarial" style="background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stats-number-empresarial" style="color: var(--success-color);" id="chamadosResolvidos">0</div>
                                <div class="stats-label-empresarial">Resolvidos Hoje</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="filters-card-empresarial">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold" style="color: var(--text-primary);">Status</label>
                                <select class="form-select form-select-empresarial" id="filtroStatus">
                                    <option value="">Todos os Status</option>
                                    <option value="ABERTO">Aberto</option>
                                    <option value="EM_ANDAMENTO">Em Andamento</option>
                                    <option value="RESOLVIDO">Resolvido</option>
                                    <option value="REABERTO">Reaberto</option>
                                    <option value="FECHADO">Fechado</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold" style="color: var(--text-primary);">Prioridade</label>
                                <select class="form-select form-select-empresarial" id="filtroPrioridade">
                                    <option value="">Todas as Prioridades</option>
                                    <option value="URGENTE">Urgente</option>
                                    <option value="ALTA">Alta</option>
                                    <option value="MEDIA">Média</option>
                                    <option value="BAIXA">Baixa</option>
                                </select>
                            </div>
                            <div class="col-md-3"
                                <label class="form-label fw-semibold" style="color: var(--text-primary);">Técnico</label>
                                <input type="text" class="form-control form-control-empresarial" id="filtroTecnico" placeholder="Nome do técnico">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold" style="color: var(--text-primary);">Buscar</label>
                                <input type="text" class="form-control form-control-empresarial" id="filtroBusca" placeholder="Número ou assunto">
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Chamados -->
                    <div class="card-empresarial">
                        <div class="card-header-empresarial">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                <h6 class="m-0 fw-bold">
                                    <i class="fas fa-table me-2"></i>
                                    Chamados de Suporte
                                    <span class="badge bg-light text-dark ms-2" id="contadorChamados">0</span>
                                </h6>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoRefresh">
                                        <label class="form-check-label text-white" for="autoRefresh">
                                            Auto-atualizar
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- Loading Overlay -->
                            <div class="loading-overlay d-none" id="loadingOverlay">
                                <div class="loading-spinner"></div>
                            </div>

                            <!-- Tabela -->
                            <div class="table-responsive">
                                <table class="table table-empresarial mb-0">
                                    <thead>
                                        <tr>
                                            <th>Número</th>
                                            <th>Assunto</th>
                                            <th>Status</th>
                                            <th>Prioridade</th>
                                            <th>Categoria</th>
                                            <th>Solicitante</th>
                                            <th>Técnico</th>
                                            <th>SLA</th>
                                            <th>Data Abertura</th>
                                            <th>Tempo Resolução</th>
                                            <th>Avaliação</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Mensagem quando não há chamados -->
                                        <tr th:if="${#lists.isEmpty(chamados)}">
                                            <td colspan="12" class="text-center py-5">
                                                <div style="color: var(--text-secondary);">
                                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                                    <h5>Nenhum chamado encontrado</h5>
                                                    <p class="mb-0">Não há chamados cadastrados no sistema.</p>
                                                    <a href="/suporte/chamados/novo" class="btn btn-primary-empresarial mt-3" th:if="${podeCriar}">
                                                        <i class="fas fa-plus"></i> Criar Primeiro Chamado
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>

                                        <!-- Lista de chamados -->
                                        <tr th:each="chamado : ${chamados}" th:unless="${#lists.isEmpty(chamados)}">
                                            <td>
                                                <strong th:text="${chamado.numero}" style="color: var(--accent-color);">#001</strong>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong th:text="${chamado.assunto}" style="color: var(--text-primary);">Problema no sistema</strong>
                                                    <br>
                                                    <small th:text="${#strings.abbreviate(chamado.descricao, 50)}" style="color: var(--text-secondary);">Descrição resumida...</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge-status" th:classappend="${
                                                          chamado.status.name() == 'ABERTO' ? 'badge-aberto' :
                                                          chamado.status.name() == 'EM_ANDAMENTO' ? 'badge-em-andamento' :
                                                          chamado.status.name() == 'RESOLVIDO' ? 'badge-resolvido' :
                                                          'badge-fechado'
                                                      }" th:text="${chamado.status.descricao}">
                                                    <i class="fas fa-circle me-1"></i>Aberto
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge-prioridade" th:classappend="${
                                                          chamado.prioridade.name() == 'BAIXA' ? 'badge-baixa' :
                                                          chamado.prioridade.name() == 'MEDIA' ? 'badge-media' :
                                                          chamado.prioridade.name() == 'ALTA' ? 'badge-alta' :
                                                          'badge-urgente'
                                                      }" th:text="${chamado.prioridade.descricao}">
                                                    <i class="fas fa-flag me-1"></i>Média
                                                </span>
                                            </td>
                                            <td>
                                                <span th:text="${chamado.categoria ?: 'Geral'}" style="color: var(--text-primary);">Geral</span>
                                                <small th:if="${chamado.subcategoria}" class="d-block" style="color: var(--text-secondary);" th:text="${chamado.subcategoria}">Subcategoria</small>
                                            </td>
                                            <td>
                                                <div>
                                                    <strong th:text="${chamado.solicitanteNome ?: 'N/A'}" style="color: var(--text-primary);">João Silva</strong>
                                                    <br>
                                                    <small th:text="${chamado.solicitanteEmail ?: ''}" style="color: var(--text-secondary);">joao@empresa.com</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span th:text="${chamado.tecnicoResponsavel ?: 'Não atribuído'}" 
                                                      th:style="${chamado.tecnicoResponsavel == null ? 'color: var(--text-secondary);' : 'color: var(--text-primary);'}">Técnico</span>
                                            </td>
                                            <td>
                                                <span th:if="${chamado.slaRestante != null}" class="sla-indicator"
                                                    th:classappend="${chamado.slaRestante < 0 ? 'sla-vencido' : (chamado.slaRestante <= 4 ? 'sla-atencao' : 'sla-ok')}">
                                                    <i class="fas fa-clock"></i>
                                                    <span th:text="${chamado.slaRestante > 0 ? chamado.slaRestante + 'h' : (chamado.slaRestante == 0 ? 'Menos de 1h' : 'Vencido')}">24h</span>
                                                </span>
                                                <span th:unless="${chamado.slaRestante != null}" style="color: var(--text-secondary);">-</span>
                                            </td>
                                            <td>
                                                <small th:text="${#temporals.format(chamado.dataAbertura, 'dd/MM/yyyy HH:mm')}" style="color: var(--text-secondary);">01/01/2024 10:00</small>
                                            </td>
                                            <td>
                                                <span th:if="${chamado.tempoResolucaoMinutos != null}"
                                                    th:text="${chamado.tempoResolucaoMinutos < 60 ? chamado.tempoResolucaoMinutos + 'min' : 
                                                               (chamado.tempoResolucaoMinutos / 60) + 'h ' + (chamado.tempoResolucaoMinutos % 60) + 'min'}"
                                                    style="color: var(--text-primary);">2h 30min</span>
                                                <span th:unless="${chamado.tempoResolucaoMinutos != null}" style="color: var(--text-secondary);">-</span>
                                            </td>
                                            <td>
                                                <div th:if="${chamado.avaliacao != null}" class="rating-stars">
                                                    <span th:each="i : ${#numbers.sequence(1, 5)}"
                                                        th:class="'star ' + ${i <= chamado.avaliacao ? 'filled' : ''}">★</span>
                                                    <small class="d-block" style="color: var(--text-secondary);" th:text="${chamado.avaliacao + '/5'}">5/5</small>
                                                </div>
                                                <span th:unless="${chamado.avaliacao != null}" style="color: var(--text-secondary);">-</span>
                                            </td>
                                            <td>
                                                <div class="d-flex gap-1">
                                                    <a th:href="@{/suporte/chamados/{id}(id=${chamado.id})}"
                                                        class="btn btn-empresarial btn-sm" style="background: var(--info-color); color: white;" title="Visualizar">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <button th:if="${chamado.status.name() == 'ABERTO' and podeIniciar}"
                                                        class="btn btn-success-empresarial btn-sm" title="Assumir Atendimento"
                                                        th:onclick="'iniciarAtendimento(' + ${chamado.id} + ')'">
                                                        <i class="fas fa-user-check"></i>
                                                    </button>
                                                    <button th:if="${chamado.status.name() == 'EM_ANDAMENTO' and podeResolver}"
                                                        class="btn btn-warning-empresarial btn-sm" title="Resolver"
                                                        th:onclick="'resolverChamado(' + ${chamado.id} + ')'">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button th:if="${chamado.status.name() == 'RESOLVIDO' and podeFechar}"
                                                        class="btn btn-empresarial btn-sm" style="background: var(--secondary-color); color: white;" title="Fechar"
                                                        th:onclick="'fecharChamado(' + ${chamado.id} + ')'">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                    <a th:href="@{/suporte/chamados/{id}/avaliar(id=${chamado.id})}"
                                                        class="btn btn-warning-empresarial btn-sm"
                                                        th:if="${(chamado.status.name() == 'RESOLVIDO' or chamado.status.name() == 'FECHADO') and chamado.avaliacao == null and podeAvaliar}"
                                                        title="Avaliar atendimento">
                                                        <i class="fas fa-star"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="/js/sidebar.js" defer></script>
    <script th:src="@{/js/notifications.js}"></script>

    <script>
        // ===== VARIÁVEIS GLOBAIS =====
        let chamadosData = [];
        let autoRefreshInterval;

        // ===== INICIALIZAÇÃO =====
        $(document).ready(function() {
            carregarDados();
            atualizarEstatisticas();
            configurarFiltros();
            configurarAutoRefresh();
            aplicarFiltrosURL();
        });

        // ===== CARREGAMENTO DE DADOS =====
        async function carregarDados() {
            mostrarLoading(true);
            
            try {
                const response = await fetch('/api/suporte/chamados');
                if (response.ok) {
                    chamadosData = await response.json();
                    renderizarDados();
                    atualizarContador();
                } else {
                    console.error('Erro ao carregar chamados:', response.statusText);
                    mostrarAlerta('danger', 'Erro ao carregar dados dos chamados');
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                mostrarAlerta('danger', 'Erro de conexão com o servidor');
            } finally {
                mostrarLoading(false);
            }
        }

        // ===== ATUALIZAÇÃO DE ESTATÍSTICAS =====
        async function atualizarEstatisticas() {
            try {
                const response = await fetch('/api/chamados/estatisticas');
                if (response.ok) {
                    const stats = await response.json();
                    $('#totalChamados').text(stats.total || 0);
                    $('#chamadosAbertos').text(stats.abertos || 0);
                    $('#chamadosAndamento').text(stats.emAndamento || 0);
                    $('#chamadosResolvidos').text(stats.resolvidosHoje || 0);
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // ===== RENDERIZAÇÃO DE DADOS =====
        function renderizarDados() {
            const dadosFiltrados = aplicarFiltros();
            // A tabela já está sendo renderizada pelo Thymeleaf
            // Aqui podemos adicionar lógica adicional se necessário
        }

        // ===== FILTROS =====
        function configurarFiltros() {
            $('#filtroStatus, #filtroPrioridade, #filtroTecnico, #filtroBusca').on('change keyup', function() {
                aplicarFiltros();
            });
        }

        function aplicarFiltros() {
            const status = $('#filtroStatus').val();
            const prioridade = $('#filtroPrioridade').val();
            const tecnico = $('#filtroTecnico').val().toLowerCase();
            const busca = $('#filtroBusca').val().toLowerCase();

            let dadosFiltrados = chamadosData;

            if (status) {
                dadosFiltrados = dadosFiltrados.filter(c => c.status === status);
            }

            if (prioridade) {
                dadosFiltrados = dadosFiltrados.filter(c => c.prioridade === prioridade);
            }

            if (tecnico) {
                dadosFiltrados = dadosFiltrados.filter(c => 
                    c.tecnicoResponsavel && c.tecnicoResponsavel.toLowerCase().includes(tecnico)
                );
            }

            if (busca) {
                dadosFiltrados = dadosFiltrados.filter(c => 
                    c.numero.toString().includes(busca) || 
                    c.assunto.toLowerCase().includes(busca)
                );
            }

            atualizarContador(dadosFiltrados.length);
            return dadosFiltrados;
        }

        function aplicarFiltrosURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const statusParam = urlParams.get('status');

            if (statusParam) {
                $('#filtroStatus').val(statusParam);
                aplicarFiltros();
            }
        }

        // ===== AUTO-REFRESH =====
        function configurarAutoRefresh() {
            $('#autoRefresh').on('change', function() {
                if (this.checked) {
                    autoRefreshInterval = setInterval(() => {
                        carregarDados();
                        atualizarEstatisticas();
                    }, 30000); // 30 segundos
                } else {
                    clearInterval(autoRefreshInterval);
                }
            });
        }

        // ===== AÇÕES DOS CHAMADOS =====
        async function iniciarAtendimento(id) {
            try {
                // Obter usuário logado automaticamente
                const response = await fetch('/suporte/api/usuario/atual');
                
                if (!response.ok) {
                    mostrarAlerta('error', 'Erro ao obter dados do usuário logado');
                    return;
                }
                
                const usuarioLogado = await response.json();
                
                // Verificar se usuário pode atender chamados
                if (!usuarioLogado.podeAtenderChamados) {
                    mostrarAlerta('warning', 'Você não tem permissão para atender chamados');
                    return;
                }
                
                const confirmar = await (typeof Swal !== 'undefined'
                    ? Swal.fire({
                        title: 'Deseja assumir o atendimento deste chamado?',
                        html: `Responsável: <strong>${usuarioLogado.nome}</strong>`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Assumir atendimento',
                        cancelButtonText: 'Cancelar'
                    }).then(r => r.isConfirmed)
                    : Promise.resolve(window.confirm(`Deseja assumir o atendimento deste chamado como ${usuarioLogado.nome}?`)));
                
                if (confirmar) {
                    await atualizarStatusChamado(id, 'iniciar', { 
                        tecnicoResponsavel: usuarioLogado.nome
                    });
                }
                
            } catch (error) {
                console.error('Erro ao iniciar atendimento:', error);
                mostrarAlerta('error', 'Erro ao iniciar atendimento. Tente novamente.');
            }
        }

        async function resolverChamado(id) {
            const confirmar = await (typeof Swal !== 'undefined'
                ? Swal.fire({
                    title: 'Deseja marcar este chamado como resolvido?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Marcar como resolvido',
                    cancelButtonText: 'Cancelar'
                }).then(r => r.isConfirmed)
                : Promise.resolve(window.confirm('Deseja marcar este chamado como resolvido?')));
            if (confirmar) {
                await atualizarStatusChamado(id, 'resolver');
            }
        }

        async function fecharChamado(id) {
            const confirmar = await (typeof Swal !== 'undefined'
                ? Swal.fire({
                    title: 'Deseja fechar este chamado definitivamente?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Fechar chamado',
                    cancelButtonText: 'Cancelar'
                }).then(r => r.isConfirmed)
                : Promise.resolve(window.confirm('Deseja fechar este chamado definitivamente?')));
            if (confirmar) {
                await atualizarStatusChamado(id, 'fechar');
            }
        }

        // ===== ATUALIZAÇÃO DE STATUS =====
        async function atualizarStatusChamado(id, acao, dadosAdicionais = {}) {
            mostrarLoading(true);

            try {
                const response = await fetch(`/api/suporte/chamados/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        acao: acao,
                        ...dadosAdicionais
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.sucesso) {
                        mostrarAlerta('success', 'Status atualizado com sucesso!');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        mostrarAlerta('danger', 'Erro: ' + (result.erro || 'Erro desconhecido'));
                    }
                } else {
                    mostrarAlerta('danger', 'Erro na comunicação com o servidor');
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                mostrarAlerta('danger', 'Erro ao conectar com o servidor');
            } finally {
                mostrarLoading(false);
            }
        }

        // ===== UTILITÁRIOS =====
        function atualizarContador(count = null) {
            const total = count !== null ? count : chamadosData.length;
            $('#contadorChamados').text(total);
        }

        function mostrarLoading(mostrar) {
            if (mostrar) {
                $('#loadingOverlay').removeClass('d-none');
            } else {
                $('#loadingOverlay').addClass('d-none');
            }
        }

        function atualizarDados() {
            carregarDados();
            atualizarEstatisticas();
            mostrarAlerta('success', 'Dados atualizados com sucesso!');
        }

        // ===== EXPORTAÇÃO =====
        function exportarExcel() {
            window.open('/api/chamados/export/excel', '_blank');
        }

        function exportarPDF() {
            window.open('/api/chamados/export/pdf', '_blank');
        }

        // ===== SISTEMA DE ALERTAS =====
        function mostrarAlerta(tipo, mensagem) {
            const iconMap = { success: 'success', danger: 'error', error: 'error', warning: 'warning', info: 'info' };
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: tipo === 'success' ? 'Sucesso' : (tipo === 'warning' ? 'Atenção' : (tipo === 'info' ? 'Informação' : 'Erro')),
                    html: mensagem,
                    icon: iconMap[tipo] || 'info',
                    confirmButtonText: 'OK'
                });
                return;
            }
            const klass = `alert-${tipo}`;
            const div = document.createElement('div');
            div.className = `alert ${klass} alert-dismissible fade show position-fixed`;
            div.style.cssText = 'top:20px;right:20px;z-index:10000;min-width:300px;';
            div.innerHTML = `${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(div);
            setTimeout(() => { try { div.remove(); } catch(e){} }, 5000);
        }
    </script>
</body>

</html>
