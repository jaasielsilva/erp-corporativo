<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Chamado #' + ${chamado.numero} + ' - Suporte - ERP Corporativo'">Chamado - Suporte - ERP Corporativo</title>
    
    <!-- CSS Files -->
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-aberto {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status-em-andamento {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-resolvido {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        
        .status-fechado {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-aberto {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status-em_andamento {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .prioridade-badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .prioridade-baixa {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        
        .prioridade-media {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .prioridade-alta {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .prioridade-urgente {
            background-color: #ffcdd2;
            color: #c62828;
            animation: pulse 2s infinite;
        }
        
        .prioridade-baixa {
            background-color: #e8f5e8;
            color: #388e3c;
            font-weight: 600;
        }
        
        .prioridade-media {
            background-color: #fff3e0;
            color: #f57c00;
            font-weight: 600;
        }
        
        .prioridade-alta {
            background-color: #ffebee;
            color: #d32f2f;
            font-weight: 600;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .sla-verde {
            color: #388e3c;
            font-weight: 600;
        }
        
        .sla-amarelo {
            color: #f57c00;
            font-weight: 600;
        }
        
        .sla-vermelho {
            color: #d32f2f;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        .info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 1rem;
            width: 12px;
            height: 12px;
            background: #007bff;
            border-radius: 50%;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <aside th:replace="~{components/sidebar :: sidebar}"></aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <header th:replace="~{components/topbar :: topbar}"></header>
            
            <!-- Page Content -->
            <section class="content-section">
                <div class="container-fluid">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="/suporte" class="text-decoration-none">
                                    <i class="fas fa-headset me-1"></i>Suporte
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="/suporte/chamados" class="text-decoration-none">
                                    <i class="fas fa-list me-1"></i>Lista de Chamados
                                </a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">
                                <i class="fas fa-eye me-1"></i>Visualizar Chamado
                            </li>
                        </ol>
                    </nav>

                    <!-- Page Header -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <div>
                            <h1 class="h3 mb-0 text-gray-800">
                                <i class="fas fa-ticket-alt me-2"></i>
                                Chamado #<span th:text="${chamado.numero}">001</span>
                            </h1>
                            <p class="text-muted mb-0" th:text="${chamado.assunto}">Assunto do chamado</p>
                        </div>
                        <div>
                            <a href="/suporte" class="btn btn-outline-secondary">
                                <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                            </a>
                            <a href="/suporte/chamados" class="btn btn-outline-primary ms-2">
                                <i class="fas fa-list me-1"></i> Lista de Chamados
                            </a>
                            <a href="/suporte/chamados/novo" class="btn btn-primary ms-2">
                                <i class="fas fa-plus me-1"></i> Novo Chamado
                            </a>
                            <div class="btn-group ms-2" role="group">
                                <button th:if="${chamado.status.name() == 'ABERTO' and podeIniciar}" 
                                        class="btn btn-success btn-action" 
                                        th:onclick="'iniciarAtendimento(' + ${chamado.id} + ')'">
                                    <i class="fas fa-play me-1"></i> Iniciar Atendimento
                                </button>
                                <button th:if="${chamado.status.name() == 'EM_ANDAMENTO' and podeResolver}" 
                                        class="btn btn-warning btn-action" 
                                        th:onclick="'resolverChamado(' + ${chamado.id} + ')'">
                                    <i class="fas fa-check me-1"></i> Resolver
                                </button>
                                <button th:if="${chamado.status.name() == 'RESOLVIDO' and podeFechar}" 
                                        class="btn btn-secondary btn-action" 
                                        th:onclick="'fecharChamado(' + ${chamado.id} + ')'">
                                    <i class="fas fa-times me-1"></i> Fechar
                                </button>
                                <button th:if="${chamado.status.name() == 'FECHADO' and podeReabrir}" 
                                        class="btn btn-warning btn-action" 
                                        th:onclick="'reabrirChamado(' + ${chamado.id} + ')'">
                                    <i class="fas fa-redo me-1"></i> Reabrir
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Informações do Chamado -->
                        <div class="col-lg-8">
                            <div class="card shadow mb-4">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Detalhes do Chamado
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- Status e Prioridade -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Status:</label>
                                            <div>
                                                <span th:class="'status-badge status-' + ${#strings.toLowerCase(chamado.status.name())}"
                                                      th:text="${chamado.status.descricao}">Aberto</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Prioridade:</label>
                                            <div>
                                                <span th:class="'prioridade-badge prioridade-' + ${#strings.toLowerCase(chamado.prioridade.name())}"
                                                      th:text="${chamado.prioridade.descricao}">Média</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Assunto -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Assunto:</label>
                                        <p class="mb-0" th:text="${chamado.assunto}">Assunto do chamado</p>
                                    </div>

                                    <!-- Descrição -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Descrição:</label>
                                        <div class="info-card">
                                            <p class="mb-0" th:text="${chamado.descricao}" style="white-space: pre-wrap;">Descrição detalhada do problema...</p>
                                        </div>
                                    </div>

                                    <!-- Categoria -->
                                    <div class="mb-4" th:if="${chamado.categoria}">
                                        <label class="form-label fw-bold">Categoria:</label>
                                        <p class="mb-0" th:text="${chamado.categoria}">Categoria do chamado</p>
                                    </div>

                                    <!-- Observações -->
                                    <div th:if="${chamado.observacoes}">
                                        <label class="form-label fw-bold">Observações:</label>
                                        <div class="info-card">
                                            <p class="mb-0" th:text="${chamado.observacoes}" style="white-space: pre-wrap;">Observações adicionais...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Informações Laterais -->
                        <div class="col-lg-4">
                            <div class="card shadow mb-4">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold">
                                        <i class="fas fa-user me-2"></i>
                                        Informações
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- Solicitante -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Solicitante:</label>
                                        <div>
                                            <strong th:text="${chamado.solicitanteNome ?: 'N/A'}">João Silva</strong>
                                            <br>
                                            <small class="text-muted" th:text="${chamado.solicitanteEmail ?: ''}">joao@empresa.com</small>
                                        </div>
                                    </div>

                                    <!-- Técnico Responsável -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Técnico Responsável:</label>
                                        <p class="mb-0" th:text="${chamado.tecnicoResponsavel ?: 'Não atribuído'}" 
                                           th:class="${chamado.tecnicoResponsavel == null ? 'text-muted' : ''}">Técnico</p>
                                    </div>

                                    <!-- Data de Abertura -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Data de Abertura:</label>
                                        <p class="mb-0" th:text="${#temporals.format(chamado.dataAbertura, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</p>
                                    </div>

                                    <!-- Data de Início -->
                                    <div class="mb-3" th:if="${chamado.dataInicio}">
                                        <label class="form-label fw-bold">Data de Início:</label>
                                        <p class="mb-0" th:text="${#temporals.format(chamado.dataInicio, 'dd/MM/yyyy HH:mm')}">01/01/2024 11:00</p>
                                    </div>

                                    <!-- Data de Resolução -->
                                    <div class="mb-3" th:if="${chamado.dataResolucao}">
                                        <label class="form-label fw-bold">Data de Resolução:</label>
                                        <p class="mb-0" th:text="${#temporals.format(chamado.dataResolucao, 'dd/MM/yyyy HH:mm')}">01/01/2024 15:00</p>
                                    </div>

                                    <!-- Data de Fechamento -->
                                    <div class="mb-3" th:if="${chamado.dataFechamento}">
                                        <label class="form-label fw-bold">Data de Fechamento:</label>
                                        <p class="mb-0" th:text="${#temporals.format(chamado.dataFechamento, 'dd/MM/yyyy HH:mm')}">01/01/2024 16:00</p>
                                    </div>

                                    <!-- SLA -->
                                    <div th:if="${chamado.slaRestante != null}">
                                        <label class="form-label fw-bold">SLA Restante:</label>
                                        <p class="mb-0">
                                            <span th:class="${chamado.slaRestante < 0 ? 'sla-vermelho' : (chamado.slaRestante == 0 && chamado.slaVencimento != null && chamado.slaVencimento.isBefore(#temporals.createNow()) ? 'sla-vermelho' : (chamado.slaRestante <= 4 ? 'sla-amarelo' : 'sla-verde'))}">
                                                <i class="fas fa-clock me-1"></i>
                                                <span th:if="${chamado.slaRestante > 0}" th:text="${chamado.slaRestante + ' horas'}">24 horas</span>
                                                <span th:if="${chamado.slaRestante == 0 && chamado.slaVencimento != null && chamado.slaVencimento.isAfter(#temporals.createNow())}" th:text="${'Menos de 1 hora'}">Menos de 1 hora</span>
                                                <span th:if="${chamado.slaRestante < 0 || (chamado.slaRestante == 0 && chamado.slaVencimento != null && chamado.slaVencimento.isBefore(#temporals.createNow()))}" th:text="${'SLA Vencido'}">SLA Vencido</span>
                                            </span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Histórico de Status -->
                            <div class="card shadow">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold">
                                        <i class="fas fa-history me-2"></i>
                                        Histórico
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="timeline">
                                        <!-- Abertura do chamado -->
                                        <div class="timeline-item">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">Chamado Aberto</h6>
                                                    <p class="mb-0 text-muted small">Por <span th:text="${chamado.solicitanteNome ?: 'Sistema'}">João Silva</span></p>
                                                </div>
                                                <small class="text-muted" th:text="${#temporals.format(chamado.dataAbertura, 'dd/MM HH:mm')}">01/01 10:00</small>
                                            </div>
                                        </div>

                                        <!-- Início do atendimento -->
                                        <div class="timeline-item status-change" th:if="${chamado.dataInicio}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">Atendimento Iniciado</h6>
                                                    <p class="mb-0 text-muted small">Por <span th:text="${chamado.tecnicoResponsavel ?: 'Técnico'}">Técnico</span></p>
                                                </div>
                                                <small class="text-muted" th:text="${#temporals.format(chamado.dataInicio, 'dd/MM HH:mm')}">01/01 11:00</small>
                                            </div>
                                        </div>

                                        <!-- Resolução -->
                                        <div class="timeline-item status-change" th:if="${chamado.dataResolucao}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">Chamado Resolvido</h6>
                                                    <p class="mb-0 text-muted small">Por <span th:text="${chamado.tecnicoResponsavel ?: 'Técnico'}">Técnico</span></p>
                                                </div>
                                                <small class="text-muted" th:text="${#temporals.format(chamado.dataResolucao, 'dd/MM HH:mm')}">01/01 15:00</small>
                                            </div>
                                        </div>

                                        <!-- Fechamento -->
                                        <div class="timeline-item status-change" th:if="${chamado.dataFechamento}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1">Chamado Fechado</h6>
                                                    <p class="mb-0 text-muted small">Por <span th:text="${chamado.tecnicoResponsavel ?: 'Sistema'}">Sistema</span></p>
                                                </div>
                                                <small class="text-muted" th:text="${#temporals.format(chamado.dataFechamento, 'dd/MM HH:mm')}">01/01 16:00</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Footer -->
            <footer th:replace="~{components/footer :: footer}"></footer>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/sidebar.js" defer></script>
    <script th:src="@{/js/notifications.js}"></script>
    
    <script>
        // Funções para ações dos chamados
        async function iniciarAtendimento(id) {
            const result = await (typeof Swal !== 'undefined'
                ? Swal.fire({
                    title: 'Informe o técnico responsável',
                    input: 'text',
                    inputPlaceholder: 'Nome do técnico',
                    showCancelButton: true,
                    confirmButtonText: 'Iniciar atendimento',
                    cancelButtonText: 'Cancelar',
                    inputValidator: (value) => {
                        if (!value || !value.trim()) return 'Informe o nome do técnico';
                    }
                })
                : Promise.resolve({ isConfirmed: true, value: window.prompt('Nome do técnico responsável:') }));
            if (result && result.isConfirmed && result.value) {
                atualizarStatusChamado(id, 'iniciar', result.value.trim());
            }
        }
        
        async function resolverChamado(id) {
            const confirmar = await (typeof Swal !== 'undefined'
                ? Swal.fire({
                    title: 'Deseja marcar este chamado como resolvido?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Marcar como resolvido',
                    cancelButtonText: 'Cancelar'
                }).then(r => r.isConfirmed)
                : Promise.resolve(window.confirm('Deseja marcar este chamado como resolvido?')));
            if (confirmar) atualizarStatusChamado(id, 'resolver');
        }
        
        async function fecharChamado(id) {
            const confirmar = await (typeof Swal !== 'undefined'
                ? Swal.fire({
                    title: 'Deseja fechar este chamado definitivamente?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Fechar chamado',
                    cancelButtonText: 'Cancelar'
                }).then(r => r.isConfirmed)
                : Promise.resolve(window.confirm('Deseja fechar este chamado definitivamente?')));
            if (confirmar) atualizarStatusChamado(id, 'fechar');
        }
        
        async function reabrirChamado(id) {
            const confirmar = await (typeof Swal !== 'undefined'
                ? Swal.fire({
                    title: 'Deseja reabrir este chamado? Ele voltará ao status ABERTO.',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Reabrir chamado',
                    cancelButtonText: 'Cancelar'
                }).then(r => r.isConfirmed)
                : Promise.resolve(window.confirm('Deseja reabrir este chamado? Ele voltará ao status ABERTO.')));
            if (confirmar) atualizarStatusChamado(id, 'reabrir');
        }
        
        function atualizarStatusChamado(id, acao, tecnico = null) {
            console.log('Atualizando status do chamado:', { id, acao, tecnico });
            
            const data = {
                acao: acao
            };
            
            if (tecnico) {
                data.tecnico = tecnico;
            }
            
            console.log('Dados a serem enviados:', data);
            console.log('URL da requisição:', `/suporte/chamados/${id}/status`);
            
            $.ajax({
                url: `/suporte/chamados/${id}/status`,
                method: 'POST',
                data: data,
                beforeSend: function() {
                    console.log('Enviando requisição AJAX...');
                },
                success: function(response) {
                    if (response && response.sucesso) {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({ title: 'Sucesso', html: 'Status atualizado com sucesso!', icon: 'success' })
                                .then(() => location.reload());
                        } else {
                            location.reload();
                        }
                    } else {
                        const msg = response && response.erro ? response.erro : 'Erro desconhecido';
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({ title: 'Erro', html: msg, icon: 'error' });
                        } else {
                            alert('Erro: ' + msg);
                        }
                    }
                },
                error: function(xhr) {
                    const msg = (xhr && xhr.responseText) ? xhr.responseText : 'Erro ao atualizar status do chamado.';
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({ title: 'Erro', html: msg, icon: 'error' });
                    } else {
                        alert(msg);
                    }
                }
            });
        }
    </script>
</body>
</html>
