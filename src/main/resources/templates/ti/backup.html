<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Backup do Sistema</title>
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/sidebar.css" rel="stylesheet">
    <link href="/css/notifications.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>
    <main class="main-content">
        <header th:replace="~{components/topbar :: topbar}"></header>

        <section class="content-area container-fluid py-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h4 mb-1"><i class="fas fa-hdd me-2"></i>Backup do Sistema</h1>
                    <p class="text-muted mb-0">Somente administradores podem executar o backup do banco.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header"><i class="fas fa-database me-2"></i>Backup do Banco de Dados (MySQL)</div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Gera um dump completo do banco de dados MySQL via Docker (mysqldump) ou fallback local, compactado em .sql.gz para download imediato.</p>
                            <form th:action="@{/ti/backup/mysql}" method="post" id="mysql-backup-form">
                                <button type="submit" class="btn btn-primary" id="btnBackupMysql" sec:authorize="hasAnyRole('ROLE_ADMIN','ROLE_MASTER','ADMIN','MASTER')">
                                    <i class="fas fa-download me-1"></i>Gerar Backup
                                </button>
                                <span class="ms-2 align-middle text-muted" sec:authorize="!hasAnyRole('ROLE_ADMIN','ROLE_MASTER','ADMIN','MASTER')">
                                    Ação disponível apenas para administradores.
                                </span>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
</div>

<script src="/js/sidebar.js" defer></script>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/notifications.js}"></script>
<script th:src="@{/js/app.js}"></script>
<script>
  (function(){
    function downloadBlob(blob, filename) {
      var url = window.URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = filename || 'backup.sql.gz';
      document.body.appendChild(a);
      a.click();
      setTimeout(function(){
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }, 0);
    }
    function onSubmit(e){
      e.preventDefault();
      var btn = document.getElementById('btnBackupMysql');
      if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...'; }
      fetch('/ti/backup/mysql', { method: 'POST' })
        .then(function(resp){
          if (!resp.ok) {
            return resp.text().then(function(t){
              var msg = 'Falha ao gerar backup (' + resp.status + ')';
              try {
                var j = JSON.parse(t);
                if (j && j.message) { msg = j.message; }
              } catch(e){}
              if (typeof Swal !== 'undefined') {
                var hint = '';
                if (t && /View .* references invalid table/i.test(t)) {
                  hint = '<br/><small class=\"text-muted\">Dica: há uma view inválida no banco. Corrija a view ou faça o dump após ajuste de permissões.</small>';
                }
                Swal.fire({
                  title: 'Erro ao gerar backup',
                  html: msg + hint,
                  icon: 'error'
                });
              }
              throw new Error(msg);
            });
          }
          var mode = resp.headers.get('X-Backup-Mode') || 'auto';
          var cd = resp.headers.get('Content-Disposition') || '';
          var match = /filename=([^;]+)/i.exec(cd);
          var filename = match ? match[1] : ('backup-' + Date.now() + '.sql.gz');
          return resp.blob().then(function(blob){
            downloadBlob(blob, filename);
            if (typeof Swal !== 'undefined' && mode && mode.toLowerCase() === 'host') {
              Swal.fire({
                title: 'Docker indisponível',
                html: 'O backup foi gerado usando o mysqldump local (<b>fallback</b>).<br/>Verifique o Docker no ambiente para usar o container.',
                icon: 'info'
              });
            }
          });
        })
        .catch(function(err){
          if (typeof Swal !== 'undefined') {
            Swal.fire({ title: 'Erro', text: (err && err.message) || 'Falha ao gerar backup', icon: 'error' });
          }
        })
        .finally(function(){
          if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-download me-1"></i>Gerar Backup'; }
        });
    }
    var form = document.getElementById('mysql-backup-form');
    if (form) { form.addEventListener('submit', onSubmit); }
  })();
</script>
</body>
</html>
