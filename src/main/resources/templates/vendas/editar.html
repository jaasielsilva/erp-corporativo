<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Venda - Painel do CEO</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  <link href="/css/sidebar.css" rel="stylesheet">
  <link href="/css/notifications.css" rel="stylesheet">
</head>

<body>
  <div class="app-container">
    <aside th:replace="~{components/sidebar :: sidebar}"></aside>

    <main class="main-content">
      <header th:replace="~{components/topbar :: topbar}"></header>

      <section class="content-area">
        <div class="container-fluid">
          <!-- Header da Página -->
          <div class="row mb-4">
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h1 class="display-6 fw-bold text-dark mb-0">
                    <i class="fas fa-edit me-2"></i>Editar Venda
                  </h1>
                  <p class="text-muted mb-0" th:text="'Venda #' + ${venda.numeroVenda}">Venda #000001</p>
                </div>
                <div>
                  <a th:href="@{'/vendas/' + ${venda.id}}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                  </a>
                </div>
              </div>
            </div>
          </div>

          <!-- Formulário de Edição -->
          <form th:action="@{'/vendas/' + ${venda.id} + '/atualizar'}" method="post" th:object="${venda}">
            <div class="row">
              <!-- Informações Básicas -->
              <div class="col-lg-8">
                <div class="card mb-4">
                  <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações da Venda</h5>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="numeroVenda" class="form-label">Número da Venda</label>
                          <input type="text" class="form-control" id="numeroVenda" th:field="*{numeroVenda}" readonly>
                        </div>
                        <div class="mb-3">
                          <label for="dataVenda" class="form-label">Data da Venda</label>
                          <input type="datetime-local" class="form-control" id="dataVenda" 
                                 th:field="*{dataVenda}" th:value="${#temporals.format(venda.dataVenda, 'yyyy-MM-dd\'T\'HH:mm')}">
                        </div>
                        <div class="mb-3">
                          <label for="status" class="form-label">Status</label>
                          <select class="form-select" id="status" th:field="*{status}">
                            <option value="Pendente">Pendente</option>
                            <option value="Finalizada">Finalizada</option>
                            <option value="Cancelada">Cancelada</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                          <select class="form-select" id="formaPagamento" th:field="*{formaPagamento}">
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="PIX">PIX</option>
                            <option value="Boleto">Boleto</option>
                            <option value="Transferência">Transferência</option>
                          </select>
                        </div>
                        <div class="mb-3">
                          <label for="parcelas" class="form-label">Parcelas</label>
                          <input type="number" class="form-control" id="parcelas" th:field="*{parcelas}" min="1" max="12">
                        </div>
                        <div class="mb-3">
                          <label for="desconto" class="form-label">Desconto (R$)</label>
                          <input type="number" class="form-control" id="desconto" th:field="*{desconto}" 
                                 step="0.01" min="0" onchange="calcularTotal()">
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="observacoes" class="form-label">Observações</label>
                      <textarea class="form-control" id="observacoes" th:field="*{observacoes}" rows="3"></textarea>
                    </div>
                  </div>
                </div>

                <!-- Itens da Venda -->
                <div class="card mb-4">
                  <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Itens da Venda</h5>
                    <button type="button" class="btn btn-light btn-sm" onclick="adicionarItem()">
                      <i class="fas fa-plus"></i> Adicionar Item
                    </button>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table class="table table-striped" id="tabelaItens">
                        <thead class="table-dark">
                          <tr>
                            <th>Produto</th>
                            <th class="text-center">Quantidade</th>
                            <th class="text-end">Preço Unitário</th>
                            <th class="text-end">Subtotal</th>
                            <th class="text-center">Ações</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr th:each="item, iterStat : ${venda.itens}" th:id="'item-' + ${iterStat.index}">
                            <td>
                              <input type="hidden" th:name="'itens[' + ${iterStat.index} + '].id'" th:value="${item.id}">
                              <input type="hidden" th:name="'itens[' + ${iterStat.index} + '].produto.id'" th:value="${item.produto.id}">
                              <strong th:text="${item.produto.nome}">Nome do Produto</strong>
                              <br>
                              <small class="text-muted" th:text="${item.produto.codigoInterno}">COD001</small>
                            </td>
                            <td class="text-center">
                              <input type="number" class="form-control form-control-sm text-center" 
                                     th:name="'itens[' + ${iterStat.index} + '].quantidade'" 
                                     th:value="${item.quantidade}" min="1" 
                                     onchange="calcularSubtotalItem(this)">
                            </td>
                            <td class="text-end">
                              <input type="number" class="form-control form-control-sm text-end" 
                                     th:name="'itens[' + ${iterStat.index} + '].precoUnitario'" 
                                     th:value="${item.precoUnitario}" step="0.01" min="0" 
                                     onchange="calcularSubtotalItem(this)">
                            </td>
                            <td class="text-end">
                              <span class="subtotal-item" th:text="'R$ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">R$ 0,00</span>
                            </td>
                            <td class="text-center">
                              <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(this)">
                                <i class="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        </tbody>
                        <tfoot class="table-light">
                          <tr>
                            <th colspan="3" class="text-end">Total Geral:</th>
                            <th class="text-end text-success" id="totalGeral">R$ 0,00</th>
                            <th></th>
                          </tr>
                        </tfoot>
                      </table>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Informações do Cliente -->
              <div class="col-lg-4">
                <div class="card mb-4">
                  <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-user me-2"></i>Cliente</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="clienteId" class="form-label">Selecionar Cliente</label>
                      <select class="form-select" id="clienteId" name="clienteId" th:field="*{cliente.id}">
                        <option value="">Selecione um cliente</option>
                        <option th:each="cliente : ${clientes}" 
                                th:value="${cliente.id}" 
                                th:text="${cliente.nome + ' - ' + cliente.cpfCnpj}"
                                th:selected="${cliente.id == venda.cliente.id}">
                          Cliente
                        </option>
                      </select>
                    </div>
                    <div class="cliente-info" th:if="${venda.cliente != null}">
                      <p><strong>Nome:</strong> <span th:text="${venda.cliente.nome}">Cliente</span></p>
                      <p><strong>CPF/CNPJ:</strong> <span th:text="${venda.cliente.cpfCnpj}">000.000.000-00</span></p>
                      <p th:if="${venda.cliente.email != null}"><strong>Email:</strong> <span th:text="${venda.cliente.email}">email@exemplo.com</span></p>
                      <p th:if="${venda.cliente.telefone != null}"><strong>Telefone:</strong> <span th:text="${venda.cliente.telefone}">(11) 99999-9999</span></p>
                    </div>
                  </div>
                </div>

                <!-- Resumo Financeiro -->
                <div class="card mb-4">
                  <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumo Financeiro</h5>
                  </div>
                  <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                      <span>Subtotal:</span>
                      <span id="subtotalResumo">R$ 0,00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                      <span>Desconto:</span>
                      <span id="descontoResumo">R$ 0,00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold text-success">
                      <span>Total:</span>
                      <span id="totalResumo">R$ 0,00</span>
                    </div>
                  </div>
                </div>

                <!-- Botões de Ação -->
                <div class="card">
                  <div class="card-body">
                    <button type="submit" class="btn btn-success w-100 mb-2">
                      <i class="fas fa-save"></i> Salvar Alterações
                    </button>
                    <a th:href="@{'/vendas/' + ${venda.id}}" class="btn btn-outline-secondary w-100">
                      <i class="fas fa-times"></i> Cancelar
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </section>

      <footer th:replace="~{components/footer :: footer}"></footer>
    </main>
  </div>

  <!-- Modal para Adicionar Item -->
  <div class="modal fade" id="modalAdicionarItem" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Adicionar Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="produtoSelect" class="form-label">Produto</label>
            <select class="form-select" id="produtoSelect">
              <option value="">Selecione um produto</option>
              <option th:each="produto : ${produtos}" 
                      th:value="${produto.id}" 
                      th:text="${produto.nome + ' - R$ ' + #numbers.formatDecimal(produto.preco, 1, 2)}"
                      th:data-preco="${produto.preco}">
                Produto
              </option>
            </select>
          </div>
          <div class="mb-3">
            <label for="quantidadeItem" class="form-label">Quantidade</label>
            <input type="number" class="form-control" id="quantidadeItem" min="1" value="1">
          </div>
          <div class="mb-3">
            <label for="precoItem" class="form-label">Preço Unitário</label>
            <input type="number" class="form-control" id="precoItem" step="0.01" min="0">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="confirmarAdicionarItem()">Adicionar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/js/notifications.js}" defer></script>
  <script src="/js/sidebar.js" defer></script>

  <script>
    let contadorItens = [[${#lists.size(venda.itens)}]];

    function calcularSubtotalItem(elemento) {
      const linha = elemento.closest('tr');
      const quantidade = linha.querySelector('input[name$=".quantidade"]').value;
      const precoUnitario = linha.querySelector('input[name$=".precoUnitario"]').value;
      const subtotal = quantidade * precoUnitario;
      
      linha.querySelector('.subtotal-item').textContent = 'R$ ' + subtotal.toFixed(2).replace('.', ',');
      calcularTotal();
    }

    function calcularTotal() {
      let subtotal = 0;
      document.querySelectorAll('.subtotal-item').forEach(span => {
        const valor = parseFloat(span.textContent.replace('R$ ', '').replace(',', '.'));
        if (!isNaN(valor)) subtotal += valor;
      });
      
      const desconto = parseFloat(document.getElementById('desconto').value) || 0;
      const total = subtotal - desconto;
      
      document.getElementById('subtotalResumo').textContent = 'R$ ' + subtotal.toFixed(2).replace('.', ',');
      document.getElementById('descontoResumo').textContent = 'R$ ' + desconto.toFixed(2).replace('.', ',');
      document.getElementById('totalResumo').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
      document.getElementById('totalGeral').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
    }

    function removerItem(botao) {
      if (confirm('Deseja realmente remover este item?')) {
        botao.closest('tr').remove();
        calcularTotal();
      }
    }

    function adicionarItem() {
      const modal = new bootstrap.Modal(document.getElementById('modalAdicionarItem'));
      modal.show();
    }

    function confirmarAdicionarItem() {
      const produtoSelect = document.getElementById('produtoSelect');
      const quantidade = document.getElementById('quantidadeItem').value;
      const preco = document.getElementById('precoItem').value;
      
      if (!produtoSelect.value || !quantidade || !preco) {
        alert('Preencha todos os campos');
        return;
      }
      
      const produtoNome = produtoSelect.options[produtoSelect.selectedIndex].text.split(' - ')[0];
      const subtotal = quantidade * preco;
      
      const tbody = document.querySelector('#tabelaItens tbody');
      const novaLinha = document.createElement('tr');
      novaLinha.id = 'item-' + contadorItens;
      
      novaLinha.innerHTML = `
        <td>
          <input type="hidden" name="itens[${contadorItens}].produto.id" value="${produtoSelect.value}">
          <strong>${produtoNome}</strong>
        </td>
        <td class="text-center">
          <input type="number" class="form-control form-control-sm text-center" 
                 name="itens[${contadorItens}].quantidade" value="${quantidade}" min="1" 
                 onchange="calcularSubtotalItem(this)">
        </td>
        <td class="text-end">
          <input type="number" class="form-control form-control-sm text-end" 
                 name="itens[${contadorItens}].precoUnitario" value="${preco}" step="0.01" min="0" 
                 onchange="calcularSubtotalItem(this)">
        </td>
        <td class="text-end">
          <span class="subtotal-item">R$ ${subtotal.toFixed(2).replace('.', ',')}</span>
        </td>
        <td class="text-center">
          <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(this)">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      
      tbody.appendChild(novaLinha);
      contadorItens++;
      
      calcularTotal();
      bootstrap.Modal.getInstance(document.getElementById('modalAdicionarItem')).hide();
      
      // Limpar formulário
      document.getElementById('produtoSelect').value = '';
      document.getElementById('quantidadeItem').value = '1';
      document.getElementById('precoItem').value = '';
    }

    // Atualizar preço quando produto for selecionado
    document.getElementById('produtoSelect').addEventListener('change', function() {
      const preco = this.options[this.selectedIndex].dataset.preco;
      if (preco) {
        document.getElementById('precoItem').value = preco;
      }
    });

    // Calcular total inicial
    document.addEventListener('DOMContentLoaded', function() {
      calcularTotal();
    });
  </script>
</body>

</html>